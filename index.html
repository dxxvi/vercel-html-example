<!DOCTYPE html>
<html lang="en" style="font-size: 18px; font-family: 'Noto Serif',serif">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Noto+Serif:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
  <style>
    :root {
      --bs-code-color: #0a6e77;
      --bs-font-monospace: "Fira Code", monospace;
      --code-color-comment: #a1b1b6;
      --code-color-italic: #36939b;
      --bs-font-sans-serif: "Noto Sans", sans-serif;
      --bs-body-color: #333;
      --a-in-button-margin: .3rem;
    }
    .accordion {
      --bs-accordion-active-bg: #2c4d6b;
      --bs-accordion-active-color: #fff;
      --bs-accordion-btn-bg: #233342;
      --bs-accordion-btn-color: var(--bs-accordion-active-color);
      --bs-accordion-btn-icon-transform: rotate(90deg);
      --bs-accordion-btn-padding-y: .5rem;
      --bs-accordion-transition: color .82s ease-in-out, background-color .82s ease-in-out, border-color .82s ease-in-out, box-shadow .82s ease-in-out, border-radius .82s ease;
    }
    a { text-decoration: none }
    code, pre { font-size: 1em }
    code > i { color: var(--code-color-italic) }
    code > i.comment { color: var(--code-color-comment) }
    pre code { color: var(--bs-code-color) }
    button.accordion-button {  padding-left: calc(var(--bs-accordion-btn-padding-x) / 2) }
    button.accordion-button > i:first-child { display: inline-block; width: 1.94em }
    button.accordion-button > code { color: var(--bs-accordion-btn-color); padding-left: .25rem; padding-right: .25rem }
    button.accordion-button > a { display: inline-block; margin-left: var(--a-in-button-margin); margin-right: var(--a-in-button-margin) }
    h2.accordion-header + div.accordion-collapse { margin-left: 1rem }
    .accordion-button::after { background-image: none; content: '\276F'; color: #fff; transform: none }
    .accordion-button:not(.collapsed)::after { background-image: none }
    .accordion-item { border: 0 }
    .accordion-button { box-shadow: none !important }
    pre { background: linear-gradient(90deg, #f3f3f3, #fff, #f5f5f5); padding: .5rem .5rem .5rem 1rem; margin-left: 1rem }
    li > pre { margin-left: unset }
    kbd {
      display: inline-block; margin: 0 2px; text-shadow: 0 1px 0 #fff; color: #242729; font: .875em "Noto Serif"; text-align: center;
      line-height: 1.1; background-color: #e4e6e8; border: 1px solid #9fa6ad; border-radius: 3px; min-width: 2.7em;
      box-shadow: 0 1px 1px rgba(12,13,14,0.15),inset 0 1px 0 0 #fff
    }
    body table.table { width: unset }
    body .table > :not(caption) > * > * { padding-top: .25rem; padding-bottom: .25rem; padding-left: 1.4rem }
    th { font-family: "Noto Serif" }

    table.vim-motions kbd { font-size: 1.2rem; padding-left: .3rem; padding-right: .3rem; min-width: 2rem }
  </style>
</head>
<body style="font: 1rem/1.43 'Noto Serif'">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
<div class="tab" title="Linux (including AWS and Vim)" fontawesome="fa-brands fa-linux">
[Free DDNS with Cloudflare](https://github.com/devrim/cloudflare-noip)

To import a gpg key: `gpg --keyserver hkp://pgp.rediris.es --recv-keys *key*`

To run Apache httpd in a docker container: specify the user/group to use in `/etc/apache2/apache2.conf` port in `/etc/apache2/ports.conf`, in `/etc/apache2/sites-available/000-default.config` change the port (to match the one used in ports.conf), specify the `&lt;Directory ...&gt;` (copied from apache2.conf) and `Alias /uri /path/to/directory`, start with `/usr/sbin/apachectl start`

Ubuntu: ignore SSL certificates when running apt `apt -o "Acquire::https::Verify-Peer=false" update`

Android: list all packages installed for current user `pm list packages` remove a package for current user `pm uninstall -k --user 0 *package*` list all packages on this phone `pm list packages -u` re-install an uninstalled app `pm install-existing *package*`

`find . -type f -exec ls "{}" \;` or `find . -type f -exec ls "{}" +`: in the 1st command, `;` needs to be escaped, that's why we need `\`. `\;` is like `ls file1; ls file2` and `+` is like `ls file1 file2`

Print the difference between 2 files: `diff --side-by-side --suppress-common-lines --width=210 *file1.java* *file2.java* | cat -n | grep -v -e '&#40;$'`

mount: `sshfs *remote_machine*:/*remote-folder* ~/*local-folder* -C` - unmount: `fusermount3 -u *mountpoint*`

Save SSL certificates in files: `openssl s_client [-proxy 10.51.40.129:3128] -connect *HOSTNAME*:*PORT* -showcerts`, save all `-----BEGIN CERTIFICATE----- ... -----END CERTIFICATE-----` in `.pem` files then convert .pem to .crt: `openssl x509 -inform PEM &lt; file.pem > file.crt`

Generate public key from AWS pem file: `ssh-keygen -y -f aws-generated.pem > aws-generated.pub`

substring: `echo "my string" | cut -c2-5 // returns a string from the position 2 to 5`

Regex: replace `([A-Z])\.([A-Z])` with `$1_$2`, look for strings not contain substring `^((?!sub string).)*$`

Keep environment variables in `sudo`: `sudo -E *command*`

To create RSA public, private keys in PEM format (`ssh-keygen` generates keys in a different format): `openssl genrsa -out private-key.pem 2048` then `openssl rsa -in private-key.pem -pubout -outform PEM -out public-key.pem`

Cut by multiple spaces: `*some command* | tr -s ' ' | cut -f...`

Read each line from a command output or from a file:
```
while read -r line; do                              while read -r line; do
  *do something with the variable $line*                *do something with the variable $line*
done &lt; &lt;(*command*)                                   done &lt; *some-file*
```

Display UTF-16 in Bash and Zsh: `snowflake=$(s='\u2744' && printf "$s") && echo $snowflake`

| Bash                                           | Zsh                          | Zsh in <i class="fa-brands fa-apple"></i> | Comment
|------------------------------------------------|------------------------------|-------------------------------------------|-------------
|<kbd>Alt</kbd>+<kbd>D</kbd>                     |                              |                                           |delete to the end of the word
|<kbd>Ctrl</kbd>+<kbd>W</kbd>                    | <kbd>Ctrl</kbd>+<kbd>W</kbd> |<kbd>&#8963;</kbd>+<kbd>W</kbd>            |delete to the beginning of the word
|<kbd>Alt</kbd>+<kbd>F</kbd>                     | <kbd>Alt</kbd>+<kbd>‚ûú</kbd>  |                                           |go to the end of the current/next word
|<kbd>Alt</kbd>+<kbd>B</kbd>                     | <kbd>Alt</kbd>+<kbd>‚Üê</kbd>  |                                           |go to the beginning of the current/prev word
|<kbd>Ctrl</kbd>+<kbd>A</kbd>                    | <kbd>Ctrl</kbd>+<kbd>A</kbd> |<kbd>&#8963;</kbd>+<kbd>A</kbd>            |to the beginning of the line
|<kbd>Ctrl</kbd>+<kbd>E</kbd>                    | <kbd>Ctrl</kbd>+<kbd>E</kbd> |<kbd>&#8963;</kbd>+<kbd>E</kbd>            |to the end of the line
|<kbd>Ctrl</kbd>+<kbd>K</kbd>                    | <kbd>Ctrl</kbd>+<kbd>K</kbd> |<kbd>&#8963;</kbd>+<kbd>K</kbd>            |kill to the end of the line
|<kbd>Ctrl</kbd>+<kbd>U</kbd>                    |                              |                                           |kill to the beginning of the line
|<kbd>Ctrl</kbd>+<kbd>Y</kbd>                    | <kbd>Ctrl</kbd>+<kbd>Y</kbd> |                                           |paste text from the kill buffer
|<kbd>Ctrl</kbd>+<kbd>L</kbd>                    | <kbd>Ctrl</kbd>+<kbd>L</kbd> |<kbd>&#8963;</kbd>+<kbd>L</kbd>            |clear screen
|                                                |<kbd>Ctrl</kbd>+<kbd>U</kbd>  |<kbd>&#8963;</kbd>+<kbd>U</kbd>            |kill the whole line
|<kbd>Ctrl</kbd>+<kbd>&#x21e7;</kbd>+<kbd>-</kbd>|<kbd>Ctrl</kbd>+<kbd>-</kbd>  |<kbd>&#8963;</kbd>+<kbd>-</kbd>            |undo the last change

| vim motions                                                              | `:set [no]number [no]relativenumber`                                         | `Ctrl-o` in insert mode                                    | c
|--------------------------------------------------------------------------|------------------------------------------------------------------------------|------------------------------------------------------------|---------------------------------------------------------------
| <kbd>h</kbd> ü†à                                                           | <kbd>j</kbd> ü†ã                                                              | <kbd>k</kbd> ü†â                                             | <kbd>l</kbd> ü†ä
| <kbd>e</kbd> to end of current word                                      | <kbd>w</kbd> to beginning of next word                                       | <kbd>b</kbd> to beginning of previous word                 | <kbd>g</kbd><kbd>e</kbd> end of previous word
| <kbd>0</kbd> to 1st character of line                                    | <kbd>^</kbd> to 1st non-blank character of line                              | <kbd>$</kbd> to end of line                                | <kbd>g</kbd><kbd>_</kbd> last non-blank character of line
| <kbd>E</kbd> to end of current WORD                                      | <kbd>W</kbd> to beginning of next WORD                                       | <kbd>B</kbd> to beginning of previous WORD                 | <kbd>g</kbd><kbd>E</kbd> end of previous WORD
| <kbd>f</kbd><kbd>{character}</kbd> to next {character}                   | <kbd>F</kbd><kbd>{character}</kbd> to previous {character}                   | <kbd>t</kbd><kbd>{character}</kbd> before next {character} | <kbd>T</kbd><kbd>{character}</kbd> before previous {character}
| <kbd>f</kbd><kbd>{character}</kbd> then <kbd>;</kbd> to next {character} | <kbd>f</kbd><kbd>{character}</kbd> then <kbd>,</kbd> to previous {character} | |
| <kbd>&#125;</kbd> next paragraph                                         | <kbd>&#123;</kbd> previous paragraph                                         | |
| <kbd>/</kbd>{pattern} search forward, then <kbd>‚Üµ</kbd>                  | <kbd>?</kbd>{pattern} search backward , then <kbd>‚Üµ</kbd>                    | <kbd>n</kbd> next match                                    | <kbd>N</kbd> previous match
| <kbd>g</kbd><kbd>g</kbd> to top of the file                              | <kbd>G</kbd> to end of file                                                  | {line number}<kbd>g</kbd><kbd>g</kbd> to a specific line   | <kbd>%</kbd> to matching bracket `&#40;&#91;&#123;&#125;&#93;&#41;`
| <kbd>v</kbd> visual mode                                                 | <kbd>V</kbd> visual line mode (text is selected by line)                     | <kbd>Ctrl</kbd>+<kbd>v</kbd> visual block mode
| <kbd>y</kbd> yank                                                        | <kbd>d</kbd> cut                                                             | <kbd>p</kbd> paste

Install [Arch Linux](https://www.youtube.com/watch?v=4dKzYmhcGEU) 17:27 shows how to remove Arch. [Use CachyOS packages in Arch](https://wiki.cachyos.org/features/optimized_repos/)‚à®
  - Make 1 empty partition in Windows with `diskmgmt`, disable Secure Boot in BIOS
  - After the Arch Linux in the USB started:
```
setfont ter-132n                    // to increase the terminal font size
iwctl                               // to connect to a wireless network
  device list                          // will show wlan0
  station wlan0 get-networks           // to list all the available wireless networks
  station wlan0 connect *my_wireless_network*
  exit                                 // run ping google.com to check
pacman -Sy && pacman -Sy archlinux-keyring
pacman -Sy archinstall              // it's said that these commands should be run separately
lsblk                               // or fdisk -l to see what partitions we have
cfdisk /dev/nvme0n1                 // to create more partitions: create 1 400MB partition with EFI System type, another with Linux filesystem type
lsblk                               // check to see if partitions are created correctly
mkfs.fat -F32 /dev/nvme0n1p*4* && mkfs.ext4 /dev/nvme0n1p*5* // format the EFI System and regular partitions
mount /dev/nvme0n1p*5* /mnt && mkdir /mnt/boot && mount /dev/nvme0n1p*4* /mnt/boot && lsblk // to verify that the mountings are correct
archinstall // choose Pre-mounted configuration, Grub bootloader, pipewire audio server, root directory of the mounted device: /mnt
  Hyprland desktop environment: dolphin dunst grim kitty polkit-kde-agent qt5/6-wayland slurp wofi xdg-desktop-portal-hyprland
  Server: docker, nginx, sshd
[root@archiso /]# lsblk && pacman -Sy grub efibootmgr dosfstools mtools ntfs-3g waybar nnn foot networkmanager neovim // choose the option to chroot
  grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
  grub-mkconfig -o /boot/grub/grub.cfg
```

  - Boot into the new Arch and add the Windows item to the Grub: uncomment the line `GRUB_DISABLE_OS_PROBER=false` in `/etc/default/grub`:
```
systemctl start NetworkManager && nmcli radio wifi on && nmcli dev wifi connect &lt;SSID&gt; password &lt;password&gt;
pacman -Sy os-prober
mount /dev/nvme0n1p1 /mnt // mount the Windows EFI partition manually if grub-mkconfig cannot find Windows
grub-mkconfig -o /boot/grub/grub.cfg
```
  - Stuff:
```
git clone https://aur.archlinux.org/paru.git && cd paru && makepkg -si
paru visual-studio-code-bin
```
  - Install KDE Plasma:
```
pacman -Sy plasma-desktop kscreen plasma-nm plasma-pa plasma-meta plasma-disks plasma-desktop plasma-thunderbolt plasma-vault plasma-systemmonitor plasma-integration libnotify bluedevil
```
  - In KDE, when we go to System Settings | Font Management | Install from File..., the .ttf files are copied to directories under `~/.fonts` and a file named `~/.fonts.conf` is created. If I manually copy .ttf files to ~/.fonts, does it work? This is ~/.fonts.conf:
```
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE fontconfig SYSTEM "fonts.dtd"&gt;
&lt;fontconfig&gt;&lt;dir&gt;~/.fonts&lt;/dir&gt;&lt;/fontconfig&gt;
```
  - Delete Arch's partitions with `diskmgmt` (EFI System partition cannot be delete here):
```
diskpart // run in Administrator cmd
  list disk
  select disk 0
  list partition
  select partition *5* // select the one with System type
  list partition     // list again to make sure we select the correct EFI System partition
  delete partition override
```

Setup an Ubuntu docker container to run X apps (like IntelliJ)‚à®
  - Run a docker container using the host network and docker socket:
```
docker run -d --name ubuntu --hostname ubuntu -v /var/run/docker.sock:/var/run/docker.sock --network host ubuntu tail -f /dev/null
docker exec -it ubuntu /bin/bash
ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime && export DEBIAN_FRONTEND=noninteractive && apt update -y && apt install -y curl vim openssh-server git zip sudo htop xorg xbase-clients xauth && sed -i -e 's/#Port 22/Port 2222/' -e 's/#AddressFamily any/AddressFamily inet/' -e 's/#ClientAliveInterval 0/ClientAliveInterval 82/' -e 's/#ClientAliveCountMax 3/ClientAliveCountMax 419/' -e 's/#AllowTcpForwarding yes/AllowTcpForwarding yes/' -e 's/#TCPKeepAlive yes/TCPKeepAlive yes/' /etc/ssh/sshd_config && mkdir /run/sshd && chmod 0755 /run/sshd && ssh-keygen -A && /usr/sbin/sshd && sed -i -E '/root.+ALL.+ALL.+ALL.+ALL/a *mylinuxaccount* ALL=(ALL:ALL) NOPASSWD: ALL' /etc/sudoers
groupadd -g 1904 docker && useradd -d /home/*mylinuxaccount* -m -u 1904 -g docker -s /bin/bash *mylinuxaccount*
mkdir -p ~/.local/bin ~/.ssh && sed -i '$ a export LIBGL_ALWAYS_INDIRECT=1' ~/.bashrc && sed -i "$ a alias ..='cd ..'" ~/.bashrc && sed -i "$ a alias ...='cd ../..'" ~/.bashrc
```

sed: substitute, add and delete lines‚à®
  - of course, the one I already knew: substitue: `sed -i 's/*a*/*b*/g' *file.txt*`; multiple substitutions `sed -i -e 's/*a*/*b*/g' -e 's/*c*/*d*/' *file.txt*`
  - print the Nth line in the file: `sed -n '*N*p' *file.txt*`
  - delete the first N + 1 lines in the file: `sed -i -e '1,*N*d' *file.txt*`
  - delete lines containing something in the file: `sed -i -e '/*something*/d' file` (no `-e` in Arch)
  - add a line after the Nth line in the file: `sed '*N* a *line to be added*' *file.txt*` (don't forget to add `-i` to edit the file)
  - add a line before the Nth line in the file: `sed '*N* i *line to be added*' *file.txt*`, `$` means the last line
  - add a line after the lines containing a pattern match: `sed '/*PATTERN*/a *line to be added*' *file.txt*`, use `-E` for regex
  - add a line before the lines containing a pattern match: `sed '/*PATTERN*/i *line to be added*' *file.txt*`

grep: filter‚à®
  - get lines longer than 82 characters: `grep '.\{82\}'`
  - count number of lines longer than 82 characters: `grep -c '.\{82\}'` instead of `grep '.\{82\}' | wc -l`

[jq](https://www.youtube.com/watch?v=j7xZ2VkLYIY)‚à®
  - `jq '.' file.json` or `cat file.json | jq '.'`. `.` is like the root, so we can add fields after it.

Use our private key on a remote machine without copying it there‚à®
  - Lists fingerprints of all identities currently represented by the agent: `ssh-add -l` which might return an error if the ssh-agent is not started.
  - In [PowerShell](https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_keymanagement), check the status of ssh-agent with `Get-Service ssh-agent`, start it `Start-Service ssh-agent`: hm ... doesn't work for me
  - Load our keys into the ssh-agent `ssh-add $env:USERPROFILE\.ssh\id_ed25519`
  - `ssh -A user@remote-machine`

AWS EC2‚à®
  - To generate the `accessKeyId` and `secretAccessKey` for the IAM in an ec2 instance:
```
export TOKEN=$(curl -X PUT --silent "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600") && curl --silent -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/iam/security-credentials/*our-iam-role-name*" | jq -r '"export AWS_ACCESS_KEY_ID=\"\(.AccessKeyId)\" \nexport AWS_SECRET_ACCESS_KEY=\"\(.SecretAccessKey)\" \nexport AWS_SESSION_TOKEN=\"\(.Token)\""'
```
  - `X11Forwarding` in EC2 instances is not enough, we need `AllowTcpForwarding` too. Install vcxsrv, run `xlaunch`, in PowerShell `$env:DISPLAY="localhost:0"`, then `ssh -Y remote-machine`. In the remote machine `export LIBGL_ALWAYS_INDIRECT=1`
  - Attach an EBS volume to an EC2 instance: `ec2Client.attacheVolume(AttacheVolumeRequest.volumeId("...").instanceId("i-xxx").device("/dev/sdb"))` then `lsblk` to check the real device as it might not be `/dev/sdb` but `/dev/nvme1n1`. Check if the volume has any file system `file -s /dev/nvme1n1`. Format it `mkfs -t ext4 /dev/nvme1n1`. Mount it `mount /dev/nvme1n1 /mnt/something`.
  - Unmount then detach an EBS volume from an EC2 instance before terminating it (`aws ec2 detach-volume` or `ec2Client.detachVolume(detachVolumeRequest)`).
  - Java example to create an EC2 spot instance that can hibernate:
```
IamInstanceProfileSpecification.builder().name("...").build()
SpotMarketOptions.builder().spotInstanceType(PERSISTENT).instanceInterruptionBehavior(HIBERNATE).maxPrice("2").build()
InstanceMarketOptionsRequest.builder().marketType(SPOT).spotOptions(spotMarketOptions).build()
TagSpecification.builder().resourceType(INSTANCE).tags(Tag.builder().key("...").value("...").build(), ...).build()
EbsBlockDevice.builder().deleteOnTermination(true).volumeSize(...).volumeType(GP3).build()
BlockDeviceMapping.builder().ebs(ebsBlockDevice, ...).deviceName("/dev/sdh").build()
RunInstancesRequest.builder().blockDeviceMappings(...).iamInstanceProfile(...).imageId(...).instanceType(T3_LARGE).instanceMarketOptions(...).keyName(...).maxCount(1).minCount(1).securityGroupIds(...).subnetId(...).tagSpecifications(...).userData(Base64.getEncoder().encodeToString(...)).build()
```

AWS ECS‚à®
  - Create a private repository (contains tags of only 1 docker image). AWS console will show us the exact commands to login, push a docker image to ECR.
  - Create a cluster (can run on Fargate (serverless) or EC2 instances)
  - Create a task definition: a task definition does the job of docker-compose.yml
  - Create a load balancer (under EC2):
      - target group: for ECS the target type is IP address but we don't need to specify any IP address here (that makes sense as the IP addresses are not fixed)
      - choose Application Load Balancer
  - Create a service:
      - a service ensures that a certain number of tasks run at all times
      - task: a running container with settings defined in the Task Definition
      - VPC, subnets: ec2 instances will be created in these subnets to run our tasks
      - security groups: applied for the ec2 instances that run our tasks
      - there's a section to specify the load balancer. At this moment, we know that load balancer will route traffics to where.
      - when done, there's a link in the service for the load balancer where there's a DNS name for this load balancer

AWS Lambda‚à®
  - All acceptable events are in `com.amazonaws:aws-lambda-java-events`.
  - Every lambda has an execution role which can upload logs to CloudWatch.
  - With API Gateway as a trigger:
      - Create a lambda but don't <kbd>+ Add Trigger</kbd> yet
      - Create an API Gateway (REST API type)
      - Add resource (e.g. `countries`, `{countryId}`, `states`, `{stateId}`)
      - <kbd>Create method</kbd> for the above resource: in this step we need the lambda arn (that's why we need a lambda first)
      - <kbd>Deploy API</kbd> so that we can specify a stage name.
      - Refresh the lambda console, we'll see that the API Gateway is added as a trigger. In the Configuration tab, the API Gateway trigger gives use an API endpoint
      - Code source: to set the jar in s3; Runtime settings: to set the runtime (e.g. Java 21) and the handler method
      - Logging messages are in CloudWatch
      - After putting the new jar in s3, we need to go to the lambda console and <kbd>Upload from ‚ñº</kbd> again.
  - With S3 event as a trigger:
      - Use `com.amazonaws.services.lambda.runtime.events.S3Event` as the input, the output can be anything.
      - `S3Event` has a `List&lt;S3EventNotificationRecord&gt;`. Each record has information about the S3 object (bucket, key, size, owner, arn ...)

AWS EventBridge‚à®
  - We can schedule an event based on cron. It can trigger a lambda.

AWS SQS (simple queue service)‚à®

| 2 types of queues | throughput           | delivery type           | ordering
|-------------------|----------------------|-------------------------|----------------------
| Standard queues   | unlimited throughput | At-Least-Once delivery  | Best effort ordering
| FIFO queues       | high throughput      | Exactly-Once processing | FIFO delivery

  - When a message is received, the visibility timeout starts. Nobody can receive the message before the visibility timeout ends. The person who receives the message has to explicitly delete it otherwise he will receive that message again.
  - Message payload max size is 256KB. Each 64KB is billed as 1 request. If we use the SQS Extended Client library for Java, we can send messages of up to 2GB (message payload will be stored in S3).
  - Messages are retained in queues for 14 days
  - We can do a long polling (wait 20s for messages) to reduce the number of requests
  - [Message group id](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagegroupid-property.html): not very sure about its purpose. It's advised to have unique message group id if we want to avoid processing duplicates in a multi-producer/consumer system.
  - SNS is a publish-subscribe service. AWS allows some types of subscribers only like SQS, Lambda, HTTP, email, mobile push notification and SMS.
  - Amazon MQ is for applications that are using JMS, Active/Rabbit MQ ... to migrate to AWS.

</div>
<div class="tab" title="Docker" fontawesome="fa-brands fa-docker">
[Docker Compose UI](https://github.com/louislam/dockge)

A place [to store a docker image](http://ttl.sh/) for 24 hrs

To run docker in a docker container: run the docker container with `-v /var/run/docker.sock:/var/run/docker.sock`

To use the exact network as host (e.g. a docker container in an ec2 instance wants to use the IAM on that instance): run the docker container with `--network host` and that means `-p host-port:container-port` is ignored (the container and the host will use the same ports).

To mount a volume to an existing docker container: create an image from the existing docker container `docker commit *container_id* *new_image_name*` then run the *new_image_name* with additional mounts

Expose docker daemon on tcp port and access it from Powershell‚à®
  - Running `systemctl start docker` shows something like `/usr/lib/systemd/system/docker.service`. Edit the line `ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 ...`
  - Powershell: install chocolatey and `choco install docker-cli` with admin right. Then `$env:DOCKER_HOST="tcp://x.x.x.x:2375"`, `docker image ls` will work.
</div>
<div class="tab" title="Kubernetes">
`kubectl` *[command]* *[TYPE]* *[NAME's]* *[flags]*:
  - command: `create`, `get`, `describe`, `delete`, `apply` ...:
      - `kubectl create -f *FILENAME* [flags] // create 1 or more resources from a file`
      - `kubectl apply -f *FILENAME* [flags] // apply a configuration change to the resource specify in the given file`
      - `kubectl delete -f *FILENAME* // delete resources from a file`
      - `kubectl get TYPE [NAME] // list one or more resources`
      - `kubectl logs POD [-c CONTAINER] [--follow] // print the logs for a container in a pod`
      - `kubectl exec POD [-c CONTAINER] [-i] [-- COMMAND [args...]] // execute a command in a container in a pod`
      - `kubectl taint NODE NAME KEY_1=VAL_1:TAINT_EFFECT_1 ... KEY_n=VAL_n:TAINT_EFFECT_n // update the taints on node`
  - TYPE: configmaps, endpoints, namespaces, nodes, secrets, services, :
      - **ReplicationController**: pod replica manager which guarantees a desired number of pod replicas running at any given time. However, Deployment does the same job better.
      - **Deployment**: like ReplicationController (uses ReplicaSet to ensure that a number of pods is running at any time) and more:
          - Rolling Updates: gradually rolls out new Pod versions while scaling down old ones.
          - Advanced Features: health check and rollbacks
      - **ReplicaSet**: ensures that a stable number of pods is running at any given time. ReplicaSet is used by Deployment.
      - **Service**: is an abstraction layer for a set of pods which provides:
          - Service Discovery: allows us to select pods by specifying key-value pairs
          - Load Balancing: a service is assigned a clusterIP, it distributes requests to that clusterIP across the pods in that service
      - **DaemonSet**: is a controller ensuring that a specified pod is running on every node (we can limit the node by using labels or taints), for example log collector, resource utilization metrics ...
      - **Job**: a controller that manages short-lived, one-time task (e.g. batch processes, file processing)
      - **Ingress**: traffic routing. The Ingress controller looks at the defined Ingress rules to determine the service (which does the load balancing) for each request.
      - **VolumeAttachment**: attach a persistent volume to a specific node for pods running on that node to use.

Taint and Torelation: used to precisely control pod placement in a cluster:
  - Taints: are attributes added to a node. A taint has 3 parts:
      - Key: a name to uniquely identity the taint
      - Value (optional): an additional detail associated with the key
      - Effect:
          - NoSchedule: pods cannot be scheduled on the tainted node unless they tolerate the taint
          - PrefereNoSchedule
          - NoExecute: existing pods with the taint are evicted and new pods cannot be scheduled on nodes marked with the taint
  - Tolerations: are permissions assigned to pods allowing them to be scheduled on nodes with matching taints

Helm Chart: is the package manager for Kubernetes application. It put all the resources needed to deploy an application in a single, reusable package. A Helm chart has 3 components: Chart.yaml (chart metadata like name, version, dependencies on other charts), YAML template (defines resources required like Deployment, Service, ConfigMaps, Secrets ...), Values.yaml (contains configuration values that can be customized so that, e.g. we can deploy app in different envs).
</div>
<div class="tab" title="Mac" fontawesome="fa-brands fa-apple">
Cannot be opened because the developer cannot be verified:
  - locate the app in Finder | &#8963;+click | select Open | click Open: the app will be saved as an exception
  - or <i class="fa-brands fa-apple"></i> menu | System Settings | Privacy & Security | there's a Open Anyway button for the app we've just failed to open
  - in case of graalvm, run `find ~/graalvm/Contents/Home/ -name "*.dylib" -exec xattr -d com.apple.quarantine "{}" \;`

Add spaces to MacOS dock: `defaults write com.apple.dock persistent-apps -array-add '{"tile-type"="spacer-tile";}'; killall Dock`
</div>
<div class="tab" title="NodeJS - HTML - CSS" fontawesome="fa-brands fa-node-js">
[Encrypt and password protect](https://github.com/robinmoisson/staticrypt) the content of your public static HTML file, to be decrypted in-browser without any back-end

[HTML codes](https://www.rapidtables.com/web/html/html-codes.html) for example `&#123;` is `&#38;#123;`

[paged.js](https://pagedjs.org/) paginates any HTML content to produce beautiful print-ready PDF

css property: `-moz-osx-font-smoothing`, Roboto Flex font (Google Fonts [filtered for variable only](https://fonts.google.com/?vfonly=true)): adjustable width

Align `dt` and `dd` in `dl`:
```
dl { display: grid; grid-template-columns: max-content auto }
dt { display: grid; align-content: center; grid-column-start: 1 }
dd { margin-left: 0; grid-column-start: 2 }
```

`getComputedStyle(*element*).getPropertyValue('*property*')`: [for example](https://developer.mozilla.org/en-US/docs/Web/API/Window/getComputedStyle) `getComputedStyle(p).getPropertyValue('font-size')`

[Insert html code to an element](https://developer.mozilla.org/en-US/docs/Web/API/Element/insertAdjacentHTML): `*element*.insertAdjacentHTML(*position*, *text*)` where `*position*` can be `beforebegin`, `afterbegin`, `beforeend` or `afterend` and `*text*` is the string to be parsed as HTML and inserted into the tree.

[Get all attributes](https://developer.mozilla.org/en-US/docs/Web/API/Element/attributes) of a html element

Convert image data to base64:
```
function convertImageToBase64(imgUrl, callback) {
  const image = new Image();
  image.crossOrigin = 'anonymous';
  image.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = image.naturalHeight;
    canvas.width = image.naturalWidth;
    ctx.drawImage(image, 0, 0);
    callback && callback(canvas.toDataURL()) // canvas.toDataURL() is what we want
  };
  image.src = imgUrl;
}
```

Angular‚à®
  - A component is annotated with `@Component` which takes a css `selector`, a `templateUrl`, 0 or many `styleUrls` and other non-popular properties like `encapsulation: ViewEncapsulation.Emulated | ShadowDom` (so that the css styles of the page don't affect this component and vice versa), ...
  - Component lifecycle: the Typescript class for the component can implement some interfaces like
      - `OnChanges`: called before `ngOnInit()` if the component has bound inputs and when the data-bound input properties change
      - `OnInit`, `DoCheck`, `AfterContentInit`, `AfterContentChecked`, `AfterViewInit`, `AfterViewChecked`, 'OnDestroy'
  - Component interaction:
      - Pass data from a parent to its child with `@Input`. We can intercept input property changes with a setter or `ngOnChanges()`
      - Parent listens for child event with `@Output() *someVar* = new EventEmitter&lt;*SomeType*&gt;(); *someVar*.emit(*someTypeInstance*);`
      - Parent can declare a local variable which is of child component type `&lt;child-component #myChildComponent&gt;&lt;/child-component&gt;`. Then __in parent component template__ (not parent component class, if we want to access the child component in the parent component class, use `@ViewChild()`), we can access properties, methods of child component using `myChildComponent.property` or `myChildComponent.method()`.
      - Parent can declare a local variable in the typescript class `@ViewChild(ChildComponent) private childComponent: ChildComponent;`
      - Use `RxJs`: [2 components share a service](https://angular.io/guide/component-interaction#parent-and-children-communicate-using-a-service) which has a `Subject` instance (from `rxjs`) and an observable of that subject. This service must be annotated with `@Injectable()` so that it can be injected to constructors of other services/components. In those other services/components, we need to subscribe to that observable.
  - Content projection: [when](https://angular.io/guide/content-projection) _I have time, I'll write about this_
  - Dynamic components: [also](https://angular.io/guide/dynamic-component-loader) very interesting
  - Directives: are classes that add additional behavior to elements. 3 directive types: component, attribute directive (`ngClass`, `ngStyle`, `ngModel` to display and update properties) and structural directive (`ngIf`, `ngFor`, `ngSwitch`)
  - Forms: [a big subject](https://angular.io/guide/forms-overview) with reactive and template-driven forms.
  - HTTP client: I think nobody will ask about [this](https://angular.io/guide/understanding-communicating-with-http) in interviews
  - What is multicasting? Error handing in observable?

</div>
<div class="tab" title="Java" fontawesome="fa-brands fa-java">
Use database for [distributed lock, Kafka topic](https://www.youtube.com/watch?v=ghpljMg8Ecc): use pessimistic/optimistic write.

Get [HTTPS](https://lcl.host/) in your local development

[DFLib](https://dflib.org/) a lightweight pure Java implementation of a common DataFrame data structure

[Slim docker images for Java apps](https://piotrminkowski.com/2023/11/07/slim-docker-images-for-java/)

[Disable SSL](https://stackoverflow.com/questions/52988677/allow-insecure-https-connection-for-java-jdk-11-httpclient) in Java 11 HttpClient

[Java 21 language update](https://docs.oracle.com/en/java/javase/21/language/pattern-matching-switch-expressions-and-statements.html): a very good to see all the changes in 1 place

Jdk 22 - [Stream Gatherer](https://blog.soebes.io/posts/2024/01/2024-01-07-jdk-gatherer/) (preview) Viktor Klang

Using Datadog + profilers [to understand request latency](https://richardstartin.github.io/posts/wallclock-profiler)

New Language [Features](https://jenkov.com/tutorials/java/index.html) from Java 7 - 22 ~ [Compare](https://javaalmanac.io/) Java API of different JDK versions

[JFR events](https://sap.github.io/SapMachine/jfrevents/21.html): when can I have time to play with JFR?

[Manifold](http://manifold.systems/) is a Java _compiler plugin_ for method extension ~ [BoofCV](http://boofcv.org) computer vision Java library - [Benchmark JDBC connectors and virtual threads](https://mariadb.com/resources/blog/benchmark-jdbc-connectors-and-java-21-virtual-threads/)

Spring Kafka [example](https://github.com/j-tim/spring-io-barcelona-2022-spring-kafka-beyond-the-basics)

Install certificates:
  - Java 11+: `keytool -importcert -trustcacerts -storepass changeit -cacerts -noprompt -file */Downloads/certificates/prag.pem* -alias *prag*`
  - Java 8: `keytool -importcert -trustcacerts -storepass changeit -keystore $JAVA_HOME/jre/lib/security/cacerts -noprompt -file */Downloads/certificates/prag.pem* -alias *prag*`

Tell the jvm to use proxy: `-Dhttp.proxyHost=... -Dhttp.proxyPort=... -Dhttp.nonProxyHosts="10.*|*.nbc.net" -Dhttp.proxyUser=... -Dhttp.proxyPassword=...`

To programmatically set log level (check [this](https://prefab.cloud/blog/dynamically-changing-java-log-level/) for ways to do this for all instances of a service. IMO Redis pub/sub is the best. If the service discovery can tell us all the instances, then we can use that):
```
var loggerContext = (ch.qos.logback.classic.LoggerContext) org.slf4j.LoggerFactory.getILoggerFactory()
List&lt;ch.qos.logback.classic.Logger> loggers = loggerContext.getLoggerList() // need to define a logger for a specific package/class in logback.xml
logger.setLevel(ch.qos.logback.classic.Level.DEBUG)
```

To test if there's a particular log message at a particular log level (for logback only):
  - Create `var listAppender = new ListAppender&lt;ILoggingEvent>()`
  - Get the logger that prints out the particular log message: `var logger = (ch.qos.logback.classic.Logger) org.slf4j.LoggerFactory.getLogger("*logger.name*")`
  - Then `logger.addAppender(listAppender); listAppender.start()`. The `listAppender.list` has all the logging events.

Download an artifact with maven: `mvn org.apache.maven.plugins:maven-dependency-plugin:3.3.0:get -Dartifact=org.jetbrains.kotlin:kotlin-stdlib:1.7.21:jar:sources`

git-commit-id maven/gradle plugin generates a `git.properties` file that we can expose via an endpoint.

spotless-maven-plugin‚à®
  - maven:
```
&lt;plugin&gt;
  &lt;groupId&gt;com.diffplug.spotless&lt;/groupId&gt;
  &lt;artifactId&gt;spotless-maven-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;java&gt;
      &lt;removeUnusedImports/&gt;
      &lt;googleJavaFormat&gt;
        &lt;formatJavadoc&gt;false&lt;/formatJavadoc&gt;
      &lt;/googleJavaFormat&gt;
      &lt;importOrder/&gt;
    &lt;/java&gt;
    &lt;pom&gt;
      &lt;sortPom&gt;
        &lt;expandEmptyElements&gt;false&lt;/expandEmptyElements&gt;
        &lt;nrOfIndentSpace&gt;2&lt;/nrOfIndentSpace&gt;
        &lt;sortDependencies&gt;scope,groupId,artifactId&lt;/sortDependencies&gt;
        &lt;sortDependencyExclusions&gt;groupId,artifactId&lt;/sortDependencyExclusions&gt;
        &lt;sortModules&gt;true&lt;/sortModules&gt;
        &lt;sortPlugins&gt;groupId,artifactId&lt;/sortPlugins&gt;
        &lt;sortProperties&gt;true&lt;/sortProperties&gt;
      &lt;/sortPom&gt;
    &lt;/pom&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;goals&gt;
        &lt;goal&gt;check&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;phase&gt;compile&lt;/phase&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
```

Kafka [Gently down the stream](https://www.gentlydownthe.stream/)‚à®
  - Outbox pattern: to solve the dual write problem: make a db transaction and publish an event: create 1 non-business step in that db transaction which is writing to the outbox table. Then there's another thread that keeps checking the outbox table and publishing events.
  - [An example](https://developers.redhat.com/articles/2024/06/20/stateful-and-reactive-stream-processing-applications-apache-kafka-quarkus-and) to count the messages by keys, they create 1 TopN message in a KTable, then shows it in a browser using Quarkus.
  - [Confluent Kafka](https://docs.confluent.io/platform/current/installation/installing_cp/zip-tar.html) download and installation or [previous version](https://www.confluent.io/previous-versions/) - if it's possible, create a trial cloud account.
  - How to delay sending a message: `ProducerRecord` accepts a timestamp in the future. So, don't use `Thread.sleep` which will block the whole app.
  - [Co-partitioning](https://www.confluent.io/blog/co-partitioning-in-kafka-streams/) in Kafka Stream: a concept to ensure the correct and efficient of joining 2+ streams. That means the topics must have the same number of partitions and the same key hashing method.
  - To make `KafkaConsumer` return `SpecificRecord`:
```
props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, KafkaAvroDeserializer.class);
props.put(KafkaAvroDeserializerConfig.SPECIFIC_AVRO_READER_CONFIG, "true"); // Kafka Streams in Action, 2nd ed also mentions this
props.put(AbstractKafkaSchemaSerDeConfig.SCHEMA_REGISTRY_URL_CONFIG, ...);
```
  - Kafka Streams: runs in our applications - Apache Flink (more powerful): runs in Flink servers (how to unit test a Flink-based app?)
  - Kafka Streams terminologies:
      - Processors: source processor (read data, KStream), stream processor, sink processor (write data). A bunch of them put together is called a Topology. A sink processor can be used as a source processor, so, don't draw a source processor connected to a sink processor.
  - Kafka Streams task: is the code that does the joining/mapping/filtering ...The max number of tasks is the max number of partitions of all the topics used in that task.
      - `KStream`: a partitioned record stream
      - `KTable`: a partitioned table (changelog stream), created with `streamsBuilder.table(topic, consumed, materialized)`. We can bring messages in a KTable to a new KStream with `kTable.toStream`. When do the messages in a KTable go to a KStream? It depends on `StreamsConfig.CACHE_MAX_BYTES_BUFFERING_CONFIG` (deprecated. What to use now?)
      - `GlobalKTable`: similar to KTable but unpartitioned
      - Increase the number of concurrent Kafka Streams tasks with `StreamsConfig.NUM_STREAM_THREADs_CONFIG`
      - Handling errors: use the config `StreamsConfig.DEFAULT_DESERIALIZATION_EXCEPTION_HANDLER_CLASS_CONFIG`, `StreamsConfig.DEFAULT_PRODUCTION_EXCEPTION_HANDLER_CLASS_CONFIG` (for serialization errors). For application errors (errors happen in the topology), we need to register a `StreamUncaughtExceptionHandler` implementation like this `kafkaStreams.setUncaughtExceptionHandler(new StreamUncaughtExceptionHandler() { ... })`
      - Stateless processing: filter, adding &amp; removing fields (what's this?), rekeying records, branching &amp; merging streams, enriching records, flatMapping
      - Stateful processing:
          - Joining data: enrich an event with info captured in a separate stream/table (`join`, `leftJoin`, `outerJoin`)
          - Aggregating data: maybe in one partition only (`aggregate`, `count`, `reduce`):
              - `count`: `kStream.groupBy...().count(PROCESSOR_NAME, Materialized): KTable`. The methods `groupBy...` give us a way to count by keys, by a combination of key and value, ...
              - `reduce` and `aggregate`: `reduce` doesn't allow a start value
          - Windowing data: group events that are close to each other in time (`windowedBy`)
          - States are stored in RocksDB which flushes data to files in `StreamsConfig.STATE_DIR_CONFIG`.
      - StateStore: why is it needed? Because we want to re-populate the KTable/GlobalKTable when the application starts.
  - To build a `KStream&lt;K, V&gt;`: `streamsBuilder.stream(TOPIC, Consumed.with(keySerde, valueSerde))`
  - To build a `KTable&lt;K, V&gt;`: `kStream.toTable(Named, Materialized)` or `streamsBuilder.table(TOPIC, Consumed.with(keySerde, valueSerde))` or `streamBuilder.table(TOPIC, Consumed.with(keySerde, valueSerde), Materialized.as(String))`. Without the `Materialized` argument, the KTable won't be materialized and its updates won't be persisted in a state store (so its state will be gone when the app restarts). Without the `Materialized` argerment, when we use `kTable.toStream(): KStream`, messages in KTable go to KStream immediately when they appear in the KTable (i.e. the KTable doesn't have the chance to delete the old messages); with `Materialized`, messages in KTable go to KStream only when there are `cache.max.bytes.buffering` bytes in the messages or after `commit.interval.ms` milliseconds.
  - To build a `GlobalKTable&lt;K, V&gt;`: the only way is to build from a topic `streamsBuilder.globalTable(TOPIC, Consumed)`
  - Joins:
      - KStream - (Global)KTable: `join`, `leftJoin` which means the join will be triggered when there's a new message in the left stream/table; if the right stream/table doesn't have a match key, the value joiner will receive a null for the right stream/table value.
      - KTable - KTable: join, leftJoin, `outerJoin`. There's no join between GlobalKTable and GlobalKTable: why? `outerJoin` will trigger the join if there's a message on either side of the join.
      - KStream - KStream: join, leftJoin, outerJoin. We have to specify a `JoinWindows` which specifies the maximum amount of time difference the 2 messages (with the same key of course) appear in the streams. There's a concept of JoinWindows.ofTimeDifferenceWith(No)Grace`.

Concurrency‚à®
  - interface `Executor.execute(Runnable): void`
  - interface `ExecutorService extends Executor`:
      - `ExecutorService.submit(Runnable): Future&lt;?>`
      - `ExecutorService.submit(Runnable, T result): Future&lt;T>`
      - `ExecutorService.submit(Callable&lt;T>): Future&lt;T>`
      - `ExecutorService.invokeAny(Collection&lt;Callable&lt;T>>, optional timeout): T`
      - `ExecutorService.invokeAll(Collection&lt;Callable&lt;T>>, optional timeout): List&lt;Future&lt;T>>`
  - interface `ScheduledExecutorService extends ExecutorService` has `schedule(Runnable | Callable, delay): ScheduledFuture`, `scheduleAtFixedRate(Runnable, initialDelay, period): ScheduledFuture&lt;?>` and `scheduleAtFixedDelay(Runnable, initialDelay, delay): ScheduledFuture&lt;?>`.
  - To get the task results in order of completion, use `var completionService = new ExecutorCompletionService&lt;R>(executorService)` then submit a job `completionService.submit(runnable/callable): Future&lt;R>` then get the next completed task result `completionService.poll/take: Future&lt;R>`
  - `ConcurrentHashMap`: `compute/computeIfAbsent/computeIfPresent` are atomic, to create a *ConcurrentHashSet*: `.newKeySet`, reduce: `reduce/reduceEntries[ToInt/Long/Double]/reduceKeys[ToInt/Long/Double]/reduceValues[ToInt/Long/Double](parallelThreshold, (k, v) -> r, (r, r) -> r): R`, parallel search: `search[Entries/Keys/Values](parallelThreshold, (k, v) -> r)`
  - Lock:
      - Issues with `synchronized`: locks must be released in the reverse order of lock acquisitions `synchronized (a) { synchronized (b) { ... } }`
      - `interface Lock`: wait forever to get the lock: `.lock()` - try to get the lock: `.tryLock(timeout): boolean` - finally must `.unlock()`. Implementation is `ReentrantLock`.
      - `interface ReadWriteLock`: used when there are much more reads than writes. `.writeLock(): Lock` returns the lock for writing - `.readLock(): Lock`: multiple reads at the same time, but while reading, no writing and while writing no reading. Implementation is `ReentrantReadWriteLock`.

Spring Data Redis‚à®
  - If we have `spring.data.redis.host/port/password/database` then a `redisConnectionFactory` bean is created for us. Otherwise, create that bean like this:
```
var redisStandaloneConfiguration = new RedisStandaloneConfiguration(host, port);
redisStandaloneConfiguration.setPassword(redisPassword);
var redisConnectionFactory = new LettuceConnectionFactory(redisStandaloneConfiguration);
redisConnectionFactory.afterPropertiesSet(); // this is very important
```
  - Then, create a `RedisTemplate&lt;..., ...>` like:
```
var redisTemplate = new RedisTemplate&lt;String, Object>();
redisTemplate.setConnectionFactory(redisConnectionFactory);
redisTemplate.setKeySerializer(new GenericJackson2JsonRedisSerializer()); // Jackson is faster than the Java serialization
redisTemplate.setHashKeySerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.afterPropertiesSet(); // this is very important
```
  - Need to test: for every type `T`, we need a Spring bean of type `RedisTemplate&lt;String, T>` otherwise, how do we read an object of type `T` from redis?

JPA‚à®
  - Collection mapping (this is [what the DB tables look like](https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-01.jpg)):
```
public &#64;Embeddable class VacationEntry &#123;                          public &#64;Entity class Employee {
  private &#64;Temporal(TemporalType.DATE) Calendar startDate;          private &#64;Id int id;
  private &#64;Column(name = "DAYS") int daysTaken;                     private long salary;
}                                                                   private &#64;ElementCollection(targetClass = VacationEntry.class) Collection vacations;
                                                                    private &#64;ElementCollection Set&lt;String> nickNames;
```
  - Transaction:
      - Propagation
          - in Spring, the default is `&#64;Transactional(propagation = Propagation.REQUIRED)` which means that a current transaction is supported and a new one is created if none exists
          - `SUPPORTS` means the current transaction is supported but will execute non-transactionally if none exists
          - `MANDATORY` supports a current transaction, throws an exception if none exists
          - `REQUIRES_NEW` creates a new transaction and suspends the current transaction
          - `NOT_SUPPORTED` executes non-transactionally, suspends the current transaction
          - `NEVER` executes non-transactionally, throws an exception if a transaction exists
          - `NESTED` executes within a nested transaction if a transaction exists
      - Isolation: describes how changes in concurrent transactions are visible to each other
          - `&#64;Transactional(isolation = Isolation.DEFAULT)`: use the default isolation level of the DB, e.g. Postgres has Read Committed as default
          - `READ_UNCOMMITTED`: dirty reads *(a transaction reads data written by a concurrent uncommitted transaction)*, non-repeatable reads *(a transaction re-reads data it has previously read and finds that data has been modified by another transaction, i.e. commited after the 1st read)* and phantom reads *(a transaction re-executes a query returning a set of rows that satisfy a search condition and finds that the set of rows has changed due to another recently-committed transaction)* can occur
          - `READ_COMMITTED`: dirty reads are prevented but non-repeatable and phantom reads can occur
          - `REPEATABLE_READ`: dirty and non-repeatable reads are prevented but phantom reads can occur
          - `SERIALIZABLE`: dirty, non-repeatable and phantom reads are prevented
  - Inheritance:
      - Class hierarchies:
          - `&#64;Entity abstract class Employee(id: int, name: String, startDate: Date)`
          - `&#64;Entity class ContractEmployee(dailyRate: int) extends Employee(id, name, startDate)`
          - `&#64;Entity abstract class CompanyEmployee(vacation: int) extends Employee(id, name, startDate) // &#64;Entity can be used with abstract class too`
          - `&#64;Entity class PartTimeEmployee(hourlyRate: int) extends CompanyEmployee(vacation)`
          - `&#64;Entity class FullTimeEmployee(salary: int) extends CompanyEmployee(vacation)`
      - `&#64;MappedSuperclass`: denotes a class that stores shared state but is not a persistent class (i.e. no `&#64;Table` on it, no query over it). In the above example, we can put `&#64;MappedSuperclass` on `CompanyEmployee` but then we won't be able to find all company employees in 1 shot.
      - Single-table strategy: the most common and performant way. Then we need a discriminator column and discriminator values.
          - `&#64;Entity &#64;Table &#64;DiscriminatorColumn(name = "...") abstract class Employee`
          - `&#64;Entity &#64;DiscriminatorValue("...") class FullTimeEmployee`
      - Joined strategy:
      - Table-per-concrete-class strategy:
  - 2 ways to fix the N+1 issue: put `@Query("SELECT p FROM ChessPlayer p LEFT JOIN FETCH p.tournaments")` or `@EntityGraph(attributePaths = "tournaments")` on a method in the Spring Data JPA Repository
  - Use PESSIMISTIC_WRITE to implement a distributed lock (HazelCast provides an implementation of distributed lock), like this:
```
interface XXXRepository extends JpaRepository(XXX, ...) {
  @Lock(LockModeType.PESSIMISTIC_WRITE)
  @QueryHints({ // exception is thrown if unable to get the lock, works for Oracle only, not Postgres
      @QueryHint(name = "jakarta.persistence.lock.timeout", value = "1000")
  })
  List&lt;XXX&gt; findBy...(...);
}
// if we want to use the lock timeout feature in not-Oracle db, we need to use EntityManager
// However, https://jakarta.ee/learn/docs/jakartaee-tutorial/current/persist/persistence-locking/persistence-locking.html
//   says it's not guaranteed
em.createNativeQuery("SET lock_timeout = '5'").executeUpdate(); // this is postgres syntax
em.createQuery("select l from HerLock l where l.id = :id", HerLock.class)
    .setParameter("id", id)
    .setHint("jakarta.persistence.lock.timeout", 999)
    .setLockMode(LockModeType.PESSIMISTIC_WRITE)
    .getResultList()
```

Composition vs Inheritance‚à®
  - class inheritance issue:
```
class Animal { void walk() { ... } }
class FlyingAnimal extends Animal { void fly() { ... } }
class SwimmingAnimal extends Animal { void swim() { ... } } // now, how to define an animal that can fly and swim?
```
  - ~~object composition~~: this is not object composition:
```
interface Animal { default void walk() { ... } }
interface FlyingAnimal extends Animal { default void fly() { ... } }
interface SwimmingAnimal extends Animal { default void swim() { ... } }
class Duck implements FlyingAnimal, SwimmingAnimal { } // we can do this because we can implement multiple interfaces
```
  - object composition:
```
class WalkingAbility { ... }
class FlyingAbility { ... }
class SwimmingAbility { ... }
class Animal {
  private WalkingAbility wa;
  private FlyingAbility fa;
  private SwimmingAbility sa;
  public static Animal createDog(WalkingAbility _wa, SwimmingAbility _sa) { ... }
  public static Animal createDuck(WalkingAbility _wa, SwimmingAbility _sa, FlyingAbility _fa) { ... }
}
```

Spring Boot 3 and OpenAPI; Always use `wiremock-standalone` to avoid jetty version conflict‚à®
  - `org.springdoc:springdoc-openapi-starter-webmvc-ui` then on a Controller method for an endpoint, we can have `@Operation`, `@ApiResponse`. On an input/output class, we can have `@Schema`. We can create a bean of type `OpenAPI` to security schemes to endpoints (e.g. `authorization: bearer ...`), a bean of type `OpenApiCustomizer` to add some examples that can be seen in `/swagger-ui/index.html`.

Testcontainers‚à®
  - [No need to start and stop the container](https://java.testcontainers.org/test_framework_integration/manual_lifecycle_control/) in every test: test classes need to `extends` an abstract class with a static variable for the container and a static block to start that container. No need to stop the container as Ryuk will do it.
  - If a specific container doesn't work, a generic container is good enough:
```
genericContainer = new GenericContainer<>(DockerImageName.parse("docker.elastic.co/elasticsearch/elasticsearch:7.10.2"))
    .withExposedPort(9200, 9300) // look for these info in docker-compose.yml
    .withEnv("...", "...")
    .waitingFor(
        new LogMessageWaitStrategy() // we can get the LogMessageWaitStrategy source code and modify it to print the logging messages
            .withRegEx("...")
            .withTimes(1)        // the docker container is said to start completely when we see a logging message matching the above regex this many times
            .withStartupTimeout(Duration.ofMinutes(2)));
```
</div>
<div class="tab" title="Scala">
This is Scala
</div>
<div class="tab" title="Kotlin">
This is Kotlin
</div>
<div class="tab" title="Rust" fontawesome="fa-brands fa-rust">
`rustup doc`: to read The Book and the standard library reference.

100 exercises to learn Rust [https://rust-exercises.com/](https://rust-exercises.com/), resources to [learn](https://github.com/ImplFerris/LearnRust) Rust

Another [place](https://github.com/dcodesdev/rustfinity.com) to do Rust exercises

[Rust Atomics and Locks](https://marabos.nl/atomics/) Jan 2023

[How to build a tree in Rust](https://dev.to/deciduously/no-more-tears-no-more-knots-arena-allocated-trees-in-rust-44k6)

[Good blogs](https://www.shuttle.rs/blog/tags/all) - [Free public APIs for testing](https://apipheny.io/free-api/) - `rustup doc` - [Practical Rust 1.x Cookbook](https://www.amazon.com/Practical-Rust-1-x-Cookbook-Microservices-ebook/dp/B0BW47FLQ9/) Feb 2023 - [Rust Standard Library Cookbook](https://www.amazon.com/Rust-Standard-Library-Cookbook-leverage-ebook/dp/B07B8RJ8VJ/) Mar 2018 - [All the books](https://1337x.to/torrent/5828661/Rust-Programming-Language-Book-Pack-3-46-titles/)

A [sample](https://github.com/rust-lang/rustlings) project structure. Or [setup Rust for AoC](https://www.youtube.com/watch?v=fEQv-cqzbPg)

[This person](https://medium.com/@omprakashsridharan) wrote blogs about server-side Rust in 2022 - 2023.

[Rust blogs in AWS 2024](https://www.shuttle.rs/blog/tags/all)

[Rust with Flutter/Dart](https://cjycode.com/posts/rust-ui-flutter/) with many good appraisals on [HN](https://news.ycombinator.com/item?id=41213711)
</div>
<div class="tab" title="Python" fontawesome="fa-brands fa-python">
Start an http server in the current directory at a specific port: `python -m http.server 8000`
</div>
<div class="tab" title="Gradle">
[Using maven BOM](https://docs.gradle.org/current/userguide/platforms.html#sub:bom_import) in `gradle.build`

All the versions (including release candidates) are [here](https://services.gradle.org/distributions/); system properties in [gradle.properties](https://docs.gradle.org/current/userguide/build_environment.html) e.g. to run gradle and compile the app with different jdks

To exclude a library globally:
```
configurations {
  all*.exclude group: 'ch.qos.reload4j', module: 'reload4j'
  all*.exclude group: 'org.slf4j', module: 'slf4j-reload4j'
}
```

To specify program arguments when running a gradle task: `gradlew bootRun --args='--spring.profiles.active=my-profile'`

To specify the JVM options for Gradle to use: `$env:GRADLE_OPTS="-Dhttps.protocols=TLSv1.2 -Djdk.tls.client.protocols=TLSv.12 -Djavax.net.ssl.trustStore=file.jsk -Djavax.net.ssl.trustStorePassword=..."` or put it in `gradle.properties` under the name `org.gradle.jvmargs`
</div>
<div class="tab" title="Git" fontawesome="fa-brands fa-git">
Delete local branch: `git branch -d *local_branch_name*`

Delete remote branch: `git push origin --delete *remote_branch_name*`

Update the local list of remote branches: `git remote update origin --prune`

Merge from another branch: `git pull && git merge --squash origin/master`     If conflict: `git merge --abort`

Make git ignore SSL verification: `export GIT_SSL_NO_VERIFY=true`

Overwrite the current local branch with the remote master: `git fetch --all && git reset --hard origin/master`

Make a file executable (so that when it is checked out, it's executable):
```
git add file.sh && git ls-files --stage // that file will have 100644
git update-index --chmod=+x file.sh && git ls-files --stage // that file will have 100755
git commit -m "..." && git push
```

Show info about a commit id (e.g. date, ...): `git show *commit-id*`

Automatically create a remote branch for the current local branch: `git config --global push.autoSetupRemote true`

Use proxy: `git config --global http.proxy http://1.2.3.4:8080` (this works for both http and https repositories). To not use proxy: `git config --global --unset http.proxy`

Use a non-default private key with git (recent versions only): `$env:GIT_SSH_COMMAND='ssh -i non-default-private-key -o IdentitiesOnly=yes'`
</div>
<div class="tab" title="VS Code">
| Windows                                               |                           | Mac                                                     |
|------------------------------------------------------:|:-------------------------:|:--------------------------------------------------------|
|<kbd>Alt</kbd>+ click                                  | multiple cursor           |<kbd>option</kbd>+ click                                 |
|<kbd>‚áß</kbd>+<kbd>Alt</kbd>+<kbd>&#8593;/&#8595;</kbd> | copy line up/down         |<kbd>‚áß</kbd>+<kbd>option</kbd>+<kbd>&#8593;/&#8595;</kbd>|
|<kbd>Alt</kbd>+<kbd>&#8593;/&#8595;</kbd>              | move line up/down         |<kbd>option</kbd>+<kbd>&#8593;/&#8595;</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>K</kbd>              | delete line               |<kbd>‚áß</kbd>+<kbd>command</kbd>+<kbd>K</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>\</kbd>              | jump to mactching bracket |<kbd>‚áß</kbd>+<kbd>command</kbd>+<kbd>\</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>[</kbd>              | fold region               |<kbd>option</kbd>+<kbd>command</kbd>+<kbd>[</kbd>        |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>]</kbd>              | unfold region             |<kbd>option</kbd>+<kbd>command</kbd>+<kbd>]</kbd>        |
</div>
<div class="tab" title="PowerShell - Windows" fontawesome="fa-brands fa-windows">
[Upgrade Windows 11 Home to Pro](https://www.youtube.com/watch?v=2FHn2GzIZrc): disconnect Internet, `Settings` | `System` | `Activation` | `Change Product Key`, use this generic key `VK7JG-NPHTM-C97JM-9MPGT-3V66T`. Finally run [this](https://github.com/massgravel/Microsoft-Activation-Scripts) in powershell `irm https://get.activated.win/get | iex`

[Traffic Monitor](https://github.com/zhongyang219/TrafficMonitor) can show network speed (in/out), cpu, memory usage in the task bar.

[komorebi](https://github.com/LGUG2Z/komorebi): a tiling window manager for Windows written in Rust

[Marp](https://marp.app/), like reveal.js, allows us to make slides from markdown

Install a `.msi` file: in cmd `msiexec.exe /i *file.msi* INSTALLDIR=%USERPROFILE%\*some-directory* MSIINSTALLPERUSER=1`

VcXsrv (this version [doesn't need admin to install](https://github.com/marchaesen/vcxsrv)): don't forget to `export LIBGL_ALWAYS_INDIRECT=1` in Linux and `DISPLAY=localhost:0` in Windows

Install python, pip in Windows: unzip the python, install pip with `python get-pip.py` here is [get-pip.py](https://bootstrap.pypa.io/get-pip.py), then modify the file `python312._pth` like this:
```
python312.zip
.
Lib\site-packages
```

| Windows Terminal | ...                                                                        | ...
|------------------|----------------------------------------------------------------------------|------------------------------------------
|                  | <kbd>Alt</kbd>+<kbd>Shft</kbd>+<kbd>-/+</kbd>                              | create a new pane vertically/horizontally
|                  | <kbd>Ctrl</kbd>+<kbd>Shft</kbd>+<kbd>W</kbd>                               | close
|                  | <kbd>Alt</kbd>+<kbd>&#x2190;&#x2191;&#x2193;&#x2192;</kbd>                 | move around
|                  | <kbd>Alt</kbd>+<kbd>Shft</kbd>+<kbd>&#x2190;&#x2191;&#x2193;&#x2192;</kbd> | resize
|                  | The cursor doesn't blink                                                   | try this `printf "\e[?12h"`

PowerShell‚à®
  - Allow scripts to run in PowerShell: `Set-ExecutionPolicy Bypass -Scope Process`
  - Change window title: `$host.ui.RawUI.WindowTitle="*New Title*"`
  - Set an environment variable: `$env:PATH += "..."` or `$env:PATH = "...;$env:PATH"` for example `$env:HTTPS_PROXY=$env:HTTP_PROXY='http://1.2.3.4:8080'`. To show all env vars: `dir env:`
  - Run a PowerShell script in background: `start-job -filepath *path\to\file.ps1*`
  - Download with wget: `Invoke-WebRequest -Uri $*uri* -OutFile $*dest*`
  - To run an app with Avecto: `PowerShell Start 'D:\Users\DangTh\PowerShell\pwsh.exe' -Verb Runas`
  - Add something to MS Defender exclusion list: `Add-MpPreference -ExclusionPath 'C:\temp'`, `Add-MpPreference -ExclusionExtension '.java'`. To see those exclusions: Settings | Virus & thread protection (Manage settings) | Exclusions (Add or remove exclusions)
  - `.bashrc` for PowerShell is at `$PROFILE` (echo it to see its value):
```
function To-Parent-Directory { Set-Location ... }
Set-Alias .. To-Parent-Directory

function To-Grandparent-Directory { Set-Location ../.. }
Set-Alias ... To-Grandparent-Directory

$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"

function prompt { // this function make the Windows Terminal tab titles shorter
  $Host.UI.RawUI.WindowTitle = "$pwd"
  (Get-Location).toString() -replace 'C:\\Users\\bo','~'
}

oh-my-posh init pwsh --config "C:\path\to\oh-my-posh.json" | Invoke-Expression

```

Uninstall some apps from cmd (run cmd as Admin) or PowerShell‚à®
  - `wmic // the prompt turns into wmic:root\cli>`
  - `product get name // get all un-installable program names`
  - `product where name="*program name*" call uninstall`
  - `Get-ProvisionedAppxPackage -Online | Where-Object { $_.PackageName -match "xbox" } | ForEach-Object { Remove-ProvisionedAppxPackage -Online -AllUsers -PackageName $_.PackageName }`

Firefox‚à®
  - [Firefox zip format](https://ftp.mozilla.org/pub/firefox/candidates/) https://ftp.mozilla.org/pub/firefox/candidates/
  - Delete the Firefox under Mozilla in registry (this has corporate-set keys to forbid Firefox extension installation): `reg delete HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Mozilla\Firefox /f`
  - [Delete 1 property](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/remove-itemproperty) in the registry: `Remove-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Mozilla\Firefox" -Name "ExtensionSettings" -Force`
  - Clean up Firefox: `rm -rf AppData/Local/Mozilla AppData/Roaming/Mozilla`
  - Show all profiles: `about:profiles` - Start with a profile: `firefox -P my-profile`
</div>
<div class="tab" title="Jenkins">
To list files: `http https://artifacts.devops.bfsaws.net/artifactory/GPTM-TEST-DEV/DF-Query/ X-JFrog-Art-Api:xxx | grep -e "-2022 " -e "-Jan-2023 " | sed 's/^.*DFQueryService/abc DFQueryService/g' | sed 's/^.*//g'`

To delete: `http DELETE https://artifacts.devops.bfsaws.net/artifactory/GPTM-TEST-DEV/DF-Query/*file.ext* X-JFrog-Art-Api:xxx` __Note__: this can be done with a folder too

Search in Jira: `project = gptmcr and assignee in (..., ...) order by key desc, assignee asc`

Declarative pipeline:
```
pipeline {
  agent { label 'aws_set2_node1 || aws_set1_node1 || aws_set1_node2' }
  options {
    timeout(time: 100, unit: 'SECONDS')
  }
  environment {
    SA_GPTM_CI = credentials('sa-gptm-ci')
  }
  stages {
    stage('...') {
      steps {
        sh '''
          echo "" >> ~/.ssh/authorized_keys.jenkins
          echo "ssh-ed25519 ..." >> ~/.ssh/authorized_keys.jenkins
        '''
      }
    }
  }
  post {
    always{
      cleanWs()
    }
  }
}
```
</div>
<div class="tab" title="Terraform">
DevOps: to make software delivery better - Terraform: Infrastructure as Code to define, deploy, update and destroy the infrastructure

Versions: 1.1.x (Dec 21 - Apr 22). Now 1.6.x

Key principals of IaC: __idempotent__ (no matter of the starting state or how many times the code is run, the final state is the same), __immutable__ (steps are repeatable)

Terraform architecture has 4 components:
  - Providers: to work with different cloud providers
  - Modules: directories of terraform files. Used to organize files, to reuse, encapsulate
  - Resources: like VPC, EC2 instances, S3, lambda ...
  - Templates: a collection of files that describe the desired state of our infrastructure

Terraform workflow:
  - Write: use HashiCorp Configuration Language (HCL)
  - Init: `terraform init` download providers
  - Plan: `terraform plan` shows what resources will be created, updated or deleted.
  - Apply: `terraform apply`.
  - Destroy: `terraform destroy` destroy resources
</div>
<div class="tab" title="B√°nh Flan Caramel" fontawesome="fa-solid fa-cake-candles">
[9 eggs, 1 cup of sugar, 320 ml of milk (not non-fat), vanilla powder](https://www.youtube.com/watch?v=F4WSf2YCstA) 1 cup = 125ml

In a non-stick pan: .5 cup of sugar, 1 spoon of water (just enough to make the sugar wet), cook medium heat until the sugar turns into caramel, quickly remove it.

.5 cup of sugar + 2.5 cups of milk, cook until it's hot but not boiling.

Whisk 9 eggs in a bowl. Pour the hot/warm milk into it while whisking. Put a bit vanilla there. Pour it out through a strainer. Remove all the bubbles. Cool it down for 10 mins.

Preheat the oven to 350oF, pour the boiling water in a large pan, bake for 45 mins.
</div>
<div class="tab" title="Finance Knowledge" fontawesome="fa-solid fa-piggy-bank">
[Underlying asset](https://www.investopedia.com/terms/u/underlying-asset.asp) are the financial assets upon which a derivative's price is based.

[Derivative](https://www.investopedia.com/terms/d/derivative.asp): a financial contract with a price that depends on underlying asset or group of assets. A derivative is set between 2 or more parties that can trade on an exchange. For example: options

[Option](https://www.investopedia.com/terms/o/option.asp): a financial instrument that is based on the value of underlying securities such as stocks, indexes and ETFs (exchange traded funds)

[Investment securities](https://www.investopedia.com/terms/i/investment-securities.asp): a category of securities. They are tradable assets such as equities or fixed income instruments. They are purchased with the intention of holding them for investment.

[Equity](https://www.investopedia.com/terms/e/equity.asp): the amount of money that would be returned to a shareholder if all the assets are liquidated and all the debts are paid off.

[Fixed income](https://www.investopedia.com/terms/f/fixedincome.asp): a type of assets and securities that pay investors a fixed interest or dividends. For example: government and corporate bonds.

[Capital Markets](https://www.investopedia.com/terms/c/capitalmarkets.asp): where savings and investments are channeled between suppliers (e.g. banks, investors) and those in need (e.g. businesses, governments). The most common capital markets are the stock market and the bond market.
</div>
<script>
  /*
   * s is a line in <code>...</code>
   * `&amp;amp;` will be replaced with `&amp;`
   * the `// till the end of the line` will be put in a <i class="comment">// till the end of the line</i>
   * the `*something here*` will be put in `<i>something here</i>`
   * Return the new line.
   */
  function fixAmpersandAndMakeComment(s) {
    let startPosition = 0;
    while (true) { // TODO needs unit tests
      s = s.replaceAll('&amp;amp;', '&amp;');
      let i = s.indexOf('*', startPosition);
      if (i < 0) break;

      if (s.substring(i + 1, i + 2) !== ' ' && s.substring(i + 1, i + 2) != '.' && s.substring(i - 1, i) != '.') {
        let j = s.indexOf('*', i + 1);
        if (j > i && s.substring(j - 1, j) !== ' ') {
          s = s.substring(0, i) + `<i>${s.substring(i + 1, j)}</i>` + s.substring(j + 1);
          startPosition = j + 1;
        } else {
          startPosition = i + 1;
        }
      } else  {
        startPosition = i + 1;
      }
    }

    let i = s.indexOf('// ');
    if (i >= 0) {
      return s.substring(0, i) + `<i class="comment">${s.substring(i)}</i>`;
    }

    return s;
  }

  /*
   * If `<...>` is used in <code>, the browser thinks that it's a tag. So we have to write `&lt;...>`.
   * But then, showdown converts them to `&amp;lt;` and `&amp;gt;`.
   * This method replaces `&amp;lt;` with `&lt;` and `&amp;gt;` with `&gt;`.
   */
  function fixLessGreaterThan(s) {
    return s.replaceAll('&amp;lt;', '&lt;').replaceAll('&amp;gt;', '&gt;');
  }

  const converter = new showdown.Converter({tables: true, literalMidWordUnderscores: true, strikethrough: true});
  let i = 1; // used to create the id for each accordion item

  const allAccordionItemHtmls = Array.from(document.querySelectorAll('div.tab'))
    .map(div => {
      const accordionItem = `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
            <i class="${div.getAttribute('fontawesome')}"></i>${div.getAttribute('title')}
          </button>
        </h2>
        <div id="collapse${i}" class="accordion-collapse collapse">
          <div class="accordion-body">${converter.makeHtml(div.innerHTML)}</div>
        </div>
      </div>
      `;
      div.parentElement.removeChild(div);
      i += 1;
      return accordionItem;
    })
    .join('\n');
  document.body.insertAdjacentHTML('afterbegin', `<div class="accordion accordion-flush" id="myAccordionNotes">${allAccordionItemHtmls}</div>`);

  // add <i> inside <code></code>
  document.querySelectorAll('code').forEach(code => {
    const newInnerHtml = code.innerHTML.split('\n')
      .map(line => fixAmpersandAndMakeComment(line))
      .map(line => fixLessGreaterThan(line))
      .join('\n');
    code.innerHTML = newInnerHtml;
  });

  // move <pre> inside the above <li> if <li> ends with `:`
  Array.from(document.querySelectorAll('li:last-child'))
    .filter(li => li.innerText.endsWith(':'))
    .forEach(li => {
      const ul = li.parentElement;
      const pre = ul.nextElementSibling;
      if (pre != null && pre.nodeName == 'PRE') {
        pre.style.marginTop = '.2em';
        li.innerHTML += pre.outerHTML;
        pre.parentElement.removeChild(pre);
      }
    });

  // if <p> is followed by an <ul> which is followed by another <ul>, merge these <ul> together
  document.querySelectorAll('p + ul + ul')
    .forEach(ul => {
      const firstUl = ul.previousElementSibling;
      while (ul) {
        let nextUl = ul.nextElementSibling;
        firstUl.insertAdjacentHTML('beforeend', ul.innerHTML);
        ul.parentElement.removeChild(ul);
        if (nextUl && nextUl.localName != 'ul') nextUl = null;
        ul = nextUl;
      }
    });

  // make <p> ending with a `‚à®` and followed by <ul> an accordion
/* TODO this function is not used?
  function removePTag(markdown) { // calls converter.makeHtml which returns <p>...</p> then removes <p> and fixes the < or >
    console.log('markdown', markdown);
    return converter.makeHtml(markdown).replace('<p>', '').replace('</p>', '').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
  }
*/
  Array.from(document.querySelectorAll('p + ul'))
    .filter(ul => ul.previousElementSibling.innerText.endsWith('‚à®'))
    .forEach(ul => {
      const p = ul.previousElementSibling;
      p.insertAdjacentHTML('beforebegin', `
        <div class="accordion accordion-flush">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
                ${p.innerHTML.substring(0, p.innerHTML.length - 1)}
              </button>
            </h2>
            <div id="collapse${i}" class="accordion-collapse collapse">${ul.outerHTML}</div>
          </div>
        </div>
      `);
      p.parentElement.removeChild(p);
      ul.parentElement.removeChild(ul);
      i += 1;
    });

  // make <p> ending with a `‚à®` and followed by a <table> which is followed by an <ul> an accordion
    Array.from(document.querySelectorAll('p + table + ul'))
      .filter(ul => ul.previousElementSibling.previousElementSibling.innerText.endsWith('‚à®'))
      .forEach(ul => {
        const table = ul.previousElementSibling;
        const p = table.previousElementSibling;
        p.insertAdjacentHTML('beforebegin', `
          <div class="accordion accordion-flush">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
                  ${p.innerHTML.substring(0, p.innerHTML.length - 1)}
                </button>
              </h2>
              <div id="collapse${i}" class="accordion-collapse collapse">
                ${table.outerHTML}
                ${ul.outerHTML}
              </div>
            </div>
          </div>
        `);
        p.parentElement.removeChild(p);
        table.parentElement.removeChild(table);
        ul.parentElement.removeChild(ul);
        i += 1;
      });

  // if <p> endings with `:` and followed by <ul> or <pre>, make them close to each other
  Array.from(document.querySelectorAll('p + ul, p + pre'))
    .filter(ulORpre => ulORpre.previousElementSibling.innerText.endsWith(':'))
    .forEach(ulORpre => ulORpre.previousElementSibling.style.marginBottom = '.2rem');

  // add bootstrap `table` class to all <table>
  document.querySelectorAll('table').forEach(table => table.classList.add('table'));

  // this is used to increase the font size of kbd in vim motions
  document.querySelectorAll('th').forEach(th => {
    if (th.innerText === 'vim motions') {
      th.parentElement.parentElement.parentElement.classList.add('vim-motions');
    }
  });
</script>
<div class="accordion accordion-flush">
  <style>
    .pro-jpa-2 { margin: .5rem }
    .pro-jpa-2 a { text-decoration: none }
    .pro-jpa-2 p.ChapterNumber, .pro-jpa-2 p.ChapterTitle { font: 1.6rem "Noto Sans", sans-serif }
    .pro-jpa-2 span.FontName2 { font-family: "Fira Code", monospace }
    .pro-jpa-2 p.Heading1 { font: 1.4rem sans-serif; color: #13c69d }
    .pro-jpa-2 pre { background: linear-gradient(90deg, #eef2f6, #fff, #eef2f6); padding: .5rem 1rem }
    .pro-jpa-2 p.Heading2 { font: 1.2rem sans-serif; color: #9f1ad8 }
    .pro-jpa-2 p.Heading3 { font: 1rem sans-serif; color: #f62 }
    .pro-jpa-2 div.notepara { margin-left: 4rem; border-left: .3rem solid #5cd81a; padding-left: 1rem }
    .pro-jpa-2 td { vertical-align: top; padding-left: 1rem }
  </style>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#jpa-collection-mapping" aria-expanded="false" aria-controls="jpa-collection-mapping">
        JPA - Collection Mapping (from the book Pro JPA 2, 2nd Edition)
      </button>
    </h2>
    <div id="jpa-collection-mapping" class="accordion-collapse collapse pro-jpa-2">
      <p class="ChapterNumber"><a id="Chap_5" target="_blank" rel="noopener noreferrer"></a>CHAPTER 5</p>
      <p class="chapimage"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/frontdot.jpg" alt="image" width="82" height="25"></p>
      <p class="ChapterTitle">Collection Mapping</p>
      <div>
        <p class="noindent">Sometimes a <span class="FontName2">Collection</span> is used like a milk crate: it's just a simple container with no apparent order or intended organization. Other cases demand some kind of system of order and arranging so the way objects are retrieved from the collection has meaning. Whether the collection is of the first type or the second, collections of objects require more effort to map than single objects, although in compensation they offer greater flexibility.</p>
        <p class="indent">In the last chapter, we began the journey of mapping collection-valued relationships, spooning out only the basics of mapping collections of entities to the database. This chapter goes into more detail about how we can map more sophisticated collection types, such as persistently ordered <span class="FontName2">Lists</span><a id="cXXX.231a" target="_blank" rel="noopener noreferrer"></a>, and <span class="FontName2">Maps</span> with keys and values that are of various object types. We will even explore how to map collections of objects that are not entities.</p>
        <p id="Sec1" class="Heading1">Relationships and Element Collections<a id="cXXX.227a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">When we speak of mapping collections, there are actually three kinds of objects that we can store in mapped collections. We can map collections of entities, embeddables, or basic types, and each one requires a certain level of understanding to be correctly mapped and efficiently used.</p>
        <p class="indent">We should clarify one potential point of confusion about these types of objects when they are stored in collections. In the previous chapter, we introduced the concept of relationships from one entity type to another, and you learned that when the source entity has a collection containing instances of the target entity type it is called a multivalued relationship. However, collections of embeddable and basic types are not relationships; they are simply collections of elements that are thus called element collections. Relationships define associations between independent entities, whereas element collections contain objects that are dependent upon the referencing entity, and can be retrieved only through the entity that contains them.</p>
        <p class="indent">A practical difference between relationships and element collections is the annotation that is used to denote them. A relationship minimally requires the relationship annotation, either <span class="FontName2">&#64;OneToMany</span> or <span class="FontName2">&#64;ManyToMany</span>, whereas an element collection is indicated by the <span class="FontName2">&#64;ElementCollection</span> annotation. Assuming the <span class="FontName2">VacationEntry</span> embeddable class in <a href="#list1" id="_list1" target="_blank" rel="noopener noreferrer">Listing 5-1</a>, <a href="#list2" id="_list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> shows an example of an element collection of embeddables in the <span class="FontName2">vacationBookings</span> attribute, as well as an element collection of basic types (<span class="FontName2">String</span>) in the <span class="FontName2">nickNames</span> attribute.</p>
        <table>
          <tr>
            <td>
              <p class="noindent2"><a href="#_list1" id="list1" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-1</i></b></a>.&nbsp;&nbsp;VacationEntry Embeddable<a id="cXXX.226" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class VacationEntry {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Calendar startDate;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DAYS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int daysTaken;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <p class="noindent2"><a href="#_list2" id="list2" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-2</i></b></a>.&nbsp;&nbsp;Element Collections of Embeddables and Basic Types<a id="cXXX.227" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=VacationEntry.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection vacationBookings;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Set&lt;String&gt; nickNames;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <div class="Figure" id="Fig1">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-01.jpg" alt="9781430249269_Fig05-01.jpg" width="502" height="285"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig1" target="_blank" rel="noopener noreferrer">Figure 5-1</a>. </span>EMPLOYEE entity table<a id="cXXX.238" target="_blank" rel="noopener noreferrer"></a> and mapped collection tables</p>
              </div>
            </td>
          </tr>
        </table>
        <p class="indent">You can see from <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> that, like the relationship annotations, the <span class="FontName2">&#64;ElementCollection</span> annotation includes a <span class="FontName2">targetClass</span> element that is used to specify the class if the <span class="FontName2">Collection</span> does not define the type of element contained in it. It also includes a <span class="FontName2">fetch</span> element to indicate whether the collection should be lazily loaded.</p>
        <p class="indent">A more interesting aspect of the mappings in <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> is the absence of any additional metadata. Recall that the elements that are being stored in the collections are not entities, so they do not have any mapped table. Embeddables are supposed to be stored in the same table as the entity that refers to them, but if there is a collection of embeddables, how would it be possible to store a multiplicity of like-mapped objects in a single row? Similarly for basic types, we could not map each nickname <span class="FontName2">String</span> to a column in the <span class="FontName2">EMPLOYEE</span> table and expect to store multiple strings in a single row. For this reason, element collections require a separate table called a collection table. Every collection table must have a join column that refers to the containing entity table. Additional columns in the collection table are used to map the attributes of the embeddable element, or the basic element state if the element is of a basic type.</p>
        <p class="indent">We can specify a collection table using a <span class="FontName2">&#64;CollectionTable</span> annotation, which allows us to designate the name of the table, as well as the join column. Default values will apply if the annotation or specific elements within that annotation are not specified. The table name will default to the name of the referencing entity, appended with an underscore and the name of the entity attribute that contains the element collection. The join column default is similarly the name of the referencing entity, appended with an underscore and the name of the primary key column of the entity table. Because no collection tables were specified in either of the element collections in the <span class="FontName2">vacationBookings</span> and <span class="FontName2">nickNames</span> attributes of the <span class="FontName2">Employee</span> entity defined in <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a>, they are defaulted to use collection tables named <span class="FontName2">EMPLOYEE_VACATIONBOOKINGS</span> and <span class="FontName2">EMPLOYEE_NICKNAMES</span>, respectively. The join column in each of the collection tables will be <span class="FontName2">EMPLOYEE_ID</span>, which is just the name of the entity combined with the mapped <span class="FontName2">Employee</span> primary key column.</p>
        <p class="indent">We map the fields or properties of the embeddable type to the columns in the collection table instead of to the primary table of the entity, with the usual column name defaulting rules applying. When the element collection contains basic types, the values are also stored in a column in the collection table, with the default column name being the name of the entity attribute. Applying this rule, the nicknames would be stored in the <span class="FontName2">NICKNAMES</span> column. After all the defaults are applied, the mapped tables would look like those in <a href="#Fig1" id="_Fig1" target="_blank" rel="noopener noreferrer">Figure 5-1</a> above.</p>
        <p class="indent">When we first discussed embeddables, you saw how the attributes were mapped within the embeddable object but could be overridden when embedded inside other entities or embeddables. We used the <span class="FontName2">&#64;AttributeOverride</span> annotation to override the column names. The same annotation can also be used to override the embedded attributes in the elements of an element collection. In <a href="#list3" id="_list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a>, the <span class="FontName2">daysTaken</span> attribute is being remapped, using <span class="FontName2">&#64;AttributeOverride</span>, from being stored in the <span class="FontName2">DAYS</span> column to being stored in the <span class="FontName2">DAYS_ABS</span> column. One important difference between using <span class="FontName2">&#64;AttributeOverride</span> on simple embedded mappings and using it to override the columns of embeddables in an element collection is that in the latter case the column specified by <span class="FontName2">&#64;AttributeOverride</span> actually applies to the collection table, not to the entity table.</p>
        <table>
          <tr>
            <td>
              <p class="noindent2"><a href="#_list3" id="list3" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-3</i></b></a>.&nbsp;&nbsp;Overriding Collection Table Columns<a id="cXXX.229" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=VacationEntry.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="VACATION",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="daysTaken",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="DAYS_ABS"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection vacationBookings;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="NICKNAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Set&lt;String&gt; nickNames;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <p class="indent">In order to override the name of the column in which the nicknames are stored, we can use the <span class="FontName2">&#64;Column</span> annotation, remembering again that the name specifies a column in the collection table, not the entity table. <a href="#Fig2" id="_Fig2" target="_blank" rel="noopener noreferrer">Figure 5-2</a> shows the mapped tables, including the overridden <span class="FontName2">VACATION</span> collection table mapped by the <span class="FontName2">vacationBookings</span> collection.</p>
              <div class="Figure" id="Fig2">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-02.jpg" alt="9781430249269_Fig05-02.jpg" width="452" height="310"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig2" target="_blank" rel="noopener noreferrer">Figure 5-2</a>. </span>EMPLOYEE entity table and mapped collection tables with overrides</p>
              </div>
            </td>
          </tr>
        </table>
        <p id="Sec2" class="Heading1">Using Different Collection Types</p>
        <p class="noindent">We can use different types of collections to store multivalued entity associations and collections of objects. Depending upon the needs of the application, any of <span class="FontName2">Collection</span>, <span class="FontName2">Set</span>, <span class="FontName2">List</span>, and <span class="FontName2">Map</span> might be appropriate. There are rules corresponding to the type of collection, however, that guide its usage, so before using a given collection type, you should be familiar with the rules that govern how that type can be mapped and manipulated.</p>
        <p class="indent">The first step is to define the collection to be any one of the interface types mentioned previously. You then initialize the attribute with a concrete implementation class. This can be done in a constructor or initialization method of the entity class and allows you to put objects in the implementation collection of a new or unpersisted entity. Once the entity becomes managed or has been persisted by means of an <span class="FontName2">EntityManager.persist()</span> call, the interface must always be used when operating on the collection, whether it has been read in from the database or has been detached from the entity manager. This is because the moment the entity becomes managed, the persistence provider can replace the initial concrete instance with an alternate instance of a <span class="FontName2">Collection</span> implementation class of its own.</p>
        <div>
          <p id="Sec3" class="Heading2">Sets or Collections<a id="cXXX.230" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The most common collection type used in associations is the standard <span class="FontName2">Collection</span> superinterface. This is used when it doesn't matter which implementation is underneath and when the common <span class="FontName2">Collection</span> methods are all that is required to access the entities stored in it.</p>
          <p class="indent">A <span class="FontName2">Set</span> will prevent duplicate elements from being inserted and might be a simpler and more concise collection model, while a vanilla <span class="FontName2">Collection</span> interface is the most generic. Neither of these interfaces requires additional annotations beyond the original mapping annotation to further specify them. They are used the same way as if they held non-persistent objects. An example of using a <span class="FontName2">Set</span> interface for an element collection and a <span class="FontName2">Collection</span> for another is in <a href="#list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a>.</p>
        </div>
        <div>
          <p id="Sec4" class="Heading2">Lists</p>
          <p class="noindent">Another common collection type is the <span class="FontName2">List</span>. A <span class="FontName2">List</span> is typically used when the entities or elements are to be retrieved in some user-defined order. Because the notion of row order in the database is not commonly defined, the task of determining the ordering must lie with the application.</p>
          <p class="indent">There are two ways to determine the order of the <span class="FontName2">List</span>. The first is to map it so that it is ordered according to state that exists in each entity or element in the List. This is the easiest method and is less intrusive on the data model. The second involves maintaining the order of the <span class="FontName2">List</span> in an additional database column. It is more Java-friendly in that it supports the traditional ordering semantics of a Java <span class="FontName2">List</span>, but can be far less performant, as you will see in the following sections.</p>
          <div>
            <p id="Sec5" class="Heading3">Ordering By Entity or Element Attribute</p>
            <p class="noindent"><a id="cXXX.231" target="_blank" rel="noopener noreferrer"></a>The most prevalent approach to ordering entities or elements in a <span class="FontName2">List</span> is to specify an ordering rule based on the comparison of a particular attribute of the entity or element. If the <span class="FontName2">List</span> is a relationship, the attribute is most often the primary key of the target entity.</p>
            <p class="indent">We indicate the attribute to order by in the <span class="FontName2">&#64;OrderBy</span> annotation. The value of the annotation is a string that contains one or more comma-separated fields or properties of the object being ordered. Each of the attributes can be optionally followed by an <span class="FontName2">ASC</span> or <span class="FontName2">DESC</span> keyword to define whether the attribute should be ordered in ascending or descending order. If the direction is not specified, the property will be ordered in ascending order.</p>
            <p class="indent">If the <span class="FontName2">List</span> is a relationship and references entities, specifying <span class="FontName2">&#64;OrderBy</span> with no fields or properties, or not specifying it at all, will cause the <span class="FontName2">List</span> to be ordered by the primary keys of the entities in the <span class="FontName2">List</span>. In the case of an element collection of basic types, then the <span class="FontName2">List</span> will be ordered by the values of the elements. Element collections of embeddable types will result in the <span class="FontName2">List</span> being defaulted to be in some undefined order, typically in the order returned by the database in the absence of any <span class="FontName2">ORDER BY</span> clause.</p>
            <p class="indent">The example back in <a href="#list20" target="_blank" rel="noopener noreferrer">Listing 4-20</a> of the previous chapter had a one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span>. If we want the employees to be in a particular order, we can use a <span class="FontName2">List</span> instead of a <span class="FontName2">Collection</span>. By adding an <span class="FontName2">&#64;OrderBy</span> annotation on the mapping, we can indicate that we want the employees to be ordered in ascending alphabetical order by name. <a href="#list4" id="_list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a> shows the updated example.</p>
            <p class="noindent2"><a href="#_list4" id="list4" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-4</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a List</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OrderBy("name ASC")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">We needn't have included the <span class="FontName2">ASC</span> in the <span class="FontName2">&#64;OrderBy</span> annotations because it would be ascending by default, but it is good style to include it.</p>
            <p class="indent">We could have just as easily ordered the employee <span class="FontName2">List</span> by an embedded field of <span class="FontName2">Employee</span>. For example, if <span class="FontName2">name</span> had been embedded in an embedded <span class="FontName2">Employee</span> field called <span class="FontName2">info</span> that was of embeddable type <span class="FontName2">EmployeeInfo</span>, we would write the annotation as <span class="FontName2">&#64;OrderBy("info.name ASC")</span>.</p>
            <p class="indent">We might also want to have suborderings using multiple attributes. We can do that by specifying comma-separated &lt;attribute name <span class="FontName2">ASC</span>/<span class="FontName2">DESC</span>&gt; pairs in the annotation. For example, if <span class="FontName2">Employee</span> had a <span class="FontName2">status</span>, we might have ordered by status and then by name by using an <span class="FontName2">&#64;OrderBy</span> annotation of <span class="FontName2">&#64;OrderBy("status DESC, name ASC")</span>. Of course, the prerequisite for using an attribute in an <span class="FontName2">&#64;OrderBy</span> annotation is that the attribute type should be comparable, meaning that it supports comparison operators.</p>
            <p class="indent">If you were to simply switch the order of two employees in the <span class="FontName2">List</span>, it might appear that they were assuming new positions in the <span class="FontName2">List</span>. However, if in a new persistence context you read the department back in again and accessed its employees the <span class="FontName2">List</span> would come back in the order that it was in before you manipulated it<a id="_Fn1" href="#Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a>. This is because the <span class="FontName2">List</span> order is based upon the collation order asserted by the <span class="FontName2">&#64;OrderBy</span> annotation. Simply changing the order of the items in a <span class="FontName2">List</span> in memory will not cause that order to be stored in the database at commit time. In fact, the order specified in <span class="FontName2">&#64;OrderBy</span> will be used only when reading the <span class="FontName2">List</span> back into memory. As a rule of thumb, the <span class="FontName2">List</span> order should always be maintained in memory to be consistent with the <span class="FontName2">&#64;OrderBy</span> ordering rules.</p>
          </div>
          <div>
            <p id="Sec6" class="Heading3">Persistently Ordered Lists<a id="cXXX.232" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Another example that calls for the order provided by <span class="FontName2">List</span> is a print queue that keeps a list of the print jobs that are queued up at any given time. The <span class="FontName2">PrintQueue</span> is essentially a First In First Out (FIFO)<a id="cXXX.233" target="_blank" rel="noopener noreferrer"></a> queue that, when the printer is available, takes the next <span class="FontName2">PrintJob</span> from the front of the queue and sends it to the printer for printing. Assuming that <span class="FontName2">PrintQueue</span> and <span class="FontName2">PrintJob</span> are entities, we would have a one-to-many relationship from <span class="FontName2">PrintQueue</span> to <span class="FontName2">PrintJob</span> and a many-to-one relationship back.</p>
            <p class="indent">Given that you know how to map the relationships, and you just learned above how to map ordered lists using <span class="FontName2">&#64;OrderBy</span>, it would seem pretty straightforward to map this relationship using a <span class="FontName2">List</span>. The <span class="FontName2">PrintJob</span> entity, in <a href="#list5" id="_list5" target="_blank" rel="noopener noreferrer">Listing 5-5</a>, illustrates its many-to-one side of the bidirectional mapping.</p>
            <table>
              <tr>
                <td>
                  <p class="noindent2"><a href="#_list5" id="list5" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-5</i></b></a>.&nbsp;&nbsp;PrintJob Entity<a id="cXXX.234" target="_blank" rel="noopener noreferrer"></a></p>
                  <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                    <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PrintJob {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private PrintQueue queue;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                    <div class="orm-ChapterReader-snippetButtonContainer"></div>
                  </div>
                </td>
                <td>
                  <div class="Figure" id="Fig3">
                    <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-03.jpg" alt="9781430249269_Fig05-03.jpg" width="423" height="133"></p>
                    <p class="FigCapt"><span class="CaptNr"><a href="#_Fig3" target="_blank" rel="noopener noreferrer">Figure 5-3</a>. </span>PRINTQUEUE table and target PRINTJOB table with order column</p>
                  </div>
                </td>
              </tr>
            </table>
            <p class="indent">The problem arises when we discover that the <span class="FontName2">PrintJob</span> entity does not have an attribute that can be used in <span class="FontName2">&#64;OrderBy</span>. Because the order of the job does not really affect the actual <span class="FontName2">PrintJob</span> that gets serviced, the decision was made to not store the order of a given job within the <span class="FontName2">PrintJob</span> entity. The position of a particular <span class="FontName2">PrintJob</span> in the queue is determined simply by its position in the job <span class="FontName2">List</span>.</p>
            <p class="indent">The <span class="FontName2">PrintJob</span> entities in the Java <span class="FontName2">List</span> cannot retain their order unless a designated database column has been created to store it. We call this column the order column, and it provides a stronger persistent ordering than <span class="FontName2">&#64;OrderBy</span>. It is in the order column that the object's order is stored and updated when it is moved from one position to another within the same <span class="FontName2">List</span>. It is transparent to the user in that the user does not need to manipulate it, or even necessarily be aware of it, in order to use the <span class="FontName2">List</span>. It does need to be known and considered as part of the mapping process, though, and is declared by means of an <span class="FontName2">&#64;OrderColumn</span> annotation.</p>
            <p class="indent">Using an <span class="FontName2">&#64;OrderColumn</span> annotation precludes the use of <span class="FontName2">&#64;OrderBy</span>, and vice versa. <a href="#list6" id="_list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a> shows how <span class="FontName2">&#64;OrderColumn</span> can be used with our one-to-many relationship mapping in <span class="FontName2">PrintQueue</span>. The table mappings are shown in <a href="#Fig3" id="_Fig3" target="_blank" rel="noopener noreferrer">Figure 5-3</a> above.</p>
            <p class="noindent2"><a href="#_list6" id="list6" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-6</i></b></a>.&nbsp;&nbsp;One-To-Many List from PrintQueue to PrintJob<a id="cXXX.235" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PrintQueue {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="queue")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OrderColumn(name="PRINT_ORDER")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;PrintJob&gt; jobs;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">You probably noticed something different about the declaration of the order column on the one-to-many side of the relationship. In the last chapter, we explained the practice of mapping the physical columns on the owning side because that is the side that owns the table in which they apply. The order column is an exception to this rule when the relationship is bidirectional because the column is always defined beside the <span class="FontName2">List</span> that it is ordering, even though it is in the table mapped by the owning many-to-one entity side. So in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a>, the <span class="FontName2">&#64;OrderColumn</span> annotation is on the <span class="FontName2">PrintQueue</span> side of the relationship, but the column named <span class="FontName2">PRINT_ORDER</span> is referring to whatever table the <span class="FontName2">PrintJob</span> entity is mapped to.</p>
            <p class="indent">Although the <span class="FontName2">&#64;OrderColumn</span> annotation must be present to enable the ordered position of the entity to be stored in a database column, the elements of the annotation are optional. The <span class="FontName2">name</span> just defaults to the name of the entity attribute, appended by the ‚Äú_ORDER‚Äù string. So, if the name had not been overridden in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a> to be <span class="FontName2">PRINT_ORDER</span>, it would have defaulted to be <span class="FontName2">JOBS_ORDER</span>.</p>
            <p class="indent">The table that the order column is stored in depends on the mapping that <span class="FontName2">&#64;OrderColumn</span> is being applied to. It is usually in the table that stores the entity or element being stored. As mentioned, in our bidirectional one-to-many relationship in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a>, the entity being stored is <span class="FontName2">PrintJob</span>, and the order column would be stored in the <span class="FontName2">PRINTJOB</span> table. If the mapping were an element collection, the order column would be stored in the collection table. In many-to-many relationships, the order column is in the join table.</p>
            <p class="indent">Some additional comments about using <span class="FontName2">&#64;OrderColumn</span> are necessary because it is a feature that could easily be misused. We said that the order column is transparent to the user of the list, but it turns out that this transparency can have unexpected repercussions for a na√Øve user.</p>
            <p class="indent">Consider a busy company with many people and many print jobs being submitted and printed. When a job makes it to the first position, it gets removed from the queue and sent to the printer. Meanwhile, another job inherits the ‚Äúon deck‚Äù position. Every time a job gets serviced, every other <span class="FontName2">PrintJob</span> remaining on the queue moves up by one position and is one step closer to being printed. In other words, with each printed job, the order of each and every other <span class="FontName2">PrintJob</span> changes and must be resaved to the database. In our case, the order column is being stored in the table in which <span class="FontName2">PrintJob</span> entities are stored: the <span class="FontName2">PRINTJOB</span> table.</p>
            <p class="indent">Needless to say, we are looking at a potentially large cost, further compounded as the queue gets longer. For every job added to a queue of size n, there will be n additional SQL updates sent to the database to change the order of that job before it even makes it to the printer. That could ring alarm bells for a database administrator, especially a vigilant one with a penchant for perusing the SQL audits.</p>
            <p class="indent">As a final comment on <span class="FontName2">List</span> usage, there is special support in JPA queries that allows ordered subsets or individual items of a <span class="FontName2">List</span> to be accessed and returned. You will see how this can be achieved in <a href="9781430249269_Ch08.xhtml" target="_blank" rel="noopener noreferrer">Chapter 8</a>.</p>
          </div>
        </div>
        <div>
          <p id="Sec7" class="Heading2">Maps</p>
          <p class="noindent">The <span class="FontName2">Map</span> is a very common collection that is used in virtually every application and offers the ability to associate a key object with an arbitrary value object. The various underlying implementations are expected to use fast hashing techniques to optimize direct access to the keys.</p>
          <p class="indent">There is a great deal of flexibility with <span class="FontName2">Map</span> types in JPA, given that the keys and values can be any combination of entities, basic types, and embeddables. Permuting the three types in the two key and value positions renders nine distinct <span class="FontName2">Map</span> types. We will give detailed explanations of the most common combinations in the following sections.</p>
          <div>
            <p id="Sec8" class="Heading3">Keys and Values<a id="cXXX.236" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Although basic types, embeddable types, or entity types can be <span class="FontName2">Map</span> keys, remember that if they are playing the role of key, they must follow the basic rules for keys. They must be comparable and respond appropriately to the <span class="FontName2">hashCode()</span> method, and <span class="FontName2">equals()</span> method when necessary<a id="_Fn2" href="#Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a>. They should also be unique, at least within the domain of a particular collection instance, so that values are not lost or overwritten in memory. Keys should not be changed, or more specifically, the parts of the key object that are used in the <span class="FontName2">hashCode()</span> and <span class="FontName2">equals()</span> methods must not be changed while the object is acting as a key in a <span class="FontName2">Map</span>.</p>
            <p class="indent">When keys are basic or embeddable types, they are stored directly in the table being referred to. Depending upon the type of mapping, it can be either the target entity table, join table, or collection table. However, when keys are entities, only the foreign key is stored in the table because entities are stored in their own table, and their identity in the database must be preserved.</p>
            <p class="indent">It is always the type of the value object in the <span class="FontName2">Map</span> that determines what kind of mapping must be used. If the values are entities, the <span class="FontName2">Map</span> must be mapped as a one-to-many or many-to-many relationship, whereas if the values of the <span class="FontName2">Map</span> are either embeddable or basic types, the <span class="FontName2">Map</span> is mapped as an element collection.</p>
            <p class="indent">Even though the <span class="FontName2">Map</span> keys do not affect the type of mapping, they still require annotations, in addition to the relationship or element collection annotations, to indicate the column(s) in which they are stored. These annotations will be covered in the different use cases in the following sections.</p>
          </div>
          <div>
            <p id="Sec9" class="Heading3">Keying By Basic Type</p>
            <p class="noindent">We mentioned in the previous sections that element collections of basic types are stored in collection tables, and basic keys are stored in the tables referred to by the mapping. If the mapping is an element collection keyed by a basic type, the keys will be stored in the same collection table in which the <span class="FontName2">Map</span> values are stored. Likewise, if it is a one-to-many relationship, and the foreign key is in the target entity table, the keys will be in the target entity table. If the relationship mapping uses a join table, the keys will be in the join table.</p>
            <p class="indent">To show the collection table case, let's look at an element collection example that maps the phone numbers of an <span class="FontName2">Employee</span>. If we use a <span class="FontName2">Map</span>, we can key on the phone number type and store the phone number as the value. So the key of each <span class="FontName2">Map</span> entry will be any of ‚ÄúHome‚Äù, ‚ÄúWork‚Äù or ‚ÄúMobile‚Äù, as a <span class="FontName2">String</span>, and the value will be the associated phone number <span class="FontName2">String</span>. <a href="#list7" id="_list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a> shows the element collection mapping<a id="cXXX.245a" target="_blank" rel="noopener noreferrer"></a> code.</p>
            <p class="noindent2"><a href="#_list7" id="list7" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-7</i></b></a>.&nbsp;&nbsp;Element Collection of Strings with String Keys<a id="cXXX.237" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, String&gt; phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">&#64;ElementCollection</span> and <span class="FontName2">&#64;CollectionTable</span> annotations are nothing new, and <a href="#list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a> showed that we can use the <span class="FontName2">&#64;Column</span> annotation to override the name of the column that stores the values in the <span class="FontName2">Collection</span>. Here we are doing the same thing, except that we are overriding the column in which the <span class="FontName2">Map</span> values would be stored instead of the items in a generic <span class="FontName2">Collection</span>.</p>
            <p class="indent">The only new annotation is <span class="FontName2">&#64;MapKeyColumn</span>, which is used to indicate the column in the collection table that stores the basic key. When the annotation is not specified, the key is stored in a column named after the mapped collection attribute, appended with the ‚Äú_KEY‚Äù suffix. In <a href="#list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a>, if we had not specified <span class="FontName2">&#64;MapKeyColumn</span>, the defaulting rule would have caused the key to be mapped to the <span class="FontName2">PHONENUMBERS_KEY</span> column in the <span class="FontName2">EMP_PHONE</span> collection table.</p>
            <p class="indent">Phone number values can be duplicated in the collection table (for example, multiple employees living at the same home and having the same phone number), so the <span class="FontName2">PHONE_NUM</span> column obviously won't be unique in the table. The types of phone numbers have to be unique only within a given <span class="FontName2">Map</span> or <span class="FontName2">Employee</span> instance, so the <span class="FontName2">PHONE_TYPE</span> column won't be the primary key, either. In fact, because basic types do not have identity, and in some cases the same key-value entries can be duplicated in multiple source entities, the key-value columns can't be the primary key columns on their own. Unique tuples in the collection table must be the combination of the key column and the foreign key column that references the source entity instance. <a href="#Fig4" id="_Fig4" target="_blank" rel="noopener noreferrer">Figure 5-4</a> shows the resulting collection table, along with the source <span class="FontName2">EMPLOYEE</span> entity table that it references. You can see the primary key constraint on the <span class="FontName2">EMPLOYEE_ID</span> and <span class="FontName2">PHONE_TYPE</span> columns.</p>
            <div class="Figure" id="Fig4">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-04.jpg" alt="9781430249269_Fig05-04.jpg" width="452" height="131"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig4" target="_blank" rel="noopener noreferrer">Figure 5-4</a>. </span>EMPLOYEE entity table<a id="cXXX.228" target="_blank" rel="noopener noreferrer"></a> and EMP_PHONE collection table<a id="cXXX.240" target="_blank" rel="noopener noreferrer"></a></p>
            </div>
            <p class="indent">We should really improve our model, though, because using a <span class="FontName2">String</span> key to store something that is constrained to be one of only three values (‚ÄúHome‚Äù, ‚ÄúMobile‚Äù, or ‚ÄúWork‚Äù), is not great style. An appropriate improvement would be to use an enumerated type instead of <span class="FontName2">String</span>. We can define our enumerated type as follows:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">public enum PhoneType { Home, Mobile, Work }</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">Now we have the valid options as enumerated constants, and there is no chance of mistyping or having invalid phone types. However, there is one further enhancement to consider. If we want to protect ourselves from future changes to the enumerated type values, either by reordering existing values or inserting additional ones, we should override the way the value is stored in the database. Instead of relying on the default approach of storing the ordinal value of the enumerated element, we want to store the <span class="FontName2">String</span> value, so we get the best of both worlds. The column will contain values that correspond to phone type settings in a human readable way, and the Java Map will have a strongly typed key.</p>
            <p class="indent">The usual way of overriding the storage strategy for an enumerated type is to use the <span class="FontName2">&#64;Enumerated</span> annotation. However, if we were to put <span class="FontName2">&#64;Enumerated</span> on our <span class="FontName2">Map</span> attribute, it would apply to the values of the element collection, not the keys. That is why there is a special <span class="FontName2">&#64;MapKeyEnumerated</span> annotation (see <a href="#list8" id="_list8" target="_blank" rel="noopener noreferrer">Listing 5-8</a>). There is also an equivalent <span class="FontName2">&#64;MapKeyTemporal</span> to specify the temporal type when the key is of type <span class="FontName2">java.util.Date</span>. Both <span class="FontName2">&#64;MapKeyEnumerated</span> and <span class="FontName2">&#64;MapKeyTemporal</span> are applicable to keys that are of a basic type, regardless of whether it is an element collection or a relationship.</p>
            <p class="noindent2"><a href="#_list8" id="list8" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-8</i></b></a>.&nbsp;&nbsp;Element Collection of Strings with Enumerated Type Keys<a id="cXXX.241" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyEnumerated(EnumType.STRING)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;PhoneType, String&gt; phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent"><a href="#list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a> had a one-to-many relationship that used a <span class="FontName2">List</span> to hold all the employees in a given department. Suppose that we change it to use a <span class="FontName2">Map</span> and keep track of which employee is working in any given office or cubicle. By keying on the cubicle number (which can contain letters as well, so we will represent them as a <span class="FontName2">String</span>), we can easily find which <span class="FontName2">Employee</span> works in that cubicle. Because this is a bidirectional one-to-many relationship, it will be mapped as a foreign key to <span class="FontName2">DEPARTMENT</span> in the <span class="FontName2">EMPLOYEE</span> table. The cubicle number keys will be stored in an additional column in the <span class="FontName2">EMPLOYEE</span> table, each one stored in the row corresponding to the <span class="FontName2">Employee</span> associated with that cubicle. <a href="#list9" id="_list9" target="_blank" rel="noopener noreferrer">Listing 5-9</a> shows the one-to-many mapping.</p>
            <p class="noindent2"><a href="#_list9" id="list9" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-9</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a Map <a id="cXXX.242" target="_blank" rel="noopener noreferrer"></a>with String Key</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="CUB_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Employee&gt; employeesByCubicle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">What if an employee could split his time between multiple departments? We would have to change our model to a many-to-many relationship and use a join table. The <span class="FontName2">&#64;MapKeyColumn</span> will be stored in the join table that references the two entities. The relationship is mapped in <a href="#list10" id="_list10" target="_blank" rel="noopener noreferrer">Listing 5-10</a>.</p>
            <p class="noindent2"><a href="#_list10" id="list10" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-10</i></b></a>.&nbsp;&nbsp;Many-to-Many Relationship Using a Map with String Keys<a id="cXXX.243" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="DEPT_EMP",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns=&#64;JoinColumn(name="DEPT_ID"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="CUB_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Employee&gt; employeesByCubicle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">If we did not override the key column with <span class="FontName2">&#64;MapKeyColumn</span>, it would have been defaulted as the name of the collection attribute suffixed by ‚Äú_KEY‚Äù. This would have produced a dreadful-looking <span class="FontName2">EMPLOYEESBYCUBICLE_KEY</span> column in the join table, which is not only ugly to read, but does not actually indicate what the key really is. <a href="#Fig5" id="_Fig5" target="_blank" rel="noopener noreferrer">Figure 5-5</a> shows the resulting tables.</p>
            <div class="Figure" id="Fig5">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-05.jpg" alt="9781430249269_Fig05-05.jpg" width="652" height="133"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig5" target="_blank" rel="noopener noreferrer">Figure 5-5</a>. </span>EMPLOYEE and DEPARTMENT entity tables<a id="cXXX.244" target="_blank" rel="noopener noreferrer"></a> and DEPT_EMP join table<a id="cXXX.245" target="_blank" rel="noopener noreferrer"></a></p>
            </div>
            <div class="notepara">
              <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;You can use a Map on only one side of a many-to-many relationship; it makes no difference which side.</p>
            </div>
          </div>
          <div>
            <p id="Sec10" class="Heading3">Keying by Entity Attribute<a id="cXXX.246" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">When a one-to-many or many-to-many relationship collection of entities is represented as a <span class="FontName2">Map</span>, it is most often keyed by some attribute of the target entity type. Keying by entity attribute is actually a special case of keying by basic type where the mapping is a relationship, and the basic type of the key is the type of the attribute (that we are keying on) in the target entity. When this common case occurs, the <span class="FontName2">&#64;MapKey</span> annotation can be used to designate the attribute of the target entity that is being keyed on.</p>
            <p class="indent">If each department keeps track of the employees in it, as in our previous example in <a href="#list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a>, we could use a <span class="FontName2">Map</span> and key on the Employee id for quick <span class="FontName2">Employee</span> lookup. The updated <span class="FontName2">Department</span> mapping is shown in <a href="#list11" id="_list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a>.</p>
            <p class="noindent2"><a href="#_list11" id="list11" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-11</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Keyed by Entity Attribute</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKey(name="id")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;Integer, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">id</span> attribute of <span class="FontName2">Employee</span> is also the identifier or primary key attribute, and it turns out that keying on the identifier is the most common case of all. It is so common that when no name is specified the entities will by default be keyed by their identifier attribute<a id="_Fn3" href="#Fn3" target="_blank" rel="noopener noreferrer"><sup>3</sup></a>. When the identifier attribute is defaulted and not explicitly listed, we do need to know the identifier type so we can correctly specify the first type parameter of the <span class="FontName2">Map</span> when using a parameterized <span class="FontName2">Map</span>.</p>
            <p class="indent">One of the reasons why the identifier attribute is used for the key is because it fits the key criteria nicely. It responds to the necessary comparison methods, <span class="FontName2">hashCode()</span> and <span class="FontName2">equals()</span>, and it is guaranteed to be unique.</p>
            <p class="indent">If another attribute is used as the key, it should also be unique, although it is not absolutely required that it be unique across the entire domain of that entity type. It really needs to be unique only within the scope of the relationship. For example, we could key on the employee name as long as we made sure that the name would be unique within any department.</p>
            <p class="indent">In the previous section, we stated that a basic key is stored in the table referred to by the mapping. The special case of keying by entity attribute is an exception to that rule in that no additional column is needed to store the key. It is already stored as part of the entity. That is why the <span class="FontName2">&#64;MapKeyColumn</span> annotation is never used when keying on an entity attribute. A provider can easily build the contents of a one-to-many relationship <span class="FontName2">Map</span> by loading the entities that are associated with the source entity and extracting the attribute being keyed on from each of the loaded entities. No additional columns need to be read or extra joins performed.</p>
          </div>
          <div>
            <p id="Sec11" class="Heading3">Keying by Embeddable Type<a id="cXXX.247" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Using embeddables as keys is not something that you should encounter very often. In fact, if you are considering doing it at all, you should probably think twice before proceeding. Just because it's possible does not mean that it is a good idea.</p>
            <p class="indent">The problem with embeddables is that they are not full-fledged entities. They are not queryable in the sense that they can't be discovered or returned except as an aggregate part of their enclosing entities. Although this might not seem like a very severe limitation at the outset, it often becomes a problem later on in the development cycle.</p>
            <p class="indent">Identity of embeddables is not defined in general, but when they are used as keys in a <span class="FontName2">Map</span> there must be some notion of uniqueness defined, applicable at least within the given <span class="FontName2">Map</span>. This means that the uniqueness constraint, at least logically, is on the combination of the embedded attributes and the foreign key column to the source entity.</p>
            <p class="indent">Embeddable key types are similar to basic key types in that they are also stored in the table referred to by the mapping, but with embeddable types there are multiple attributes to store, not just one value. This results in multiple columns contributing to the primary key.</p>
            <div>
              <p id="Sec12" class="Heading4">Sharing Embeddable Key Mappings with Values</p>
              <p class="noindent">The code example in <a href="#list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a> showed a bidirectional one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span> that was keyed by the <span class="FontName2">id</span> attribute of <span class="FontName2">Employee</span>. What if we had wanted to key on multiple attributes of <span class="FontName2">Employee</span>? For example, it might be desirable to look up employees by name in the <span class="FontName2">Map</span>, assuming that the name is unique within a given department. If the name were split into two attributes, one for the first name and one for the last name, as shown in <a href="#list12" id="_list12" target="_blank" rel="noopener noreferrer">Listing 5-12</a>, then we would need a separate object to combine them and act as the key object in the <span class="FontName2">Map</span>. An embeddable type, such as <span class="FontName2">EmployeeName</span> in <a href="#list13" id="_list13" target="_blank" rel="noopener noreferrer">Listing 5-13</a>, can be used for this purpose. Having an <span class="FontName2">EmployeeName</span> embeddable type also provides a useful class for passing the encapsulated full name around the system.</p>
              <p class="noindent2"><a href="#_list12" id="list12" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-12</i></b></a>.&nbsp;&nbsp;Employee Entity</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String firstName;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String lastName;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="noindent2"><a href="#_list13" id="list13" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-13</i></b></a>.&nbsp;&nbsp;EmployeeName Embeddable with Read-Only Mappings</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeName {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String first_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String last_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">Because the bidirectional one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span> is stored in the target entity table, the embeddable object key must also be stored there. However, it would be redundant for the two name components to be stored twice in each row, once for the <span class="FontName2">firstName</span> and <span class="FontName2">lastName</span> attributes of <span class="FontName2">Employee</span> and once for the <span class="FontName2">first_Name</span> and <span class="FontName2">last_Name</span> attributes of the <span class="FontName2">EmployeeName</span> key object. With a bit of clever mapping we can just reuse the two columns mapped to the <span class="FontName2">Employee</span> attributes and map them as read-only in the key (setting insertable and updatable to <span class="FontName2">false</span>). That is why in <a href="#list13" target="_blank" rel="noopener noreferrer">Listing 5-13</a> we map the <span class="FontName2">first_Name</span> and <span class="FontName2">last_Name</span> attributes to the same columns as the <span class="FontName2">firstName</span> and <span class="FontName2">lastName</span> attributes of <span class="FontName2">Employee</span>. From the <span class="FontName2">Department</span> perspective, the relationship in <a href="#list14" id="_list14" target="_blank" rel="noopener noreferrer">Listing 5-14</a> does not change much from <a href="#list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a>, except that the <span class="FontName2">Map</span> is keyed by <span class="FontName2">EmployeeName</span> instead of by <span class="FontName2">Integer</span>, and <span class="FontName2">&#64;MapKey</span> is not used because the key is an embeddable and not an attribute of <span class="FontName2">Employee</span>.</p>
              <p class="noindent2"><a href="#_list14" id="list14" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-14</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Keyed by Embeddable</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </div>
            <div>
              <p id="Sec13" class="Heading4">Overriding Embeddable Attributes</p>
              <p class="noindent">Another modeling option is to combine the two name columns within the <span class="FontName2">Employee</span> entity and define an embedded attribute of type <span class="FontName2">EmployeeName</span>, as shown in <a href="#list15" id="_list15" target="_blank" rel="noopener noreferrer">Listing 5-15</a>.</p>
              <p class="noindent2"><a href="#_list15" id="list15" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-15</i></b></a>.&nbsp;&nbsp;Employee Entity with Embedded Attribute</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private EmployeeName name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">This time we are not sharing columns, so we must ensure that the mappings in <span class="FontName2">EmployeeName</span> are no longer read-only, or else the name will never get written to the database. The updated <span class="FontName2">EmployeeName</span> embeddable is in <a href="#list16" id="_list16" target="_blank" rel="noopener noreferrer">Listing 5-16</a>.</p>
              <p class="noindent2"><a href="#_list16" id="list16" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-16</i></b></a>.&nbsp;&nbsp;EmployeeName Embeddable</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeName {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String first_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String last_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">For the purpose of illustration, let's go back to the many-to-many model described in <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 5-10</a>, except that we will key on the <span class="FontName2">EmployeeName</span> embeddable instead of the cubicle <span class="FontName2">id</span>. Even though the <span class="FontName2">EmployeeName</span> attributes are stored in the <span class="FontName2">EMPLOYEE</span> table for every <span class="FontName2">Employee</span>, the keys of the <span class="FontName2">Map</span> must still be stored in the <span class="FontName2">DEPT_EMP</span> join table. This is a result of the key being an embeddable type. Keying by either a single attribute of the entity or by a basic type would alleviate this denormalized data scenario.</p>
              <p class="indent">By default, the key attributes would be mapped to the column names from the mappings defined within <span class="FontName2">EmployeeName</span>, but if the join table already exists and the columns in the join table do not have those names, the names must be overridden. <a href="#list17" id="_list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a> shows how the embeddable attribute mappings of the <span class="FontName2">Map</span> key can be overridden from what they are defined to be in the embeddable class.</p>
              <p class="noindent2"><a href="#_list17" id="list17" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-17</i></b></a>.&nbsp;&nbsp;Many-to-Many Map Keyed by Embeddable Type with Overriding</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="DEPT_EMP",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="DEPT_ID"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;AttributeOverride(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="first_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">column=&#64;Column(name="EMP_FNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;AttributeOverride(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="last_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">column=&#64;Column(name="EMP_LNAME"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">The tables for the mapping are shown in <a href="#Fig6" id="_Fig6" target="_blank" rel="noopener noreferrer">Figure 5-6</a>, with the embeddable attributes mapped to the join table for the key state and in the <span class="FontName2">EMPLOYEE</span> table for the <span class="FontName2">Employee</span> state. If the mapping had been an element collection, the embeddable attributes would be stored in a collection table instead of a join table.</p>
              <div class="Figure" id="Fig6">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-06.jpg" alt="9781430249269_Fig05-06.jpg" width="652" height="148"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig6" target="_blank" rel="noopener noreferrer">Figure 5-6</a>. </span>DEPARTMENT and EMPLOYEE entity table<a id="cXXX.239" target="_blank" rel="noopener noreferrer"></a>s and DEPT_EMP join table</p>
              </div>
              <p class="indent">As you can see from <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, the mapping defaults for the key are being overridden through the use of <span class="FontName2">&#64;AttributeOverride</span>. If instead of a many-to-many relationship we had an <span class="FontName2">&#64;ElementCollection</span> of some embeddable type in a <span class="FontName2">Map</span>, we would have to differentiate between the key and the value. We would do this by prefixing the attribute name with ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù, depending upon which of the embeddable types we were overriding. An element collection of embedded <span class="FontName2">EmployeeInfo</span> types, with the same key overrides as those in the relationship in <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, would use the following key prefixes:</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;ElementCollection</span><br><span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="key.first_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="EMP_FNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="key.last_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="EMP_LNAME"))</span><br><span class="FontName2">})</span><br><span class="FontName2">private Map&lt;EmployeeName, EmployeeInfo&gt; empInfos;</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </div>
          </div>
          <div>
            <p id="Sec14" class="Heading3">Keying by Entity<a id="cXXX.248" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">You might be reluctant to use entities as keys because intuition might lead you to think of this as a more resource-intensive option, with higher load and management costs. While that might be true in some cases, it is not necessarily always so. Quite often the entity you are considering keying on will already be in memory, or needed anyway, and keying on it either just accesses a cached instance or causes the instance to be loaded for later use.</p>
            <p class="indent">One advantage of keying by entity type is that entity instances are globally unique (within the persistence unit) so there will not be any identity problems to deal with across different relationships or collections. A corollary of the basic identity property of entities is that only a foreign key needs to be stored in the mapped table, leading to a more normalized design and data storage schema.</p>
            <p class="indent">As with the other types of <span class="FontName2">Map</span> keys, the key (in this case, a foreign key to the entity being keyed on) will be stored in the table referred to by the mapping.</p>
            <p class="indent">Recall that the term used by JPA to represent a foreign key column is join column, and we use join columns in many-to-one and one-to-one relationships, as well as in join tables of collection-valued relationships. We now have a similar situation, except that instead of referring to the target of a relationship, our join column is referring to the entity key in a <span class="FontName2">Map</span> entry. To differentiate join columns that point to map keys from the ones used in relationships, a separate <span class="FontName2">&#64;MapKeyJoinColumn</span> annotation was created. This annotation is used to override the join column defaults for an entity key. When it is not specified, the join column will have the same default column name as basic keys (the name of the relationship or element collection attribute, appended with the string ‚Äú_KEY‚Äù).</p>
            <p class="indent">To illustrate the case of an entity being used as a key, we can add the notion of the seniority an <span class="FontName2">Employee</span> has within a given <span class="FontName2">Department</span>. We want to have a loose association between an <span class="FontName2">Employee</span> and his seniority, and the seniority has to be local to a <span class="FontName2">Department</span>. By defining an element collection <span class="FontName2">Map</span> in <span class="FontName2">Department</span>, with the seniority as the values and <span class="FontName2">Employee</span> entities as the keys, the seniority any <span class="FontName2">Employee</span> has in a given <span class="FontName2">Department</span> can be looked up by using the <span class="FontName2">Employee</span> instance as a key. The seniority is stored in a collection table, and if an <span class="FontName2">Employee</span> changes departments none of the other <span class="FontName2">Employee</span> objects needs to change. The indirection of the collection table, and the fact that the connections between the <span class="FontName2">Department</span>, the <span class="FontName2">Employee</span>, and the seniority value are all maintained by virtue of the <span class="FontName2">Map</span>, provide just the right level of coupling. Only the entries in the collection table would need to be updated.</p>
            <p class="indent"><a href="#list18" id="_list18" target="_blank" rel="noopener noreferrer">Listing 5-18</a> shows the element collection mapping, with the join column being overridden using the <span class="FontName2">&#64;MapKeyJoinColumn</span> annotation and the <span class="FontName2">Map</span> value column being overridden using the standard <span class="FontName2">&#64;Column</span> annotation.</p>
            <p class="noindent2"><a href="#_list18" id="list18" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-18</i></b></a>.&nbsp;&nbsp;Element Collection Map Keyed by EntityType</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_SENIORITY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyJoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="SENIORITY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;Employee, Integer&gt; seniorities;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent"><a href="#Fig7" id="_Fig7" target="_blank" rel="noopener noreferrer">Figure 5-7</a> shows that the collection table is nothing more than the values of the <span class="FontName2">Map</span> (the seniority) with a foreign key to the <span class="FontName2">Department</span> source entity table and another foreign key to the <span class="FontName2">Employee</span> entity key table.</p>
            <div class="Figure" id="Fig7">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-07.jpg" alt="9781430249269_Fig05-07.jpg" width="671" height="125"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig7" target="_blank" rel="noopener noreferrer">Figure 5-7</a>. </span>DEPARTMENT and EMPLOYEE entity tables with EMP_SENIORITY collection table</p>
            </div>
          </div>
          <div>
            <p id="Sec15" class="Heading3">Untyped Maps<a id="cXXX.249" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">If we did not want to (or were not able to) use the typed parameter version of <span class="FontName2">Map&lt;KeyType, ValueType&gt;</span>, we would define it using the non-parameterized style of <span class="FontName2">Map</span> shown in <a href="#list19" id="_list19" target="_blank" rel="noopener noreferrer">Listing 5-19</a>.</p>
            <p class="noindent2"><a href="#_list19" id="list19" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-19</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a Non-parameterized Map</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(targetEntity=Employee.class, mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKey</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">targetEntity</span> element only ever indicates the type of the <span class="FontName2">Map</span> value. Of course, if the <span class="FontName2">Map</span> holds an element collection and not a relationship, the <span class="FontName2">targetClass</span> element of <span class="FontName2">&#64;ElementCollection</span> is used to indicate the value type of the <span class="FontName2">Map</span>.</p>
            <p class="indent">In <a href="#list19" target="_blank" rel="noopener noreferrer">Listing 5-19</a>, the type of the <span class="FontName2">Map</span> key can be easily deduced because the mapping is an entity relationship. The <span class="FontName2">&#64;MapKey</span> default is to use the identifier attribute, <span class="FontName2">id</span>, of type <span class="FontName2">int</span> or <span class="FontName2">Integer</span>. If <span class="FontName2">&#64;MapKey</span> had been specified and dictated that the key be an attribute that was not an identifier attribute, the type would still have been deducible because the entity attributes are all mapped with known types. However, if the key isn't an attribute of the target entity, <span class="FontName2">&#64;MapKeyClass</span> might be used instead of <span class="FontName2">&#64;MapKey</span>. It indicates the type of the key class when the <span class="FontName2">Map</span> is not defined in a typed way using generics. It is also used when the <span class="FontName2">Map</span> references an element collection instead of a relationship because basic or embeddable types do not have identifier attributes, and basic types do not even have attributes.</p>
            <p class="indent">To illustrate how <span class="FontName2">&#64;MapKeyClass</span> is used, let's take the element collection in <a href="#list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a> and assume that it does not define the type parameters on the <span class="FontName2">Map</span>. The typing is filled in through the use of the <span class="FontName2">&#64;MapKeyClass</span> annotation and the <span class="FontName2">targetClass</span> element in <span class="FontName2">&#64;ElementCollection</span>, as shown in <a href="#list20" id="_list20" target="_blank" rel="noopener noreferrer">Listing 5-20</a>.</p>
            <p class="noindent2"><a href="#_list20" id="list20" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-20</i></b></a>.&nbsp;&nbsp;Untyped Element Collection of Strings with String Keys</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=String.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyClass(String.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">&#64;MapKeyClass</span> annotation should be used whenever the key class cannot be deduced from the attribute definition or the other mapping metadata.</p>
          </div>
          <div>
            <p id="Sec16" class="Heading3">Rules for Maps<a id="cXXX.250" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Learning about the various <span class="FontName2">Map</span> variants can get kind of confusing given that you can choose any one of three different kinds of key types and three different kinds of value types. Below are some of the basic rules of using a <span class="FontName2">Map</span>.</p>
            <ul class="bulleted">
              <li>Use the <span class="FontName2">&#64;MapKeyClass</span> and <span class="FontName2">targetEntity</span>/<span class="FontName2">targetClass</span> elements of the relationship and element collection mappings to specify the classes when an untyped <span class="FontName2">Map</span> is used.</li>
              <li>Use <span class="FontName2">&#64;MapKey</span> with one-to-many or many-to-many relationship <span class="FontName2">Map</span> that is keyed on an attribute of the target entity.</li>
              <li>Use <span class="FontName2">&#64;MapKeyJoinColumn</span> to override the join column of the entity key.</li>
              <li>Use <span class="FontName2">&#64;Column</span> to override the column storing the values of an element collection of basic types.</li>
              <li>Use <span class="FontName2">&#64;MapKeyColumn</span> to override the column storing the keys when keyed by a basic type.</li>
              <li>Use <span class="FontName2">&#64;MapKeyTemporal</span> and <span class="FontName2">&#64;MapKeyEnumerated</span> if you need to further qualify a basic key that is a temporal or enumerated type.</li>
              <li>Use <span class="FontName2">&#64;AttributeOverride</span> with a ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù prefix to override the column of an embeddable attribute type that is a <span class="FontName2">Map</span> key or a value, respectively.</li>
            </ul>
            <p class="indent"><a href="#Tab1" id="_Tab1" target="_blank" rel="noopener noreferrer">Table 5-1</a> summarizes some of the different aspects of using a <span class="FontName2">Map</span>.</p>
            <div class="Table" id="Tab1">
              <p class="TabCapt"><span class="CaptNr"><a href="#_Tab1" target="_blank" rel="noopener noreferrer">Table 5-1</a>. </span>Summary of Mapping a Map</p>
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/Table5-1.jpg" alt="image" width="900" height="762"></p>
            </div>
          </div>
        </div>
        <div>
          <p id="Sec17" class="Heading2">Duplicates<a id="cXXX.251" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">When we were discussing the <span class="FontName2">Set</span> interface we mentioned that it was ideal for preventing duplicates. What we meant was that the <span class="FontName2">Set</span> datatype in Java does not allow them. We didn't really say anything about duplicates in the database. In fact, the JPA specification does not say anything about whether duplicates are allowed in collections, either in the database or in memory, and in most cases they will not be supported. To get a feeling for why supporting duplicates is difficult, let's go to the data model and uncover some of the gory details. You might prefer to skip this section if duplicates are not interesting to you. Read on, however, if you are in a situation where an external application can come in behind your back and insert a duplicate record, for example.</p>
          <p class="indent">The <span class="FontName2">Collection</span> interface is very general and allows for a multitude of <span class="FontName2">Collection</span> subinterfaces and implementation classes. So it is very soft in its specification of whether duplicates are allowed, instead allowing the subinterface or implementation class to decide what behavior best fits that <span class="FontName2">Collection</span> type.</p>
          <p class="indent">For a <span class="FontName2">Collection</span> that does happen to allow duplicates, collection-valued relationship mappings use either a foreign key in the target entity table or a join table. The first case will always be a one-to-many mapping, and in that case there will be only one row for the target entity, and only one column in that row to contain the foreign key to the source entity. That leaves no way to capture the fact that the target entity is in the collection more than once.</p>
          <p class="indent">In the join table case, each row stores a join column to the source entity and a join column to the target entity, and the primary key of the join table is composed of the combination of the two. Only duplicate rows in that model could link multiple instances of the target to the same source, and duplicate rows in a relational database are highly frowned upon.</p>
          <p class="indent">An element collection is in a similar situation, except that instead of a foreign key to the target entity there are one or more columns in the collection table storing the basic or embeddable values. These columns just combine with the foreign key to the source entity to make up the primary key, and once again duplicate rows would be required to have duplicate values in a collection.</p>
          <p class="indent">The persistently ordered <span class="FontName2">List</span> is a little different, however, because it adds an order column to the mix. If the order column were to be included as part of the primary key, multiple relationship entries could exist in the <span class="FontName2">List</span>‚Äîeach of their respective rows potentially having the same element value data and foreign key reference, but differing only by the value of the order column. Thus, the uniqueness of a row is identified not only by the source and target objects but also by its position in the <span class="FontName2">List</span>.</p>
          <p class="indent">In the case of the foreign key in the target table, it would be bad practice indeed to include the order column in the primary key of an entity table, so we won't even explore that as an option. However, when a join table or collection table is used, it is a perfectly reasonable thing to do, allowing duplicate values to be inserted in a persistently ordered <span class="FontName2">List</span>. This is possible, though, only if the provider includes the order column in the primary key of the table or gives you the option of configuring it in that way.</p>
          <p class="indent">Before you rejoice that your provider might allow you to store duplicates, be aware that there is a price to pay. This can be seen in the example of exchanging the order of two elements in the <span class="FontName2">List</span>. If the order column were just a regular column, it wouldn't be too much of a stretch for the provider to optimize the database operations by simply updating the order columns of the two records with the correct values. However, if the order column is part of the primary key, what you are really saying is that the ordering of the contained object in the <span class="FontName2">List</span> is an integral part of the relationship between the containing and contained objects. Assigning a new order to the contained object is not modifying an aspect of the relationship, but effectively destroying the relationship and creating a new one with a different ordering. That means deleting the two old rows and creating two new ones.</p>
          <p class="indent">A <span class="FontName2">Map</span> has keys that must be unique, so duplicate keys clearly don't make sense. It is similar to a <span class="FontName2">List</span> when it comes to its values, however, because it has a key column that can be part of the primary key. Once again, the case of the foreign key in the target table does not allow for multiple keys to point to the same entity, so one-to-many relationships that are mapped that way simply do not permit the same entity to be mapped to multiple keys in the same <span class="FontName2">Map</span>.</p>
          <p class="indent">For join tables and collection tables, duplicates will be possible in the <span class="FontName2">Map</span> only if it is keyed by something other than an attribute of the entity, or embeddable, and the key column is included in the primary key. The trade-off in the case of the <span class="FontName2">Map</span> is similar to the one that we discussed with <span class="FontName2">List</span>, except that the price of allowing duplicates in a <span class="FontName2">Map</span> is paid when you want to reassign an existing key to a different value.</p>
        </div>
        <div>
          <p id="Sec18" class="Heading2">Null Values<a id="cXXX.252" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">It is probably even less common to insert null values in a collection than it is to have duplicates. This is one reason why the JPA specification is not particularly clear on what happens when you insert null into a collection. As with duplicates, the cases are a little complex and require individual consideration.</p>
          <p class="indent">The <span class="FontName2">Set</span>, <span class="FontName2">List</span>, and <span class="FontName2">Map</span> interfaces join the <span class="FontName2">Collection</span> interface in being general enough to be wishy-washy when it comes to specifying what happens when null is inserted. They simply delegate the decision to the implementation, so an implementation class might choose to support inserting null values or throw an exception. JPA does no better; it ends up falling to the particular vendor's proxy implementation to allow null or throw a <span class="FontName2">NullPointerException</span> when null is added. Note that you cannot make your collection interface allow null simply by initializing it with an implementation instance, such as <span class="FontName2">HashSet</span>, that allows null. The provider will replace the instance with one of its own implementation classes the next time the object becomes managed, and the new implementation class might or might not allow null values.</p>
          <p class="indent">In order for a null value to exist in the database the value column or columns must be nullable. This is the obvious part, but the corollary might be less evident, if a little repetitive. It claims once again that only relationships and element collections that use a join table or collection table can have null values in the collection. The proof is left for you to figure out, but (as a hint) try creating an entity that has all null values, including the identifier, with no identifier generation.</p>
          <p class="indent">There is a further limitation on null values when it comes to element collections of embeddable objects. Entity references in a join table or element collections of basic types in a collection table are single-column values or references. The problem in the embeddable case is that if a combination of columns mapped to an embeddable are all null, there is no way for the provider to know whether it signifies a null value or an empty embeddable object full of null values. Providers might assume that it is an empty embedded object or they might have a controllable option to dictate whether the nulls get treated one way or the other.</p>
          <p class="indent">Maps are equally non-committal about allowing null keys, but it really doesn't fit very well with the model of key columns being primary key fields. Most databases do not allow one of the primary key fields to be nullable, and we would not recommend it even for the odd one that does.</p>
        </div>
        <p id="Sec19" class="Heading1">Best Practices</p>
        <p class="noindent">With all the options and possibilities that have emerged, we would be cruel indeed if we did not offer at least some measure of guidance to the lonely collections traveler. Of course, the reason why there are so many options is because there are so many different cases to solve, so it is not really appropriate to come up with hard and fast rules. However, some general guidelines will hopefully assist you in picking the right mapping strategy for your specific application use case.</p>
        <ul class="bulleted">
          <li>When using a <span class="FontName2">List</span>, do not assume that it is ordered automatically if you have not actually specified any ordering. The <span class="FontName2">List</span> order might be affected by the database results, which are only partially deterministic with respect to how they are ordered. There are no guarantees that such an ordering will be the same across multiple executions.</li>
          <li>It will generally be possible to order the objects by one of their own attributes. Using the <span class="FontName2">&#64;OrderBy</span> annotation will always be the best approach when compared to a persistent <span class="FontName2">List</span> that must maintain the order of the items within it by updating a specific order column. Use the order column only when it is impossible to do otherwise.</li>
          <li><span class="FontName2">Map</span> types are very helpful, but they can be relatively complicated to properly configure. Once you reach that stage, however, the modeling capabilities that they offer and the loose association support that can be leveraged makes them ideal candidates for various kinds of relationships and element collections.</li>
          <li>As with the <span class="FontName2">List</span>, the preferred and most efficient use of a <span class="FontName2">Map</span> is to use an attribute of the target object as a key, making a <span class="FontName2">Map</span> of entities keyed by a basic attribute type the most common and useful. It will often solve most of the problems you encounter. A <span class="FontName2">Map</span> of basic keys and values can be a useful configuration for associating one basic object with another.</li>
          <li>Avoid using embedded objects in a <span class="FontName2">Map</span>, particularly as keys, because their identity is typically not defined. Embeddables in general should be treated with care and used only when absolutely necessary.</li>
          <li>Support for duplicate or null values in collections is not guaranteed, and is not recommended even when possible. They will cause certain types of operations on the collection type to be slower and more database-intensive, sometimes amounting to a combination of record deletion and insertion instead of simple updates.</li>
        </ul>
        <p id="Sec20" class="Heading1">Summary</p>
        <p class="noindent">In this chapter, we took a more in-depth look at various ways of mapping collections to the database. We looked at how the contents of the collection determine how it is mapped, and noted that there are many flexible options for storing different kinds of objects in various types of collections.</p>
        <p class="indent">We showed that the difference between relationships and element collections was whether entities or basic/embeddable types were being stored in them. We went on to examine the different types of collections, and how <span class="FontName2">Collection</span> and <span class="FontName2">Set</span> can be used for simple container purposes, while <span class="FontName2">List</span> can be used to maintain ordered collections. We showed that there are two different approaches to using a <span class="FontName2">List</span> and that maintaining a persistent <span class="FontName2">List</span> is possible, but not usually the best strategy.</p>
        <p class="indent">We then elaborated on all the <span class="FontName2">Map</span> types, explaining how combinations of basic, embeddable, and entity types can be used as keys and values. We experimented with and showed examples of using many of the different combinations of key and value types, illustrating how each changed the way the collection was mapped. We then outlined, in list form, the basic rules of using a <span class="FontName2">Map</span> type.</p>
        <p class="indent">We finished off collections by looking at the corner cases of adding duplicates and null values to collections and outlined the cases when support might be reasonable. Some best practices and practical guidance to using collections followed.</p>
        <p class="indent">The next chapter will discuss using entity managers and persistence contexts in more advanced ways than we did previously, delving into the practices and nuances of injecting and using them in Java EE and Java SE environments.</p>
        <p class="FootNote"><a id="Fn1" href="#_Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a> Assuming that the collection was not returned from a second level shared cache.</p>
        <p class="FootNote"><a id="Fn2" href="#_Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> See the javadoc for java.util.Map for more details.</p>
        <p class="FootNote"><a id="Fn3" href="#_Fn3" target="_blank" rel="noopener noreferrer"><sup>3</sup></a> The <span class="FontName2">&#64;MapKey</span> annotation is still required, however; otherwise, the <span class="FontName2">&#64;MapKeyColumn</span> defaults would apply.</p>
      </div>
    </div>
  </div>
</div>
<div class="accordion accordion-flush">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#jpa-advanced-object-relational-mapping" aria-expanded="false" aria-controls="jpa-advanced-object-relational-mapping">
        JPA - Advanced Object-Relational Mapping (from the book Pro JPA 2, 2nd Edition)
      </button>
    </h2>
    <div id="jpa-advanced-object-relational-mapping" class="accordion-collapse collapse pro-jpa-2">
      <p class="ChapterNumber"><a id="Chap_10" target="_blank" rel="noopener noreferrer"></a>CHAPTER 10</p>
      <p class="chapimage"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/frontdot.jpg" alt="image" width="82" height="25"></p>
      <p class="ChapterTitle">Advanced Object-Relational Mapping<a id="cXXX.634" target="_blank" rel="noopener noreferrer"></a></p>
      <div>
        <p class="noindent">Every application is different, and, while most have some elements of complexity in them, the difficult parts in one application will tend to be different than those in other types of applications. Chances are that whichever application you are working on at any given time will need to make use of at least one advanced feature of the API. This chapter will introduce and explain some of these more advanced ORM<a id="cXXX.684a" target="_blank" rel="noopener noreferrer"></a> features.</p>
        <p class="indent">Many of the features in this chapter are targeted at applications that need to reconcile the differences between an existing data model and an object model. For example, when the data in an entity table would be better decomposed in the object model as an entity and a dependent object that is referenced by the entity, then the mapping infrastructure should be able to support that. Likewise, when the entity data is spread across multiple tables, the mapping layer should allow for this kind of configuration to be specified.</p>
        <p class="indent">There has been no shortage of discussion in this book about how entities in JPA are just regular Java classes and not special objects that are required to extend a specific subclass or implement special methods. One of the benefits of entities being regular Java classes is that they can adhere to already established concepts and practices that exist in object-oriented systems. One of the traditional object-oriented innovations is the use of inheritance and creating objects in a hierarchy in order to inherit state and behavior.</p>
        <p class="indent">This chapter will discuss some of the more advanced mapping features and delve into the diverse possibilities offered by the API and the mapping layer. We will also see how inheritance works within the framework of the Java Persistence API and how it affects the model.</p>
        <p class="Heading1" id="Sec1">Table and Column Names<a id="cXXX.635" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In previous sections, we have shown the names of tables and columns as uppercase identifiers. We did this, first, because it helps differentiate them from Java identifiers and, second, because the SQL standard defines that undelimited database identifiers do not respect case, and most tend to display them in uppercase.</p>
        <p class="indent">Anywhere a table or column name is specified, or is defaulted, the identifier string is passed through to the JDBC driver exactly as it is specified, or defaulted. For example, when no table name is specified for the <span class="FontName2">Employee</span> entity, then the name of the table assumed and used by the provider will be <span class="FontName2">Employee</span>, which by SQL definition is no different from <span class="FontName2">EMPLOYEE</span>. The provider is neither required nor expected to do anything to try to adjust the identifiers before passing them to the database driver.</p>
        <p class="indent">The following annotations should, therefore, be equivalent in that they refer to the same table in a SQL standard compliant database:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Table(name="employee")</span><br><span class="FontName2">&#64;Table(name="Employee")</span><br><span class="FontName2">&#64;Table(name="EMPLOYEE")</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Some database names are intended to be case-specific and must be explicitly delimited. For example, a table might be called <span class="FontName2">EmployeeSales</span>, but without case distinction would become <span class="FontName2">EMPLOYEESALES</span>, clearly less readable and harder to ascertain its meaning. While it is by no means common, or good practice, a database in theory could have an <span class="FontName2">EMPLOYEE</span> table as well as an <span class="FontName2">Employee</span> table. These would need to be delimited in order to distinguish between the two. The method of delimiting is the use of a second set of double quotes, which must be escaped, around the identifier. The escaping mechanism is the backslash (the \ character), which would cause the following annotations to refer to different tables:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Table(name="\"Employee\"")</span><br><span class="FontName2">&#64;Table(name="\"EMPLOYEE\"")</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Notice that the outer set of double quotes is just the usual delimiter of strings in annotation elements, but the inner double quotes are preceded by the backslash to cause them to be escaped, indicating that they are part of the string, not string terminators.</p>
        <p class="indent">When using an XML mapping file, the identifier is also delimited by including quotes in the identifier name. For example, the following two elements represent different columns:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&lt;column name="&amp;quot;ID&amp;quot;"/&gt;</span><br><span class="FontName2">&lt;column name="&amp;quot;Id&amp;quot;"/&gt;</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">The method of XML escaping is different than the one used in Java. Instead of using the backslash, XML escapes with an ampersand (&amp;) character followed by a word describing the specific thing being escaped (in this case, ‚Äúquot‚Äù) and finally a trailing semicolon (;) character.</p>
        <div class="notepara">
          <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Some vendors support features to normalize the case of the identifiers that are stored and passed back and forth between the provider and the JDBC driver. This works around certain JDBC drivers that, for example, accept uppercase identifiers in the native SQL query select statement, but pass them back mapped to lowercase identifiers.</p>
        </div>
        <p class="indent">Sometimes the database is set to use case-specific identifiers, and it would become rather tedious (and look exceedingly ugly) to have to put the extra quotes on every single table and column name. If you find yourself in that situation, there is a convenience setting in the XML mapping file that will be of value to you.</p>
        <p class="indent">By including the empty <span class="FontName2">delimited-identifiers</span> element in the XML mapping file, all identifiers in the persistence unit will be treated as delimited, and quotes will be added to them when they are passed to the driver. The only catch is that there is no way to override this setting. Once the <span class="FontName2">delimited-identifiers</span> flag is turned on, all identifiers must be specified exactly as they exist in the database. Furthermore, if you decide to turn on the <span class="FontName2">delimited-identifiers</span> option, make sure you remove any escaped quotes in your identifier names or you will find that they will be included in the name. Using escaping in addition to the delimited identifiers option will take the escaped quotes and wrap them with further quotes, making the escaped ones become part of the identifier.</p>
        <p class="Heading1" id="Sec2">Converting Entity State<a id="cXXX.636" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.636a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">Back in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> we showed some of the ways that specific kinds of data, such as enumerated types, temporal types, and large objects, can be stored in the database. However, it would be impractical to define targeted support for each and every kind of data that is not a primitive, particularly because there will always be some application that wants to store the data in a new and different way, or is forced to do so because of a legacy database. Furthermore, an application might define its own set of types that the specification could clearly never predict. A more flexible and scalable solution, therefore, is to devise a way that enables the application to define its own conversion strategy for whatever type it deems necessary to convert. This is made possible through the use of converters.</p>
        <div class="notepara">
          <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Converters were added to the JPA 2.1 specification.</p>
        </div>
        <div>
          <p id="Sec3" class="Heading2">Creating a Converter<a id="cXXX.637" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">A converter is a application-specified class that implements the <span class="FontName2">AttributeConverter&lt;X,Y&gt;</span> interface. It can be declaratively applied to persistent attributes in any entity, mapped superclass, or embeddable class to control how the state of the attribute is stored in the database. It similarly defines how the state is converted from the database back into the object. These two conversion operations comprise the two methods of the <span class="FontName2">AttributeConverter&lt;X,Y&gt;</span> interface, shown in <a href="#list1" id="_list1" target="_blank" rel="noopener noreferrer">Listing 10-1</a>.</p>
          <p class="noindent2"><a href="#_list1" id="list1" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-1.</i></b></a>&nbsp;&nbsp;AttributeConverter Interface<a id="cXXX.638" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public interface AttributeConverter&lt;X,Y&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Y convertToDatabaseColumn (X attribute);</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public X convertToEntityAttribute (Y dbData);</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that the interface should be defined with two type parameters. The first type parameter represents the type of the entity attribute while the second represents the JDBC type to be used when storing the data in the database column. A sample converter implementation class is shown in <a href="#list2" id="_list2" target="_blank" rel="noopener noreferrer">Listing 10-2</a>. It illustrates a simple converter needed to store a boolean entity attribute as an integer in the database.</p>
          <p class="noindent2"><a href="#_list2" id="list2" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-2.</i></b></a>&nbsp;&nbsp;Boolean-to-Integer Converter<a id="cXXX.639" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Converter</span><br><span class="FontName2">public class BooleanToIntegerConverter&nbsp;&nbsp;implements AttributeConverter&lt;Boolean,Integer&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Integer convertToDatabaseColumn (Boolean attrib) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (attrib ? 1 : 0);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Boolean convertToEntityAttribute (Integer dbData) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (dbData &gt; 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;There is currently only support to convert an entity attribute to a single column in the database. The ability to store it across multiple columns may be standardized in a future release.</p>
          </div>
          <p class="indent">The converter class is annotated so that the container can detect and validate it. The conversion methods are trivial in this case because the conversion process is such a simple one, but the conversion logic could be more extensive if more was needed.</p>
          <p class="indent">Converters can be used for explicit or automatic conversion of basic state, as the following sections describe.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Converters are <i>managed classes</i>, hence when running in Java SE each converter class should be included in a <span class="FontName2">class</span> element in the <span class="FontName2">persistence.xml</span> descriptor.</p>
          </div>
        </div>
        <div>
          <p id="Sec4" class="Heading2">Declarative Attribute Conversion<a id="cXXX.642a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">A converter can be used explicitly to convert an entity attribute by annotating the attribute with <span class="FontName2">&#64;Convert</span> and setting the <span class="FontName2">converter</span> element to the converter class. For example, if we had a <span class="FontName2">Boolean</span> attribute named ‚Äúbonded‚Äù in our <span class="FontName2">Employee</span> entity, it could be converted to an <span class="FontName2">Integer</span> in the mapped database column if we annotated the attribute with <span class="FontName2">&#64;Convert</span> and specified the converter class declared in the previous section:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class)</span><br><span class="FontName2">private Boolean bonded;</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The attribute being converted should be of the correct type. Since the first parameterized type of the converter is <span class="FontName2">Boolean</span>, the attribute we are converting should be of type <span class="FontName2">Boolean</span>. However, wrapper and primitive types are autoboxed during conversion, so the attribute could also have been of type <span class="FontName2">boolean</span>.</p>
          <div>
            <p id="Sec5" class="Heading3">Converting Embedded Attributes<a id="cXXX.640" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">If the attribute to be converted is part of an embeddable type and we are converting it from within a referencing entity, then we use the <span class="FontName2">attributeName</span> element to specify the attribute to convert. For example, if the <span class="FontName2">bonded</span> attribute from above was contained within a <span class="FontName2">SecurityInfo</span> embeddable object and the <span class="FontName2">Employee</span> entity had a <span class="FontName2">securityInfo</span> attribute, then we could convert it as in <a href="#list3" id="_list3" target="_blank" rel="noopener noreferrer">Listing 10-3</a>:</p>
            <p class="noindent2"><a href="#_list3" id="list3" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-3.</i></b></a>&nbsp;&nbsp;Converting an Embedded Attribute</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class, attributeName="bonded")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private SecurityInfo securityInfo;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class SecurityInfo {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Boolean bonded;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">In the ‚ÄúComplex Embedded Objects‚Äù section later in this chapter we will describe more advanced usages of embeddables; in particular, the dot notation will be shown as a means to override nested embeddables. This same notation may also be used in the <span class="FontName2">attributeName</span> of the <span class="FontName2">&#64;Convert</span> annotation<a id="cXXX.641" target="_blank" rel="noopener noreferrer"></a> to reference a nested embedded attribute.</p>
          </div>
          <div>
            <p id="Sec6" class="Heading3">Converting Collections<a id="cXXX.642" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">In <a href="9781430249269_Ch05.xhtml" target="_blank" rel="noopener noreferrer">Chapter 5</a> we showed that collections may be mapped as element collections if the values are a basic or embeddable type, or mapped as one-to-many or many-to-many relationships if the values are an entity type. Converters may be applied to element collections but since converters do not convert entity instances they may not, in general, be applied to relationship mappings.<a id="_Fn1" href="#Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a></p>
            <p class="indent">Element collections of basic types are simple to convert. They are annotated the same way as basic attributes that are not collections. Thus, if we had an attribute that was of type <span class="FontName2">List&lt;Boolean&gt;</span>, we would annotate it just as we did our <span class="FontName2">bonded</span> attribute above, and all of the boolean values in the collection would be converted:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;ElementCollection</span><br><span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class)</span><br><span class="FontName2">private List&lt;Boolean&gt; securityClearances;</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">If an element collection is a <span class="FontName2">Map</span> with values that are of a basic type, then the values of the <span class="FontName2">Map</span> will be converted. To perform conversion on the keys, the <span class="FontName2">attributeName</span> element should be used with a special value of ‚Äúkey‚Äù to indicate that the keys of the <span class="FontName2">Map</span> are to be converted instead of the values.</p>
            <p class="indent">Recall from the ‚ÄúOverriding Embeddable Attributes‚Äù section in <a href="9781430249269_Ch05.xhtml" target="_blank" rel="noopener noreferrer">Chapter 5</a> that if we had an element collection that was a <span class="FontName2">Map</span>, and it contained embeddables, then we prefixed the <span class="FontName2">name</span> element of <span class="FontName2">&#64;AttributeOverride</span> with ‚Äúkey.‚Äù or ‚Äúvalue‚Äù. This was to distinguish whether we were overriding the column for an embeddable key or value of the <span class="FontName2">Map</span>. Similarly, if we want to convert an embeddable attribute in a <span class="FontName2">Map</span>, then we would prefix the <span class="FontName2">attributeName</span> element with ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù followed by the name of the embeddable attribute to be converted. As a special case, we can use the ‚Äúkey‚Äù or ‚Äúkey.‚Äù prefix on either of the one-to-many or many-to-many collection relationships to map the keys if they are basic or embeddable types, respectively. Using the domain model in <a href="9781430249269_Ch05.xhtml#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, if we wanted to convert the employee last name to be stored as uppercase characters (assuming we have defined the corresponding converter class), we would annotate the attribute as shown in <a href="#list4" id="_list4" target="_blank" rel="noopener noreferrer">Listing 10-4</a>:</p>
            <p class="noindent2"><a href="#_list4" id="list4" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-4.</i></b></a>&nbsp;&nbsp;Converting an Embeddable Attribute Key in a Relationship Map</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Convert(converter=UpperCaseConverter.class, attributeName="key.lastName")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec7" class="Heading3">Limitations<a id="cXXX.643" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">There are a few restrictions placed on converters, mostly to prevent users from doing things that would get them into trouble. For instance, converters cannot be used on identifier attributes, version attributes, or relationship attributes (unless you are converting the key part of a relationship <span class="FontName2">Map</span>, as in <a href="#list4" target="_blank" rel="noopener noreferrer">Listing 10-4</a>). Hopefully this will not come as a surprise to you, since in most cases converting these types of attributes would arguably be a pretty bad idea. These attributes are heavily used by the provider as it manages the entities; changing their shape or even their value could cause inconsistencies or incorrect results.</p>
            <p class="indent">Converters also cannot be used on attributes annotated with <span class="FontName2">&#64;Enumerated</span> or <span class="FontName2">&#64;Temporal</span>, but that doesn't mean you can't convert enumerated types or temporal types. It just means that if you use the standard <span class="FontName2">&#64;Enumerated</span> or <span class="FontName2">&#64;Temporal</span> annotations to map those types, then you also cannot use custom converters. If you are using a custom converter class, then you are taking over control of the value that gets stored and there is no need for you to use any of those annotations to get the JPA provider to do the conversion for you. Put simply, if you are doing custom conversion using converters on enumerated or temporal types, just leave the <span class="FontName2">&#64;Enumerated</span><a id="cXXX.644" target="_blank" rel="noopener noreferrer"></a> or <span class="FontName2">&#64;Temporal</span> annotations<a id="cXXX.645" target="_blank" rel="noopener noreferrer"></a> off.</p>
          </div>
        </div>
        <div>
          <p id="Sec8" class="Heading2">Automatic Conversion<a id="cXXX.646" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">When we defined a converter to convert a boolean to an integer, we likely had in mind that it would be used in very specific places, on one or possibly a few attributes. You generally don't want to convert every boolean attribute in your domain to an integer. However, if you frequently use a more semantically rich data type, such as the <span class="FontName2">URL</span> class, then you might want every attribute of that type to be converted. You can do this by setting the <span class="FontName2">autoApply</span> option on the <span class="FontName2">&#64;Converter</span> annotation<a id="cXXX.647" target="_blank" rel="noopener noreferrer"></a>. In <a href="#list5" id="_list5" target="_blank" rel="noopener noreferrer">Listing 10-5</a>, a <span class="FontName2">URL</span> converter is declared with the <span class="FontName2">autoApply</span> option enabled. This will cause every persistent attribute of type <span class="FontName2">URL</span> in the persistence unit to be converted to a string when the entity that contains it is written to the database.</p>
          <p class="noindent2"><a href="#_list5" id="list5" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-5.</i></b></a>&nbsp;&nbsp;URL-to-String Converter<a id="cXXX.648" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Converter(autoApply=true)</span><br><span class="FontName2">public class URLConverter implements AttributeConverter&lt;URL,String&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String convertToDatabaseColumn (URL attrib) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return attrib.toString();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public URL convertToEntityAttribute (String dbData) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return new URL(dbData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;It is undefined if two converters are declared to be auto-applied to the same attribute type.</p>
          </div>
          <p class="indent">We can override the conversion on a per-attribute basis. If, instead of the auto-applied converter, we want to use a different converter for a given attribute, then we can annotate the attribute with the <span class="FontName2">&#64;Convert</span> annotation and specify the converter class we want to use. Alternatively, if we want to disable the conversion altogether and let the provider revert to serialization of the URL, then we can use the <span class="FontName2">disableConversion</span> attribute:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Convert(disableConversion=true)</span><br><span class="FontName2">URL homePage;</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec9" class="Heading2">Converters and Queries<a id="cXXX.649" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Defining the converters and configuring which attributes to convert is pretty much all you need to do to get conversion to work. But there are a couple of additional points related to conversion that you should be aware of when querying.</p>
          <p class="indent">The first is that the query processor will apply the converter to both the attributes targeted for conversion as well as the literals they are being compared against in a query. However, the operators are not modified. This means that only certain comparison operators will work once the query is converted. To illustrate this point, consider the following query:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">SELECT e FROM Employee e WHERE e.bonded = true</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">This query will work fine if <span class="FontName2">bonded</span> is set to be converted from boolean to integer. The generated SQL will have converted both the <span class="FontName2">bonded</span> attribute and the literal ‚Äútrue‚Äù to the corresponding integer by invoking the <span class="FontName2">convertToDatabaseColumn()</span> method on it and the equals operator will work just as well on integers as it does on booleans.</p>
          <p class="indent">However, we may want to query for all of the employees who are not bonded:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">SELECT e FROM Employee e WHERE NOT e.bonded</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">If we try to execute this query the parser will have no problem with it, but when it comes time to execute it the resulting SQL will contain a <span class="FontName2">NOT</span> and the value of <span class="FontName2">e.bonded</span> will have been converted to be an integer. This will generally cause a database exception since the <span class="FontName2">NOT</span> operation cannot be applied to an integer.</p>
          <p class="indent">It is possible that you will bump into an issue or two if you do any significant querying across converted attributes. While you can usually rely on conversion of literals and input parameters used in comparison, if they are contained within a function, such as <span class="FontName2">UPPER()</span> or <span class="FontName2">MOD()</span>, they probably will not be converted. Even some of the more advanced comparison operations, such as <span class="FontName2">LIKE</span>, may not apply conversion to the literal operand. The moral is to try not to use converted attributes in queries, and if you do, play around and do some experimenting to make sure your queries work as expected.</p>
        </div>
        <p id="Sec10" class="Heading1">Complex Embedded Objects<a id="cXXX.650a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we looked at embedding objects within entities, and how an embedded object becomes part of, and dependent upon, the entity that embeds it. We will now explain how more can be done with embedded objects, and how they can contain more than just basic mappings.</p>
        <div>
          <p id="Sec11" class="Heading2">Advanced Embedded Mappings</p>
          <p class="noindent">Embedded objects can embed other objects, have element collections of basic or embeddable types, and have relationships to entities. This is all possible under the assumption that objects embedded within other embedded objects are still dependent upon the embedding entity. Similarly, when bidirectional relationships<a id="cXXX.650" target="_blank" rel="noopener noreferrer"></a> exist within an embedded object, they are treated as though they exist in the owning entity, and the target entity points back to the owning entity, not to the embedded object.</p>
          <p class="indent">As an example, let's bring back our <span class="FontName2">Employee</span> and embedded <span class="FontName2">Address</span> objects from <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> and update the model just a little bit. Insert a <span class="FontName2">ContactInfo</span> object<a id="cXXX.651" target="_blank" rel="noopener noreferrer"></a>, containing the address plus the phone information, into each employee. Instead of having an <span class="FontName2">address</span> attribute, our <span class="FontName2">Employee</span> entity would now have an attribute named <span class="FontName2">contactInfo</span>, of type <span class="FontName2">ContactInfo</span>, annotated with <span class="FontName2">&#64;Embedded</span>. The model is shown in <a href="#Fig1" id="_Fig1" target="_blank" rel="noopener noreferrer">Figure 10-1</a>.</p>
          <div class="Figure" id="Fig1">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-01.jpg" alt="9781430249269_Fig10-01.jpg" width="673" height="306"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig1" target="_blank" rel="noopener noreferrer">Figure 10-1</a>. </span>Nested embeddables with relationships</p>
          </div>
          <p class="indent">The <span class="FontName2">ContactInfo</span> clas<a id="cXXX.652" target="_blank" rel="noopener noreferrer"></a>s contains an embedded object, as well as some relationships, and would be annotated as shown in <a href="#list6" id="_list6" target="_blank" rel="noopener noreferrer">Listing 10-6</a>.</p>
          <p class="noindent2"><a href="#_list6" id="list6" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-6.</i></b></a>&nbsp;&nbsp;Embeddable ContactInfo Class<a id="cXXX.653" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Embeddable &#64;Access(AccessType.FIELD)</span><br><span class="FontName2">public class ContactInfo {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Address residence;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="PRI_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Phone primaryPhone;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany &#64;MapKey(name="type")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="EMP_PHONES")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Phone&gt; phones;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The <span class="FontName2">Address</span> class remains the same as in <a href="9781430249269_Ch04.xhtml#list26" target="_blank" rel="noopener noreferrer">Listing 4-26</a>, but we have added more depth to our contact information. Within the <span class="FontName2">ContactInfo</span> embeddable, we have the address as a nested embedded object, but we also have an additional unidirectional relationship to the phone number serving as the primary contact number. A bidirectional many-to-many relationship to the employee's phone numbers would have a default join table named <span class="FontName2">EMPLOYEE_PHONE</span>, and on the <span class="FontName2">Phone</span> side the relationship attribute would refer to a list of <span class="FontName2">Employee</span> instances, with the <span class="FontName2">mappedBy</span> element being the qualified name of the embedded relationship attribute. By qualified, we mean that it must first contain the attribute within <span class="FontName2">Employee</span> that contains the embeddable, as well as a dot separator character (.) and the relationship attribute within the embeddable. <a href="#list7" id="_list7" target="_blank" rel="noopener noreferrer">Listing 10-7</a> shows the <span class="FontName2">Phone</span> class and its mapping back to the <span class="FontName2">Employee</span> entity.</p>
          <p class="noindent2"><a href="#_list7" id="list7" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-7.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Phone</span> Class<a id="cXXX.654" target="_blank" rel="noopener noreferrer"></a> Referring To Embedded Attribute</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Phone {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String num;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany(mappedBy="contactInfo.phones")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Employee&gt; employees;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String type;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">A proviso about embeddable types is that if an embedded object is a part of an element collection, then the embedded object in the collection can only include mappings where the foreign key is stored in the source table. It can contain owned relationships, such as one-to-one and many-to-one, but it cannot contain one-to-many or many-to-many relationships where the foreign key is in either the target table or a join table<a id="cXXX.695" target="_blank" rel="noopener noreferrer"></a>. Similarly, it can't contain other collection table-based mappings like element collections.</p>
        </div>
        <div>
          <p id="Sec12" class="Heading2">Overriding Embedded Relationships</p>
          <p class="noindent">When we first introduced embeddables back in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we showed how embeddable types could be reused by being embedded within multiple entity classes. Even though the state is mapped within the embeddable, the embedding entity can override those mappings by using <span class="FontName2">&#64;AttributeOverride</span> to redefine how the embedded state is mapped within that particular entity table. Now that we are using relationships within embeddables, <span class="FontName2">&#64;AttributeOverride</span> does not suffice. To override how a relationship is mapped, we need to use <span class="FontName2">&#64;AssociationOverride</span>, which provides us with the ability to override relationship<a id="cXXX.655" target="_blank" rel="noopener noreferrer"></a> join columns and join tables.</p>
          <p class="indent">Before we look at an example of overriding an embeddable with a relationship in it, let's first think about the reusability of such an object. If a relationship from entity A to entity B is defined within the embeddable of type E, then either the relationship is owned by A and the foreign key is in the table corresponding to A (or in a join table owned by A), or it is owned by B and the foreign key is going to be in B's table (or a join table owned by B). If it is owned by B, then the foreign key will be to A's table, and there would be no way to use E in any other entity because the foreign key would be to the wrong table. Similarly, if the relationship was bidirectional, then the attribute in B would be of type A (or a collection of A) and could not refer to an object of some other type. It can be understood, therefore, that only embeddables with relationships that are owned by the source entity, A, and that are unidirectional, can be reused in other entities.</p>
          <p class="indent">Suppose the many-to-many relationship in <span class="FontName2">ContactInfo</span> was unidirectional and <span class="FontName2">Phone</span> didn't have a reference back to the <span class="FontName2">Employee</span> that embedded the <span class="FontName2">ContactInfo</span>. We might want to embed instances of <span class="FontName2">ContactInfo</span> within a <span class="FontName2">Customer</span> entity as well. The <span class="FontName2">CUSTOMER</span> table, however, might have a <span class="FontName2">PRI_CONTACT</span> foreign key column instead of <span class="FontName2">PRI_NUM</span>, and of course we would not be able to share the same join table for both <span class="FontName2">Employee</span> and <span class="FontName2">Customer</span> relationships to the <span class="FontName2">Phone</span>. The resulting <span class="FontName2">Customer</span> class is shown in <a href="#list8" id="_list8" target="_blank" rel="noopener noreferrer">Listing 10-8</a>.</p>
          <p class="noindent2"><a href="#_list8" id="list8" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-8.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Customer</span> Class Embedding <span class="FontName2">ContactInfo</span></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Customer {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="address.zip", column=&#64;Column(name="ZIP"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverride(name="primaryPhone",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="EMERG_PHONE")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverride(name="phones",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinTable=&#64;JoinTable(name="CUST_PHONE"))})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private ContactInfo contactInfo;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We can override the <span class="FontName2">zip</span> attribute in the address that is embedded within <span class="FontName2">contactInfo</span> by using <span class="FontName2">&#64;AttributeOverride</span> and navigating to the attribute in the nested embedded <span class="FontName2">Address</span> object.</p>
          <p class="indent">Because we are overriding two associations we need to use the plural variant of <span class="FontName2">&#64;AssociationOverrides</span>. Note that if there had not been a join table explicitly specified for the <span class="FontName2">phones</span> attribute, then the default join table name would have been different depending upon which entity was embedding the <span class="FontName2">ContactInfo</span>. Since the default name is composed partly of the name of the owning entity, the table joining the <span class="FontName2">Employee</span> entity to the <span class="FontName2">Phone</span> entity would have defaulted to <span class="FontName2">EMPLOYEE_PHONE</span>, whereas in <span class="FontName2">Customer</span> the join table would have defaulted to <span class="FontName2">CUSTOMER_PHONE</span>.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;There is currently no way to override the collection table for an element collection in an embeddable.</p>
          </div>
        </div>
        <p class="Heading1" id="Sec13">Compound Primary Keys<a id="cXXX.656a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.656" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In some cases, an entity needs to have a primary key or identifier that is composed of multiple fields, or from the database perspective the primary key in its table is made up of multiple columns. This is more common for legacy databases and also occurs when a primary key is composed of a relationship, a topic that we will discuss later in this chapter.</p>
        <p class="indent">There are two options available for having compound primary keys in an entity, depending on how the entity class is structured. Both of them require the use of a separate class containing the primary key fields called a primary key class; the difference between the two options is determined by what the entity class contains.</p>
        <p class="indent">Primary key classes must include method definitions for <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> in order to be able to be stored and keyed on by the persistence provider, and their fields or properties must be in the set of valid identifier types listed in the previous chapter. They must also be public, implement <span class="FontName2">Serializable</span>, and have a no-arg constructor.</p>
        <p class="indent">As an example of a compound primary key, we will look at the <span class="FontName2">Employee</span> entity<a id="cXXX.657" target="_blank" rel="noopener noreferrer"></a> again, only this time the employee number is specific to the country where he works. Two employees in different countries can have the same employee number, but only one can be used within any given country. <a href="#Fig2" id="_Fig2" target="_blank" rel="noopener noreferrer">Figure 10-2</a> shows the <span class="FontName2">EMPLOYEE</span> table structured with a compound primary key to capture this requirement. Given this table definition, we will now look at how to map the <span class="FontName2">Employee</span> entity using the two different styles of primary key class.</p>
        <div class="Figure" id="Fig2">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-02.jpg" alt="9781430249269_Fig10-02.jpg" width="196" height="206"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig2" target="_blank" rel="noopener noreferrer">Figure 10-2</a>. </span>EMPLOYEE table with a compound primary key</p>
        </div>
        <div>
          <p id="Sec14" class="Heading2">Id Class<a id="cXXX.658" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The first and most basic type of primary key class is an id class. Each field of the entity that makes up the primary key is marked with the <span class="FontName2">&#64;Id</span> annotation. The primary key class is defined separately and associated with the entity by using the <span class="FontName2">&#64;IdClass</span> annotation on the entity class definition. <a href="#list9" id="_list9" target="_blank" rel="noopener noreferrer">Listing 10-9</a> demonstrates an entity with a compound primary key that uses an id class. The accompanying id class is shown in <a href="#list10" id="_list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a>.</p>
          <p class="noindent2"><a href="#_list9" id="list9" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-9.</i></b></a>&nbsp;&nbsp;Using an Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The primary key class must contain fields or properties that match the primary key attributes in the entity in both name and type. <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a> shows the <span class="FontName2">EmployeeId</span> primary key class. It has two fields, one to represent the country and one to represent the employee number. We have also supplied <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> methods to allow the class to be used in sorting and hashing operations.</p>
          <p class="noindent2"><a href="#_list10" id="list10" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-10.</i></b></a>&nbsp;&nbsp;The <span class="FontName2">EmployeeId</span> Id Class<a id="cXXX.659" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public class EmployeeId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String getCountry() { return country; }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int getId() { return id; }</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public boolean equals(Object o) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return ((o instanceof EmployeeId) &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">country.equals(((EmployeeId)o).getCountry()) &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">id == ((EmployeeId)o).getId());</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int hashCode() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return country.hashCode() + id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that there are no setter methods on the <span class="FontName2">EmployeeId</span> class. Once it has been constructed using the primary key values, it can't be changed. We do this to enforce the notion that a primary key value cannot be changed, even when it is made up of multiple fields. Because the <span class="FontName2">&#64;Id</span> annotation was placed on the fields of the entity, the provider will also use field access when it needs to work with the primary key class.</p>
          <p class="indent">The id class is useful as a structured object that encapsulates all of the primary key information. For example, when doing a query based upon the primary key, such as the <span class="FontName2">find()</span> method of the <span class="FontName2">EntityManager</span> interface, an instance of the id class can be used as an argument instead of some unstructured and unordered collection of primary key data. <a href="#list11" id="_list11" target="_blank" rel="noopener noreferrer">Listing 10-11</a> shows a code snippet that searches for an <span class="FontName2">Employee</span> with a given country name and employee number. A new instance of the <span class="FontName2">EmployeeId</span> class is constructed using the method arguments and then used as the argument to the <span class="FontName2">find()</span> method.</p>
          <p class="noindent2"><a href="#_list11" id="list11" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-11.</i></b></a>&nbsp;&nbsp;Invoking a Primary Key Query on an Entity with an Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">EmployeeId id = new EmployeeId(country, id);</span><br><span class="FontName2">Employee emp = em.find(Employee.class, id);</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Because the argument to <span class="FontName2">find()</span> is of type <span class="FontName2">Object</span>, vendors can support passing in simple arrays or collections of primary key information. Passing arguments that are not primary key classes is not portable.</p>
          </div>
        </div>
        <div>
          <p id="Sec15" class="Heading2">Embedded Id Class<a id="cXXX.660" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">An entity that contains a single field of the same type as the primary key class is said to use an embedded id class. The embedded id class is just an embedded object that happens to be composed of the primary key components. We use an <span class="FontName2">&#64;EmbeddedId</span> annotation to indicate that it is not just a regular embedded object but also a primary key class. When we use this approach, there are no <span class="FontName2">&#64;Id</span> annotations on the class, nor is the <span class="FontName2">&#64;IdClass</span> annotation used. You can think of <span class="FontName2">&#64;EmbeddedId</span> as the logical equivalent to putting both <span class="FontName2">&#64;Id</span> and <span class="FontName2">&#64;Embedded</span> on the field.</p>
          <p class="indent">Like other embedded objects, the embedded id class must be annotated with <span class="FontName2">&#64;Embeddable</span>, but the access type might differ from that of the entity that uses it. <a href="#list12" id="_list12" target="_blank" rel="noopener noreferrer">Listing 10-12</a> shows the <span class="FontName2">EmployeeId</span> class again, this time as an embeddable primary key class. The getter methods, <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> implementations are the same as the previous version from <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a>.</p>
          <p class="noindent2"><a href="#_list12" id="list12" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-12.</i></b></a>&nbsp;&nbsp;Embeddable Primary Key Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeId {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Using the embedded primary key class is no different than using a regular embedded type, except that the annotation used on the attribute is <span class="FontName2">&#64;EmbeddedId</span> instead of <span class="FontName2">&#64;Embedded</span>. <a href="#list13" id="_list13" target="_blank" rel="noopener noreferrer">Listing 10-13</a> shows the <span class="FontName2">Employee</span> entity adjusted to use the embedded version of the <span class="FontName2">EmployeeId</span> class. Note that since the column mappings are present on the embedded type, we do not specify the mapping for <span class="FontName2">EMP_ID</span> as was done in the case of the id class. If the embedded primary key class is used by more than one entity, then the <span class="FontName2">&#64;AttributeOverride</span> annotation can be used to customize mappings just as you would for a regular embedded type. To return the <span class="FontName2">country</span> and <span class="FontName2">id</span> attributes of the primary key from getter methods, we must delegate to the embedded id object to obtain the values.</p>
          <p class="noindent2"><a href="#_list13" id="list13" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-13.</i></b></a>&nbsp;&nbsp;Using an Embedded Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private EmployeeId id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = new EmployeeId(country, id);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String getCountry() { return id.getCountry(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int getId() { return id.getId(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We can create an instance of <span class="FontName2">EmployeeId</span> and pass it to the <span class="FontName2">find()</span> method just as we did for the id class example, but, if we want to create the same query using JP QL and reference the primary key, we have to traverse the embedded id class explicitly. <a href="#list14" id="_list14" target="_blank" rel="noopener noreferrer">Listing 10-14</a> shows this technique. Even though <span class="FontName2">id</span> is not a relationship, we still traverse it using the dot notation in order to access the members of the embedded class.</p>
          <p class="noindent2"><a href="#_list14" id="list14" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-14.</i></b></a>&nbsp;&nbsp;Referencing an Embedded Id Class in a Query</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public Employee findEmployee(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (Employee)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">em.createQuery("SELECT e " +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">"FROM Employee e " +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">"WHERE e.id.country = ?1 AND e.id.id = ?2")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.setParameter(1, country)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.setParameter(2, id)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.getSingleResult();</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The decision to use a single embedded identifier attribute or a group of identifier attributes, each mapped separately in the entity class, mostly comes down to personal preference. Some people like to encapsulate the identifier components into a single entity attribute of the embedded identifier class type. The trade-off is that it makes dereferencing a part of the identifier a little bit longer in code or in JP QL, although having helper methods, like those in <a href="#list13" target="_blank" rel="noopener noreferrer">Listing 10-13</a>, can help.</p>
          <p class="indent">If you access or set parts of the identifier individually, then it might make more sense to create a separate entity attribute for each of the constituent identifier parts. This presents a more representative model and interface for the separate identifier components. However, if most of the time you reference and pass around the entire identifier as an object, then you might be better off with an embedded identifier that creates and stores a single instance of the composite identifier.</p>
        </div>
        <p class="Heading1" id="Sec16">Derived Identifiers<a id="cXXX.661" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">When an identifier in one entity includes a foreign key to another entity, it's called a derived identifier. Because the entity containing the derived identifier depends upon another entity for its identity, the first is called the dependent entity<a id="cXXX.662" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.663" target="_blank" rel="noopener noreferrer"></a>. The entity that it depends upon is the target of a many-to-one or one-to-one relationship from the dependent entity, and is called the parent entity<a id="cXXX.664" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.665" target="_blank" rel="noopener noreferrer"></a>. <a href="#Fig3" id="_Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a> shows an example of a data model for the two kinds of entities, with <span class="FontName2">DEPARTMENT</span> table representing the parent entity and <span class="FontName2">PROJECT</span> table representing the dependent entity. Note that in this example there is an additional <span class="FontName2">name</span> primary key column in <span class="FontName2">PROJECT</span>, meaning that the corresponding <span class="FontName2">Project</span> entity has an identifier attribute that is not part of its relationship to <span class="FontName2">Department</span>.</p>
        <div class="Figure" id="Fig3">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-03.jpg" alt="9781430249269_Fig10-03.jpg" width="540" height="192"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>. </span>Dependent and parent entity tables</p>
        </div>
        <p class="indent">The dependent object cannot exist without a primary key, and since that primary key consists of the foreign key to the parent entity it should be clear that a new dependent entity cannot be persisted without the relationship to the parent entity being established. It is undefined to modify the primary key of an existing entity, thus the one-to-one or many-to-one relationship that is part of a derived identifier is likewise immutable and must not be reassigned to a new entity once the dependent entity has been persisted or already exists.</p>
        <p class="indent">We spent the last few sections discussing different kinds of identifiers, and you might think back to what you learned and realize that there are a number of different parameters that might affect how a derived identifier can be configured. For example, the identifier in either of the entities might be composed of one or a plurality of attributes. The relationship from the dependent entity to the parent entity might make up the entire derived identifier, or, as in <a href="#Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>, there might be additional state in the dependent entity that contributes to it. One of the entities might have a simple or compound primary key, and in the compound case might have an id class or an embedded id class. All of these factors combine to produce a multitude of scenarios, each of which requires slightly different configurations. The basic rules for derived identifiers are outlined first, with some more detailed descriptions in the following sections.</p>
        <div>
          <p id="Sec17" class="Heading2">Basic Rules<a id="cXXX.666" target="_blank" rel="noopener noreferrer"></a> for Derived Identifiers<a id="cXXX.679a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Most of the rules for derived identifiers can be summarized in a few general statements, although applying the rules together might not be quite as easy. We will go through some of the cases later to explain them, and even show an exception case or two to keep it interesting, but to lay the groundwork for those use cases the rules can be laid out as follows:</p>
          <ul class="bulleted">
            <li>A dependent entity might have multiple parent entities (i.e., a derived identifier might include multiple foreign keys).</li>
            <li>A dependent entity must have all its relationships to parent entities set before it can be persisted.</li>
            <li>If an entity class has multiple id attributes, then not only must it use an id class, but there must also be a corresponding attribute of the same name in the id class as each of the id attributes in the entity.</li>
            <li>Id attributes in an entity might be of a simple type, or of an entity type that is the target of a many-to-one or one-to-one relationship.</li>
            <li>If an id attribute in an entity is of a simple type, then the type of the matching attribute in the id class must be of the same simple type.</li>
            <li>If an id attribute in an entity is a relationship, then the type of the matching attribute in the id class is of the same type as the primary key type of the target entity in the relationship (whether the primary key type is a simple type, an id class, or an embedded id class).</li>
            <li>If the derived identifier of a dependent entity is in the form of an embedded id class, then each attribute of that id class that represents a relationship should be referred to by a <span class="FontName2">&#64;MapsId</span> annotation on the corresponding relationship attribute.</li>
          </ul>
          <p class="indent">The following sections describe how these rules may be applied.</p>
        </div>
        <div>
          <p id="Sec18" class="Heading2">Shared Primary Key</p>
          <p class="noindent">A simple, if somewhat less common case, is when the derived identifier is composed of a single attribute<a id="cXXX.667" target="_blank" rel="noopener noreferrer"></a> that is the relationship foreign key. As an example, suppose there was a bidirectional one-to-one relationship between <span class="FontName2">Employee</span> and <span class="FontName2">EmployeeHistory</span> entities. Because there is only ever one <span class="FontName2">EmployeeHistory</span> per <span class="FontName2">Employee</span>, we might decide to share the primary key. In <a href="#list15" id="_list15" target="_blank" rel="noopener noreferrer">Listing 10-15</a>, if the <span class="FontName2">EmployeeHistory</span> is the dependent entity, then we indicate that the relationship foreign key is the identifier by annotating the relationship with <span class="FontName2">&#64;Id</span>.</p>
          <p class="noindent2"><a href="#_list15" id="list15" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-15.</i></b></a>&nbsp;&nbsp;Derived Identifier with Single Attribute</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class EmployeeHistory {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The primary key type of <span class="FontName2">EmployeeHistory</span> is going to be of the same type as <span class="FontName2">Employee</span>, so if <span class="FontName2">Employee</span> has a simple integer identifier<a id="cXXX.668" target="_blank" rel="noopener noreferrer"></a> then the identifier of <span class="FontName2">EmployeeHistory</span> is also going to be an integer. If <span class="FontName2">Employee</span> has a compound primary key, either with an id class or an embedded id class, then <span class="FontName2">EmployeeHistory</span> is going to share the same id class (and should also be annotated with the <span class="FontName2">&#64;IdClass</span> annotation). The problem is that this trips over the id class rule that there should be a matching attribute in the entity for each attribute in its id class. This is the exception to the rule, because of the very fact that the id class is shared between both parent and dependent entities.</p>
          <p class="indent">Occasionally, somebody might want the entity to contain a primary key attribute as well as the relationship attribute, with both attributes mapped to the same foreign key column in the table. Even though the primary key attribute is unnecessary in the entity, some people might want to define it separately for easier access. Despite the fact that the two attributes map to the same foreign key column (which is also the primary key column), the mapping does not have to be duplicated in both places. The <span class="FontName2">&#64;Id</span> annotation is placed on the identifier attribute and <span class="FontName2">&#64;MapsId</span> annotates the relationship attribute to indicate that it is mapping the id attribute as well. This is shown in <a href="#list16" id="_list16" target="_blank" rel="noopener noreferrer">Listing 10-16</a>. Note that physical mapping annotations (e.g. <span class="FontName2">&#64;Column</span>) should not be specified on the <span class="FontName2">empId</span> attribute since <span class="FontName2">&#64;MapsId</span> is indicating that the relationship attribute is where the mapping occurs.</p>
          <p class="noindent2"><a href="#_list16" id="list16" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-16.</i></b></a>&nbsp;&nbsp;Derived Identifier with Shared Mappings<a id="cXXX.669" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class EmployeeHistory {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">int empId;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapsId</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">There are a couple of additional points worth mentioning about <span class="FontName2">&#64;MapsId</span>, before we move on to derived identifiers with multiple mapped attributes.</p>
          <p class="indent">The first point is really a logical follow-on to the fact that the relationship annotated with <span class="FontName2">&#64;MapsId</span> defines the mapping for the identifier attribute as well. If there is no overriding <span class="FontName2">&#64;JoinColumn</span> annotation<a id="cXXX.670" target="_blank" rel="noopener noreferrer"></a> on the relationship attribute, then the join column will be defaulted according to the usual defaulting rules. If this is the case, then the identifier attribute will also be mapped to that same default. For example, if the <span class="FontName2">&#64;JoinColumn</span> annotation was removed from <a href="#list16" target="_blank" rel="noopener noreferrer">Listing 10-16</a> then both the <span class="FontName2">employee</span> and the <span class="FontName2">empId</span> attributes would be mapped to the default <span class="FontName2">EMPLOYEE_ID</span> foreign key column (assuming the primary key column in the <span class="FontName2">EMPLOYEE</span> table was <span class="FontName2">ID</span>).</p>
          <p class="indent">Secondly, even though the identifier attribute shares the database mapping defined on the relationship attribute, from the perspective of the identifier attribute it is really a read-only mapping. Updates or inserts to the database foreign key column will only ever occur through the relationship attribute<a id="cXXX.671" target="_blank" rel="noopener noreferrer"></a>. This is one of the reasons why you must always remember to set the parent relationships before trying to persist a dependent entity.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Do not attempt to set only the identifier attribute (and not the relationship attribute) as a means to shortcut persisting a dependent entity. Some providers may have special support for doing this, but it will not portably cause the foreign key to be written to the database.</p>
          </div>
          <p class="indent">The identifier attribute will get filled in automatically by the provider when an entity instance is read from the database, or flushed/committed. However, it cannot be assumed to be there when first calling <span class="FontName2">persist()</span> on an instance unless the user sets it explicitly.</p>
        </div>
        <div>
          <p id="Sec19" class="Heading2">Multiple Mapped Attributes</p>
          <p class="noindent">A more common case is probably the one in which the dependent entity has an identifier that includes not only a relationship, but also some state of its own. We will use the example shown in <a href="#Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>, where a <span class="FontName2">Project</span> has a compound identifier composed of a name and a foreign key to the department that manages it. With the unique identifier being the combination of its name and department, no department would be permitted to create more than one project with the same name. However, two different departments may choose the same name for their own projects. <a href="#list17" id="_list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> illustrates the trivial mapping<a id="cXXX.672" target="_blank" rel="noopener noreferrer"></a> of the <span class="FontName2">Project</span> identifier using <span class="FontName2">&#64;Id</span> on both the <span class="FontName2">name</span> and <span class="FontName2">dept</span> attributes.</p>
          <p class="noindent2"><a href="#_list17" id="list17" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-17.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Project</span> with Dependent Identifier</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(ProjectId.class)</span><br><span class="FontName2">public class Project {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_NUM",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_CTY",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">referencedColumnName="COUNTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department dept;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The compound identifier<a id="cXXX.673" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.674" target="_blank" rel="noopener noreferrer"></a> means that we must also specify the primary key class using the <span class="FontName2">&#64;IdClass</span> annotation. Recall our rule that primary key classes must have a matching named attribute for each of the id attributes on the entity, and usually the attributes must also be of the same type. However, this rule only applies when the attributes are of simple types, not entity types. If <span class="FontName2">&#64;Id</span> is annotating a relationship, then that relationship attribute is going to be of some target entity type, and the rule extension is that the primary key class attribute must be of the same type as the primary key of the target entity. This means that the <span class="FontName2">ProjectId</span> class specified as the id class for <span class="FontName2">Project</span> in <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> must have an attribute named <span class="FontName2">name</span>, of type <span class="FontName2">String</span>, and another named <span class="FontName2">dept</span> that will be the same type as the primary key of <span class="FontName2">Department</span>. If <span class="FontName2">Department</span> has a simple integer primary key, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> will be of type <span class="FontName2">int</span>, but if <span class="FontName2">Department</span> has a compound primary key, with its own primary key class, say <span class="FontName2">DeptId</span>, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> would be of type <span class="FontName2">DeptId</span>, as shown in <a href="#list18" id="_list18" target="_blank" rel="noopener noreferrer">Listing 10-18</a>.</p>
          <p class="noindent2"><a href="#_list18" id="list18" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-18.</i></b></a>&nbsp;&nbsp;<span class="FontName2">ProjectId and DeptId</span> Id Classes<a id="cXXX.675" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public class ProjectId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private DeptId dept;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public ProjectId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public ProjectId(DeptId deptId, String name) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.dept = deptId;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.name = name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br>&nbsp;&nbsp; <span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">public class DeptId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public DeptId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public DeptId (int number, String country) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.number = number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec20" class="Heading2">Using EmbeddedId</p>
          <p class="noindent">It is also possible to have a derived identifier when one or the other (or both) of the entities uses <span class="FontName2">&#64;EmbeddedId</span>. When the id class is embedded, the non-relationship identifier attributes are mapped within the embeddable id class<a id="cXXX.678a" target="_blank" rel="noopener noreferrer"></a>, as usual, but the attributes in the embedded id class that correspond to relationships are mapped by the relationship attributes in the entity. <a href="#list19" id="_list19" target="_blank" rel="noopener noreferrer">Listing 10-19</a> shows how the derived identifier is mapped in the <span class="FontName2">Project</span> class when an embedded id class is used. We annotate the relationship attribute with <span class="FontName2">&#64;MapsId(‚Äúdept‚Äù)</span>, indicating that it is also specifying the mapping for the <span class="FontName2">dept</span> attribute of the embedded id class. The <span class="FontName2">dept</span> attribute<a id="cXXX.676" target="_blank" rel="noopener noreferrer"></a> of <span class="FontName2">ProjectId</span> is of the same primary key type as <span class="FontName2">Department</span> in <a href="#list20" id="_list20" target="_blank" rel="noopener noreferrer">Listing 10-20</a>.</p>
          <p class="noindent2"><a href="#_list19" id="list19" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-19.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Project</span> and Embedded <span class="FontName2">ProjectId</span> Class<a id="cXXX.677" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Project {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private ProjectId id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapsId("dept")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;JoinColumn(name="DEPT_NUM", referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;JoinColumn(name="DEPT_CTRY", referencedColumnName="CTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class ProjectId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="P_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private DeptId dept;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="noindent2"><a href="#_list20" id="list20" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-20.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Department</span> and Embedded <span class="FontName2">DeptId</span> Class<a id="cXXX.678" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private DeptId id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Project&gt; projects;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class DeptId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="CTRY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that we have used multiple join columns on the <span class="FontName2">department</span> relationship because <span class="FontName2">Department</span> has a compound primary key. Mapping multipart identifiers is explained in more detail in the ‚ÄúCompound Join Columns‚Äù section later in the chapter.</p>
          <p class="indent">The <span class="FontName2">Department</span> entity has an embedded identifier, but it is not a derived identifier because the <span class="FontName2">DeptId</span> id class does not have any attributes that correspond to relationship attributes in <span class="FontName2">Department</span>. The <span class="FontName2">&#64;Column</span> annotations in the <span class="FontName2">DeptId</span> class map the identifier fields in the <span class="FontName2">Department</span> entity, but when <span class="FontName2">DeptId</span> is embedded in <span class="FontName2">ProjectId</span>, those column mappings do not apply. Once the <span class="FontName2">dept</span> attribute is mapped by the <span class="FontName2">department</span> relationship in <span class="FontName2">Project</span>, the <span class="FontName2">&#64;JoinColumn</span> annotations on that relationship are used as the column mappings for the <span class="FontName2">PROJECT</span> table.</p>
          <p class="indent">If the <span class="FontName2">Department</span> class had a simple primary key, for example a long instead of an id class, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> would just be the simple primary key type of <span class="FontName2">Department</span> (the <span class="FontName2">long</span> type), and there would only be one join column on the many-to-one <span class="FontName2">department</span> attribute in <span class="FontName2">Project</span>.</p>
          <div class="singlethin">
            <p class="Heading4a">ALTERNATIVE TO DERIVED IDENTIFIERS<a id="cXXX.679" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The <span class="FontName2">&#64;MapsId</span> annotation and the ability to apply <span class="FontName2">&#64;Id</span> to relationship attributes was introduced in JPA 2.0 to improve the situation that existed in JPA 1.0. At that time, only the one-to-one shared primary key scenario was specified using the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation (using the <span class="FontName2">&#64;Id</span> annotation is the preferred and recommended method going forward).</p>
            <p class="noindent">Although there was no specified way to solve the general case of including a foreign key in an identifier, it was generally supported through the practice of adding one or more additional (redundant) fields to the dependent entity. Each added field would hold a foreign key to the related entity, and, because both the added field and the relationship would be mapped to the same join column(s), one or the other of the two would need to be marked as read-only (see ‚ÄúRead-Only Mappings‚Äù section), or not updatable or insertable. The following example shows how <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> would be done using JPA 1.0. The id class would be the same. Since the <span class="FontName2">deptNumber</span> and <span class="FontName2">deptCountry</span> attributes are identifier attributes, and can't be changed in the database, there is no need to set their updatability to false.</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(ProjectId.class)</span><br><span class="FontName2">public class Project {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DEPT_NUM", insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int deptNumber;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DEPT_CTRY", insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String deptCountry;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_NUM", referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_CTRY", referencedColumnName="CTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br><br><span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
        </div>
        <p id="Sec21" class="Heading1">Advanced Mapping Elements</p>
        <p class="noindent">Additional elements<a id="cXXX.684b" target="_blank" rel="noopener noreferrer"></a> may be specified on the <span class="FontName2">&#64;Column</span> and <span class="FontName2">&#64;JoinColumn</span> annotations (and their <span class="FontName2">&#64;MapKeyColumn</span>, <span class="FontName2">&#64;MapKeyJoinColumn</span>, and <span class="FontName2">&#64;OrderColumn</span> relatives), some of which apply to schema generation that will be discussed in <a href="9781430249269_Ch14.xhtml" target="_blank" rel="noopener noreferrer">Chapter 14</a>. Other parts we can describe separately as applying to columns and join columns in the following sections.</p>
        <div>
          <p id="Sec22" class="Heading2">Read-Only Mappings<a id="cXXX.680" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.681" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">JPA does not really define any kind of read-only entity, although it will likely show up in a future release. The API does, however, define options to set individual mappings to be read-only using the <span class="FontName2">insertable</span> and <span class="FontName2">updatable</span> elements of the <span class="FontName2">&#64;Column</span> and <span class="FontName2">&#64;JoinColumn</span> annotations<a id="cXXX.682" target="_blank" rel="noopener noreferrer"></a>. These two settings default to true but can be set to false if we want to ensure that the provider will not insert or update information in the table in response to changes in the entity instance. If the data in the mapped table already exists and we want to ensure that it will not be modified at runtime, then the <span class="FontName2">insertable</span> and <span class="FontName2">updatable</span> elements can be set to false, effectively preventing the provider from doing anything other than reading the entity from the database. <a href="#list21" id="_list21" target="_blank" rel="noopener noreferrer">Listing 10-21</a> demonstrates the <span class="FontName2">Employee</span> entity with read-only mappings.</p>
          <p class="noindent2"><a href="#_list21" id="list21" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-21.</i></b></a>&nbsp;&nbsp;Making An Entity Read-only<a id="cXXX.683" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We don't need to worry about the identifier mapping being modified, because it is illegal to modify identifiers. The other mappings, though, are marked as not being able to be inserted or updated, so we are assuming that there are already entities in the database to be read in and used. No new entities will be persisted, and existing entities will never be updated.</p>
          <p class="indent">Note that this does not guarantee that the entity state will not change in memory. <span class="FontName2">Employee</span> instances could still get changed either inside or outside a transaction, but at transaction commit time or whenever the entities get flushed to the database, this state will not be saved and the provider will likely not throw an exception to indicate it. Be careful modifying read-only mappings in memory, however, as changing the entities can cause them to become inconsistent with the state in the database and could wreak havoc on a vendor-specific cache.</p>
          <p class="indent">Even though all of these mappings are not updatable, the entity as a whole could still be deleted. A proper read-only feature will solve this problem once and for all in a future release, but in the meantime some vendors support the notion of read-only entities, and can optimize the treatment of them in their caches and persistence context implementations.</p>
        </div>
        <div>
          <p id="Sec23" class="Heading2">Optionality<a id="cXXX.684" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">As we will see in <a href="9781430249269_Ch14.xhtml" target="_blank" rel="noopener noreferrer">Chapter 14</a>, when we talk about schema generation, there exists metadata that either permits the database columns to be null or requires them to have values. While this setting will affect the physical database schema, there are also settings on some of the logical mappings that allow a basic mapping or a single-valued association mapping to be left empty or required to be specified in the object model. The element that requires or permits such behavior is the <span class="FontName2">optional</span> element in the <span class="FontName2">&#64;Basic</span>, <span class="FontName2">&#64;ManyToOne</span>, and <span class="FontName2">&#64;OneToOne</span> annotations.</p>
          <p class="indent">When the <span class="FontName2">optional</span> element is specified as false, it indicates to the provider that the field or property mapping may not be null. The API does not actually define what the behavior is in the case when the value is null, but the provider may choose to throw an exception or simply do something else. For basic mappings, it is only a hint and can be completely ignored. The <span class="FontName2">optional</span> element may also be used by the provider when doing schema generation, because, if <span class="FontName2">optional</span> is set to true, then the column in the database must also be nullable.</p>
          <p class="indent">Because the API does not go into any detail about ordinality of the object model, there is a certain amount of non-portability associated with using it. An example of setting the manager to be a required attribute is shown in <a href="#list22" id="_list22" target="_blank" rel="noopener noreferrer">Listing 10-22</a>. The default value for <span class="FontName2">optional</span> is true, making it necessary to be specified only if a false value is needed.</p>
          <p class="noindent2"><a href="#_list22" id="list22" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-22.</i></b></a>&nbsp;&nbsp;Using Optional Mappings<a id="cXXX.685" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne(optional=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <p id="Sec24" class="Heading1">Advanced Relationships<a id="cXXX.686a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.686" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">If you are in the opportune position of starting from a Java application and creating a database schema, then you have complete control over what the schema looks like and how you map the classes to the database. In this case, it is likely that you will not need to use very many of the advanced relationship features that are offered by the API. The flexibility of being able to define a data model usually makes for a less demanding mapping configuration. However, if you are in the unfortunate situation of mapping a Java model to an existing database, then in order to work around the data schema you might need access to more mappings than those we have discussed so far. The mappings described in the following sections are primarily for mapping to legacy databases, and will most often be used because they are the only option. A notable exception is the orphan removal feature, used to model a parent‚Äìchild relationship.</p>
        <div>
          <p id="Sec25" class="Heading2">Using Join Tables<a id="cXXX.688a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">We have already seen mappings such as the many-to-many and unidirectional one-to-many mappings that use join tables. Sometimes a database schema uses a join table to relate two entity types, even though the cardinality of the target entity in the relationship is one. A one-to-one or many-to-one relationship does not normally need a join table because the target will only ever be a single entity and the foreign key can be stored in the source entity table. But if the join table already exists for a many-to-one relationship, then of course we must map the relationship using that join table. To do so, we need only add the <span class="FontName2">&#64;JoinTable</span> annotation to the relationship mapping.</p>
          <p class="indent">Whether the relationship is unidirectional or bidirectional<a id="cXXX.687" target="_blank" rel="noopener noreferrer"></a>, the <span class="FontName2">&#64;JoinTable</span> annotation is a physical annotation and must be defined on the owning side of the relationship, just as with all other mappings. However, because a join table is not the default configuration for mappings that are not many-to-many or unidirectional one-to-many, we do need to specify the annotation when we want a join table to be used. The elements of the <span class="FontName2">&#64;JoinTable</span> annotation can still be used to override the various schema names.</p>
          <p class="indent">In <a href="#list23" id="_list23" target="_blank" rel="noopener noreferrer">Listing 10-23</a>, we see a join table being used for a many-to-one relationship from <span class="FontName2">Employee</span> to <span class="FontName2">Department</span>. The relationship may be unidirectional or it may be bidirectional, with a one-to-many relationship from <span class="FontName2">Department</span> back to <span class="FontName2">Employee</span>, but in either case the ‚Äúmany‚Äù side must always be the owner. The reason is because even if it were bidirectional, the <span class="FontName2">&#64;ManyToOne</span> side could not be the owner because there would be no way for the <span class="FontName2">&#64;ManyToOne</span> attribute to refer to the owning <span class="FontName2">&#64;OneToMany</span> attribute side. There is no <span class="FontName2">mappedBy</span> element in the <span class="FontName2">&#64;ManyToOne</span> annotation definition.</p>
          <p class="noindent2"><a href="#_list23" id="list23" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-23.</i></b></a>&nbsp;&nbsp;Many-to-One Mapping<a id="cXXX.688" target="_blank" rel="noopener noreferrer"></a> Using a Join Table</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="EMP_DEPT")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">As with most other mappings, the non-owning side of a bidirectional relationship does not change based upon whether the relationship is mapped using a join table or not. It simply refers to the owning relationship and lets it map to the physical tables/columns accordingly.</p>
        </div>
        <div>
          <p id="Sec26" class="Heading2">Avoiding Join Tables</p>
          <p class="noindent">Up to this point, we have discussed a unidirectional one-to-many mapping in the context of using a join table, but it is also possible to map a unidirectional mapping without using a join table. It requires the foreign key to be in the target table, or ‚Äúmany‚Äù side of the relationship, even though the target object does not have any reference to the ‚Äúone‚Äù side. This is called a unidirectional one-to-many target foreign key mapping, because the foreign key is in the target table instead of a join table.</p>
          <p class="indent">To use this mapping, we first indicate that the one-to-many relationship<a id="cXXX.689" target="_blank" rel="noopener noreferrer"></a> is unidirectional by not specifying any <span class="FontName2">mappedBy</span> element in the annotation. Then we specify a <span class="FontName2">&#64;JoinColumn</span> annotation on the one-to-many attribute to indicate the foreign key column. The catch is that the join column that we are specifying applies to the table of the target object, not the source object in which the annotation appears.</p>
          <p class="indent">The example in <a href="#list24" id="_list24" target="_blank" rel="noopener noreferrer">Listing 10-24</a> shows how simple it is to map a unidirectional one-to-many mapping using a target foreign key. The <span class="FontName2">DEPT_ID</span> column refers to the table mapped by <span class="FontName2">Employee</span>, and is a foreign key to the <span class="FontName2">DEPARTMENT</span> table, even though the <span class="FontName2">Employee</span> entity does not have any relationship attribute back to <span class="FontName2">Department</span>.</p>
          <p class="noindent2"><a href="#_list24" id="list24" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-24.</i></b></a>&nbsp;&nbsp;Unidirectional One-to-Many Mapping Using a Target Foreign Key<a id="cXXX.690" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Before you use this mapping, you should understand the implications of doing so, as they can be quite negative, both from a modeling perspective and a performance perspective. Each row in the <span class="FontName2">EMPLOYEE</span> table corresponds to an <span class="FontName2">Employee</span> instance, with each column corresponding to some state or relationship in the instance. When there is a change in the row, there is the assumption that some kind of change occurred to the corresponding <span class="FontName2">Employee</span>, but in this case that does not necessarily follow. The <span class="FontName2">Employee</span> might have just been changed to a different <span class="FontName2">Department</span>, and because there was no reference to the <span class="FontName2">Department</span> from the <span class="FontName2">Employee</span> there was no change to the <span class="FontName2">Employee</span>.</p>
          <p class="indent">From a performance standpoint, think of the case when both the state of an <span class="FontName2">Employee</span> is changed and the <span class="FontName2">Department</span> that it belongs to is changed. When writing out the <span class="FontName2">Employee</span> state, the foreign key to the <span class="FontName2">Department</span> is not known because the <span class="FontName2">Employee</span> entity does not have any reference to it. In this case, the <span class="FontName2">Employee</span> might have to be written out twice, once for the changed state of the <span class="FontName2">Employee</span>, and a second time when the <span class="FontName2">Department</span> entity changes are written out, and the foreign key from <span class="FontName2">Employee</span> to <span class="FontName2">Department</span> must be updated to point to the <span class="FontName2">Department</span> that is referring to it.</p>
        </div>
        <div>
          <p id="Sec27" class="Heading2">Compound Join Columns<a id="cXXX.693a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Now that we have discussed how to create entities with compound primary keys, it is not a far stretch to figure out that, as soon as we have a relationship to an entity with a compound identifier, we will need some way to extend the way we currently reference it.</p>
          <p class="indent">Up to this point, we have dealt with the physical relationship mapping only as a join column, but, if the primary key that we are referencing is composed of multiple fields, then we will need multiple join columns. This is why we have the plural <span class="FontName2">&#64;JoinColumns</span> annotation<a id="cXXX.691" target="_blank" rel="noopener noreferrer"></a> that can hold as many join columns as we need to put into it.</p>
          <p class="indent">There are no default values for join column names when we have multiple join columns. The simplest answer is to require the user to assign them, so, when multiple join columns are used, both the <span class="FontName2">name</span> element and the <span class="FontName2">referencedColumnName</span> element, which indicates the name of the primary key column in the target table, must be specified.</p>
          <p class="indent">Now that we are getting into more complex scenarios, let's add a more interesting relationship to the mix. Let's say that employees have managers and that each manager has a number of employees that work for him. You may not find that very interesting until you realize that managers are themselves employees, so the join columns are actually self-referential<a id="cXXX.692" target="_blank" rel="noopener noreferrer"></a>, that is, referring to the same table they are stored in. <a href="#Fig4" id="_Fig4" target="_blank" rel="noopener noreferrer">Figure 10-4</a> shows the <span class="FontName2">EMPLOYEE</span> table<a id="cXXX.693" target="_blank" rel="noopener noreferrer"></a> with this relationship.</p>
          <div class="Figure" id="Fig4">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-04.jpg" alt="9781430249269_Fig10-04.jpg" width="269" height="265"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig4" target="_blank" rel="noopener noreferrer">Figure 10-4</a>. </span>EMPLOYEE table with self-referencing compound foreign key</p>
          </div>
          <p class="indent"><a href="#list25" id="_list25" target="_blank" rel="noopener noreferrer">Listing 10-25</a> shows a version of the <span class="FontName2">Employee</span> entity that has a <span class="FontName2">manager</span> relationship, which is many-to-one from each of the managed employees to the manager, and a one-to-many <span class="FontName2">directs</span> relationship from the manager to its managed employees.</p>
          <p class="noindent2"><a href="#_list25" id="list25" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-25.</i></b></a>&nbsp;&nbsp;Self-referencing Compound Relationships</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_ID", referencedColumnName="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="manager")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Employee&gt; directs;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Any number of join columns can be specified, although in practice very seldom are there more than two. The plural form of <span class="FontName2">&#64;JoinColumns</span> may be used on many-to-one or one-to-one relationships<a id="cXXX.694" target="_blank" rel="noopener noreferrer"></a> or more generally whenever the single <span class="FontName2">&#64;JoinColumn</span> annotation is valid.</p>
          <p class="indent">Another example to consider is in the join table of a many-to-many relationship. We can revisit the <span class="FontName2">Employee</span> and <span class="FontName2">Project</span> relationship described in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> to take into account our compound primary key in <span class="FontName2">Employee</span>. The new table structure for this relationship is shown in <a href="#Fig5" id="_Fig5" target="_blank" rel="noopener noreferrer">Figure 10-5</a>.</p>
          <div class="Figure" id="Fig5">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-05.jpg" alt="9781430249269_Fig10-05.jpg" width="708" height="163"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig5" target="_blank" rel="noopener noreferrer">Figure 10-5</a>. </span>Join table with a compound primary key</p>
          </div>
          <p class="indent">If we keep the <span class="FontName2">Employee</span> entity as the owner, where the join table is defined, then the mapping for this relationship will be as shown in <a href="#list26" id="_list26" target="_blank" rel="noopener noreferrer">Listing 10-26</a>.</p>
          <p class="noindent2"><a href="#_list26" id="list26" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-26.</i></b></a>&nbsp;&nbsp;Join Table with Compound Join Columns</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="EMP_PROJECT",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID", referencedColumnName="EMP_ID")},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="PROJECT_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Project&gt; projects;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec28" class="Heading2">Orphan Removal<a id="cXXX.696" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The <span class="FontName2">orphanRemoval</span> element<a id="cXXX.697" target="_blank" rel="noopener noreferrer"></a> provides a convenient way of modeling parent-child relationships, or more specifically privately owned relationships. We differentiate these two because privately owned is a particular variety of parent-child in which the child entity may only be a child of one parent entity, and may not ever belong to a different parent. While some parent-child relationships allow the child to migrate from one parent to another, in a privately owned mapping the owned entity was created to belong to the parent and cannot ever be migrated. Once it is removed from the parent, it is considered orphaned and is deleted by the provider.</p>
          <p class="indent">Only relationships with single cardinality on the source side can enable orphan removal, which is why the <span class="FontName2">orphanRemoval</span> option is defined on the <span class="FontName2">&#64;OneToOne</span> and <span class="FontName2">&#64;OneToMany</span> relationship annotations, but on neither of the <span class="FontName2">&#64;ManyToOne</span> or <span class="FontName2">&#64;ManyToMany</span> annotations.</p>
          <p class="indent">When specified, the <span class="FontName2">orphanRemoval</span> element causes the child entity to be removed when the relationship between the parent and the child is broken. This can be done either by setting to null the attribute that holds the related entity, or additionally in the one-to-many case by removing the child entity from the collection. The provider is then responsible, at flush or commit time (whichever comes first), for removing the orphaned child entity.</p>
          <p class="indent">In a parent-child relationship, the child is dependent upon the existence of the parent. If the parent is removed, then by definition the child becomes an orphan and must also be removed. This second feature of orphan removal behavior is exactly equivalent to a feature that we covered in <a href="9781430249269_Ch06.xhtml" target="_blank" rel="noopener noreferrer">Chapter 6</a> called cascading, in which it is possible to cascade any subset of a defined set of operations across a relationship. Setting orphan removal on a relationship automatically causes the relationship to have the <span class="FontName2">REMOVE</span> operation option added to its cascade list, so it is not necessary to explicitly add it. Doing so is simply redundant. It is impossible to turn off cascading <span class="FontName2">REMOVE</span> from a relationship marked for orphan removal since its very definition requires such behavior to be present.</p>
          <p class="indent">In <a href="#list27" id="_list27" target="_blank" rel="noopener noreferrer">Listing 10-27</a>, the <span class="FontName2">Employee</span> class defines a one-to-many relationship to its list of annual evaluations. It doesn't matter whether the relationship is unidirectional or bidirectional, the configuration and semantics are the same, so we need not show the other side of the relationship.</p>
          <p class="noindent2"><a href="#_list27" id="list27" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-27.</i></b></a>&nbsp;&nbsp;Employee Class with Orphan Removal<a id="cXXX.698" target="_blank" rel="noopener noreferrer"></a> of Evaluation Entities</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(orphanRemoval=true)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Evaluation&gt; evals;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Suppose an employee receives an unfair evaluation from a manager. The employee might go to the manager to correct the information and the evaluation might be modified, or the employee might have to appeal the evaluation, and if successful the evaluation might simply be removed from the employee record. This would cause it to be deleted from the database as well. If the employee decided to leave the company, then when the employee is removed from the system his evaluations will be automatically removed along with him.</p>
          <p class="indent">If the collection in the relationship was a <span class="FontName2">Map</span>, keyed by a different entity type, then orphan removal would only apply to the entity values in the <span class="FontName2">Map</span>, not to the keys. This means that entity keys are never privately owned.</p>
          <p class="indent">Finally, if the orphaned object is not currently managed in the persistence context, either because it has been created in memory and not yet persisted or because it is simply detached from the persistence context, orphan removal will not be applied. Similarly, if it has already been removed in the current persistence context orphan removal will not be applied.</p>
        </div>
        <div>
          <p id="Sec29" class="Heading2">Mapping Relationship State<a id="cXXX.687a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">There are times when a relationship actually has state associated with it. For example, let's say that we want to maintain the date an employee was assigned to work on a project. Storing the state on the employee is possible but less helpful, since the date is really coupled to the employee's relationship to a particular project (a single entry in the many-to-many association). Taking an employee off a project should really just cause the assignment date to go away, so storing it as part of the employee means that we have to ensure that the two are consistent with each other, which can be bothersome. In UML, we would show this kind of relationship using an association class. <a href="#Fig6" id="_Fig6" target="_blank" rel="noopener noreferrer">Figure 10-6</a> shows an example of this technique.</p>
          <div class="Figure" id="Fig6">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-06.jpg" alt="9781430249269_Fig10-06.jpg" width="675" height="329"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig6" target="_blank" rel="noopener noreferrer">Figure 10-6</a>. </span>Modeling state on a relationship using an association class<a id="cXXX.699" target="_blank" rel="noopener noreferrer"></a></p>
          </div>
          <p class="indent">In the database, everything is rosy because we can simply add a column to the join table. The data model provides natural support for relationship state. <a href="#Fig7" id="_Fig7" target="_blank" rel="noopener noreferrer">Figure 10-7</a> shows the many-to-many relationship between <span class="FontName2">EMPLOYEE</span> and <span class="FontName2">PROJECT</span> with an expanded join table.</p>
          <div class="Figure" id="Fig7">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-07.jpg" alt="9781430249269_Fig10-07.jpg" width="708" height="142"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig7" target="_blank" rel="noopener noreferrer">Figure 10-7</a>. </span>Join table<a id="cXXX.700" target="_blank" rel="noopener noreferrer"></a> with additional state</p>
          </div>
          <p class="indent">When we get to the object model, however, it becomes much more problematic. The issue is that Java has no inherent support for relationship state. Relationships are just object references or pointers, hence no state can ever exist on them. State exists on objects only, and relationships are not first-class objects.</p>
          <p class="indent">The Java solution is to turn the relationship into an entity that contains the desired state and map the new entity to what was previously the join table. The new entity will have a many-to-one relationship to each of the existing entity types, and each of the entity types will have a one-to-many relationship back to the new entity representing the relationship. The primary key of the new entity will be the combination of the two relationships to the two entity types. <a href="#list28" id="_list28" target="_blank" rel="noopener noreferrer">Listing 10-28</a> shows all of the participants in the <span class="FontName2">Employee</span> and <span class="FontName2">Project</span> relationship.</p>
          <p class="noindent2"><a href="#_list28" id="list28" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-28.</i></b></a>&nbsp;&nbsp;Mapping Relationship State with an Intermediate Entity<a id="cXXX.701" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="employee")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;ProjectAssignment&gt; assignments;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Project {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="project")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;ProjectAssignment&gt; assignments;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP_PROJECT")</span><br><span class="FontName2">&#64;IdClass(ProjectAssignmentId.class)</span><br><span class="FontName2">public class ProjectAssignment {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="PROJECT_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Project project;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="START_DATE", updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">public class ProjectAssignmentId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int project;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Here we have the primary key entirely composed of relationships, with the two foreign key columns making up the primary key in the <span class="FontName2">EMP_PROJECT</span> join table. The date at which the assignment was made could be manually set when the assignment is created, or it could be associated with a trigger that causes it to be set when the assignment is created in the database. Note that, if a trigger were used, then the entity would need to be refreshed from the database in order to populate the assignment date field in the Java object.</p>
        </div>
        <p id="Sec30" class="Heading1">Multiple Tables<a id="cXXX.709a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">The most common mapping scenarios are of the so-called meet-in-the-middle variety<a id="cXXX.702" target="_blank" rel="noopener noreferrer"></a>. This means that the data model and the object model already exist, or, if one does not exist, then it is created independently of the other model. This is relevant because there are a number of features in the Java Persistence API that attempt to address concerns that arise in this case.</p>
        <p class="indent">Up to this point, we have assumed that an entity gets mapped to a single table and that a single row in that table represents an entity. In an existing or legacy data model, it was actually quite common to spread data, even data that was tightly coupled, across multiple tables. This was done for different administrative as well as performance reasons, one of which was to decrease table contention when specific subsets of the data were accessed or modified.</p>
        <p class="indent">To account for this, entities may be mapped across multiple tables by making use of the <span class="FontName2">&#64;SecondaryTable</span> annotation<a id="cXXX.703" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.704" target="_blank" rel="noopener noreferrer"></a> and its plural <span class="FontName2">&#64;SecondaryTables</span> form. The default table or the table defined by the <span class="FontName2">&#64;Table</span> annotation<a id="cXXX.705" target="_blank" rel="noopener noreferrer"></a> is called the primary table, and any additional ones are called secondary tables. We can then distribute the data in an entity across rows in both the primary table and the secondary tables simply by defining the secondary tables as annotations on the entity and then specifying when we map each field or property which table the column is in. We do this by specifying the name of the table in the <span class="FontName2">table</span> element in <span class="FontName2">&#64;Column</span> or <span class="FontName2">&#64;JoinColumn</span>. We did not need to use this element earlier, because the default value of <span class="FontName2">table</span> is the name of the primary table.</p>
        <p class="indent">The only bit that is left is to specify how to join the secondary table or tables to the primary table. We saw in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> how the primary key join column is a special case of a join column where the join column is just the primary key column (or columns in the case of composite primary keys). Support for joining secondary tables to the primary table is limited to primary key join columns and is specified as a <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation<a id="cXXX.706" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.707" target="_blank" rel="noopener noreferrer"></a> as part of the <span class="FontName2">&#64;SecondaryTable</span> annotation.</p>
        <p class="indent">To demonstrate the use of a secondary table, consider the data model shown in <a href="#Fig8" id="_Fig8" target="_blank" rel="noopener noreferrer">Figure 10-8</a>. There is a primary key relationship between the <span class="FontName2">EMP</span> and <span class="FontName2">EMP_ADDRESS</span> tables. The <span class="FontName2">EMP</span> table stores the primary employee information, while the address information has been moved to the <span class="FontName2">EMP_ADDRESS</span> table.</p>
        <div class="Figure" id="Fig8">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-08.jpg" alt="9781430249269_Fig10-08.jpg" width="579" height="233"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig8" target="_blank" rel="noopener noreferrer">Figure 10-8</a>. </span>EMP and EMP_ADDRESS tables</p>
        </div>
        <p class="indent">To map this table structure to the <span class="FontName2">Employee</span> entity, we must declare <span class="FontName2">EMP_ADDRESS</span> as a secondary table and use the table element of the <span class="FontName2">&#64;Column</span> annotation for every attribute stored in that table. <a href="#list29" id="_list29" target="_blank" rel="noopener noreferrer">Listing 10-29</a> shows the mapped entity. The primary key of the <span class="FontName2">EMP_ADDRESS</span> table is in the <span class="FontName2">EMP_ID</span> column. If it had been named <span class="FontName2">ID</span>, then we would not have needed to use the name element in the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation. It defaults to the name of the primary key column in the primary table.</p>
        <p class="noindent2"><a href="#_list29" id="list29" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-29.</i></b></a>&nbsp;&nbsp;Mapping an Entity Across Two Tables<a id="cXXX.708" target="_blank" rel="noopener noreferrer"></a></p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;SecondaryTable(name="EMP_ADDRESS",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">pkJoinColumns=&#64;PrimaryKeyJoinColumn(name="EMP_ID"))</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String street;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String city;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String state;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="ZIP_CODE", table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String zip;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">In <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we learned how to use the <span class="FontName2">schema</span> or <span class="FontName2">catalog</span> elements in <span class="FontName2">&#64;Table</span> to qualify the primary table to be in a particular database schema or catalog. This is also valid in the <span class="FontName2">&#64;SecondaryTable</span> annotation.</p>
        <p class="indent">Previously, when discussing embedded objects, we mapped the address fields of the <span class="FontName2">Employee</span> entity into an <span class="FontName2">Address</span> embedded type. With the address data in a secondary table, it is still possible to do this by specifying the mapped table name as part of the column information in the <span class="FontName2">&#64;AttributeOverride</span> annotation. <a href="#list30" id="_list30" target="_blank" rel="noopener noreferrer">Listing 10-30</a> demonstrates this approach. Note that we have to enumerate all of the fields in the embedded type even though the column names may match the correct default values.</p>
        <p class="noindent2"><a href="#_list30" id="list30" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-30.</i></b></a>&nbsp;&nbsp;Mapping an Embedded Type<a id="cXXX.709" target="_blank" rel="noopener noreferrer"></a> to a Secondary Table</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;SecondaryTable(name="EMP_ADDRESS",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">pkJoinColumns=&#64;PrimaryKeyJoinColumn(name="EMP_ID"))</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="street", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="city", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="state", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="zip",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="ZIP_CODE", table="EMP_ADDRESS"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Address address;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Let's consider a more complex example involving multiple tables and compound primary keys. <a href="#Fig9" id="_Fig9" target="_blank" rel="noopener noreferrer">Figure 10-9</a> shows the table structure<a id="cXXX.710" target="_blank" rel="noopener noreferrer"></a> we wish to map. In addition to the <span class="FontName2">EMPLOYEE</span> table, there are two secondary tables, <span class="FontName2">ORG_STRUCTURE</span> and <span class="FontName2">EMP_LOB</span>. The <span class="FontName2">ORG_STRUCTURE</span> table stores employee and manager reporting information. The <span class="FontName2">EMP_LOB</span> table stores large objects that are infrequently fetched during normal query options. Moving large objects to a secondary table is a common design technique in many database schemas.</p>
        <div class="Figure" id="Fig9">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-09.jpg" alt="9781430249269_Fig10-09.jpg" width="742" height="160"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig9" target="_blank" rel="noopener noreferrer">Figure 10-9</a>. </span>Secondary tables with compound primary key relationships</p>
        </div>
        <p class="indent"><a href="#list31" id="_list31" target="_blank" rel="noopener noreferrer">Listing 10-31</a> shows the <span class="FontName2">Employee</span> entity mapped to this table structure. The <span class="FontName2">EmployeeId</span> id class from <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a> has been reused in this example.</p>
        <p class="noindent2"><a href="#_list31" id="list31" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-31.</i></b></a>&nbsp;&nbsp;Mapping an Entity with Multiple Secondary Tables<a id="cXXX.711" target="_blank" rel="noopener noreferrer"></a></p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">&#64;SecondaryTables({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;SecondaryTable(name="ORG_STRUCTURE", pkJoinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="EMP_ID", referencedColumnName="EMP_ID")}),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;SecondaryTable(name="EMP_LOB", pkJoinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="ID", referencedColumnName="EMP_ID")})</span><br><span class="FontName2">})</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Basic(fetch=FetchType.LAZY)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Lob</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_LOB")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private byte[] photo;</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Basic(fetch=FetchType.LAZY)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Lob</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_LOB")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private char[] comments;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_COUNTRY", referencedColumnName="COUNTRY",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">table="ORG_STRUCTURE"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_ID", referencedColumnName="EMP_ID",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">table="ORG_STRUCTURE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">We have thrown a few curves into this example to make it more interesting. The first is that we have defined <span class="FontName2">Employee</span> to have a composite primary key. This requires additional information to be provided for the <span class="FontName2">EMP_LOB</span> table, because its primary key is not named the same as the primary table. The next difference is that we are storing a relationship in the <span class="FontName2">ORG_STRUCTURE</span> secondary table. The <span class="FontName2">MGR_COUNTRY</span> and <span class="FontName2">MGR_ID</span> columns combine to reference the id of the manager for this employee. Since the employee has a composite primary key, the <span class="FontName2">manager</span> relationship must also specify a set of join columns instead of only one, and the <span class="FontName2">referencedColumnName</span> elements in those join columns refer to the primary key columns <span class="FontName2">COUNTRY</span> and <span class="FontName2">EMP_ID</span> in the entity's own primary table <span class="FontName2">EMPLOYEE</span>.</p>
        <p id="Sec31" class="Heading1">Inheritance<a id="cXXX.712a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.712" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">One of the common mistakes made by novice object-oriented developers is that they get converted to the principle of reuse, but carry it too far. It is too easy to get caught up in the quest for reuse and create complex inheritance hierarchies all for the sake of sharing a few methods. These kinds of multi-level hierarchies will often lead to pain and hardship down the road as the application becomes difficult to debug and a challenge to maintain.</p>
        <p class="indent">Most applications do enjoy the benefits of at least some inheritance in the object model. As with most things, though, moderation should be applied, especially when it comes to mapping the classes to relational databases. Large hierarchies can often lead to significant performance reduction, and it may be that the cost of code reuse is higher than you might want to pay.</p>
        <p class="indent">In the following sections, we will explain the support that exists in the API to map inheritance hierarchies and outline some of the repercussions.</p>
        <div>
          <p id="Sec32" class="Heading2">Class Hierarchies<a id="cXXX.719b" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Because this is a book about the Java Persistence API, the first and most obvious place to start talking about inheritance is in the Java object model<a id="cXXX.713" target="_blank" rel="noopener noreferrer"></a>. Entities are objects, after all, and should be able to inherit state and behavior from other entities. This is not only expected but also essential for the development of object-oriented applications.</p>
          <p class="indent">What does it mean when one entity inherits state from its entity superclass? It can imply different things in the data model, but in the Java model it simply means that when a subclass entity is instantiated, it has its own version or copy of both its locally defined state and its inherited state, all of which is persistent. While this basic premise is not at all surprising, it opens up the less obvious question of what happens when an entity inherits from something other than another entity. Which classes is an entity allowed to extend, and what happens when it does?</p>
          <p class="indent">Consider the class hierarchy shown in <a href="#Fig10" id="_Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. As we saw in <a href="9781430249269_Ch01.xhtml" target="_blank" rel="noopener noreferrer">Chapter 1</a>, there are a number of ways that class inheritance can be represented in the database. In the object model, there may even be a number of different ways to implement a hierarchy, some of which may include non-entity classes<a id="cXXX.714" target="_blank" rel="noopener noreferrer"></a>. We will use this example as we explore ways to persist inheritance hierarchies in the following sections.</p>
          <div class="Figure" id="Fig10">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-10.jpg" alt="9781430249269_Fig10-10.jpg" width="629" height="483"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. </span>Inheritance class hierarchy</p>
          </div>
          <p class="indent">We differentiate between a general class hierarchy, which is a set of various types of Java classes that extend each other in a tree, and an entity hierarchy, which is a tree consisting of persistent entity classes interspersed with non-entity classes. An entity hierarchy is rooted at the first entity class in the hierarchy.</p>
          <div>
            <p id="Sec33" class="Heading3">Mapped Superclasses<a id="cXXX.715" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The Java Persistence API defines a special kind of class called a mapped superclass that is quite useful as a superclass for entities. A mapped superclass provides a convenient class in which to store shared state and behavior that entities can inherit from, but it is itself not a persistent class and cannot act in the capacity of an entity. It cannot be queried over and cannot be the target of a relationship. Annotations such as <span class="FontName2">&#64;Table</span> are not permitted on mapped superclasses because the state defined in them applies only to its entity subclasses.</p>
            <p class="indent">Mapped superclasses can be compared to entities in somewhat the same way that an abstract class is compared to a concrete class; they can contain state and behavior but just can't be instantiated as persistent entities. An abstract class is of use only in relation to its concrete subclasses, and a mapped superclass is useful only as state and behavior that is inherited by the entity subclasses that extend it. They do not play a role in an entity inheritance hierarchy other than contributing that state and behavior to the entities that inherit from them.</p>
            <p class="indent">Mapped superclasses may or may not be defined as abstract in their class definitions, but it is good practice to make them actual abstract Java classes. We don't know of any good use cases for creating concrete Java instances of them without ever being able to persist them, and chances are that, if you happen to find one, you probably want the mapped superclass to be an entity.</p>
            <p class="indent">All of the default mapping rules that apply to entities also apply to the basic and relationship state in mapped superclasses. The biggest advantage of using mapped superclasses is being able to define partial shared state that should not be accessed on its own without the additional state that its entity subclasses add to it. If you are not sure whether to make a class an entity or a mapped superclass, then you need only ask yourself if you will ever need to query across or access an instance that is only exposed as an instance of that mapped class. This also includes relationships, since a mapped superclass can't be used as the target of a relationship. If you answer yes to any variant of that question, then you should probably make it a first-class entity.</p>
            <p class="indent">Looking back at <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>, we could conceivably treat the <span class="FontName2">CompanyEmployee</span> class as a mapped superclass instead of an entity. It defines shared state, but perhaps we have no reason to query over it.</p>
            <p class="indent">A class is indicated as being a mapped superclass by annotating it with the <span class="FontName2">&#64;MappedSuperclass</span> annotation. The class fragments from <a href="#list32" id="_list32" target="_blank" rel="noopener noreferrer">Listing 10-32</a> show how the hierarchy would be mapped with <span class="FontName2">CompanyEmployee</span> as a mapped superclass.</p>
            <p class="noindent2"><a href="#_list32" id="list32" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-32.</i></b></a>&nbsp;&nbsp;Entities Inheriting from a Mapped Superclass<a id="cXXX.716" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pension;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec34" class="Heading3">Transient Classes<a id="cXXX.717" target="_blank" rel="noopener noreferrer"></a> in the Hierarchy</p>
            <p class="noindent">Classes in an entity hierarchy, that are not entities or mapped superclasses, are called transient classes. Entities may extend transient classes either directly or indirectly through a mapped superclass. When an entity inherits from a transient class, the state defined in the transient class is still inherited in the entity, but it is not persistent. In other words, the entity will have space allocated for the inherited state, according to the usual Java rules, but that state will not be managed by the persistence provider. It will be effectively ignored during the lifecycle of the entity. The entity might manage that state manually through the use of lifecycle callback methods that we describe in <a href="9781430249269_Ch12.xhtml" target="_blank" rel="noopener noreferrer">Chapter 12</a>, or other approaches, but the state will not be persisted as part of the provider-managed entity lifecycle.</p>
            <p class="indent">One could conceive of having a hierarchy that is composed of an entity that has a transient subclass, which in turn has one or more entity subclasses. While this case is not really a common one, it is nonetheless possible and can be achieved in the rare circumstances when having shared transient state or common behavior is desired. It would normally be more convenient, though, to declare the transient state or behavior in the entity superclass than to create an intermediate transient class. <a href="#list33" id="_list33" target="_blank" rel="noopener noreferrer">Listing 10-33</a> shows an entity that inherits from a superclass that defines transient state that is the time an entity was created in memory.</p>
            <p class="noindent2"><a href="#_list33" id="list33" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-33.</i></b></a>&nbsp;&nbsp;Entity Inheriting from a Transient Superclass<a id="cXXX.718" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">public abstract class CachedEntity {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long createTime;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public CachedEntity() { createTime = System.currentTimeMillis(); }</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public long getCacheAge() { return System.currentTimeMillis() - createTime; }</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee extends CachedEntity {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee() { super(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">In this example, we moved the transient state from the entity class into a transient superclass, but the end result is really quite the same. The previous example might have been a little neater without the extra class, but this example allows us to share the transient state and behavior across any number of entities that need only extend <span class="FontName2">CachedEntity</span>.</p>
          </div>
          <div>
            <p id="Sec35" class="Heading3">Abstract and Concrete Classes<a id="cXXX.719" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">We have mentioned the notion of abstract versus concrete classes in the context of mapped superclasses, but we didn't go into any more detail about entity and transient classes. Most people, depending upon their philosophy, might expect that all non-leaf classes in an object hierarchy should be abstract, or at the very least that some of them would be. A restriction that entities must always be concrete classes would mess this up quite handily, and fortunately this is not the case. It is perfectly acceptable for entities, mapped superclasses, or transient classes to be either abstract or concrete at any level of the inheritance tree. As with mapped superclasses, making transient classes concrete in the hierarchy doesn't really serve any purpose, and as a general rule should be avoided to prevent accidental development errors and misuse.</p>
            <p class="indent">The case that we have not talked about is the one where an entity is an abstract class. The only difference between an entity that is an abstract class and one that is a concrete class is the Java rule that prohibits abstract classes from being instantiated. They can still define persistent state and behavior that will be inherited by the concrete entity subclasses below them. They can be queried, the result of which will be composed of concrete entity subclass instances. They can also bear the inheritance mapping metadata for the hierarchy.</p>
            <p class="indent">Our hierarchy in <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a> had an <span class="FontName2">Employee</span> class that was a concrete class. We would not want users to accidentally instantiate this class and then try to persist a partially defined employee. We could protect against this by defining it to be abstract. We would then end up with all of our non-leaf classes being abstract and the leaf classes being persistent.</p>
          </div>
        </div>
        <div>
          <p id="Sec36" class="Heading2">Inheritance Models<a id="cXXX.720" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">JPA provides support for three different data representations. The use of two of them is fairly widespread, while the third is less common and not required to be supported, though it is still fully defined with the intention that providers might be required to support it in the future.</p>
          <p class="indent">When an entity hierarchy exists, it is always rooted at an entity class. Recall that mapped superclasses do not count as levels in the hierarchy because they contribute only to the entities beneath them. The root entity class must signify the inheritance hierarchy by being annotated with the <span class="FontName2">&#64;Inheritance</span> annotation. This annotation indicates the strategy that should be used for mapping and must be one of the three strategies described in the following sections.</p>
          <p class="indent">Every entity in the hierarchy must either define or inherit its identifier, which means that the identifier must be defined either in the root entity or in a mapped superclass above it. A mapped superclass may be higher up in the class hierarchy than where the identifier is defined.</p>
          <div>
            <p id="Sec37" class="Heading3">Single-Table Strategy<a id="cXXX.721a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.721" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The most common and performant way of storing the state of multiple classes is to define a single table to contain a superset of all the possible state in any of the entity classes. This approach is called, not surprisingly, a single-table strategy. It has the consequence that, for any given table row representing an instance of a concrete class, there may be columns that do not have values because they apply only to a sibling class in the hierarchy.</p>
            <p class="indent">From <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a> we see that the <span class="FontName2">id</span> is located in the root <span class="FontName2">Employee</span> entity class<a id="cXXX.297a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.722" target="_blank" rel="noopener noreferrer"></a> and is shared by the rest of the persistence classes<a id="cXXX.297s" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.723" target="_blank" rel="noopener noreferrer"></a>. All the persistent entities in an inheritance tree must use the same type of identifier. We don't need to think about it very long before we see why this makes sense at both levels. In the object layer, it wouldn't be possible to issue a polymorphic <span class="FontName2">find()</span> operation on a superclass if there were not a common identifier type that we could pass in. Similarly, at the table level, we would need multiple primary key columns but without being able to fill them all in on any given insertion of an instance that only made use of one of them.</p>
            <p class="indent">The table must contain enough columns to store all the state in all the classes. An individual row stores the state of an entity instance of a concrete entity type, which would normally imply that there would be some columns left unfilled in every row. Of course, this leads to the conclusion that the columns mapped to concrete subclass state should be nullable, which is normally not a big issue but could be a problem for some database administrators.</p>
            <p class="indent">In general, the single-table approach tends to be more wasteful of database tablespace, but it does offer peak performance for both polymorphic queries<a id="cXXX.298p" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.724" target="_blank" rel="noopener noreferrer"></a> and write operations. The SQL that is needed to issue these operations is simple, optimized, and does not require joining.</p>
            <p class="indent">To specify the single-table strategy for the inheritance hierarchy, the root entity class is annotated with the <span class="FontName2">&#64;Inheritance</span> annotation with its strategy set to <span class="FontName2">SINGLE_TABLE</span>. In our previous model, this would mean annotating the <span class="FontName2">Employee</span> class as follows:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.SINGLE_TABLE)</span><br><span class="FontName2">public abstract class Employee { ... }</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">As it turns out, though, the single-table strategy is the default one, so we wouldn't strictly even need to include the <span class="FontName2">strategy</span> element at all. An empty <span class="FontName2">&#64;Inheritance</span> annotation would do the trick just as well.</p>
            <p class="indent">In <a href="#Fig11" id="_Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a>, we see the single-table representation of our <span class="FontName2">Employee</span> hierarchy model. In terms of the table structure and schema architecture for the single-table strategy, it makes no difference whether <span class="FontName2">CompanyEmployee</span> is a mapped superclass or an entity.</p>
            <div class="Figure" id="Fig11">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-11.jpg" alt="9781430249269_Fig10-11.jpg" width="196" height="377"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a>. </span>A single-table inheritance data model</p>
            </div>
            <div>
              <p id="Sec38" class="Heading4">Discriminator Column<a id="cXXX.298a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.725" target="_blank" rel="noopener noreferrer"></a></p>
              <p class="noindent">You may have noticed an extra column named <span class="FontName2">EMP_TYPE</span> in <a href="#Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a> that was not mapped to any field in any of the classes in <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. This field has a special purpose and is required when using a single table to model inheritance. It is called a discriminator column and is mapped using the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation in conjunction with the <span class="FontName2">&#64;Inheritance</span> annotation we have already learned about. The <span class="FontName2">name</span> element of this annotation specifies the name of the column that should be used as the discriminator column, and if not specified will be defaulted to a column named ‚ÄúDTYPE‚Äù.</p>
              <p class="indent">A <span class="FontName2">discriminatorType</span> element dictates the type of the discriminator column. Some applications prefer to use strings to discriminate between the entity types, while others like using integer values to indicate the class. The type of the discriminator column may be one of three predefined discriminator column types: <span class="FontName2">INTEGER</span>, <span class="FontName2">STRING</span>, or <span class="FontName2">CHAR</span>. If the <span class="FontName2">discriminatorType</span> element is not specified, then the default type of <span class="FontName2">STRING</span> will be assumed.</p>
            </div>
            <div>
              <p id="Sec39" class="Heading4">Discriminator Value<a id="cXXX.298v" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.726" target="_blank" rel="noopener noreferrer"></a></p>
              <p class="noindent">Every row in the table will have a value in the discriminator column called a discriminator value, or a class indicator, to indicate the type of entity that is stored in that row. Every concrete entity in the inheritance hierarchy, therefore, needs a discriminator value specific to that entity type so that the provider can process or assign the correct entity type when it loads and stores the row. The way this is done is to use a <span class="FontName2">&#64;DiscriminatorValue</span> annotation on each concrete entity class. The string value in the annotation specifies the discriminator value that instances of the class will get assigned when they are inserted into the database. This will allow the provider to recognize instances of the class when it issues queries. This value should be of the same type as was specified or defaulted as the <span class="FontName2">discriminatorType</span> element in the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation.</p>
              <p class="indent">If no <span class="FontName2">&#64;DiscriminatorValue</span> annotation is specified, then the provider will use a provider-specific way of obtaining the value. If the <span class="FontName2">discriminatorType</span> is <span class="FontName2">STRING</span>, then the provider will just use the entity name as the class indicator string. If the <span class="FontName2">discriminatorType</span> is <span class="FontName2">INTEGER</span>, then we would either have to specify the discriminator values for every entity class or none of them. If we were to specify some but not others, then we could not guarantee that a provider-generated value would not overlap with one that we specified.</p>
              <p class="indent"><a href="#list34" id="_list34" target="_blank" rel="noopener noreferrer">Listing 10-34</a> shows how our <span class="FontName2">Employee</span> hierarchy is mapped to a single-table strategy.</p>
              <p class="noindent2"><a href="#_list34" id="list34" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-34.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Single-Table Strategy</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE")</span><br><span class="FontName2">public abstract class Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class ContractEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;DiscriminatorValue("FTEmp")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee { ... }</span><br><br><span class="FontName2">&#64;Entity(name="PTEmp")</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee { ... }</span>
  </pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">The <span class="FontName2">Employee</span> class is the root class, so it establishes the inheritance strategy and discriminator column. We have assumed the default strategy of <span class="FontName2">SINGLE_TABLE</span> and discriminator type of <span class="FontName2">STRING</span>.</p>
              <p class="indent">Neither the <span class="FontName2">Employee</span> nor the <span class="FontName2">CompanyEmployee</span> classes have discriminator values, because discriminator values should not be specified for abstract entity classes, mapped superclasses, transient classes, or any abstract classes for that matter. Only concrete entity classes use discriminator values since they are the only ones that actually get stored and retrieved from the database.</p>
              <p class="indent">The <span class="FontName2">ContractEmployee</span> entity<a id="cXXX.727" target="_blank" rel="noopener noreferrer"></a> does not use a <span class="FontName2">&#64;DiscriminatorValue</span> annotation, because the default string ‚ÄúContractEmployee‚Äù, which is the default entity name that is given to the class, is just what we want. The <span class="FontName2">FullTimeEmployee</span> class explicitly lists its discriminator value to be ‚ÄúFTEmp‚Äù, so that is what is stored in each row for instances of <span class="FontName2">FullTimeEmployee</span>. Meanwhile, the <span class="FontName2">PartTimeEmployee</span> class will get ‚ÄúPTEmp‚Äù as its discriminator value because it set its entity name to be ‚ÄúPTEmp‚Äù, and the entity name gets used as the discriminator value when none is specified.</p>
              <p class="indent">In <a href="#Fig12" id="_Fig12" target="_blank" rel="noopener noreferrer">Figure 10-12</a>, we can see a sample of some of the data<a id="cXXX.727a" target="_blank" rel="noopener noreferrer"></a> that we might find given the earlier model and settings. We can see from the <span class="FontName2">EMP_TYPE</span> discriminator column that there are three different types of concrete entities. We also see null values in the columns that do not apply to an entity instance.</p>
              <div class="Figure" id="Fig12">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-12.jpg" alt="9781430249269_Fig10-12.jpg" width="727" height="269"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig12" target="_blank" rel="noopener noreferrer">Figure 10-12</a>. </span>Sample of single-table inheritance data</p>
              </div>
            </div>
          </div>
          <div>
            <p id="Sec40" class="Heading3">Joined Strategy<a id="cXXX.729" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.730" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">From the perspective of a Java developer, a data model that maps each entity to its own table makes a lot of sense. Every entity, whether it is abstract or concrete, will have its state mapped to a different table. Consistent with our earlier description, mapped superclasses do not get mapped to their own tables but are mapped as part of their entity subclasses.</p>
            <p class="indent">Mapping a table per entity provides the data reuse that a normalized<a id="_Fn2" href="#Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> data schema offers and is the most efficient way to store data that is shared by multiple subclasses in a hierarchy. The problem is that, when it comes time to reassemble an instance of any of the subclasses, the tables of the subclasses must be joined together with the superclass tables. It makes it fairly obvious why this strategy is called the joined strategy. It is also somewhat more expensive to insert an entity instance, because a row must be inserted in each of its superclass tables along the way.</p>
            <p class="indent">Recall from the single-table strategy that the identifier must be of the same type for every class in the hierarchy. In a joined approach, we will have the same type of primary key in each of the tables, and the primary key of a subclass table also acts as a foreign key that joins to its superclass table. This should ring a bell because of its similarity to the multiple-table case earlier in the chapter where we joined the tables together using the primary keys of the tables and used the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation to indicate it. We use this same annotation in the joined inheritance case since we have multiple tables that each contain the same primary key type and each potentially has a row that contributes to the final combined entity state.</p>
            <p class="indent">While joined inheritance is both intuitive and efficient in terms of data storage, the joining that it requires makes it somewhat expensive to use when hierarchies are deep or wide. The deeper the hierarchy, the more joins it will take to assemble instances of the concrete entity at the bottom. The broader the hierarchy the more joins it will take to query across an entity superclass.</p>
            <p class="indent">In <a href="#Fig13" id="_Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a>, we see our <span class="FontName2">Employee</span> example mapped to a joined table architecture. The data for an entity subclass is spread across the tables in the same way that it is spread across the class hierarchy. When using a joined architecture, the decision as to whether <span class="FontName2">CompanyEmployee</span> is a mapped superclass or an entity makes a difference, since mapped superclasses do not get mapped to tables. An entity, even if it is an abstract class, always does. Figure 8-13 shows it as a mapped superclass, but if it were an entity, then an additional <span class="FontName2">COMPANY_EMP</span> table would exist with <span class="FontName2">ID</span> and <span class="FontName2">VACATION</span> columns in it, and the <span class="FontName2">VACATION</span> column in the <span class="FontName2">FT_EMP</span> and <span class="FontName2">PT_EMP</span> tables would not be present.</p>
            <div class="Figure" id="Fig13">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-13.jpg" alt="9781430249269_Fig10-13.jpg" width="752" height="427"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a>. </span>Joined inheritance data model</p>
            </div>
            <p class="indent">To map an entity hierarchy to a joined model, the <span class="FontName2">&#64;Inheritance</span> annotation need only specify <span class="FontName2">JOINED</span> as the strategy. Like the single-table example, the subclasses will adopt the same strategy that is specified in the root entity superclass.</p>
            <p class="indent">Even though there are multiple tables to model the hierarchy, the discriminator column is only defined on the root table, so the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation is placed on the same class as the <span class="FontName2">&#64;Inheritance</span> annotation.</p>
            <div class="notepara">
              <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Some vendors offer implementations of joined inheritance without the use of a discriminator column. Discriminator columns should be used if provider portability is required.</p>
            </div>
            <p class="indent">Our <span class="FontName2">Employee</span> hierarchy example can be mapped using the joined approach shown in <a href="#list35" id="_list35" target="_blank" rel="noopener noreferrer">Listing 10-35</a>. In this example, we have used integer discriminator columns instead of the default string type.</p>
            <p class="noindent2"><a href="#_list35" id="list35" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-35.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using the Joined Strategy</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.JOINED)</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE", discriminatorType=DiscriminatorType.INTEGER)</span><br><span class="FontName2">public abstract class Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("1")</span><br><span class="FontName2">public class ContractEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="FT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("2")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="PT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("3")</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee { ... }</span>
  </pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec41" class="Heading3">Table-per-Concrete-Class Strategy<a id="cXXX.302a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.731" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.732" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">A third approach to mapping an entity hierarchy is to use a strategy where a table per concrete class is defined. This data architecture goes in the reverse direction of non-normalization of entity data and maps each concrete entity class and all its inherited state to a separate table. This has the effect of causing all shared state to be redefined in the tables of all the concrete entities that inherit it. This strategy is not required to be supported by providers but is included because it is anticipated that it will be required in a future release of the API. We will describe it briefly for completeness.</p>
            <p class="indent">The negative side of using this strategy is that it makes polymorphic querying across a class hierarchy more expensive than the other strategies. The problem is that it must either issue multiple separate queries across each of the subclass tables, or query across all of them using a UNION operation, which is generally regarded as being expensive when lots of data is involved. If there are non-leaf concrete classes, then each of them will have its own table. Subclasses of the concrete classes will have to store the inherited fields in their own tables, along with their own defined fields.</p>
            <p class="indent">The bright side of table-per-concrete-class hierarchies when compared to joined hierarchies is seen in cases of querying over instances of a single concrete entity. In the joined case, every query requires a join, even when querying across a single concrete entity class. In the table-per-concrete-class case, it is akin to the single-table hierarchy because the query is confined to a single table. Another advantage is that the discriminator column goes away. Every concrete entity has its own separate table, and there is no mixing or sharing of schema, so no class indicator is ever needed.</p>
            <p class="indent">Mapping our example to this type of hierarchy is a matter of specifying the strategy as <span class="FontName2">TABLE_PER_CLASS</span> and making sure there is a table for each of the concrete classes. If a legacy database is being used, then the inherited columns could be named differently in each of the concrete tables and the <span class="FontName2">&#64;AttributeOverride</span> annotation would come in handy. In this case, the <span class="FontName2">CONTRACT_EMP</span> table didn't have the <span class="FontName2">NAME</span> and <span class="FontName2">S_DATE</span> columns but instead had <span class="FontName2">FULLNAME</span> and <span class="FontName2">SDATE</span> for the <span class="FontName2">name</span> and <span class="FontName2">startDate</span> fields defined in <span class="FontName2">Employee</span>.</p>
            <p class="indent">If the attribute that we wanted to override was an association instead of a simple state mapping, then we could still override the mapping, but we would need to use an <span class="FontName2">&#64;AssociationOverride</span> annotation instead of <span class="FontName2">&#64;AttributeOverride</span>. The <span class="FontName2">&#64;AssociationOverride</span> annotation allows us to override the join columns used to reference the target entity of a many-to-one or one-to-one association defined in a mapped superclass. To show this, we need to add a <span class="FontName2">manager</span> attribute to the <span class="FontName2">CompanyEmployee</span> mapped superclass. The join column is mapped by default in the <span class="FontName2">CompanyEmployee</span> class to the <span class="FontName2">MANAGER</span> column in the two <span class="FontName2">FT_EMP</span> and <span class="FontName2">PT_EMP</span> subclass tables, but in <span class="FontName2">PT_EMP</span> the name of the join column is actually <span class="FontName2">MGR</span>. We override the join column by adding the <span class="FontName2">&#64;AssociationOverride</span> annotation to the <span class="FontName2">PartTimeEmployee</span> entity class and specifying the name of the attribute we are overriding and the join column that we are overriding it to be. <a href="#list36" id="_list36" target="_blank" rel="noopener noreferrer">Listing 10-36</a> shows a complete example of the entity mappings, including the overrides.</p>
            <p class="noindent2"><a href="#_list36" id="list36" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-36.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Table-per-Concrete-Class Strategy</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.TABLE_PER_CLASS)</span><br><span class="FontName2">public abstract class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="name", column=&#64;Column(name="FULLNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="startDate", column=&#64;Column(name="SDATE"))</span><br><span class="FontName2">})</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity &#64;Table(name="FT_EMP")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PENSION")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pensionContribution;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="PT_EMP")</span><br><span class="FontName2">&#64;AssociationOverride(name="manager",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="MGR"))</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The table organization shows how these columns are mapped to the concrete tables. See <a href="#Fig14" id="_Fig14" target="_blank" rel="noopener noreferrer">Figure 10-14</a> for a clear picture of what the tables would look like and how the different types of employee instances would be stored.</p>
            <div class="Figure" id="Fig14">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-14.jpg" alt="9781430249269_Fig10-14.jpg" width="644" height="225"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig14" target="_blank" rel="noopener noreferrer">Figure 10-14</a>. </span>Table-per-concrete-class data model</p>
            </div>
          </div>
        </div>
        <div>
          <p id="Sec42" class="Heading2">Mixed Inheritance<a id="cXXX.733" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.734" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">We should begin this section by saying that the practice of mixing inheritance types within a single inheritance hierarchy is currently outside the specification. We are including it because it is both useful and interesting, but we are offering a warning that it might not be portable to rely on such behavior, even if your vendor supports it.</p>
          <p class="indent">Furthermore, it really makes sense to mix only single-table and joined inheritance types. We will show an example of mixing these two, bearing in mind that support for them is vendor-specific. The intent is that, in future releases of the specification, the more useful cases will be standardized and required to be supported by compliant implementations.</p>
          <p class="indent">The premise for mixing inheritance types is that it is well within the realm of possibilities that a data model includes a combination of single-table and joined-table designs within a single entity hierarchy. This can be illustrated by taking our joined example in <a href="#Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a> and storing the <span class="FontName2">FullTimeEmployee</span> and <span class="FontName2">PartTimeEmployee</span> instances in a single table. This would produce a model that looks like the one shown in <a href="#Fig15" id="_Fig15" target="_blank" rel="noopener noreferrer">Figure 10-15</a>.</p>
          <div class="Figure" id="Fig15">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-15.jpg" alt="9781430249269_Fig10-15.jpg" width="654" height="171"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig15" target="_blank" rel="noopener noreferrer">Figure 10-15</a>. </span>Mixed inheritance data model</p>
          </div>
          <p class="indent">In this example, the joined strategy is used for the <span class="FontName2">Employee</span> and <span class="FontName2">ContractEmployee</span> classes, while the <span class="FontName2">CompanyEmployee</span>, <span class="FontName2">FullTimeEmployee</span>, and <span class="FontName2">PartTimeEmployee</span> classes revert to a single-table model. To make this inheritance strategy switch at the level of the <span class="FontName2">CompanyEmployee</span>, we need to make a simple change to the hierarchy. We need to turn <span class="FontName2">CompanyEmployee</span> into an abstract entity instead of a mapped superclass so that it can bear the new inheritance metadata. Note that this is simply an annotation change, not making any change to the domain model.</p>
          <p class="indent">The inheritance strategies can be mapped as shown in <a href="#list37" id="_list37" target="_blank" rel="noopener noreferrer">Listing 10-37</a>. Notice that we do not need to have a discriminator column for the single-table subhierarchy since we already have one in the superclass <span class="FontName2">EMP</span> table.</p>
          <p class="noindent2"><a href="#_list37" id="list37" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-37.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Mixed Strategies<a id="cXXX.735" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.JOINED)</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE")</span><br><span class="FontName2">public abstract class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE") private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="COMPANY_EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.SINGLE_TABLE)</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PENSION")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pensionContribution;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <p id="Sec43" class="Heading1">Summary</p>
        <p class="noindent">Entity mapping requirements often go well beyond the simplistic mappings that map a field or a relationship to a named column. In this chapter, we addressed some of the more varied and diverse mapping practices that are supported by the Java Persistence API.</p>
        <p class="indent">We discussed how to delimit database identifiers on a case-by-case basis, or for all the mappings in a persistence unit. We illustrated how delimiting identifiers allows the inclusion of special characters and provides case-sensitivity when the target database requires it.</p>
        <p class="indent">A method of doing fine-grained conversion of basic attribute state was shown to be a powerful technique to adapt data. By creating converters we were also able to persist existing and newly defined data types in highly customizable ways. Conversion can be declaratively controlled on a flexible per-attribute or across-the-board basis.</p>
        <p class="indent">We showed how embeddable objects can have state, element collections, further nested embeddables, and even relationships. We gave examples of reusing an embeddable object with relationships in it by overriding the relationship mappings within the embedding entity.</p>
        <p class="indent">Identifiers may be composed of multiple columns. We revealed the two approaches for defining and using compound primary keys, and demonstrated when they could be used. We established how other entities can have foreign key references to entities with compound identifiers and explained how multiple join columns can be used in any context when a single join column applies. We also showed some examples of mapping identifiers, called derived identifiers, which included a relationship as part of their identities.</p>
        <p class="indent">We explained some advanced relationship features, such as read-only mappings and optionality, and showed how they could be of benefit to some models. We then went on to describe some of the more advanced mapping scenarios that included using join tables or sometimes avoiding the use of join tables. The topic of orphan removal was also touched upon and clarified.</p>
        <p class="indent">We went on to show how to distribute entity state across multiple tables and how to use the secondary tables with relationships. We even saw how an embedded object can map to a secondary table of an entity.</p>
        <p class="indent">Finally, we went into detail about the three different inheritance strategies that can be used to map inheritance hierarchies to tables. We explained mapped superclasses and how they can be used to define shared state and behavior. We went over the data models that differentiate the various approaches and showed how to map an entity hierarchy to the tables in each case. We finished off by illustrating how to mix inheritance types within a single hierarchy.</p>
        <p class="indent">In the next chapter, we will continue our discussion of advanced topics but turn our attention to queries and the use of native SQL and stored procedures. We will also exlain how to create entity graphs and use them to create query fetch plans.</p>
        <p class="FootNote"><a id="Fn1" href="#_Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a> Except in the case described later in this section.</p>
        <p class="FootNote"><a id="Fn2" href="#_Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> Normalization of data is a database practice that attempts to remove redundantly stored data. For the seminal paper on data normalization, see ‚ÄúA Relational Model of Data for Large Shared Databanks‚Äù by E. F. Codd (Communications of the ACM, 13(6) June 1970). Also, any database design book or paper should have an overview.</p>
      </div>
    </div>
  </div>
</div>
<div class="accordion accordion-flush">
  <style>
    #spring-boot-3-cookbook h1, #spring-boot-3-cookbook h2, #spring-boot-3-cookbook h3 { font-family: 'Noto Sans',sans-serif}
    #spring-boot-3-cookbook h3 { font-size: 1.1rem; color: #f26 }
    #spring-boot-3-cookbook h2 { font-size: 1.3rem; color: #1362d1; font-weight: 400 }
    #spring-boot-3-cookbook h1 { font-size: 1.7rem; color: #f62; font-weight: 300 }
    #spring-boot-3-cookbook div.flex { display: flex }
    #spring-boot-3-cookbook div.flex > div.IMG---Figure { position: relative; }
    #spring-boot-3-cookbook div.IMG---Figure > p.IMG---Caption {
      position: absolute; margin: 0; right: 1rem; bottom: -.5rem; padding: .4rem .6rem;
      background-color: rgba(255,255,255,.8); border-radius: 1rem; font-family: sans-serif }
    #spring-boot-3-cookbook pre code { color: var(--bs-body-color) }
  </style>
  <h2 class="accordion-header">
    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#spring-boot-3-cookbook" aria-expanded="false" aria-controls="spring-boot-3-cookbook">
      Spring Boot 3 Cookbook: OAuth2 and Observability
    </button>
  </h2>
  <div id="spring-boot-3-cookbook" class="accordion-collapse collapse">
    <div class="content-body w90">
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec12">
              <div class="epub-source">
                <h1>Securing Spring Boot Applications with OAuth2</h1>
                <div>
                  <p><strong class="bold">Open Authorization 2.0</strong> (<strong class="bold">OAuth 2.0</strong>) is an open standard protocol that provides secure authorization for web and mobile applications. It allows users to grant limited access to their resources on one website (called the ‚Äúresource server‚Äù) to another website or application (called the ‚Äúclient‚Äù) without sharing their credentials, such as usernames and passwords. This means that the resource server will never see a user's credentials. OAuth 2.0 is widely used for enabling <strong class="bold">single sign-on</strong> (<strong class="bold">SSO</strong>), accessing third-party APIs, and implementing secure authorization mechanisms. SSO allows a user to log in to any of several related, yet independent, applications with a single ID. Once logged in to an application, the user is not required to reenter the credentials to access the rest of <span class="No-Break">the applications.</span></p>
                  <p><strong class="bold">OpenID Connect</strong> (<strong class="bold">OIDC</strong>) is an open standard for user authentication that's built on top of OAuth 2.0. It's used with OAuth 2.0 to enable secure access to user data. An example of this is when an application allows you to sign in with your Google Account. Usually, they can request access to certain parts of your Google Account profile or permissions to interact with your account on <span class="No-Break">your behalf.</span></p>
                  <p>In this chapter, we will learn how to deploy a basic Spring Authorization Server that we'll be using in most of the recipes in this book. Then, we'll learn about the most common scenarios to protect an application, from a RESTful API to a web application. Finally, we'll apply the same concepts but using two popular cloud solutions: Google Accounts for user authentication and Azure AD B2C for an extensible end-to-end <span class="No-Break">authentication experience.</span></p>
                  <p>Spring Boot offers great support for OAuth2 and OIDC, regardless of the Identity/Authorization server used. It manages the standard OAuth2/OpenID concepts that are implemented by <span class="No-Break">all vendors.</span></p>
                  <div class="flex">
                    <p>In this chapter, we will cover the <span class="No-Break">following recipes:</span></p>
                    <ul>
                      <li>Setting up Spring <span class="No-Break">Authorization Server</span></li>
                      <li>Protecting a RESTful API <span class="No-Break">using OAuth2</span></li>
                      <li>Protecting a RESTful API using OAuth2 with <span class="No-Break">different scopes</span></li>
                      <li>Configuring an MVC application with <span class="No-Break">OpenID authentication</span></li>
                      <li>Logging in with <span class="No-Break">Google Accounts</span></li>
                      <li>Integrating a RESTful API with a cloud <strong class="bold">identity </strong><span class="No-Break"><strong class="bold">provider</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">IdP</strong></span><span class="No-Break">)</span></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec14">
              <div class="epub-source">
                <h1>Setting up Spring Authorization Server</h1>
                <div>
                  <p>Spring Authorization Server is a project under the umbrella of Spring Framework that provides the components you need to create an Authorization Server. In this recipe, you will deploy a very simple Authorization Server that you will use for most of the recipes in this chapter. In the following recipes, you will continue to customize this server to achieve the goals of <span class="No-Break">each exercise.</span></p>
                  <p>The configuration of this server is just for demo purposes. The Authorization Server plays a crucial role in managing and granting access to protected resources. If you plan to use it in production, I recommend following the instructions from the project at <a href="https://docs.spring.io/spring-authorization-server/reference/overview.html" target="_blank">https://docs.spring.io/spring-authorization-server/reference/overview.html</a>. In any case, the principles that we will explain in this book have been adjusted to the OAuth2 specification and well-known practices. For this reason, you will be able to apply what you learn here to any other <span class="No-Break">Authorization Server.</span></p>
                  <h2>Getting ready</h2>
                  <p>To create the Spring Authorization Server, we will use Spring Initializr. You can open this tool in your browser using <a href="https://start.spring.io/" target="_blank">https://start.spring.io/</a> or use it in your code editor if it's <span class="No-Break">been integrated.</span></p>
                  <p>I assume that you have basic knowledge of OAuth2. However, I have added some links in the <em class="italic">See also</em> section that can be useful if you need to go through <span class="No-Break">some concepts.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, we will create a Spring Authorization Server using Spring Initializr and do a very basic configuration to create an application registration. Finally, we'll test the application registration and analyze the results. Follow <span class="No-Break">these steps:</span></p>
                  <ol>
                    <li>Open <a href="https://start.spring.io" target="_blank">https://start.spring.io</a>, as you did in the <em class="italic">Creating a RESTful API</em> recipe in <a href="https://subscription.packtpub.com/book/programming/9781835089491/1"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, and use the same parameters, except change the <span class="No-Break">following options:</span>
                      <ul>
                        <li>For <strong class="bold">Artifact</strong>, <span class="No-Break">type </span><span class="No-Break"><code class="literal">footballauth</code></span></li>
                        <li>For <strong class="bold">Dependencies</strong>, select <strong class="bold">OAuth2 </strong><span class="No-Break"><strong class="bold">Authorization Server</strong></span><span class="No-Break">:</span></li>
                      </ul></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_1.jpg" alt="Figure 2.1: Spring Initializr options for Spring Authorization Server">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1: Spring Initializr options for Spring Authorization Server</p>
                    </div>
                  </div>
                  <p class="list-inset">Click on the <strong class="bold">GENERATE</strong> button to download the project, then unzip the content to your <span class="No-Break">working folder.</span></p>
                  <ol>
                    <li value="2">Now, we need to configure the authorization server. For that, we will create an <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder with the <span class="No-Break">following content:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">server:
  port: 9000
spring:
  security:
    oauth2:
      authorizationserver:
        client:
          basic-client:
            registration:
              client-id: "football"
              client-secret: "{noop}SuperSecret"
              client-authentication-methods:
                - "client_secret_post"
              authorization-grant-types:
                - "client_credentials"
              scopes:
                - "football:read"</code> </pre>
                      </div>
                      <p class="list-inset">We just defined an application that can be authenticated using the client <span class="No-Break">credential flow.</span></p></li>
                    <li>Now, you can execute your Authorization Server. You can retrieve the configuration of our server by making a request to http://localhost:9000/.well-known/openid-configuration. As the path indicates, this is a well-known endpoint that all OAuth2-compliant vendors implement to expose the relevant configuration for client applications. Most of the client libraries can configure themselves just from <span class="No-Break">this endpoint.</span></li>
                    <li>To verify that it works, we can execute the authentication of our client. You can do this by executing the following <code class="literal">POST</code> request <span class="No-Break">via </span><span class="No-Break"><code class="literal">curl</code></span><span class="No-Break">:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=football' \
--data-urlencode 'client_secret=SuperSecret' \
--data-urlencode 'scope=football:read'</code> </pre>
                      </div>
                      <p class="list-inset">You should see a response that looks similar <span class="No-Break">to this:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">{"access_token":"eyJraWQiOiIyMWZkYzEyMy05NTZmLTQ5YWQtODU2 Zi1mNjAxNzc4NzAwMmQiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJiYXNp Yy1jbGllbnQiLCJhdWQiOiJiYXNpYy1jbGllbnQiL CJuYmYiOjE2OTk1NzIwNjcsInNjb3BlIjpbInByb2ZpbGUiXSwiaXNzIj oiaHR0cDovL2xvY2FsaG9zdDo5MDAwIiwiZXhwIjoxNjk5NTcyMzY3LCJ pYXQiOjE2OTk1NzIwNjd9.TavlnbirP_4zGH8WaJHrcCrNs5ZCnStqqiX Kc6pakfvQPviosGdgo9vunq4ogRZWYNjXOS5GYw0XlubSj0UDznnxSLyx 7tR7cEZJSQVHc6kffuozycJ_xl5yzw6_Kv_pJ4fP00b7pbHWO8ciZKUhmW -Pvt5TV8sMFY-uNzgsCtiN5EYdplMUfZdwHMy8yon3bUah8Py7RoAw1bIE ioGUEiK5XLDaE4yGdo8RyyBv4wj3mw6Bs8dcLspLKWXG5spXlZes6XCaSu 0ZXtLE09AgA_Gmq0kwmhWXgnpGKuCkhkXASyJXboQD9TR0y3yTn_aNeiuV MPzX4DQ7IaCKzgmaYg","scope":"profile","token_type":"Bearer","expires_in":299}</code> </pre>
                      </div></li>
                    <li>Now, you can copy the value of the <code class="literal">access_token</code> field, open <a href="https://jwt.ms" target="_blank">https://jwt.ms</a> in your browser, and paste the value there. In the <strong class="bold">Decoded Token</strong> tab, you can see the token in its decoded form, while if you click on the <strong class="bold">Claims</strong> tab, you can see an explanation of <span class="No-Break">each field:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_2.jpg" alt="Figure 2.2: JWT token decoded in jwt.ms">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2: JWT token decoded in jwt.ms</p>
                    </div>
                  </div>
                  <ol>
                    <li value="6">Congratulations ‚Äì you've deployed a Spring Authorization Server and successfully configured an application <span class="No-Break">for authorization.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>Spring OAuth2 Authorization Server contains all the components you need to create an authorization server. With the configuration provided in <code class="literal">application.yml</code>, it created an application with a <code class="literal">client-id</code> value of <code class="literal">basic-client</code>. Let's look at the parameters that were used for the application and see how <span class="No-Break">they work:</span></p>
                  <ul>
                    <li>The <code class="literal">client-id</code> is the identifier of the application we create d. In this case, it <span class="No-Break">is </span><span class="No-Break"><code class="literal">football</code></span><span class="No-Break">.</span></li>
                    <li>The <code class="literal">client-secret</code> is the secret of the application. By using the <code class="literal">{noop}</code> prefix in the secret, we tell Spring Security that the password is not encrypted and can be <span class="No-Break">used as-is.</span></li>
                    <li>The <code class="literal">client-authentication-methods</code> is used to specify how this application can authenticate. By using the <code class="literal">client_secret_post</code> method, we can ensure that the client ID and secret will be sent in a <code class="literal">POST</code> request. We could configure additional methods, such as <code class="literal">client_secret_basic</code>, in which case the client ID and secret will be sent as HTTP basic schema ‚Äì that is, in <span class="No-Break">the URL.</span></li>
                    <li>With the <code class="literal">authorization-grant-types</code>, we specify what grant flows are allowed for this application. By setting <code class="literal">client_credentials</code>, we are configuring an application that won't have a user interface, such as a background server application. If you have an application that will interact with users, you could configure other options, such <span class="No-Break">as </span><span class="No-Break"><code class="literal">authorization_code</code></span><span class="No-Break">.</span></li>
                    <li>Finally, with the <code class="literal">scopes</code>, we are configuring the scopes that are allowed for this application. In this case, it is just the <span class="No-Break"><code class="literal">football:read</code></span><span class="No-Break"> scope.</span></li>
                  </ul>
                  <p>Spring OAuth2 Authorization Server keeps this configuration in memory. As you may have guessed, this is just for demonstration and development purposes. In a production environment, you will need to persist this data. Spring OAuth2 Authorization Server provides support for <span class="No-Break">JPA repositories.</span></p>
                  <p>We used <strong class="bold">JWT MS</strong> (<a href="https://jwt.ms" target="_blank">https://jwt.ms</a>) to inspect the access token that was issued by our authorization server. This tool just decodes the token and describes the standard fields. There is another popular tool named <strong class="bold">JWT IO</strong> (<a href="https://jwt.io" target="_blank">https://jwt.io</a>) that also allows you to validate the token, but it doesn't explain <span class="No-Break">each field.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>You can follow the instructions from the Spring OAuth2 Authorization Server project to implement the core services with <span class="No-Break">JPA: </span><a href="https://docs.spring.io/spring-authorization-server/docs/current/reference/html/guides/how-to-jpa.html" target="_blank"><span class="No-Break">https://docs.spring.io/spring-authorization-server/docs/current/reference/html/guides/how-to-jpa.html</span></a><span class="No-Break">.</span></p>
                  <p>You can use any relational database supported by Spring Data JPA, such as PostgreSQL, which we used in <a href="https://subscription.packtpub.com/book/programming/9781835089491/5"><span class="No-Break"><em class="italic">Chapter 5</em></span></a><span class="No-Break">.</span></p>
                  <h2>See also</h2>
                  <p>In this chapter, we'll manage many OAuth2 concepts, something that can be difficult to understand if you don't have <span class="No-Break">previous knowledge.</span></p>
                  <p>For instance, it is very important to understand the different <span class="No-Break">token types:</span></p>
                  <ul>
                    <li><code class="literal">access_token</code>: This contains all authorization information granted by the authorization server that the resource server <span class="No-Break">will verify.</span></li>
                    <li><code class="literal">id_token</code>: This token is used for session management, normally in client applications, to customize the user interface, <span class="No-Break">for example.</span></li>
                    <li><code class="literal">refresh_token</code>: This token is used to get new <code class="literal">access_tokens</code> and <code class="literal">id_tokens</code> when they are about to expire. <code class="literal">refresh_token</code> is considered a secret as its lifetime is larger than the others and can be used not only to get fresher tokens for the already authorized applications but also for new ones. It is important to protect this <span class="No-Break">token accordingly.</span></li>
                  </ul>
                  <p>I strongly recommend getting familiar with the basic OAuth2 flows and their <span class="No-Break">main purposes:</span></p>
                  <ul>
                    <li><strong class="bold">Client </strong><span class="No-Break"><strong class="bold">credential flow</strong></span><span class="No-Break">:</span>
                      <p class="list-inset">This is the simplest flow and was used in this recipe. It is intended for applications without user interaction ‚Äì for instance, for server applications communicating with other applications. They can be authenticated in different ways, such as with a secret, as seen in this recipe, a certificate, or other more <span class="No-Break">sophisticated techniques.</span></p></li>
                    <li class=" has_sub"><strong class="bold">Authorization code </strong><span class="No-Break"><strong class="bold">grant flow</strong></span><span class="No-Break">:</span>
                      <p class="list-inset">This is intended to authenticate web and mobile applications. This is the two-leg authentication flow, where the user authenticates and allows the application to access the requested scopes. Then, the authentication endpoint issues a short-lived piece of code that should be redeemed in the token endpoint to get an access token. After, the application (not the user) should be authenticated. There are two variants of this flow, depending on how <span class="No-Break">it authenticates:</span></p>
                      <ul>
                        <li>Using a client ID and a secret. This is intended for confidential applications, such as those that can keep secrets. This includes <span class="No-Break">server applications.</span></li>
                        <li>Using a client ID and a challenge, also known as <strong class="bold">Proof Key Challenge Exchange</strong> (<strong class="bold">PKCE</strong>). This is intended for public applications, such as those that cannot keep a secret, such as mobile applications, or applications that just live in the browser, such as <strong class="bold">single-page </strong><span class="No-Break"><strong class="bold">applications</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">SPAs</strong></span><span class="No-Break">).</span></li>
                      </ul></li>
                    <li><strong class="bold">Refresh </strong><span class="No-Break"><strong class="bold">token flow</strong></span><span class="No-Break">:</span>
                      <p class="list-inset">As its name suggests, it is used to refresh access and ID tokens when they are about to expire. For that, it <span class="No-Break">uses </span><span class="No-Break"><code class="literal">refresh_token</code></span><span class="No-Break">.</span></p></li>
                  </ul>
                  <p>There are more flows, but these are the basic ones that will be used in <span class="No-Break">this chapter.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec15">
              <div class="epub-source">
                <h1>Protecting a RESTful API using OAuth2</h1>
                <div>
                  <p>Protecting a resource ‚Äì in this case, a RESTful API ‚Äì is the core functionality of OAuth. In OAuth2, a resource server delegates authorization to access a third-party server ‚Äì that is, the authorization server. In this recipe, you'll learn how to configure a RESTful API application so that it can authorize the requests that are issued by your Spring <span class="No-Break">Authorization Server.</span></p>
                  <p>We will continue with our samples for football data management. You will protect your Football API by only allowing clients who have been granted access by our <span class="No-Break">Authorization Server.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the Authorization Server you created in the <em class="italic">Setting up Spring Authorization Server</em> recipe. If you haven't completed that yet, you can use the authorization server that I've prepared. You can find it in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a>, in the <span class="No-Break"><code class="literal">chapter4/recipe4-2/start</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, you will create a new RESTful API and configure it as a <em class="italic">resource server</em> using the client registration you created in the previous recipe. Follow <span class="No-Break">these steps:</span></p>
                  <ol>
                    <li>First, create a RESTful API using Spring Initializr (<a href="https://start.spring.io" target="_blank">https://start.spring.io</a>). Use the same options that you did in the <em class="italic">Creating a RESTful API</em> recipe in <a href="https://subscription.packtpub.com/book/programming/9781835089491/1"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, except change the <span class="No-Break">following options:</span>
                      <ul>
                        <li>For <strong class="bold">Artifact</strong>, <span class="No-Break">type </span><span class="No-Break"><code class="literal">footballresource</code></span><span class="No-Break">.</span></li>
                        <li>For <strong class="bold">Dependencies</strong>, select <strong class="bold">Spring Web</strong> and <strong class="bold">Oauth2 </strong><span class="No-Break"><strong class="bold">Resource Server</strong></span><span class="No-Break">:</span></li>
                      </ul></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_3.jpg" alt="Figure 2.3: Spring Initializr options for a protected RESTful API">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3: Spring Initializr options for a protected RESTful API</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">GENERATE</strong> to download a ZIP file that contains your project template. Unzip it in your working folder and open it in your <span class="No-Break">code editor.</span></p>
                  <ol>
                    <li value="2">We can create a simple REST controller with a method that returns a list of teams. For that, create a class named <code class="literal">Football.java</code> with the <span class="No-Break">following content:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@RequestMapping("/football")
@RestController
public class FootballController {
    @GetMapping("/teams")
    public List&lt;String&gt; getTeams() {
        return List.of("Argentina", "Australia", "Brazil");
    }
}</code> </pre>
                      </div>
                      <p class="list-inset">Now, let's configure our application for authorization by using the Authorization Server we created in the previous recipe. For that, create an <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder with the <span class="No-Break">following content:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          <strong class="bold">audiences:</strong>
<strong class="bold">          - football</strong>
<strong class="bold">          issuer-uri: http://localhost:9000</strong></code> </pre>
                      </div>
                      <p class="list-inset">You can now execute the application. If you try to invoke the RESTful API using <code class="literal">curl</code>, this is what you'll have <span class="No-Break">to do:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl http://localhost:8080/football/teams</code> </pre>
                      </div>
                      <p class="list-inset">You will receive an <code class="literal">HTTP Error 401 </code><span class="No-Break"><code class="literal">Unauthorized</code></span><span class="No-Break"> error.</span></p></li>
                    <li>We need to get an access token from our Authorization Server first. For that, you can execute the following request <span class="No-Break">using </span><span class="No-Break"><code class="literal">curl</code></span><span class="No-Break">:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=football' \
--data-urlencode 'client_secret=SuperSecret' \
--data-urlencode 'scope=football:read'</code> </pre>
                      </div>
                      <p class="list-inset">The response will look <span class="No-Break">like this:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_4.jpg" alt="Figure 2.4: Access token issued by the Authorization Server">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4: Access token issued by the Authorization Server</p>
                    </div>
                  </div>
                  <ol>
                    <li value="4">Copy the access token value and use it in the <span class="No-Break">next</span><span class="No-Break"></span><span class="No-Break"> request:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl -H "Authorization: Bearer <strong class="bold">&lt;access_token&gt;</strong>" http://localhost:8080/football/teams</code> </pre>
                      </div>
                      <p class="list-inset">In the preceding request, replace <code class="literal">&lt;access_token&gt;</code> with the value of the access token you obtained in the previous request, as shown in <span class="No-Break"><em class="italic">Figure 2</em></span><span class="No-Break"><em class="italic">.4</em></span><span class="No-Break">.</span></p>
                      <p class="list-inset">Now, the resource server will return the expected result, along with a list <span class="No-Break">of teams.</span></p></li>
                    <li>You now have our RESTful API that's protected by the tokens that were issued by the <span class="No-Break">authorization server.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>In this simplified example, you saw how authorization works in OAuth2. There's an authorization server issuing a token with authorization information. A resource server ‚Äì our RESTful API ‚Äì then checks the token's validity and applies the provided configuration. The authorization server can issue the token in different formats, but the most common is via <strong class="bold">JSON Web Tokens</strong> (<strong class="bold">JWT</strong>). A JWT consists of three parts: a header, a payload, and a signature. These parts are encoded in base64 and are separated by period (<code class="literal">.</code>) <span class="No-Break">signs:</span></p>
                  <ul>
                    <li>The header contains the metadata needed to manage the token. It is encoded <span class="No-Break">in base64.</span></li>
                    <li>The payload contains the actual data and claims about the token. It carries information such as the expiration time, issuer, and custom claims. It is encoded <span class="No-Break">in base64.</span></li>
                    <li>The signature is created by taking the encoded header and encoded payload, along with a secret, and signing them using the signing algorithm specified in the header. The signature is used to verify the <em class="italic">authenticity</em> and <em class="italic">integrity</em> of the token so that we can ensure the token was issued by the authorization server and was not modified by <span class="No-Break">anyone else.</span></li>
                  </ul>
                  <p>The resource needs to validate the authenticity and integrity of the token. For that, it needs to verify the signature. The Authorization Server provides an endpoint to download the public key of the certificate being used to sign the token. So, the first thing that the authorization server needs to know is where that endpoint is. We can configure this manually in the <code class="literal">application.yml</code> file, but luckily, Spring Resource Server knows how to retrieve all the information about the authorization server automatically. Just by configuring the <code class="literal">issuer-uri</code> property, it knows how to retrieve the rest of <span class="No-Break">the information.</span></p>
                  <p>Almost all authorization servers in the market can provide the well-known <code class="literal">OpenId</code> endpoint if we add the following path to the issuer URI: <code class="literal">.well-known/openid-configuration</code>. The first time the resource server needs to validate a JWT, it calls that endpoint ‚Äì in our case, http://localhost:9000/.well-known/openid-configuration ‚Äì and retrieves all the information it needs, such as the authorization and token endpoint, the <strong class="bold">JSON Web Key Set</strong> (<strong class="bold">JWKS</strong>) endpoint, which contains the sign-in key, and so on. JWKSs are the public keys that the authorization server can use to sign a token. The clients can download these keys to validate the signature of <span class="No-Break">the JWT.</span></p>
                  <p>Now that we know how the resource server validates that the token has been issued by the authorization server, we need to know how we can validate that the token is intended for our RESTful APIs. In the <code class="literal">application.yml</code> file, we've configured the <code class="literal">audiences</code> field. This indicates the entity for which the token is valid and who or what the token is intended for. The <code class="literal">aud</code> claim helps ensure that a JWT is only accepted by the intended recipient or resource server. The <code class="literal">aud</code> claim is part of the payload of the JWT. In our case, the payload, after decoding the base64, looks <span class="No-Break">like this:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">{
  "sub": "football",
  <strong class="bold">"aud": "football",</strong>
  "nbf": 1699671850,
  "scope": [
    "football:read"
  ],
  "iss": "http://localhost:9000",
  "exp": 1699672150,
  "iat": 1699671850
}</code> </pre>
                  </div>
                  <p>Just by setting <code class="literal">issuer-uri</code> and <code class="literal">audiences</code>, we ensure that only JWT issued by our Authorization Server and those that are intended for our application/audience will be accepted. Spring Resource Server performs other standard checks, such as for the expiration time (the <code class="literal">exp</code> claim) and not valid before (the <code class="literal">nbf</code> claim). Anything else will be rejected with an <code class="literal">HTTP 401 Unauthorized</code> error. In the <em class="italic">Protecting a RESTful API using OAuth2 with different scopes</em> recipe, we'll learn how to use other claims to <span class="No-Break">enhance protection.</span></p>
                  <p>It is important to note that from a Spring Resource Server perspective, it's not important how the client obtained the access token as that responsibility is delegated to the Authorization Server. The Authorization Server may require different levels of validations, depending on the kind of resource being accessed. Some examples of validations are <span class="No-Break">as follows:</span></p>
                  <ul>
                    <li>Client ID and secret, as shown in <span class="No-Break">this example.</span></li>
                    <li>Multiple factors of authentication. For applications with user interaction, the authorization server may consider that the username and password are not enough and force using a second factor of authentication, such as an authentication application, a certificate, and <span class="No-Break">so on.</span></li>
                    <li>If an application tries to access specific scopes, it may require explicit consent. We see this often with social networks when a third-party application needs to access certain parts of our profile or tries to perform special actions, such as publishing on <span class="No-Break">our behalf.</span></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec16">
              <div class="epub-source">
                <h1>Protecting a RESTful API using OAuth2 with different scopes</h1>
                <div>
                  <p>In the previous recipe, we learned how to protect our application. In this recipe, we'll learn how to apply more fine-grained security. We need to apply different levels of access to the application: one general form of read access for the consumers of our RESTful API and administrative access so that we can make changes to <span class="No-Break">the data.</span></p>
                  <p>To apply different levels of access to the API, we'll use the standard OAuth2 concept of <em class="italic">scopes</em>. In OAuth 2.0, <code class="literal">scope</code> is a parameter that's used to specify the level of access and permissions that a client application is requesting from the user and the authorization server. It defines what actions or resources the client application is allowed to perform on behalf of the user. Scopes help ensure that users have control over which parts of their data and resources they grant access to, and they allow for fine-grained access control. In applications with user interaction, granting a scope may imply explicit consent from the user. For applications with no user interaction, it can be configured with <span class="No-Break">administrative consent.</span></p>
                  <p>In our football application, you will create two access levels: one for read-only access and another for <span class="No-Break">administrative access.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, we'll reuse the Authentication Server from the <em class="italic">Setting up Spring Authorization Server</em> recipe and the resource server we created in the <em class="italic">Protecting a RESTful API using OAuth2</em> recipe. If you haven't completed these recipes yet, you can find a working version in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a>, in the <span class="No-Break"><code class="literal">chapter4/recipe4-3/start</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Let's create the <code class="literal">football:read</code> and <code class="literal">football:admin</code> scopes in the Authorization Server and apply the configuration for managing them in the <span class="No-Break">resource server:</span></p>
                  <ol>
                    <li>The first thing you should do is ensure that the scopes are defined in the authorization server. For that, go to the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder of the project you created in the <em class="italic">Setting up Spring Authorization Server</em> recipe. If you're using the implementation I provided, as explained in the <em class="italic">Getting ready</em> section of that recipe, you can find the project in the <code class="literal">footballauth</code> folder. Ensure that the application mentions the <code class="literal">football:read</code> and <code class="literal">football:admin</code> scopes. The application configuration in the <code class="literal">application.yml</code> file should look <span class="No-Break">like this:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  security:
    oauth2:
      authorizationserver:
        client:
          football:
            registration:
              client-id: "football"
              client-secret: "{noop}SuperSecret"
              client-authentication-methods:
                - "client_secret_post"
              authorization-grant-types:
                - "client_credentials"
              <strong class="bold">scopes:</strong>
<strong class="bold">                - "football:read"</strong>
<strong class="bold">                - "football:admin</strong></code> </pre>
                      </div></li>
                    <li>Let's create an action that requires administrative access to the RESTful API. For instance, you can create a method to create a team. For that, in the <code class="literal">FootballController</code> controller class, create a method named <code class="literal">addTeam</code> that's mapped to a <span class="No-Break"><code class="literal">POST</code></span><span class="No-Break"> action:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@PostMapping("/teams")
public String addTeam(@RequestBody String teamName){
  return teamName + " added";
}</code> </pre>
                      </div>
                      <p class="list-inset">You can do a more complex implementation, but for this exercise, we can keep this <span class="No-Break">emulated implementation.</span></p></li>
                    <li>Now, configure the resource server so that it can manage the scopes. For that, create a configuration class that exposes a <span class="No-Break"><code class="literal">SecurityFilterChain</code></span><span class="No-Break"> bean:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@Configuration</strong>
public class SecurityConfig {
    <strong class="bold">@Bean</strong>
    public <strong class="bold">SecurityFilterChain</strong>
    filterChain(HttpSecurity http) throws Exception {
        return http.authorizeHttpRequests(authorize -&gt;
            <strong class="bold">authorize.requestMatchers(HttpMethod.GET, "/football/teams/**")
                .hasAuthority("SCOPE_football:read")
                .requestMatchers(HttpMethod.POST, "/football/teams/**")</strong>
<strong class="bold">            .hasAuthority("SCOPE_football:admin")</strong>
            .anyRequest().authenticated())
            .oauth2ResourceServer(oauth2 -&gt;
            oauth2.jwt(Customizer.withDefaults()))
            .build();
    }
}</code> </pre>
                      </div>
                      <p class="list-inset">Note that as part of <code class="literal">SecurityFilterChain</code>, we defined a couple of <code class="literal">requestMatchers</code> with <code class="literal">HttpMethod</code>, the request path, and the required authority using <span class="No-Break">both scopes.</span></p></li>
                    <li>Now that we have the required configuration, let's run the application and perform some tests to validate <span class="No-Break">its behavior:</span>
                      <ol>
                        <li class="upper-roman">First, get an access token from the authorization server, requesting just the <code class="literal">football:read</code> scope. You can execute the request by running the following <span class="No-Break"><code class="literal">curl</code></span><span class="No-Break"> command:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=football' \
--data-urlencode 'client_secret=SuperSecret' \
--data-urlencode '<strong class="bold">scope=football:read</strong>'</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Take the access token that was returned and use it in the authorization header of the <span class="No-Break">following request:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl -H "Authorization: Bearer &lt;access_token&gt;" http://localhost:8080/football/teams</code> </pre>
                      </div>
                      <p class="list-inset">It should return the data normally and the HTTP response code should <span class="No-Break">be </span><span class="No-Break"><code class="literal">200</code></span><span class="No-Break">.</span></p>
                      <p class="list-inset">However, let's say you try to perform the POST request to create <span class="No-Break">a team:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl -H "Authorization: Bearer &lt;access_token&gt;" -H "Content-Type: application/text" <strong class="bold">--request POST</strong> --data 'Senegal' http://localhost:8080/football/teams -v</code> </pre>
                      </div></li>
                  </ol>
                  <p class="callout-heading">A note on curl</p>
                  <p class="callout">Note that we're starting to use the <code class="literal">-v</code> parameter. It provides a verbose response so that we can see the reasons <span class="No-Break">something fails.</span></p>
                  <p class="list-inset">It will return an HTTP 403 forbidden error, and the details will look <span class="No-Break">as this:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">WWW-Authenticate: Bearer error="insufficient_scope", error_description="The request requires higher privileges than provided by the access token.", error_uri="https://tools.ietf.org/html/rfc6750#section-3.1"</code> </pre>
                  </div>
                  <ol>
                    <li class="upper-roman" value="3">Now, let's retrieve another access token with the <span class="No-Break">appropriate scopes:</span></li>
                  </ol>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">curl --location 'http://localhost:9000/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=football' \
--data-urlencode 'client_secret=SuperSecret' \
--data-urlencode '<strong class="bold">scope=football:read football:admin</strong>'</code> </pre>
                  </div>
                  <p class="list-inset">Note that we can request more than one scope at <span class="No-Break">a time.</span></p>
                  <p class="list-inset">If we execute the request to create a team with the new access token, we'll see that it works as expected and will return something like <span class="No-Break"><code class="literal">Senegal added</code></span><span class="No-Break">.</span></p>
                  <ol>
                    <li value="5">With that, our application is protected and we've applied different levels of protection to our <span class="No-Break">resource server.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>The <code class="literal">SecurityFilterChain</code> bean is a component that's used for configuring the security filters that intercept and process incoming HTTP requests. Here, we created a <code class="literal">SecurityFilterChain</code> bean that looks for two matching patterns: <code class="literal">GET</code> requests that match the <code class="literal">/football/teams/**</code> path pattern and <code class="literal">POST</code> requests that match the same path pattern. <code class="literal">GET</code> requests should have the <code class="literal">SCOPE_football:read</code> authority and <code class="literal">POST</code> should have the <code class="literal">SCOPE_football:admin</code> authority. Once you configure <code class="literal">SecurityFilterChain</code>, it is applied to all incoming HTTP requests. Then, if a request matching the pattern doesn't have the required scope, it will raise an <code class="literal">HTTP 403 </code><span class="No-Break"><code class="literal">forbidden</code></span><span class="No-Break"> response.</span></p>
                  <p>Why is <code class="literal">SCOPE_ prefix</code> used? It is created by the default <code class="literal">JwtAuthenticationConverter</code>. This component transforms the JWT into an <code class="literal">Authentication</code> object. The default <code class="literal">JwtAuthenticationConverter</code> is wired by Spring Security, but you can also register your own converter if you want a <span class="No-Break">different behavior.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>More validations can be performed on JWT. For instance, a common way of validating a request is by checking <span class="No-Break">its roles.</span></p>
                  <p>You can validate a request's roles by registering a <code class="literal">SecurityFilterChain</code> bean. Let's say you have an administrator role defined in your Authorization Server. Here, you can configure a <code class="literal">SecurityFilterChain</code> bean in the resource server to ensure that only users with the <code class="literal">ADMIN</code> role can perform <code class="literal">POST</code> requests on <code class="literal">football/teams path</code>, <span class="No-Break">as follows:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@Bean
public SecurityFilterChain filterChainRoles(HttpSecurity
http) throws Exception {
    return http.authorizeHttpRequests(authorize -&gt;
    authorize.requestMatchers(HttpMethod.POST,
    "football/teams/**")<strong class="bold">.hasRole("ADMIN")</strong>
    .anyRequest().authenticated())
    .oauth2ResourceServer(oauth2 -&gt;
    oauth2.jwt(Customizer.withDefaults()))
    .build();
}</code> </pre>
                  </div>
                  <p>You can make other checks to validate your token. In this case, you can use <code class="literal">OAuth2TokenValidator</code>. For instance, you may want to validate that a given claim is present in your JWT. For that, you can create a class that <span class="No-Break">implements </span><span class="No-Break"><code class="literal">OAuth2TokenValidator</code></span><span class="No-Break">:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">class CustomClaimValidator implements
OAuth2TokenValidator&lt;Jwt&gt; {
    OAuth2Error error = new OAuth2Error("custom_code",
    "This feature is only for special football fans",
    null);
    @Override
    public OAuth2TokenValidatorResult validate(Jwt jwt) {
        <strong class="bold">if (jwt.getClaims().containsKey("specialFan"))</strong>{
            return OAuth2TokenValidatorResult.success();
        }
        else{
            return
                OAuth2TokenValidatorResult.failure(error);
        }
    }
}</code> </pre>
                  </div>
                  <h2>See also</h2>
                  <p>I recommend that you look at the Spring OAuth2 Resource Server project documentation at <a href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/jwt.html" target="_blank">https://docs.spring.io/spring-security/reference/servle<span></span>t/oauth2/resource-server/jwt.html</a> for <span class="No-Break">more details.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec17">
              <div class="epub-source">
                <h1>Configuring an MVC application with OpenID authentication</h1>
                <div>
                  <p>We want to create a new web application for our football fans. To do so, we must authenticate the users when they're accessing the application. We'll use access tokens to access the protected <span class="No-Break">RESTful API.</span></p>
                  <p>In this recipe, we'll learn how to use Spring OAuth2 Client to protect an MVC web application and get access tokens for other <span class="No-Break">protected resources.</span></p>
                  <p>If you plan to use an SPA, you will need to look for OpenID-certified libraries for your <span class="No-Break">target environment.</span></p>
                  <h2>Getting ready</h2>
                  <p>For this recipe, you will reuse the Authorization Server application you created in the <em class="italic">Setting up Spring Authorization Server</em> recipe and the application you created in the <em class="italic">Protecting a RESTful API using OAuth2 with different scopes</em> recipe. I've prepared a working version of both projects in case you haven't completed them yet. You can find them in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a>, in the <span class="No-Break"><code class="literal">chapter4/recipe4-4/start</code></span><span class="No-Break"> folder.</span></p>
                  <p>The authentication process involves some redirections and requires managing sessions for the protected application. We'll use Redis to maintain the sessions for the application. You can download Redis and execute it on your computer, but as we did for other recipes, you can deploy Redis on Docker. For that, just execute the following command in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">docker run --name spring-cache -p 6379:6379 -d redis</code> </pre>
                  </div>
                  <p>This command will download the Redis community image if it is not yet present on your computer and will start the Redis server so that it's listening on port <code class="literal">6379</code> without any credentials. In a production environment, you probably want to secure this service, but in this recipe, we'll keep it open <span class="No-Break">for simplicity.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, you'll create a new web application and integrate it with the existing authorization server and the RESTful API you created in previous recipes. Follow <span class="No-Break">these steps:</span></p>
                  <ol>
                    <li>First, you'll need to create the client registration in the Authorization Server. For that, open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder of the Authorization Server ‚Äì that is, the project you created in the <em class="italic">Setting up Spring Authorization Server</em> recipe. Add the new client registration, <span class="No-Break">as follows:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  security:
    oauth2:
      authorizationserver:
        client:
          football-ui:
            registration:
              client-id: "football-ui"
              client-secret: "{noop}TheSecretSauce"
              client-authentication-methods:
                - "client_secret_basic"
              authorization-grant-types:
                - "authorization_code"
                - "refresh_token"
                - "client_credentials"
              redirect-uris:
                - "http://localhost:9080/login/oauth2/code/football-ui"
              scopes:
                - "openid"
                - "profile"
                - "football:read"
                - "football:admin"
            require-authorization-consent: true</code> </pre>
                      </div></li>
                    <li>As we want to authenticate users, you will need to create at least one user. To do that, in the same <code class="literal">application.yml</code> file in the Authorization Server, add the <span class="No-Break">following configuration:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">User:
    name: "user"
    password: "password"</code> </pre>
                      </div>
                      <p class="list-inset">The <code class="literal">user</code> element should be aligned with the <code class="literal">oauth2</code> element. Remember that the indentation in <code class="literal">.yml</code> files is very important. You can change the username and password and set the values <span class="No-Break">you wish.</span></p>
                      <p class="list-inset">Keep this configuration as you'll use it later in the <span class="No-Break">web application.</span></p></li>
                    <li>Now, let's create a new Spring Boot application for our web application. You can use <em class="italic">Spring Initializr</em>, as you did in the <em class="italic">Creating a RESTful API</em> recipe in <a href="https://subscription.packtpub.com/book/programming/9781835089491/1"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, but change the <span class="No-Break">following options:</span>
                      <ul>
                        <li>For <strong class="bold">Artifact</strong>, <span class="No-Break">type </span><span class="No-Break"><code class="literal">footballui</code></span></li>
                        <li>For <strong class="bold">Dependencies</strong>, select <strong class="bold">Spring Web</strong>, <strong class="bold">Thymeleaf</strong>, <strong class="bold">Spring Session</strong>, <strong class="bold">Spring Data Redis (Access+Driver)</strong>, <strong class="bold">OAuth2 Client</strong>, and <span class="No-Break"><strong class="bold">OAuth2 Security</strong></span><span class="No-Break">:</span></li>
                      </ul></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_5.jpg" alt="Figure 2.5: Spring Initializr options for the web application">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5: Spring Initializr options for the web application</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">GENERATE</strong> to download the project template as a ZIP file. Unzip the file in your development folder and open it in your preferred <span class="No-Break">code editor.</span></p>
                  <ol>
                    <li value="4">There is a known incompatibility between <strong class="bold">Thymeleaf</strong> and <strong class="bold">Spring Security</strong>. To integrate both components, it is necessary to add an additional dependency to <code class="literal">org.thymeleaf.extras: thymeleaf-extras-springsecurity6</code>. For that, open the project's <code class="literal">pom.xml</code> file and add the <span class="No-Break">following dependency:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
    &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
    &lt;artifactId&gt;thymeleaf-extras-springsecurity6
        &lt;/artifactId&gt;
    &lt;version&gt;3.1.1.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code> </pre>
                      </div></li>
                    <li>Let's start by creating our web pages. Since we're following the <strong class="bold">Model View Controller</strong> (<strong class="bold">MVC</strong>) approach, we'll need to create the <code class="literal">Controller</code> class, which will populate a model and then be presented in the view. The view is rendered using the Thymeleaf <span class="No-Break">template engine:</span>
                      <ol>
                        <li class="upper-roman">First, create the <code class="literal">Controller</code> class and name it <code class="literal">FootballController</code> while providing a simple method for the <span class="No-Break">home page:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Controller
public class FootballController {
    @GetMapping("/")
    public String home() {
        return "home";
    }
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">This method returns the name of the view. Now, we need to create <span class="No-Break">the view.</span></li>
                        <li class="upper-roman">For the view, we should create a new template for Thymeleaf. The default template location is the <code class="literal">resources/template</code> folder. In the same folder, create a file named <code class="literal">home.html</code> with the <span class="No-Break">following content:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;The great football app&lt;/title&gt;
    &lt;meta http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;p&gt;Let's see <strong class="bold">&lt;a href="/myself"&gt;</strong> who you are &lt;/a&gt;.
    You will need to login first!&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code> </pre>
                      </div>
                      <p class="list-inset">This is a very basic page, but it now contains a link that we want <span class="No-Break">to protect.</span></p></li>
                    <li>Now, we must configure the application so that it can be authenticated using the Authorization Server and force it to be authenticated for all pages except for the home page we <span class="No-Break">just created:</span>
                      <ol>
                        <li class="upper-roman">To integrate the web application with the Authorization Server, open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and configure the OAuth2 client application, <span class="No-Break">as follows:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  security:
    oauth2:
      client:
        registration:
          football-ui:
            <strong class="bold">client-id: "football-ui"</strong>
<strong class="bold">            client-secret: "TheSecretSauce"</strong>
            redirect-uri:
              "{baseUrl}/login/oauth2/code/
              {registrationId}"
            authorization-grant-type:
              authorization_code
            scope:
              openid,profile,football:read,
              football:admin
        provider:
          <strong class="bold">football-ui:</strong>
<strong class="bold">            </strong><strong class="bold">issuer-uri: http://localhost:9000</strong></code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">You'll need the parameters that you defined in the <span class="No-Break">Authorization Server.</span></li>
                        <li class="upper-roman">Now, configure the application so that it protects all pages except the home page and uses the OAuth2 login credentials. For that, create a new configuration class named <code class="literal">SecurityConfiguration</code> and create a <span class="No-Break"><code class="literal">SecurityFilterChain</code></span><span class="No-Break"> bean:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@Configuration</strong>
<strong class="bold">@EnableWebSecurity</strong>
public class SecurityConfiguration {
    @Bean
    public <strong class="bold">SecurityFilterChain</strong>
    defaultSecurityFilterChain(HttpSecurity http)
    throws Exception {
        http.authorizeHttpRequests(
            (authorize) -&gt; authorize
            <strong class="bold">.requestMatchers("/").permitAll()</strong>
            <strong class="bold">.anyRequest().authenticated()</strong>)
            .<strong class="bold">oauth2Login</strong>(Customizer.withDefaults());
        return http.build();
    }
}</code> </pre>
                      </div>
                      <p class="list-inset">With this configuration, you've protected all pages, except the root. So, let's create the rest of <span class="No-Break">the pages.</span></p></li>
                    <li>Next, we need to create a page to show the user information. To do that, in the same <code class="literal">FootballController</code> controller, create a new method, <span class="No-Break">as follows:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@GetMapping("/myself")
public String user(Model model,
<strong class="bold">@AuthenticationPrincipal OidcUser</strong> oidcUser) {
    model.addAttribute("userName",
        oidcUser.getName());
    model.addAttribute("audience",
        oidcUser.getAudience());
    model.addAttribute("expiresAt",
        oidcUser.getExpiresAt());
    model.addAttribute("claims",
        oidcUser.getClaims());
    return "myself";
}</code> </pre>
                      </div>
                      <p class="list-inset">Here, we are asking Spring Boot to inject <code class="literal">OidcUser</code> as a method parameter and we are creating a model that we'll use in the view <span class="No-Break">named </span><span class="No-Break"><code class="literal">myself</code></span><span class="No-Break">.</span></p>
                      <p class="list-inset">Now, create a file named <code class="literal">myself.html</code> in the <code class="literal">resources/templates</code> folder. Put the following content in <code class="literal">&lt;body&gt;</code> to show the <span class="No-Break"><code class="literal">Model</code></span><span class="No-Break"> data:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;body&gt;
    &lt;h1&gt;This is what we can see in your OpenId
        data&lt;/h1&gt;
    &lt;p&gt;Your username &lt;span style="font-weight:bold"
        th:text="${userName}" /&gt;! &lt;/p&gt;
    &lt;p&gt;Audience &lt;span style="font-weight:bold"
        th:text="${audience}" /&gt;.&lt;/p&gt;
    &lt;p&gt;Expires at &lt;span style="font-weight:bold"
        th:text="${expiresAt}" /&gt;.&lt;/p&gt;
    &lt;/div&gt;
    &lt;h2&gt;Here all the claims&lt;/h2&gt;
    &lt;table&gt;
        &lt;tr th:each="claim: ${claims}"&gt;
            &lt;td th:text="${claim.key}" /&gt;
            &lt;td th:text="${claim.value}" /&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;h2&gt;Let's try to use your rights&lt;/h2&gt;
    &lt;a href="<strong class="bold">/teams</strong>"&gt;Teams&lt;/a&gt;
&lt;/body&gt;</code> </pre>
                      </div>
                      <p class="list-inset">As you can see, there is a link to <code class="literal">/teams</code>. This link will open a new page showing the teams. The teams page retrieves data from the RESTful API you created in the <em class="italic">Protecting a RESTful API using OAuth2 with different </em><span class="No-Break"><em class="italic">scopes</em></span><span class="No-Break"> recipe.</span></p></li>
                    <li>Let's create a new method in <code class="literal">FootballController</code> so that we can get the teams. For that, you will get an access token by using the Spring Boot <span class="No-Break">OAuth2 client:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@GetMapping("/teams")
public String teams(<strong class="bold">@RegisteredOAuth2AuthorizedClient("football-ui") OAuth2AuthorizedClient authorizedClient</strong>, Model model) {
    RestTemplate restTemplate = new RestTemplate();
    HttpHeaders headers = new HttpHeaders();
    <strong class="bold">headers.add(HttpHeaders.AUTHORIZATION, "Bearer " + authorizedClient.getAccessToken().getTokenValue());</strong>
    HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(null,
        headers);
    ResponseEntity&lt;String&gt; response =
        restTemplate.exchange(
        "http://localhost:8080/football/teams",
        HttpMethod.GET, entity, String.class);
    model.addAttribute("teams", response.getBody());
    return "teams";
}</code> </pre>
                      </div>
                      <p class="list-inset">You need to pass the access token in the <code class="literal">Authorization</code> header, with the <code class="literal">Bearer</code> string as <span class="No-Break">a prefix.</span></p></li>
                    <li>To allow the web application to use the RESTful API, you'll need to include <code class="literal">football-ui</code>, the web application audience, as an accepted audience. For that, in the project you created in the <em class="italic">Protecting a RESTful API using OAuth2 with different scopes</em> recipe, open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and add <code class="literal">football-ui</code> to the <code class="literal">audiences</code> property. The <code class="literal">application.yml</code> file should look <span class="No-Break">like this:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          <strong class="bold">audiences:</strong>
          - football
          <strong class="bold">- football-ui</strong>
          issuer-uri: http://localhost:9000</code> </pre>
                      </div></li>
                    <li>There is still an important detail we must cover before we start the new application: we need to configure Redis. The only settings that are required for it are <code class="literal">hostname</code> and <code class="literal">port</code>. For that, open the <code class="literal">application.yml</code> file of the <code class="literal">football-ui</code> project again and set the <span class="No-Break">following configuration:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  data:
    redis:
      host: localhost
      port: 6379</code> </pre>
                      </div></li>
                    <li>The last setting to configure is the application port. The resource server is already using port <code class="literal">8080</code>. To avoid port conflicts, we need to change the port of the <code class="literal">football-ui</code> project. For that, in the same <code class="literal">application.yml</code> file, add the <span class="No-Break">following setting:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">server:
  port: 9080</code> </pre>
                      </div>
                      <p class="list-inset">You can set any port that is not being used yet. Keep in mind that it's part of the configuration in the Authorization Server. If you modify the port, you will need to modify the configuration in the <span class="No-Break">authorization server.</span></p></li>
                    <li>Now, you can run the application. Go to http://localhost:9080 in <span class="No-Break">your browser:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_6.jpg" alt="Figure 2.6: The application's home page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6: The application's home page</p>
                    </div>
                  </div>
                  <p class="list-inset">Here, you will see the home page, which is the only route that is not protected. If you click on the <strong class="bold">who you are</strong> link, you will be redirected to the login page in the <span class="No-Break">Authorization Server:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_7.jpg" alt="Figure 2.7: Login page in the authorization server">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7: Login page in the authorization server</p>
                    </div>
                  </div>
                  <p class="list-inset">Apply the username and password you configured in <em class="italic">Step 2</em> and click on the <strong class="bold">Sign in</strong> button. You'll be redirected to the consent page, where you should permit the scopes being requested by <span class="No-Break">the application:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_8.jpg" alt="Figure 2.8: Consent page in the authorization server">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8: Consent page in the authorization server</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">Submit Consent</strong>; you will be redirected to the application. The OAuth client application will complete the process by redeeming the access code generated by the authentication endpoint to obtain the ID token, access token, and refresh token. This part of the process is transparent for you as it's managed by the <span class="No-Break">OAuth2 client.</span></p>
                  <p class="list-inset">Once it's done this, you'll be returned to the application on the page you created to show the user <span class="No-Break">authentication data:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_9.jpg" alt="Figure 2.9: Application page with user OpenID data">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9: Application page with user OpenID data</p>
                    </div>
                  </div>
                  <p class="list-inset">If you click on the <strong class="bold">Teams</strong> link, it will call the RESTful API to get the <span class="No-Break"><code class="literal">teams</code></span><span class="No-Break"> data:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_10.jpg" alt="Figure 2.10: The application page showing the data from the RESTful API">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10: The application page showing the data from the RESTful API</p>
                    </div>
                  </div>
                  <p>With that, your web application is protected by OpenID and it can call another <span class="No-Break">OAuth2-protected resource.</span></p>
                  <h2>How it works‚Ä¶</h2>
                  <p>In this project, you protected your web application by using OIDC. It is an authentication protocol that is an extension of OAuth 2.0. It provides a standardized way for users to log in to web applications or mobile apps using their existing accounts with IdPs. In our exercise, we used the Authorization Server as an IdP <span class="No-Break">as well.</span></p>
                  <p>The OIDC server normally provides a discovery endpoint at <code class="literal">.well-known/openid-configuration</code>. If this is not provided, then it was likely hidden intentionally by the administrator. That endpoint provides all the information the client applications need to authenticate. In our application, we used the <em class="italic">authorization code grant flow</em>. It involves <span class="No-Break">several steps:</span></p>
                  <ol>
                    <li>First, the client application redirects the user for authentication, requesting the required scopes for <span class="No-Break">application usage.</span></li>
                    <li>Then, the user is authenticated. Depending on the features provided by the authorization server, it could use sophisticated mechanisms to validate the user, such as certificates, multiple authentication factors, or even <span class="No-Break">biometric features.</span></li>
                    <li>If the user is authenticated, the authorization server may ask the user for consent or not, depending on the scopes requested by the <span class="No-Break">client application.</span></li>
                    <li>Once authenticated, the Authorization Server will redirect the user to the client application, providing a short-lived authorization code. Then, the client application will redeem the authorization code on the token endpoint (provided by the discovery endpoint). The authorization server will return the tokens with the scopes that have been consented to. The scopes that have not been consented by the user won't be present in the issued tokens. The following tokens are returned by the <span class="No-Break">authorization server:</span>
                      <ul>
                        <li>An ID token containing the session information. This token should not be used for authorization, just for <span class="No-Break">authentication purposes.</span></li>
                        <li>An access token, which contains the authorization information, such as the scopes that have been consented. If the application requires a scope, it should validate the scopes returned and manage <span class="No-Break">them accordingly.</span></li>
                        <li>A refresh token, which is used to get new tokens before <span class="No-Break">they expire.</span></li>
                      </ul></li>
                  </ol>
                  <p>Since many redirects are involved in this process, the client application needs to keep the state of the user, hence the requirement for session management. The Spring Framework provides a convenient way to manage sessions <span class="No-Break">using Redis.</span></p>
                  <p>Keep in mind that the client application needs to access the discovery endpoint when it starts. For that reason, remember to start your authorization server before the <span class="No-Break">client application.</span></p>
                  <p>In this exercise, you configured the root page as the only permitted page without authentication. To access any other page, it must be authenticated. For that reason, just by trying to navigate to <code class="literal">/myself</code> or <code class="literal">/teams</code>, the authorization process <span class="No-Break">is initiated.</span></p>
                  <h2>See also</h2>
                  <p>Many modern applications are SPA. This type of application runs mostly in the browser. Also, note that many libraries implement OIDC. I recommend using an OpenID-certified library as they are validated <span class="No-Break">by peers.</span></p>
                  <p>Even with the growing popularity of SPA, I haven't explained the authentication of this type of application as it is not related to Spring Boot. However, if you are interested in integrating an SPA with Spring Authorization Server, I recommend following the guidelines from the Spring OAuth2 Authorization Server project <span class="No-Break">at </span><span class="No-Break">https://docs.spring.io/spring-authorization-server/docs/current/reference/html/guides/how-to-pkce.html</span><span class="No-Break">.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec18">
              <div class="epub-source">
                <h1>Logging in with Google Accounts</h1>
                <div>
                  <p>You have a new requirement for your football application: your users want to log in to your application using their <span class="No-Break">Gmail accounts.</span></p>
                  <p>To implement this scenario, you will configure your Authorization Server as an OAuth2 client, with Google Accounts being their IdP. You will learn how to create an OAuth2 Client ID in Google Cloud and integrate it into <span class="No-Break">your application.</span></p>
                  <h2>Getting ready</h2>
                  <p>For this recipe, you will reuse the Spring Authorization Server you created in the <em class="italic">Setting up Spring Authorization Server</em> and <em class="italic">Protecting a RESTful API using OAuth2 with different scopes</em> recipes, as well as the web application you created in the <em class="italic">Configuring an MVC application with OpenID authentication</em> recipe. The MVC application stores sessions in Redis. You can run a Redis server in Docker, as explained in the <em class="italic">Configuring an MVC application with OpenID </em><span class="No-Break"><em class="italic">authentication</em></span><span class="No-Break"> recipe.</span></p>
                  <p>I've prepared a working version of the required recipes in case you haven't completed them yet. You can find them in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a>, in the <span class="No-Break"><code class="literal">chapter4/recipe4-5/start</code></span><span class="No-Break"> folder.</span></p>
                  <p>As you will integrate the application with Google Accounts, you will need a Google Account. If you don't have a Google Account yet, you can create one <span class="No-Break">at </span><a href="https://accounts.google.com" target="_blank"><span class="No-Break">https://accounts.google.com</span></a><span class="No-Break">.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Let's start by creating an OAuth2 client in Google and then use the configuration provided to configure our Authorization Server so that it can log in to your application <span class="No-Break">using GoogleAaccounts:</span></p>
                  <ol>
                    <li>Let's start by opening the Google Cloud console at <a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a>. You will need to log in using your Google Account. Once you've done this, you will see the Google Cloud <span class="No-Break">home page:</span>
                      <ol>
                        <li class="upper-roman">First, you'll need to create <span class="No-Break">a project:</span></li>
                      </ol></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_11.jpg" alt="Figure 2.11: The Google Cloud home page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11: The Google Cloud home page</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="2">To create the project, click <strong class="bold">Select </strong><span class="No-Break"><strong class="bold">a project</strong></span><span class="No-Break">.</span></li>
                    <li class="upper-roman">In the <strong class="bold">Select a project</strong> dialogue, click <span class="No-Break"><strong class="bold">NEW PROJECT</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_12.jpg" alt="Figure 2.12: Creating a new project">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12: Creating a new project</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="4">Name the project ‚Äì for <span class="No-Break">instance, </span><span class="No-Break"><code class="literal">springboot3-cookbook</code></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_13.jpg" alt="Figure 2.13: New Project settings">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13: New Project settings</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="5">Click <strong class="bold">CREATE</strong>. This process will take a few moments. A notification will appear when it is completed. Once created, select <span class="No-Break">the project.</span></li>
                  </ol>
                  <ol>
                    <li value="2">Now that we have a project, let's configure the consent page for our web application. For that, open the <strong class="bold">APIs &amp; Services</strong> menu and <span class="No-Break">choose </span><span class="No-Break"><strong class="bold">Credentials</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_14.jpg" alt="Figure 2.14: The Credentials menu">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.14: The Credentials menu</p>
                    </div>
                  </div>
                  <p class="list-inset">On the <strong class="bold">Credentials</strong> page, you will see a reminder to create the consent page for <span class="No-Break">the application:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_15.jpg" alt="Figure 2.15: The Credentials home page with a reminder to configure the OAuth consent screen highlighted">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.15: The Credentials home page with a reminder to configure the OAuth consent screen highlighted</p>
                    </div>
                  </div>
                  <p class="list-inset">Click on the <strong class="bold">CONFIGURE CONSENT SCREEN</strong> button and follow the instructions to configure the consent page. For <strong class="bold">User Type</strong>, select <strong class="bold">External</strong> and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">CREATE</strong></span><span class="No-Break">.</span></p>
                  <p class="list-inset">With this type of user, the application will start in testing mode. This means that only some test users will be able to use it. Once you've completed the development process and the application is ready, you can publish it. To do this, your site must be verified. We won't publish the application in this recipe, but if you plan to use it in your application, you'll need to complete <span class="No-Break">this step.</span></p>
                  <p class="list-inset">After selecting <strong class="bold">External</strong> for <strong class="bold">User Type</strong>, there is a four-step process you must <span class="No-Break">go through:</span></p>
                  <ol>
                    <li class="upper-roman">First, we have the <strong class="bold">OAuth </strong><span class="No-Break"><strong class="bold">consent</strong></span><span class="No-Break"> screen:</span>
                      <ul>
                        <li>Here, you should configure the application's name. You can set it as <strong class="bold">Spring Boot 3 Cookbook</strong>, <span class="No-Break">for instance.</span></li>
                        <li>You should configure a user support email. You can use the same email address that you use for your <span class="No-Break">Google Account.</span></li>
                        <li>You should also configure the Developer Contact Information email. Again, you can use the same email address that you use for your <span class="No-Break">Google Account.</span></li>
                        <li>The rest of the parameters are optional. We don't need to configure them <span class="No-Break">for now.</span></li>
                      </ul></li>
                    <li class="upper-roman">For <strong class="bold">Update selected scopes</strong>, click <strong class="bold">ADD OR REMOVE SCOPES</strong> and select <strong class="bold">openid</strong>, <strong class="bold">userinfo.email</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="bold">userinfo.profile</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_16.jpg" alt="Figure 2.16: Selecting scopes">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.16: Selecting scopes</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="3">Then, <span class="No-Break">click </span><span class="No-Break"><strong class="bold">UPDATE</strong></span><span class="No-Break">.</span></li>
                    <li class="upper-roman">In <strong class="bold">test users</strong> step, click <strong class="bold">ADD USERS</strong> to add some testing users who will be able to access the application before it's published. You can add a different Google Account to test <span class="No-Break">the application.</span></li>
                    <li class="upper-roman">In the <strong class="bold">summary</strong> step, you will see a summary of your consent screen. You can click <strong class="bold">BACK TO DASHBOARD</strong> to return to the <strong class="bold">OAuth consent </strong><span class="No-Break"><strong class="bold">screen</strong></span><span class="No-Break"> page.</span></li>
                  </ol>
                  <ol>
                    <li value="3">Next, we will create the client credentials. For that, once again, navigate to the <strong class="bold">Credentials</strong> page, as shown in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.17</em>. Once you are on the <strong class="bold">Credentials</strong> page, click <strong class="bold">+ CREATE CREDENTIALS</strong> and select <strong class="bold">OAuth </strong><span class="No-Break"><strong class="bold">client ID</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_17.jpg" alt="Figure 2.17: Selecting OAuth client ID credentials">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.17: Selecting OAuth client ID credentials</p>
                    </div>
                  </div>
                  <ul>
                    <li>For <strong class="bold">Application type</strong>, select <span class="No-Break"><strong class="bold">Web application</strong></span></li>
                    <li>For <strong class="bold">Name</strong>, <span class="No-Break">set </span><span class="No-Break"><code class="literal">football-gmail</code></span></li>
                    <li>For <strong class="bold">Authorized redirect URIs</strong>, <span class="No-Break">add </span><span class="No-Break">http://localhost:9000/login/oauth2/code/football-gmail</span><span class="No-Break">:</span></li>
                  </ul>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_18.jpg" alt="Figure 2.18: Creating an OAuth client ID">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.18: Creating an OAuth client ID</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">CREATE</strong>. A dialogue box will appear, informing you that the client was created and showing you the <strong class="bold">Client ID</strong> and <strong class="bold">Client secret</strong> details. We'll need this data to configure the Authorization Server, so keep <span class="No-Break">it safe:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_19.jpg" alt="Figure 2.19: OAuth client created">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.19: OAuth client created</p>
                    </div>
                  </div>
                  <p class="list-inset">There is a button to download a JSON file containing the configuration. Click on it and save the JSON file in a secure place as it contains the credentials that are required to use <span class="No-Break">the client.</span></p>
                  <ol>
                    <li value="4">Now, we can configure the Spring OAuth2 <span class="No-Break">Authorization Server:</span>
                      <ol>
                        <li class="upper-roman">First, we need to add the OAuth2 client dependency. For that, open the <code class="literal">pom.xml</code> file and add the <span class="No-Break">following dependency:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-oauth2-client
        &lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Next, open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and add the client configuration <span class="No-Break">for Google:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring
  security:
    oauth2:
      client:
        registration:
          football-gmail:
            <strong class="bold">client-id: "replace with your client id"</strong>
<strong class="bold">            client-secret: "replace with your secret"</strong>
            redirect-uri:
              "{baseUrl}/login/oauth2/code/
              {registrationId}"
            authorization-grant-type:
              authorization_code
            scope: openid,profile,email
        provider:
          football-gmail:
            issuer-uri: https://accounts.google.com
            user-name-attribute: given_name</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">Replace the <code class="literal">client-id</code> and <code class="literal">client-secret</code> fields with the values you obtained in <span class="No-Break"><em class="italic">Step 2</em></span><span class="No-Break">.</span></li>
                        <li class="upper-roman">The last step to configure the Authorization Server is defining the behavior of the security checks. For that, create a configuration class <span class="No-Break">named </span><span class="No-Break"><code class="literal">SecurityConfig</code></span><span class="No-Break">:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@Configuration</strong>
<strong class="bold">@EnableWebSecurity</strong>
public class SecurityConfig {
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="5">Then, add a <span class="No-Break"><code class="literal">SecurityFilterChain</code></span><span class="No-Break"> bean:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Bean
<strong class="bold">@Order(1)</strong>
public SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http)
        throws Exception{
    OAuth2AuthorizationServerConfiguration
        .applyDefaultSecurity(http);
    http.getConfigurer(
        OAuth2AuthorizationServerConfigurer.class)
        .oidc(Customizer.withDefaults());
    http
        .exceptionHandling((exceptions) -&gt; exceptions
            .defaultAuthenticationEntryPointFor(
                new LoginUrlAuthenticationEntryPoint(
                    "/oauth2/authorization/
                    football-gmail"),
                new MediaTypeRequestMatcher(
                    MediaType.TEXT_HTML)
            )
        )
        .oauth2ResourceServer((oauth2) -&gt;
            oauth2.jwt(Customizer.withDefaults()));
    return http.build();
}</code> </pre>
                      </div>
                      <p class="list-inset">The preceding code configures Spring Security to use OAuth 2.0 and OpenID Connect 1.0 for authentication, as well as to accept JWT access tokens for certain requests. For instance, it will accept requests that provide JWT access tokens to get <span class="No-Break">user information.</span></p>
                      <p class="list-inset">You will also need to add another <code class="literal">SecurityFilterChain</code> bean but with less priority. It will initiate the OAuth2 login process, which means it will initiate the authentication as a client application in Google, as configured in the <span class="No-Break"><code class="literal">application.yml</code></span><span class="No-Break"> file:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Bean
<strong class="bold">@Order(2)</strong>
public SecurityFilterChain
defaultSecurityFilterChain(HttpSecurity http)
        throws Exception {
    http
        .authorizeHttpRequests((authorize) -&gt;
            authorize
            .anyRequest().authenticated())
        .oauth2Login(Customizer.withDefaults());
    return http.build();
}</code> </pre>
                      </div>
                      <p class="list-inset">The preceding code configures Spring Security to require authentications for all requests and to use OAuth 2.0 for <span class="No-Break">logging in.</span></p></li>
                    <li>With that, your OAuth2 Authorization Server has been configured to require authentication using Google Accounts. Now, you can run all <span class="No-Break">your environments:</span>
                      <ul>
                        <li>Run the Authorization Server you <span class="No-Break">just configured</span></li>
                        <li>Run the RESTful API server you created in the <em class="italic">Protecting a RESTful API using OAuth2 with different </em><span class="No-Break"><em class="italic">scopes</em></span><span class="No-Break"> recipe</span></li>
                        <li>Run the web application you created in the <em class="italic">Configuring an MVC application with OpenID </em><span class="No-Break"><em class="italic">authentication</em></span><span class="No-Break"> recipe</span></li>
                      </ul>
                      <p class="list-inset">When you navigate to <code class="literal">http://localhost:9080/myself</code>, you will be asked to log in using a <span class="No-Break">Google Account:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_20.jpg" alt="Figure 2.20: Logging in using a Google Account">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.20: Logging in using a Google Account</p>
                    </div>
                  </div>
                  <p class="list-inset">Once you've logged in, you will see that the application is the same. You can now use the claims issued by the Authorization Server and invoke the <span class="No-Break">RESTful API.</span></p>
                  <h2>How it works‚Ä¶</h2>
                  <p>Because we're using the Authorization Server with just the login delegated in Google, the Authorization Server doesn't need to maintain a user repository, though it still has the responsibility of issuing tokens. This means that when the application requests to identify a user, the Authorization Server redirects the login to Google. Once back, the Authorization Server continues issuing tokens. Due to this, you didn't need to change the code in the MVC web application or the <span class="No-Break">RESTful API.</span></p>
                  <p>It is possible to configure the MVC application so that it bypasses the authorization server and logs in to Google Accounts directly. You just need to replace the OAuth2 client configuration in the MVC web application with the client configuration you used in the Authorization server. However, in that case, you won't be able to use the access tokens that have been issued by Google to protect your RESTful API. This is because Google access tokens are intended to be used with Google services only and they are not <span class="No-Break">standard JWT.</span></p>
                  <p>The main complexity is configuring the security chain as there are many options available. In the <code class="literal">SecurityConfig</code> class, there are two <code class="literal">Beans</code> with <span class="No-Break">different priorities.</span></p>
                  <p>The <code class="literal">SecurityConfig</code> class defines two <code class="literal">SecurityFilterChain</code> beans. Here, <code class="literal">SecurityFilterChain</code> is essentially a chain of filters that Spring Security uses to perform various security checks. Each filter in the chain has a specific role, such as authenticating <span class="No-Break">the user.</span></p>
                  <p>The first <code class="literal">SecurityFilterChain</code> bean is defined with an order of 1, meaning it will be the first filter chain to be consulted. This filter chain has been configured to apply default security settings for an OAuth 2.0 authorization server. It also enables OpenID Connect 1.0 via the <code class="literal">oidc(Customizer.withDefaults())</code> <span class="No-Break">method call.</span></p>
                  <p>The configuration also specifies that if a user is not authenticated, they should be redirected to the OAuth 2.0 login endpoint. This is done using <code class="literal">LoginUrlAuthenticationEntryPoint</code> with a URL <span class="No-Break">of </span><span class="No-Break"><code class="literal">/oauth2/authorization/football-gmail</code></span><span class="No-Break">.</span></p>
                  <p>The filter chain is also configured to accept JWT access tokens for user info and/or client registration. This is done using the <code class="literal">oauth2ResourceServer((oauth2) -&gt; oauth2.jwt(Customizer.withDefaults()))</code> <span class="No-Break">method call.</span></p>
                  <p>The second <code class="literal">SecurityFilterChain</code> bean is defined with an order of 2, meaning it will be consulted if the first filter chain does not handle the request. The <code class="literal">anyRequest().authenticated()</code> chain of methods means that any request must <span class="No-Break">be authenticated.</span></p>
                  <p>The <code class="literal">oauth2Login(Customizer.withDefaults())</code> method call configures the application to use OAuth 2.0 for authentication. The <code class="literal">Customizer.withDefaults()</code> method call is used to apply the default configuration for OAuth <span class="No-Break">2.0 login.</span></p>
                  <h2>See also</h2>
                  <p>As you can see, integrating a third-party authentication in the Authorization Server just requires configuring the client application for the IdP. So, if you need to integrate with another social provider, you will need to obtain the client <span class="No-Break">application data.</span></p>
                  <p>If you want to integrate with GitHub, you can create an application registration on the <span class="No-Break">https://github.com/settings/developers</span><span class="No-Break"> page.</span></p>
                  <p>For Facebook, you can create your application on the developer's page <span class="No-Break">at </span><span class="No-Break">https://developers.facebook.com/apps</span><span class="No-Break">.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch03lvl1sec19">
              <div class="epub-source">
                <h1>Integrating a RESTful API with a cloud IdP</h1>
                <div>
                  <p>Now that your application is becoming more and more popular, you decide to delegate your authentication to a cloud IdP as they offer advanced protection for sophisticated threats. You decide to use Azure AD B2C. This service is intended for public-facing applications, allowing customers to sign in and sign up, as well as customize the user journey, social network integration, and other <span class="No-Break">interesting features.</span></p>
                  <p>What you'll learn in this recipe can be applied to other cloud IdPs, such as Okta, AWS Cognito, Google Firebase, and many others. Spring Boot offers specialized starters that simplify the process of integrating with an IdP <span class="No-Break">even more.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, we'll integrate the application you prepared in the <em class="italic">Configuring an MVC application with OpenID authentication</em> recipe. If you haven't completed that recipe yet, I've prepared a working version that you can find in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</a>, in the <code class="literal">chapter4/recipe4-6/start</code> folder. This recipe also requires Redis, as explained in the <em class="italic">Configuring an MVC application with OpenID authentication</em> recipe. The easiest way to deploy it on your computer is by <span class="No-Break">using Docker.</span></p>
                  <p>As we'll be integrating with Azure AD B2C, you will need an Azure subscription. If you don't have one, you can create a free account at https://azure.microsoft.com/free. Azure AD B2C offers a free tier that allows up to 50,000 monthly <span class="No-Break">active users.</span></p>
                  <p>If you don't have an Azure AD B2C tenant, please follow the instructions at <a href="https://learn.microsoft.com/azure/active-directory-b2c/tutorial-create-tenant" target="_blank">https://learn.microsoft.com/azure/active-directory-b2c/tutorial-create-tenant</a> to create one before starting <span class="No-Break">this recipe.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Follow these steps to build a smooth sign-in/signup process with Azure AD B2C and learn how to connect it seamlessly with your Spring Boot application for large-scale <span class="No-Break">user authentication:</span></p>
                  <ol>
                    <li>The first thing you'll need to do is create an application registration in Azure AD B2C. An application registration is the same as the client registration you created in Spring Authorization Server in previous recipes. You can create the application registration in the <strong class="bold">App </strong><span class="No-Break"><strong class="bold">registrations</strong></span><span class="No-Break"> section:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_21.jpg" alt="Figure 2.21: Creating an app registration in Azure AD B2C">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.21: Creating an app registration in Azure AD B2C</p>
                    </div>
                  </div>
                  <ol>
                    <li value="2">On the <strong class="bold">App registrations</strong> page, set the <span class="No-Break">following parameters:</span>
                      <ul>
                        <li>For <strong class="bold">Name</strong>, set the name of the application. I suggest that you use <span class="No-Break"><code class="literal">Football UI</code></span><span class="No-Break">.</span></li>
                        <li>For <strong class="bold">Supported account types</strong>, select <strong class="bold">Accounts in any identity provider or organizational directory (for authenticating users with user flows)</strong>. It's the <span class="No-Break">default option.</span></li>
                        <li>For <strong class="bold">Redirect URI (recommended)</strong>, configure <strong class="bold">Web</strong> as the platform and <code class="literal">http://localhost:9080/login/oauth/code</code> as the value of the <span class="No-Break">redirect UI:</span></li>
                      </ul></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_22.jpg" alt="Figure 2.22: Application registration options in Azure AD B2C">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.22: Application registration options in Azure AD B2C</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">Register</strong> to continue with the application <span class="No-Break">registration</span><span class="No-Break"></span><span class="No-Break"> process.</span></p>
                  <ol>
                    <li value="3">Once you have created the application registration, you need to configure a client secret. You can do this in the <strong class="bold">Certificates &amp; secrets</strong> section of the application registration <span class="No-Break">you've created:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_23.jpg" alt="Figure 2.23: Creating a new client secret">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.23: Creating a new client secret</p>
                    </div>
                  </div>
                  <ol>
                    <li value="4">Once you've created the secret, the secret value generated by Azure AD B2C will appear. You should copy the value now as it won't be accessible again. Keep it safe as you'll need <span class="No-Break">it later.</span></li>
                    <li>Finally, we must create a user flow. A user flow is a configuration policy that can be used to set up the authentication experience for end users. Set the <span class="No-Break">following options:</span>
                      <ul>
                        <li>For <strong class="bold">User flow type</strong>, select <strong class="bold">Sign up and sign in</strong>. Set the <span class="No-Break">version </span><span class="No-Break"><strong class="bold">Recommended</strong></span><span class="No-Break">.</span></li>
                        <li>For <strong class="bold">Name</strong>, type <code class="literal">SUSI</code>; this is an acronym for ‚Äúsign up and <span class="No-Break">sign in.‚Äù</span></li>
                        <li>For <strong class="bold">Identity providers</strong>, select <span class="No-Break"><strong class="bold">Email signup</strong></span><span class="No-Break">.</span></li>
                        <li>For <strong class="bold">User attributes and token claims</strong>, select <strong class="bold">Given Name</strong> and <strong class="bold">Surname</strong>. For both attributes, check the <strong class="bold">Collect attribute</strong> and <strong class="bold">Return </strong><span class="No-Break"><strong class="bold">claim</strong></span><span class="No-Break"> boxes.</span></li>
                        <li>Keep the rest of the <span class="No-Break">options as-is:</span></li>
                      </ul></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_24.jpg" alt="Figure 2.24: The Create a user flow page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.24: The Create a user flow page</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">Create</strong> to create the <span class="No-Break">user flow.</span></p>
                  <ol>
                    <li value="6">Now, let's configure our application. First, you'll need to add the appropriate dependencies. For that, open the <code class="literal">pom.xml</code> file of the web application and add the <span class="No-Break"><code class="literal">org.springframework.boot:spring-boot-starter-oauth2-client</code></span><span class="No-Break"> dependency:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                      </div></li>
                    <li>Then, you'll need to configure the Azure AD B2C settings in the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder. Replace the Oauth2 client settings with the B2C ones. The file should look <span class="No-Break">as follows:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">server:
  port: 9080
<strong class="bold">spring:</strong>
  <strong class="bold">cloud:</strong>
<strong class="bold">    azure:</strong>
<strong class="bold">      active-directory:</strong>
<strong class="bold">        b2c:</strong>
<strong class="bold">          enabled: true</strong>
<strong class="bold">          base-uri:</strong>
<strong class="bold">            </strong>https://sb3cookbook.b2clogin.com/
              sb3cookbook.onmicrosoft.com/
<strong class="bold">          credential:</strong>
<strong class="bold">            client-id:</strong>
<strong class="bold">              aa71b816-3d6e-4ee1-876b-83d5a60c4d84</strong>
<strong class="bold">            </strong><strong class="bold">client-secret: '&lt;the secret&gt;</strong>'
<strong class="bold">          login-flow: sign-up-or-sign-in</strong>
<strong class="bold">          logout-success-url: </strong>http://localhost:9080
<strong class="bold">          user-flows:</strong>
<strong class="bold">            sign-up-or-sign-in: B2C_1_SUSI</strong>
<strong class="bold">          user-name-attribute-name: given_name</strong>
  data:
    redis:
      host: localhost
      port: 6379</code> </pre>
                      </div>
                      <p class="list-inset">In the <code class="literal">client-secret</code> field, set the value you kept in <em class="italic">Step 4</em>. I recommend enclosing the secret value in quotation marks since the secret likely contains reserved characters that can cause unexpected behavior when the <code class="literal">application.yaml</code> file is <span class="No-Break">being processed.</span></p></li>
                    <li>To complete the OpenID configuration to allow users to log in to your application with Azure AD B2C, you'll need to adjust the security chain by applying an Azure AD OIDC configurer. To do this, modify the <code class="literal">SecurityConfiguration</code> class by adding <code class="literal">AadB2cOidcLoginConfigurer</code> in the constructor to allow bean injection, and then use it in the existing <code class="literal">defaultSecurityFilterChain</code> method, <span class="No-Break">as follows:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private final <strong class="bold">AadB2cOidcLoginConfigurer configurer</strong>;
public SecurityConfiguration(<strong class="bold">AadB2cOidcLoginConfigurer</strong>
<strong class="bold">configurer</strong>) {
    this.configurer = configurer;
}
@Bean
public SecurityFilterChain
defaultSecurityFilterChain(HttpSecurity http) throws
Exception {
    http
        .authorizeHttpRequests((authorize) -&gt;
            authorize
            .requestMatchers("/").permitAll()
            .anyRequest().authenticated())
        .apply(<strong class="bold">configurer</strong>);
    return http.build();
}</code> </pre>
                      </div></li>
                    <li>At this point, you can run your web application and authenticate with Azure AD B2C. However, there's still something pending that's protecting the RESTful API server with Azure <span class="No-Break">AD B2C.</span>
                      <p class="list-inset">To get around this, you can modify the dependencies. For that, open the <code class="literal">pom.xml</code> file of the RESTful API project and replace the <code class="literal">org.springframework.boot: spring-boot-starter-oauth2-resource-server</code> dependency <span class="No-Break">with </span><span class="No-Break"><code class="literal">com.azure.spring:spring-cloud-azure-starter-active-directory-b2c</code></span><span class="No-Break">:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-starter-active-
    directory-b2c&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                      </div></li>
                    <li>Now, modify the <code class="literal">application.yml</code> file so that it configures the Azure B2C <span class="No-Break">client registration:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
  cloud:
    azure:
      active-directory:
        b2c:
          enabled: true
          profile:
            tenant-id:
              b2b8f451-385b-4b9d-9268-244a8f05b32f
          credential:
            client-id:
              aa71b816-3d6e-4ee1-876b-83d5a60c4d84
          base-uri: https://sb3cookbook.b2clogin.com
          user-flows:
            sign-up-or-sign-in: B2C_1_SISU</code> </pre>
                      </div></li>
                    <li>Now, you can run both the web application and the RESTful server since both are protected with Azure <span class="No-Break">AD B2C:</span>
                      <ol>
                        <li class="upper-roman">Open your browser and navigate to <code class="literal">http://localhost:8080/myself</code>. As the method is protected, you will be redirected to the <strong class="bold">Azure AD B2C Sign up or sign </strong><span class="No-Break"><strong class="bold">in</strong></span><span class="No-Break"> page:</span></li>
                      </ol></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_25.jpg" alt="Figure 2.25: The Azure AD B2C default Sign up or sign in page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.25: The Azure AD B2C default Sign up or sign in page</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="2">If you click on the <strong class="bold">Sign up now</strong> link, you can create a <span class="No-Break">new user:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_26.jpg" alt="Figure 2.26: Sign-up page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.26: Sign-up page</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="3">The first step is to provide a valid email address. Once you've done this click <strong class="bold">Send verification code</strong>. You will receive an email containing a verification code that you will need to provide on this page. Once verified, you can introduce the rest of <span class="No-Break">the fields.</span></li>
                    <li class="upper-roman">When you return to the page, you will see the claims that have been provided by Azure <span class="No-Break">AD B2C:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_27.jpg" alt="Figure 2.27: Our web page showing the claims from Azure B2C">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.27: Our web page showing the claims from Azure B2C</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="5">If you click on the <strong class="bold">Teams</strong> link, you will see the same data that you did in the <em class="italic">Configuring an MVC application with OpenID </em><span class="No-Break"><em class="italic">authentication</em></span><span class="No-Break"> recipe.</span></li>
                    <li class="upper-roman">If you click on the <strong class="bold">Logout</strong> link, you will be redirected to the default <span class="No-Break">logout page:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_28.jpg" alt="Figure 2.28: The default logout page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.28: The default logout page</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="7">Finally, if you click on the <strong class="bold">Log Out</strong> button, you will be redirected to the logout endpoint in Azure <span class="No-Break">AD B2C.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>The <code class="literal">com.azure.spring:spring-cloud-azure-starter-active-directory-b2c</code> dependency includes both the Spring OAuth2 client and Spring OAuth2 resource starters that we used in previous recipes. On top of those starters, it also includes specific components to adapt the Azure AD B2C-specific features. For instance, the discovery endpoint cannot be inferred just from the issuer URL as it is dependent on the Azure AD B2C policy <span class="No-Break">being used.</span></p>
                  <p>The Azure AD B2C starter maps the configuration used in the Azure portal to the configuration on your <code class="literal">application.yml</code> file. Apart from that, the application doesn't require specific changes as it follows the <span class="No-Break">OAuth2 specification.</span></p>
                  <p>In Azure AD B2C, we defined an app registration. This is equivalent to the concept of a client in Spring <span class="No-Break">Authorization Server.</span></p>
                  <p>Azure AD B2C allows us to define different policies so that we can customize the user experience. We created a policy that performs the sign-up and sign-in process using the default settings, but you can define an edit profile or reset password policy as well. Other interesting capabilities include defining custom interfaces and integrating other IdPs. For instance, it's quite easy to integrate with cloud providers such as Google Accounts, social network providers such as Facebook and Instagram, and enterprise IdPs such as <span class="No-Break">Azure Entra.</span></p>
                  <p>One of the main advantages of this solution is that users can register themselves; they don't need an administrator to do this <span class="No-Break">for them.</span></p>
                  <p>This recipe doesn't intend to review all the possibilities of Azure AD B2C ‚Äì it's been provided to help you understand how to integrate your Spring Boot application with Azure <span class="No-Break">AD B2C.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>An interesting and probably more frequent scenario is when our RESTful API uses a different application registration than the UI application. When I build a RESTful API, I usually design it while keeping one thing in mind: more than one client should be able to consume it. This works for different scenarios, such as the web and mobile versions, or allowing a third-party application to consume some of the APIs. In that scenario, you can create a dedicated application registration for your RESTful API and create different application roles with different access levels. Then, you can assign the corresponding role to the <span class="No-Break">consumer applications.</span></p>
                  <p>When you create the application registration for the RESTful API, you can create the roles by opening the manifest and including the desired roles of your application. For instance, we can create the <code class="literal">football.read</code> role for general consumer access and the <code class="literal">football.admin</code> role for administrative access. It would look <span class="No-Break">like this:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_29.jpg" alt="Figure 2.29: The application registration manifest with two application roles">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.29: The application registration manifest with two application roles</p>
                    </div>
                  </div>
                  <p>Then, in the RESTful application registration area, go to <strong class="bold">Expose an API</strong> and assign an <strong class="bold">Application ID </strong><span class="No-Break"><strong class="bold">URI</strong></span><span class="No-Break"> value:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_30.jpg" alt="Figure 2.30: Assigning an Application ID URI value">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.30: Assigning an Application ID URI value</p>
                    </div>
                  </div>
                  <p>Then, we can assign permissions to the RESTful API. Go to <strong class="bold">API permissions</strong> and assign <span class="No-Break"><strong class="bold">Application permissions</strong></span><span class="No-Break">:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_02_31.jpg" alt="Figure 2.31: Assigning application permissions to the consumer application">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.31: Assigning application permissions to the consumer application</p>
                    </div>
                  </div>
                  <p>Now, the RESTful API has its own application registration. This means that you can configure the application with its own audience, instead of the UI application. To configure that, go to the <code class="literal">application.yml</code> file of the RESTful API and change the <code class="literal">client-id</code> property to the client ID of the application registration of the <span class="No-Break">RESTful API.</span></p>
                  <p>If you want to use the application roles to provide different access levels, you will need to use <code class="literal">AadJwtGrantedAuthoritiesConverter</code> from the Azure AD B2C starter. You can register the bean in the <code class="literal">SecurityConfig</code> class, <span class="No-Break">as follows:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@Bean
public Converter&lt;Jwt, Collection&lt;GrantedAuthority&gt;&gt;
aadJwtGrantedAuthoritiesConverter() {
    return new <strong class="bold">AadJwtGrantedAuthoritiesConverter</strong>();
}
@Bean
public JwtAuthenticationConverter
aadJwtAuthenticationConverter() {
    JwtAuthenticationConverter converter = new
        JwtAuthenticationConverter();
        converter.setJwtGrantedAuthoritiesConverter(
            <strong class="bold">aadJwtGrantedAuthoritiesConverter</strong>());
    return converter;
}</code> </pre>
                  </div>
                  <p>By default, the Spring OAuth2 resource server only converts the <code class="literal">scope</code> claim and the application roles will be provided in the <code class="literal">roles</code> claim. The converter generates authorities for each role with the <code class="literal">APPROLE_</code> prefix. So, you can restrict access using these authorities <span class="No-Break">like so:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    return http
        .authorizeHttpRequests(authorize -&gt; authorize
            .requestMatchers(HttpMethod.GET,
                "/football/teams/**").hasAnyAuthority(
                "APPROLE_football.read",
                "APPROLE_football.admin")
            .requestMatchers(HttpMethod.POST,
                "/football/teams/**").hasAnyAuthority(
                "APPROLE_football.admin")
            .anyRequest().authenticated())
        .oauth2ResourceServer(oauth2 -&gt;
            oauth2.jwt(Customizer.withDefaults()))
        .build();
}</code> </pre>
                  </div>
                  <p>Here's what the payload of an access token with the application roles <span class="No-Break">looks like:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">{
  <strong class="bold">¬´aud¬ª: ¬´fdc345e8-d545-49af-aa1a-04a087364c8b¬ª,</strong>
  "iss": "https://login.microsoftonline.com/b2b8f451-385b-
    4b9d-9268-244a8f05b32f/v2.0",
  "iat": 1700518483,
  "nbf": 1700518483,
  "exp": 1700522383,
  "aio": "ASQA2/8VAAAAIXIjK+
    28DPOc4epV22pKGfqdRSnps2dtReyZY7MPhpk=",
  "azp": "aa71b816-3d6e-4ee1-876b-83d5a60c4d84",
  "azpacr": "1",
  "oid": "d88d83d6-421f-41e2-ba99-f49516fd439a",
  "rh": "0.ASQAUfS4sls4nUuSaCRKjwWzL-hFw_
    1F1a9JqhoEoIc2TIskAAA.",
  <strong class="bold">¬´roles¬ª: [</strong>
<strong class="bold">    "football.read",</strong>
<strong class="bold">    "football.admin"</strong>
<strong class="bold">  ],</strong>
  "sub": "d88d83d6-421f-41e2-ba99-f49516fd439a",
  "tid": "b2b8f451-385b-4b9d-9268-244a8f05b32f",
  "uti": "JSxYHbHkpUS91mwBtxNaAA",
  "ver": "2.0"
}</code> </pre>
                  </div>
                  <p>By doing this, only the allowed client applications will be able to consume the <span class="No-Break">RESTful API.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="content-body w90">
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec20">
              <div class="epub-source">
                <h1>Observability, Monitoring, and Application Management</h1>
                <div>
                  <p>Monitoring and observability are crucial aspects of managing and maintaining the health, performance, and reliability of modern applications. In microservices-oriented applications, with multiple instances of different services running at the same time to deliver a solution, observability and monitoring help in understanding the interactions between these services and <span class="No-Break">identifying issues.</span></p>
                  <p>Monitoring plays a crucial role in large environments, enabling resource utilization and performance metrics to be tracked. This, in turn, facilitates dynamically scaling resources to effectively meet the demands of the system. This is especially useful in cloud computing environments, where you pay for the resources used and where you can adapt your application resources to the real demands of your users. Without monitoring, how do you know if your application is running at 100% CPU and the response time is so slow that your users abandon <span class="No-Break">your application?</span></p>
                  <p>When you have multiple microservices running in your application and there's an issue, observability is crucial in identifying the failing component and the context in which <span class="No-Break">errors occur.</span></p>
                  <p>Observability and monitoring are also very important for continuous improvement. You can use the insights gained from monitoring to make data-driven decisions, enhance performance, and refine the solution <span class="No-Break">over time.</span></p>
                  <p>Spring Boot, through Actuator, provides not only monitoring but also management capabilities that allow you to interact with the application in production environments. This capability not only allows you to detect potential issues in the application but also helps in troubleshooting <span class="No-Break">at runtime.</span></p>
                  <p>In this chapter, you will gain insights into activating observability and monitoring features within your Spring Boot applications. We'll start by providing health checks in your application. Here, you'll learn how to leverage the data that's generated by your application through popular open source solutions. This chapter will also cover creating traces within your system, allowing you to correlate activities across different microservices and explore them using Zipkin. Additionally, you will learn how to monitor the exposed metrics of your application using Prometheus and Grafana. Beyond the standard metrics provided by Spring Boot and its associated components, you will generate custom metrics tailored to your application's specifics and monitor them. Once your application becomes both monitorable and observable, you can also integrate with commercial tools while considering the plethora of powerful monitoring solutions available in the market that are well-suited for production environments. Finally, you will learn how to change application settings at runtime so that you can troubleshoot <span class="No-Break">your application.</span></p>
                  <p>In this chapter, we're going to cover the <span class="No-Break">following recipes:</span></p>
                  <ul>
                    <li>Adding Actuator to <span class="No-Break">your application</span></li>
                    <li>Creating a custom <span class="No-Break">Actuator endpoint</span></li>
                    <li>Using probes and creating a custom <span class="No-Break">health check</span></li>
                    <li>Implementing <span class="No-Break">distributed tracing</span></li>
                    <li>Accessing <span class="No-Break">standard metrics</span></li>
                    <li>Creating your <span class="No-Break">own metrics</span></li>
                    <li>Integrating your application with Prometheus <span class="No-Break">and Grafana</span></li>
                    <li>Changing the settings of a <span class="No-Break">running application</span></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec22">
              <div class="epub-source">
                <h1>Adding Actuator to your application</h1>
                <div>
                  <p>So, you plan to develop a new RESTful API to complete your football-related suite of services. You are concerned about the responsiveness of your application and our aim to provide a resilient service. For that reason, you are very interested in monitoring your application <span class="No-Break">health properly.</span></p>
                  <p>Before you start to monitor your application, your application should be monitorable. For that, you have decided to start using <strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Boot Actuator</strong></span><span class="No-Break">.</span></p>
                  <p>Spring Boot Actuator comprises a set of production-ready functionalities packaged with the Spring Framework. It incorporates various built-in tools and endpoints that are designed to allow you to monitor, manage, and interact with Spring Boot applications within a production setting. Actuator simplifies the process of comprehending and resolving runtime behaviors in Spring <span class="No-Break">Boot applications.</span></p>
                  <p>The Actuator module exposes multiple endpoints, including <code class="literal">health</code>, <code class="literal">metrics</code>, <code class="literal">info</code>, <code class="literal">dump</code>, and <code class="literal">env</code>, among others, offering operational insights into the running application. Once this dependency is included, you have a lot of out-of-the-box endpoints available. Customizing and extending these endpoints can easily be achieved and provides flexibility in terms <span class="No-Break">of configuration.</span></p>
                  <p>In this recipe, you will learn how to include Spring Boot Actuator in your project and use some of the endpoints that are provided out of <span class="No-Break">the box.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, we'll create an application using the <em class="italic">Spring Initializr</em> tool. As you did in previous chapters of this book, you can use the tool in your browser by going to <a href="https://start.spring.io" target="_blank">https://start.spring.io</a> or integrating it into your favorite <span class="No-Break">code editor.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Let's create a project with Actuator enabled and start exploring the <span class="No-Break">endpoints provided:</span></p>
                  <ol>
                    <li>Create a project using the <em class="italic">Spring Initializr</em> tool. Open <a href="https://start.spring.io" target="_blank">https://start.spring.io</a> and use the same parameters that you used in the <em class="italic">Creating a RESTful API recipe</em> of <a href="https://subscription.packtpub.com/book/programming/9781835089491/1"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, except change the <span class="No-Break">following options:</span>
                      <ul>
                        <li>For <strong class="bold">Artifact</strong>, <span class="No-Break">type </span><span class="No-Break"><code class="literal">fooballobs</code></span></li>
                        <li>For <strong class="bold">Dependencies</strong>, select <strong class="bold">Spring Web</strong> and <strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Boot Actuator</strong></span></li>
                      </ul></li>
                    <li>Download the template that was generated with <em class="italic">Spring Initializr</em> and unzip the content to your <span class="No-Break">working directory.</span></li>
                    <li>If you run the application now, you can access the health endpoint at <code class="literal">/actuator/health</code>. Before running the application, we'll expose some endpoints. For that, create an <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and add the <span class="No-Break">following content:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    endpoints:
        web:
            exposure:
                include: <strong class="bold">health,env,metrics,beans,loggers</strong></code> </pre>
                      </div></li>
                    <li>Now, run the application. You can now access the exposed <span class="No-Break">Actuator endpoints:</span>
                      <ul>
                        <li><code class="literal">http://localhost:8080/actuator/health</code>: This endpoint provides health information about your application. It is very useful in containerized environments such as Kubernetes to ensure that your application is up <span class="No-Break">and running.</span></li>
                        <li>http://localhost:8080/actuator/env: This endpoint returns the environment variables of <span class="No-Break">the application.</span></li>
                        <li><code class="literal">http://localhost:8080/actuator/metrics</code>: This endpoint returns a list that contains the metrics that have been exposed by the application. You can get the values of any of the metrics that have been exposed by appending the name to the metrics endpoint. For instance, to get <code class="literal">process.cpu.usage</code>, you can <span class="No-Break">request </span><span class="No-Break">http://localhost:8080/actuator/metrics/process.cpu.usage</span><span class="No-Break">.</span></li>
                        <li><code class="literal">http://localhost:8080/actuator/beans</code>: This endpoint returns a list with the beans registered in the IoC container ‚Äì that is, a list of beans that can be injected into <span class="No-Break">other beans.</span></li>
                        <li><code class="literal">http://localhost:8080/actuator/loggers</code>: This endpoint returns the list of log levels and loggers of the application. It also allows to modify the log level <span class="No-Break">at runtime.</span></li>
                      </ul></li>
                    <li>In this recipe, you exposed just some of the available endpoints. You can find the full list of built-in endpoints <span class="No-Break">at </span><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints" target="_blank"><span class="No-Break">https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints</span></a><span class="No-Break">.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>When you integrate Actuator into your application, it provides a set of endpoints that can be used for monitoring your application and managing its behavior. In addition to the built-in endpoints, it lets you add <span class="No-Break">your own.</span></p>
                  <p>Endpoints can be enabled or disabled. By default, all endpoints are enabled except the shutdown endpoint ‚Äì as its name suggests, you can use it to gracefully shut down the application. Then, the endpoints can be exposed, meaning that they can be accessed remotely using HTTP requests or JMX. By default, only the health endpoint is exposed. In this book, we'll mostly focus on HTTP as it can be used with standard monitoring tools not specific to the Java ecosystem. HTTP is only available for web applications; if you're developing another type of application, you will need to <span class="No-Break">use JMX.</span></p>
                  <p>Depending on the components you use, more data will be exposed. For instance, when you include Spring Data JPA, the Spring Data metrics become available, so you will have to configure the number of open connections and other relevant metrics for Spring <span class="No-Break">Data monitoring.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>Some of the endpoints provided by Actuator may expose very sensitive information. So, the health endpoint is the only one that's exposed by default. If your applications can only be accessed inside a virtual network or protected with a firewall, maybe you can keep endpoints open. Whether your application is publicly exposed or you simply want to control who accesses your Actuator endpoint, you may want to protect them, as explained in <a href="https://subscription.packtpub.com/book/programming/9781835089491/2"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>. For instance, a security configuration could look <span class="No-Break">as follows:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
                .authorizeHttpRequests(authorize -&gt;
                      <strong class="bold">authorize.requestMatchers("/actuator/**").hasRole("ADMIN")</strong>
                        .anyRequest().authenticated())
                .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt(Customizer.withDefaults()))
                .build();
    }
}</code> </pre>
                  </div>
                  <p>You can refer to Spring Boot's official documentation at <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security" target="_blank">https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.security</a> for <span class="No-Break">more details.</span></p>
                  <h2>See also</h2>
                  <p>In addition to endpoints provided by Spring Boot and the components used, Actuator provides a flexible implementation that allows you to create your own endpoints. Later in this chapter, you will learn how to create your own Actuator endpoint, metrics, and custom <span class="No-Break">health checks.</span></p>
                  <p>See the <em class="italic">Creating a custom Actuator endpoint</em>, <em class="italic">Creating a custom health check</em>, and <em class="italic">Creating your own metrics</em> recipes for <span class="No-Break">more information.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec23">
              <div class="epub-source">
                <h1>Creating a custom Actuator endpoint</h1>
                <div>
                  <p>In our example, we are developing a new RESTful API that requires a file to be loaded from blob storage. That file doesn't change frequently, which means it's loaded in memory at application startup and is not reloaded again automatically. You need to know which version of the file is loaded, and you want to force a reload when there is a <span class="No-Break">new version.</span></p>
                  <p>To implement this feature, you will use a custom Actuator endpoint. This endpoint will have a <code class="literal">GET</code> operation to return the current file version, and a <code class="literal">POST</code> method to reload <span class="No-Break">the file.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the application you created in the <em class="italic">Adding Actuator to your application</em> recipe. I've prepared a working version in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</a>. It can be found in the <span class="No-Break"><code class="literal">chapter3/recipe3-2/start</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Let's modify the RESTful API so that it loads a file from a folder and returns some results. Once you've done this, you'll need to create a custom Actuator endpoint that returns the file that's been loaded. You will also need to configure the endpoint to reload <span class="No-Break">the file:</span></p>
                  <ol>
                    <li>Start by creating a class that loads a file and keeps the content <span class="No-Break">in memory:</span>
                      <ol>
                        <li class="upper-roman">Let's name it <code class="literal">FileLoader</code> and add the <span class="No-Break">following code:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public class FileLoader {
    private String fileName;
    private List&lt;String&gt; teams;
    private String folder;
    public FileLoader(String folder) {
        this.folder = folder;
    }
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">To load the file and keep the content in memory, add the <span class="No-Break">following code:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private void loadFile(String fileName) throws Exception {
       this.fileName = fileName;
       ObjectMapper mapper = new ObjectMapper();
       File file = new File(fileName);
       teams = mapper.readValue(file,
               new TypeReference&lt;List&lt;String&gt;&gt;() {
               });
 }</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">Now, add a public method so that you can load the first file that's found in the folder that's passed in <span class="No-Break">the constructor:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public void loadFile() throws IOException {
    Files.list(Paths.get(folder))
         .filter(Files::isRegularFile)
         .findFirst()
         .ifPresent(file -&gt; {
             try {
                  loadFile(file.toString());
             } catch (Exception e) {
                  e.printStackTrace();
             }
        });
}</code> </pre>
                      </div></li>
                    <li>Next, create a class annotated with <code class="literal">@Endpoint</code> to define the custom Actuator endpoint. Name <span class="No-Break">it </span><span class="No-Break"><code class="literal">FootballCustomEndpoint</code></span><span class="No-Break">:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@Endpoint(id = "football")</strong>
public class FootballCustomEndpoint {
    private FileLoader fileLoader;
    FootballCustomEndpoint(FileLoader fileLoader){
        this.fileLoader = fileLoader;
    }
}</code> </pre>
                      </div>
                      <p class="list-inset">This class receives a <code class="literal">FileLoader</code> object in the constructor to perform the <span class="No-Break">necessary actions.</span></p></li>
                    <li>Now, create the custom endpoint operations <span class="No-Break">in </span><span class="No-Break"><code class="literal">FootballCustomEndpoint</code></span><span class="No-Break">:</span>
                      <ol>
                        <li class="upper-roman">Create a method annotated with <code class="literal">@ReadOperation</code> to retrieve the file version <span class="No-Break">in use:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@ReadOperation</strong>
public String getFileVersion(){
    return fileLoader.getFileName();
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Create a method annotated with <code class="literal">@WriteOperation</code> to refresh <span class="No-Break">the file:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@WriteOperation</strong>
public void refreshFile(){
   try {
       fileLoader.loadFile();
   } catch (Exception e) {
       e.printStackTrace();
   }
}</code> </pre>
                      </div></li>
                    <li>Next, you need to create a bean for both the <code class="literal">FileLoader</code> <span class="No-Break">and </span><span class="No-Break"><code class="literal">FootballCustom</code></span><code class="literal"> </code><span class="No-Break"><code class="literal">Endpoint</code></span><span class="No-Break"> classes:</span>
                      <ol>
                        <li class="upper-roman">Create a class named <code class="literal">FootballConfiguration</code> and annotate it <span class="No-Break">with </span><span class="No-Break"><code class="literal">@Configuration</code></span><span class="No-Break">:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup"><strong class="bold">@Configuration</strong>
public class FootballConfiguration {
    @Value("${football.folder}")
    private String folder;
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Note that there is a field annotated with <code class="literal">@Value</code>. It will load the folder path containing the file to load from <span class="No-Break">the configuration.</span></li>
                        <li class="upper-roman">Create a method that produces a bean <span class="No-Break">for </span><span class="No-Break"><code class="literal">FileLoader</code></span><span class="No-Break">:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Bean
public FileLoader fileLoader() throws IOException{
    FileLoader fileLoader = new FileLoader(folder);
    return fileLoader;
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="4">Now, create a method that <span class="No-Break">produces </span><span class="No-Break"><code class="literal">FootballCustomEndpoint</code></span><span class="No-Break">:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Bean
public FootballCustomEndpoint footballCustomEndpoint(FileLoader fileLoader){
    return new FootballCustomEndpoint(fileLoader);
}</code> </pre>
                      </div></li>
                    <li>Since <code class="literal">FileLoader</code> needs to load the file by using the <code class="literal">loadFile</code> method, you will need to create a class that implement an <span class="No-Break"><code class="literal">ApplicationRunner</code></span><span class="No-Break"> interface:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Component
public class DataInitializer implements ApplicationRunner {
    private FileLoader fileLoader;
    public DataInitializer(FileLoader fileLoader) {
        this.fileLoader = fileLoader;
    }
    @Override
    public void run(ApplicationArguments args) throws Exception {
        fileLoader.loadFile();
    }
}</code> </pre>
                      </div></li>
                    <li>Modify the <code class="literal">application.yml</code> file in the <span class="No-Break"><code class="literal">resources</code></span><span class="No-Break"> folder:</span>
                      <ol>
                        <li class="upper-roman">Add a setting that provides a path to the folder containing the file <span class="No-Break">to load:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">football:
    folder: teams</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Add the new <span class="No-Break">Actuator endpoint:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    endpoints:
        web:
            exposure:
                include: health,env,metrics,beans,loggers,<strong class="bold">football</strong></code> </pre>
                      </div></li>
                    <li>Finally, create a folder named <code class="literal">teams</code> in the root of the project and a file named <code class="literal">1.0.0.json</code>. As content, add an array containing teams ‚Äì for example, <code class="literal">[ "Argentina", "</code><span class="No-Break"><code class="literal">Australia", "Brazil"]</code></span><span class="No-Break">.</span></li>
                    <li>Create a sample RESTful controller that returns the content that's loaded in memory by the <span class="No-Break"><code class="literal">FileLoader</code></span><span class="No-Break"> class:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@RestController
@RequestMapping("/football")
public class FootballController {
    private FileLoader fileLoader;
    public FootballController(FileLoader fileLoader){
        this.fileLoader = fileLoader;
    }
    @GetMapping
    public List&lt;String&gt; getTeams(){
        return fileLoader.getTeams();
    }
}</code> </pre>
                      </div></li>
                    <li>The service is now ready to test. Execute the application and perform the <span class="No-Break">following requests:</span>
                      <ol>
                        <li class="upper-roman">Get the current file version using the custom Actuator endpoint. For that, open your terminal and execute the following <span class="No-Break"><code class="literal">curl</code></span><span class="No-Break"> request:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl http://localhost:8080/actuator/football</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">You will receive the filename as a response ‚Äì that <span class="No-Break">is, </span><span class="No-Break"><code class="literal">teams/1.0.0.json</code></span><span class="No-Break">.</span></li>
                        <li class="upper-roman">Let's create a new version of the file. Rename the file <code class="literal">1.0.1.json</code> and add a new element to the <code class="literal">teams</code> array, <span class="No-Break">like so:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">[ "Senegal", "Argentina", "Australia", "Brazil"]</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="4">Now, use the custom Actuator endpoint to refresh the file in the application. For that, in your terminal, execute the following <span class="No-Break"><code class="literal">curl</code></span><span class="No-Break"> request:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --request POST http://localhost:8080/actuator/football</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="5">Check the current file version again; you will now <span class="No-Break">get </span><span class="No-Break"><code class="literal">teams/1.0.</code></span><span class="No-Break"><strong class="bold">1</strong></span><span class="No-Break"><code class="literal">.json</code></span><span class="No-Break">.</span></li>
                        <li class="upper-roman">You can also use a RESTful API to validate that the results correspond with the content of <span class="No-Break">the file.</span></li>
                      </ol></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>By creating a bean with the <code class="literal">@Endpoint</code> annotation, Actuator exposes all methods annotated with <code class="literal">@ReadOperation</code>, <code class="literal">@WriteOperation</code>, and <code class="literal">@DeleteOperation</code> over JMX and HTTP. This example is not much different from a regular RESTful endpoint, but the purpose is different as it's used to manage the application or library you developed. Of course, you can implement your custom Actuator endpoint, but usually, Actuator endpoints are provided as part of a component that is used by others and may require some internal information or behavior to be exposed. For instance, database drivers such as PostgreSQL, database connection pool managers such as HikariCP, and caching systems such as Redis usually provide Actuator endpoints. If you plan to create some kind of system or library that will be used by others and you are interested in exposing some internals to facilitate management in runtime, Actuator endpoints are a <span class="No-Break">great solution.</span></p>
                  <p>An <code class="literal">ApplicationRunner</code> is a component that is executed right after the application starts. When Spring Boot executes, the <code class="literal">ApplicationRunner</code> isn't ready to accept requests yet. You can define more than one <code class="literal">ApplicationRunner</code>. Once all the <code class="literal">ApplicationRunner</code> components are executed, the application is ready to <span class="No-Break">accept requests.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec24">
              <div class="epub-source">
                <h1>Using probes and creating a custom health check</h1>
                <div>
                  <p>Your new football trading service is getting readily adopted by football fans. This service is used to exchange stickers with football players' pictures on them between fans. To accelerate the process, the service caches some data in the application's memory. You need to ensure that the cache is filled before you start <span class="No-Break">serving requests.</span></p>
                  <p>Under normal conditions, the football trading service works fine; however, under heavy load, the application instances start degrading and after some instability, they end up being unresponsive. To counteract this, you prepare some stress tests in the lab environment. However, you realize that the application starts degrading because you have issues connecting to the database. At the same time, you realize that those kinds of issues happen when the application has more than 90 pending orders. While you find a definitive solution, you decide to expose when the application is unable to process more requests and create a health check that verifies if it can connect to <span class="No-Break">the database.</span></p>
                  <p>Probes are mostly used by container orchestrators, such as Kubernetes, to verify that the application is ready to accept requests and when it is already working to indicate that it's alive. In Kubernetes, they are known as readiness and <span class="No-Break">liveness probes.</span></p>
                  <p>A health check is a mechanism to verify that the application has everything ready to work ‚Äì for instance, it's able to connect to <span class="No-Break">a database.</span></p>
                  <p>In this recipe, you will learn how to expose a readiness check, how to change your liveness state, and how to create a custom health check that can be used by the hosting platform or a monitoring system to determine the health of your application instances and when your application is ready to <span class="No-Break">accept requests.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the application you created in the <em class="italic">Creating a custom Actuator endpoint</em> recipe. I've prepared a working version in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</a>. It can be found in the <span class="No-Break"><code class="literal">chapter3/recipe3-3/start</code></span><span class="No-Break"> folder.</span></p>
                  <p>In this recipe, you will verify that the application can connect to the application database. We'll use PostgreSQL as a database. To run PostgreSQL locally, we'll use Docker. You can download and start the database just by executing the following command in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">docker run -e POSTGRES_USER=packt -e POSTGRES_PASSWORD=packt -p 5432:5432 --name postgresql postgres</code> </pre>
                  </div>
                  <p>If you created any database in <a href="https://subscription.packtpub.com/book/programming/9781835089491/5"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>, you can reuse it here. This recipe doesn't perform any real queries ‚Äì it just verifies it can connect. If you don't have a database created in the container, you can create a database using the <strong class="bold">psql</strong> tool. For that, execute the following command in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">psql -h localhost -U packt</code> </pre>
                  </div>
                  <p>You will be prompted for a password. Specify <code class="literal">packt</code> and press <strong class="bold">intro</strong>. You will be connected to a PostgreSQL terminal. Execute the following command to create <span class="No-Break">a database:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">CREATE DATABASE football;</code> </pre>
                  </div>
                  <p>Now, you can exit the database by executing the <span class="No-Break"><code class="literal">quit;</code></span><span class="No-Break"> command.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, you'll configure your application so that it can manage probes and create a custom health check to verify that the application can connect to <span class="No-Break">the database:</span></p>
                  <ol>
                    <li>Start by updating the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder so that it can enable readiness and liveness probes. For that, include <span class="No-Break">the following:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    endpoint:
        health:
            probes:
                enabled: true</code> </pre>
                      </div></li>
                    <li>Next, create a class that emulates the football trading service. Name <span class="No-Break">it </span><span class="No-Break"><code class="literal">TradingService</code></span><span class="No-Break">:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Service
public class TradingService {
}</code> </pre>
                      </div>
                      <p class="list-inset">This class will manage the trading requests. When trading a request, if it detects that there are more than 90 pending orders, it will notify you that the application cannot manage more requests. For that, it will use <code class="literal">ApplicationEventPublisher</code>, which will be injected into <span class="No-Break">the constructor:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private ApplicationEventPublisher applicationEventPublisher;
public TradingService(ApplicationEventPublisher applicationEventPublisher) {
    this.applicationEventPublisher = applicationEventPublisher;
}</code> </pre>
                      </div>
                      <p class="list-inset">Next, define a method that returns the number of pending orders. We'll simulate this by returning a random number between 0 <span class="No-Break">and 100:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public int getPendingOrders() {
    Random random = new Random();
    return random.nextInt(100);
}</code> </pre>
                      </div>
                      <p class="list-inset">Finally, you can create a method that manages the trading operations. If there are more than 90 pending orders, it will change the state of <span class="No-Break">the application:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public int tradeCards(int orders) {
    if (getPendingOrders() &gt; 90) {
        AvailabilityChangeEvent.publish(applicationEventPublisher, new Exception("There are more than 90 pending orders"), LivenessState.BROKEN);
    } else {
        AvailabilityChangeEvent.publish(applicationEventPublisher, new Exception("working fine"), LivenessState.CORRECT);
    }
    return orders;
}</code> </pre>
                      </div></li>
                    <li>Now, configure the connection to <span class="No-Break">the database:</span>
                      <ol>
                        <li class="upper-roman">Add Spring Data JDBC and PostgreSQL dependencies. For that, in the <code class="literal">pom.xml</code> file, add the <span class="No-Break">following dependencies:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
    &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Add the following configuration to the <code class="literal">application.yml</code> file in the <span class="No-Break"><code class="literal">resources</code></span><span class="No-Break"> folder:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
    datasource:
        url: jdbc:postgresql://localhost:5432/football
        username: packt
        password: packt</code> </pre>
                      </div></li>
                    <li>Now, let's create a <span class="No-Break">health indicator:</span>
                      <ol>
                        <li class="upper-roman">For that, create a class named <code class="literal">FootballHealthIndicator</code> that implements the <span class="No-Break"><code class="literal">HealthIndicator</code></span><span class="No-Break"> interface:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Component
public class FootballHealthIndicator implements HealthIndicator {
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">As it will connect to the database, inject <code class="literal">JdbcTemplate</code> into <span class="No-Break">the constructor:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private JdbcTemplate template;
public FootballHealthIndicator(JdbcTemplate template) {
    this.template = template;
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">Now, override the health method so that you can perform <span class="No-Break">connectivity checking:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Override
public Health health() {
    try {
        template.execute("SELECT 1");
        return Health.up().build();
    } catch (DataAccessException e) {
    return Health.down().withDetail("Cannot connect to database", e).build();
    }
}</code> </pre>
                      </div></li>
                    <li>Before testing the application, you can modify the <code class="literal">FileLoader</code> class, simulating it so that it takes a few seconds to load the file. You can do this by modifying the <code class="literal">loadFile</code> method by adding the following code. This will make the application wait 10 seconds before it loads <span class="No-Break">the file:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">try {
    Thread.sleep(10000);
} catch (InterruptedException e) {
    e.printStackTrace();
}</code> </pre>
                      </div></li>
                    <li>Now, let's test the <span class="No-Break">application's readiness:</span>
                      <ol>
                        <li class="upper-roman">Before running the application, execute the following command in <span class="No-Break">your terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch curl http://localhost:8080/actuator/health/readiness</code> </pre>
                      </div>
                      <p class="list-inset">This command will execute a request to the readiness probe <span class="No-Break">every second.</span></p>
                      <ol>
                        <li class="upper-roman" value="2">Start the application. You will see that the output of the <code class="literal">watch</code> command changes. First, it will appear <span class="No-Break">as </span><span class="No-Break"><strong class="bold">OUT_OF_SERVICE</strong></span><span class="No-Break">:</span></li>
                      </ol></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_1.jpg" alt="Figure 3.1: Readiness status set to OUT_OF_SERVICE">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1: Readiness status set to OUT_OF_SERVICE</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="3">After 10 seconds or the time you configured in <em class="italic">Step 5</em>, it will change <span class="No-Break">to </span><span class="No-Break"><strong class="bold">UP</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_2.jpg" alt="Figure 3.2: Readiness status changed to UP">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2: Readiness status changed to UP</p>
                    </div>
                  </div>
                  <ol>
                    <li value="7">Now, test the <span class="No-Break">application's liveness:</span>
                      <ol>
                        <li class="upper-roman">Again, execute a <code class="literal">watch</code> command, but this time, make requests to the liveness <span class="No-Break">probe's endpoint:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch curl http://localhost:8080/actuator/health/readiness</code> </pre>
                      </div>
                      <p class="list-inset">You will see that the status <span class="No-Break">is </span><span class="No-Break"><strong class="bold">UP</strong></span><span class="No-Break">.</span></p>
                      <ol>
                        <li class="upper-roman" value="2">Let's start using the trading endpoint. Run another watcher that executes trading requests. For that, execute the following command in a <span class="No-Break">new terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch -n 1 -x curl --request POST -H "Content-Type: application/json" --data "1" http://localhost:8080/football</code> </pre>
                      </div>
                      <p class="list-inset">Remember that if there are more than 90 pending requests, it will mark itself as failing. Since a random number between 0 and 100 is selected, there's a 10% possibility it <span class="No-Break">will fail.</span></p>
                      <p class="list-inset">You will see that the readiness endpoint returns <strong class="bold">DOWN</strong> from time <span class="No-Break">to time.</span></p></li>
                    <li>Finally, test the health <span class="No-Break">check endpoint:</span>
                      <ol>
                        <li class="upper-roman">Execute a <code class="literal">watch</code> command for the Actuator <span class="No-Break">health endpoint:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch curl http://localhost:8080/actuator/health</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">it will return <strong class="bold">UP</strong> every time. To verify that it detects when it cannot connect to the database, stop the PostgreSQL container. To do so, run the <span class="No-Break">following command:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">docker stop postgresql</code> </pre>
                      </div>
                      <p class="list-inset">You will see that the Actuator endpoint will take longer to respond and that the response will <span class="No-Break">be </span><span class="No-Break"><strong class="bold">DOWN</strong></span><span class="No-Break">.</span></p></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>Readiness and liveness probes are enabled automatically when Spring Boot detects it's running on Kubernetes, but you can enable them manually. In this recipe, we enabled them explicitly, but if you run the application on Kubernetes, this will be <span class="No-Break">done automatically.</span></p>
                  <p>Readiness and liveness probes should not check any external component. They should verify that the application is ready internally and that it's capable of responding. On the other hand, health checks should verify that all dependent components <span class="No-Break">are available.</span></p>
                  <p>The Spring Boot application life cycle goes through different states, and it generates events every time it changes its state. I won't explain all possible application states here; instead, I'll focus on the relevant states during readiness probes. The first state is <code class="literal">starting</code>. Once Spring Boot initializes the components, it changes to <code class="literal">started</code>. At this point, it's not ready yet, so it needs to run all <code class="literal">ApplicationRunner</code> and <code class="literal">CommandLineRunner</code> instances defined in the application. Once all of them are executed, it changes to <code class="literal">ready</code>. In this recipe, we introduced a delay of 10 seconds in the <code class="literal">loadFile</code> method. During this period, the readiness status was <strong class="bold">OUT_OF_SERVICE</strong>. Once it had loaded the file, it changed <span class="No-Break">to </span><span class="No-Break"><strong class="bold">UP</strong></span><span class="No-Break">.</span></p>
                  <p>If you want to learn more, take a look at the following Spring Boot <span class="No-Break">documentation: </span><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.application-events-and-listeners" target="_blank"><span class="No-Break">https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.application-events-and-listeners</span></a><span class="No-Break">.</span></p>
                  <p>Be careful while checking other components. First, if it is another service, such as the one we created in this recipe, it will likely also have probes and health checks. Checking this via your service can be redundant. Second, try to make light checks; otherwise, you may generate too much load, which can cause performance issues. In this recipe, the SQL command we used was <code class="literal">SELECT 1</code>. This command connects to the database but doesn't require computing resources from the database engine out of the <span class="No-Break">connection itself.</span></p>
                  <h2>See also</h2>
                  <p>Health checks should not necessarily imply that you check the health of all the dependencies of your application. Rather, you should check if your application has any problems that could be solved by reducing the load or by rebooting. If your application depends on an unresponsive service and you mark your application as unhealthy, the application instance will be restarted. However, if your problem is in another application, the problem won't disappear, and the application will be restarted again and again without solving the problem. For that kind of scenario, consider implementing a <em class="italic">circuit breaker</em> solution. See <a href="https://spring.io/guides/gs/cloud-circuit-breaker/" target="_blank">https://spring.io/guides/gs/cloud-circuit-breaker/</a> for guidance on how to implement this using <span class="No-Break">Spring Cloud.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec25">
              <div class="epub-source">
                <h1>Implementing distributed tracing</h1>
                <div>
                  <p>So far, you've created a solution with two microservices, the football trading microservice and the client microservice. Among other features, the trading microservice provides the ranking of players. The client microservice enhances the list of players by adding the ranking that was obtained from the <span class="No-Break">trading microservice.</span></p>
                  <p>Distributed tracing emerges as a crucial tool as it offers a systematic approach to monitoring, analyzing, and optimizing the flow of requests between microservices. Distributed tracing is a method of monitoring and visualizing the flow of requests as they propagate through various components of a distributed system, providing insights into performance, latency, and dependencies <span class="No-Break">between services.</span></p>
                  <p>In this recipe, you will learn how to enable distributed tracing for your microservices, export the data to Zipkin, and access <span class="No-Break">the results.</span></p>
                  <p>Zipkin is an open source distributed tracing system that helps developers trace, monitor, and visualize the paths of requests as they travel through various microservices in a distributed system, providing valuable insights into performance and dependencies. What you will learn about Zipkin in this recipe can be easily adapted to <span class="No-Break">other tools.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, we'll visualize the traces using Zipkin. You can deploy it on your computer using Docker. For that, open your terminal and execute the <span class="No-Break">following command:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">docker run -d -p 9411:9411 openzipkin/zipkin</code> </pre>
                  </div>
                  <p>The preceding command will download an image with an OpenZipkin server, if you don't have one already, and start <span class="No-Break">the server.</span></p>
                  <p>We'll reuse the trading service we created in the <em class="italic">Using probes and creating a custom health check</em> recipe. If you haven't completed it yet, don't worry ‚Äì I've prepared a working version in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</a>. It can be found in the <span class="No-Break"><code class="literal">chapter3/recipe3-4/start</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>Let's enable distributed tracing in the existing trading service and create the new client service. For the new client service, we'll need to ensure that distributed tracing is enabled as well. Before starting, ensure that your OpenZipkin server is running, as explained in the <em class="italic">Getting </em><span class="No-Break"><em class="italic">ready</em></span><span class="No-Break"> section:</span></p>
                  <ol>
                    <li>Start by enabling distributed tracing in the trading microservice you created in the <em class="italic">Using probes and creating a custom health </em><span class="No-Break"><em class="italic">check</em></span><span class="No-Break"> recipe:</span>
                      <ol>
                        <li class="upper-roman">For that, open the <code class="literal">pom.xml</code> file and add the <span class="No-Break">following dependencies:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
   &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
   &lt;artifactId&gt;micrometer-tracing-bridge-otel&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
   &lt;artifactId&gt;opentelemetry-exporter-zipkin&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">The first dependency is a bridge between <strong class="bold">Micrometer</strong> and <strong class="bold">OpenTelemetry</strong>. The second dependency is an exporter from OpenTelemetry to <strong class="bold">Zipkin</strong>. I'll explain this in more detail in the <em class="italic">How it </em><span class="No-Break"><em class="italic">works‚Ä¶</em></span><span class="No-Break"> section.</span></li>
                        <li class="upper-roman">Now the application can send the traces to Zipkin. However, before running the application, you'll need to make some adjustments. Open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and add the <span class="No-Break">following setting:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management
    tracing:
        sampling:
            probability: 1.0</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="4">By default, sampling is only set to 10%. This means that only 10% of traces are sent. With this change, you will send 100% of <span class="No-Break">the traces.</span></li>
                        <li class="upper-roman">In the same <code class="literal">application.yml</code> file, add the <span class="No-Break">following configuration:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">spring:
    application:
        name: trading-service</code> </pre>
                      </div>
                      <p class="list-inset">This change is not mandatory but helps identify the service in <span class="No-Break">distributed tracing.</span></p></li>
                    <li>Next, create the ranking endpoint in the football trading microservice that will be consumed by the client microservice. For that, in <code class="literal">FootballController</code>, create the <span class="No-Break">following method:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@GetMapping("ranking/{player}")
public int getRanking(@PathVariable String player) {
    logger.info(¬´Preparing ranking for player {}¬ª, player);
    if (random.nextInt(100) &gt; 97) {
        throw new RuntimeException("It's not possible to get the ranking for player " + player
              + " at this moment. Please try again later.");
    }
    return random.nextInt(1000);
}</code> </pre>
                      </div>
                      <p class="list-inset">To simulate random errors, this method throws an exception when a random number from 0 to 99 is greater than 97 ‚Äì that is, 2% of <span class="No-Break">the time.</span></p></li>
                    <li>Next, create a new application that will act as the client application. As usual, you can create the template using the <em class="italic">Spring </em><span class="No-Break"><em class="italic">Initializr</em></span><span class="No-Break"> tool:</span>
                      <ul>
                        <li class=" has_sub">Open <a href="https://start.spring.io" target="_blank">https://start.spring.io</a> and use the same parameters that you did in the <em class="italic">Creating a RESTful API</em> recipe of <a href="https://subscription.packtpub.com/book/programming/9781835089491/1"><em class="italic">Chapter 1</em></a>, except change the <span class="No-Break">following options:</span>
                          <ul>
                            <li>For <strong class="bold">Artifact</strong>, <span class="No-Break">type </span><span class="No-Break"><code class="literal">fooballclient</code></span></li>
                            <li>For <strong class="bold">Dependencies</strong>, select <strong class="bold">Spring Web</strong> and <strong class="bold">Spring </strong><span class="No-Break"><strong class="bold">Boot Actuator</strong></span></li>
                          </ul></li>
                        <li>Add dependencies for OpenTelemetry and Zipkin, as you did for the football trading service application. So, open the <code class="literal">pom.xml</code> file and add the <span class="No-Break">following dependencies:</span>
                          <div class="code-toolbar">
                            <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
   &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
   &lt;artifactId&gt;micrometer-tracing-bridge-otel&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
   &lt;artifactId&gt;opentelemetry-exporter-zipkin&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                          </div></li>
                      </ul></li>
                    <li>In the client application, add a <span class="No-Break">RESTful controller:</span>
                      <ol>
                        <li class="upper-roman">Name <span class="No-Break">it </span><span class="No-Break"><code class="literal">PlayersController</code></span><span class="No-Break">:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@RestController
@RequestMapping("/players")
public class PlayersController {
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">This application must call the trading service. For that, it will use <code class="literal">RestTemplate</code>. To achieve the correlation between service calls, you should use <code class="literal">RestTemplateBuilder</code> to create <code class="literal">RestTemplate</code>. Then, inject <code class="literal">RestTemplateBuilder</code> into the <span class="No-Break">controller's constructor:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private RestTemplate restTemplate;
public PlayersController(RestTemplateBuilder restTemplateBuilder) {
   this.restTemplate = <strong class="bold">restTemplateBuilder.build();</strong>
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">Now, you can create the controller method that calls the trading service of the <span class="No-Break">other application:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@GetMapping
public List&lt;PlayerRanking&gt; getPlayers() {
   String url = "http://localhost:8080/football/ranking";
   List&lt;String&gt; players = List.of("Aitana Bonmat√≠", "Alexia Putellas", "Andrea Falc√≥n");
   return players.stream().map(player -&gt; {
      int ranking = <strong class="bold">this.restTemplate</strong>.getForObject(url + "/" + player, int.class);
      return new PlayerRanking(player, ranking);
   }).collect(Collectors.toList());
}</code> </pre>
                      </div></li>
                    <li>Configure client application tracing in the <span class="No-Break"><code class="literal">application.yml</code></span><span class="No-Break"> file:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    tracing:
        <strong class="bold">sampling:</strong>
<strong class="bold">            probability: 1.0</strong>
spring:
    application:
        name: football-client</code> </pre>
                      </div>
                      <p class="list-inset">As you did in the trading service, you should set <code class="literal">sampling</code> to <code class="literal">1.0</code> so that 100% of the traces will be recorded. To distinguish the client application from the trading service application, set the <code class="literal">spring.application.name</code> property <span class="No-Break">to </span><span class="No-Break"><code class="literal">football-client</code></span><span class="No-Break">.</span></p></li>
                    <li>To avoid port conflicts with the trading application, configure the client application so that it uses port <code class="literal">8090</code>. To do that, add the following parameter to the <span class="No-Break"><code class="literal">application.yml</code></span><span class="No-Break"> file:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">server:
  port: 8090</code> </pre>
                      </div></li>
                    <li>Now, you can test the application. Call the client application; it will make multiple calls to the trading service. To make continuous requests to the client application, you can execute the following command in <span class="No-Break">your terminal:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch curl http://localhost:8090/players</code> </pre>
                      </div></li>
                    <li>Finally, open Zipkin to see the traces. For that, go to <code class="literal">http://localhost:9411/</code> in <span class="No-Break">your browser:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_3.jpg" alt="Figure 3.3: The Zipkin home page">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3: The Zipkin home page</p>
                    </div>
                  </div>
                  <p class="list-inset">On the home page, click <strong class="bold">RUN QUERY</strong> to see the traces that have <span class="No-Break">been generated:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_4.jpg" alt="Figure 3.4: Root traces in Zipkin">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4: Root traces in Zipkin</p>
                    </div>
                  </div>
                  <p class="list-inset">On this page, you will see that the traces from the client application are root traces. Since we introduced a random error, you will see that there are failed and successful traces. If you click the <strong class="bold">SHOW</strong> button for any of these traces, you will see the traces of both RESTful APIs. There will be a main request for the client service and nested requests for the <span class="No-Break">trading service:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_5.jpg" alt="Figure 3.5: Trace details, including nested traces">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5: Trace details, including nested traces</p>
                    </div>
                  </div>
                  <p class="list-inset">You can also view the dependencies between services by clicking on the <strong class="bold">Dependencies</strong> link on the <span class="No-Break">top bar:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_6.jpg" alt="Figure 3.6: Viewing the dependencies between services in Zipkin">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6: Viewing the dependencies between services in Zipkin</p>
                    </div>
                  </div>
                  <p class="list-inset">Here, you can see the dependencies between the <code class="literal">football-client</code> application and the <span class="No-Break"><code class="literal">trading-service</code></span><span class="No-Break"> application.</span></p>
                  <h2>How it works‚Ä¶</h2>
                  <p><em class="italic">Micrometer</em> is a library that allows you to instrument your application without dependencies with specific vendors. This means that your code won't change if you decide to use another tool, such as <em class="italic">Wavefront</em>, instead <span class="No-Break">of Zipkin.</span></p>
                  <p>The <code class="literal">io.micrometer:micrometer-tracing-bridge-otel</code> dependency creates a bridge between <em class="italic">Micrometer</em> and <em class="italic">OpenTelemetry</em>, after which the <code class="literal">io.opentelemetry: opentelemetry-exporter-zipkin</code> dependency exports from <em class="italic">OpenTelemetry</em> to <em class="italic">Zipkin</em>. If you want to use another tool to monitor your traces, you just need to change these dependencies, without any additional <span class="No-Break">code changes.</span></p>
                  <p>The default address to send traces to Zipkin is <code class="literal">http://localhost:9411</code>. That's why we didn't need to configure it explicitly. In a production environment, you can use the <span class="No-Break"><code class="literal">management.zipkin.tracing.endpoint</code></span><span class="No-Break"> property.</span></p>
                  <p>In this recipe, we used <code class="literal">RestTemplateBuilder</code>. This is important as it configures <code class="literal">RestTemplate</code> by adding the tracing headers to the outgoing requests. Then, the target service gathers the tracing headers that can be used to nest the traces in the called application to the root trace from the client application. In reactive applications, you should use <code class="literal">WebClient.Builder</code> instead <span class="No-Break">of </span><span class="No-Break"><code class="literal">RestTemplateBuilder</code></span><span class="No-Break">.</span></p>
                  <p>In this recipe, we configured 100% sampling. This means that we send all traces to the tracing server. We did this for learning purposes; normally, you shouldn't do this in production as you can overload the tracing server by, for example, deploying a server via Zipkin or ingesting a lot of data if you're using a managed service in the cloud. The amount of data that's ingested directly affects monitoring systems ‚Äì that is, the more data you ingest, the more it will cost you. However, even if you deploy your own tracing server, you will need to scale up as well. So, either way, it can increase your overall cost. In a large-scale system, having a sampling rate of 10% is more than enough to detect issues between services as well as understand the dependencies between <span class="No-Break">the components.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>Micrometer tracing creates spans ‚Äì that is, units of work or segments of a distributed trace that represent the execution of a specific operation, for each request. Spans capture information about the duration, context, and any associated metadata related to the <span class="No-Break">respective operation.</span></p>
                  <p>You can create a span by starting an observation using the <code class="literal">ObservationRegistry</code> component. For instance, say <code class="literal">TradingService</code> has different important parts that you want to trace, such as <em class="italic">Collect data</em> and <em class="italic">Process data</em>. You can create different spans for those in <span class="No-Break">your code.</span></p>
                  <p>To implement this, you will need to inject <code class="literal">ObservationRegistry</code> into your controller using the Spring Boot dependency container. For that, you need to define the <code class="literal">ObservationRegistry</code> parameter in the <span class="No-Break">controller's constructor:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">private final ObservationRegistry observationRegistry;
public FootballController(ObservationRegistry observationRegistry) {
        this.observationRegistry = observationRegistry;
}</code> </pre>
                  </div>
                  <p>Then, you must create the observations in <span class="No-Break">the code:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@GetMapping("ranking/{player}")
public int getRanking(@PathVariable String player) {
   Observation collectObservation = <strong class="bold">Observation.createNotStarted("collect", observationRegistry);</strong>
<strong class="bold">   collectObservation.lowCardinalityKeyValue("player", player);</strong>
   <strong class="bold">collectObservation.observe</strong>(() -&gt; {
      try {
          logger.info("Simulate a data collection for player {}", player);
          Thread.sleep(random.nextInt(1000));
      } catch (InterruptedException e) {
          e.printStackTrace();
      }
   });
   Observation processObservation = <strong class="bold">Observation.createNotStarted("process", observationRegistry);</strong>
   <strong class="bold">processObservation.lowCardinalityKeyValue("player", player);</strong>
   <strong class="bold">processObservation.observe</strong>(() -&gt; {
            try {
                logger.info("Simulate a data processing for player {}", player);
                Thread.sleep(random.nextInt(1000));
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        return random.nextInt(1000);
    }</code> </pre>
                  </div>
                  <p>Note that the observations include the player with <code class="literal">lowCardinalityKeyValue</code> to facilitate finding spans through <span class="No-Break">this data.</span></p>
                  <p class="callout-heading">Note</p>
                  <p class="callout">Some parts of the code have been removed for brevity. You can find the full version in this book's GitHub repository <span class="No-Break">at </span><span class="No-Break">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</span><span class="No-Break">.</span></p>
                  <p>Now, in Zipkin, you can see the custom spans nested <span class="No-Break">in </span><span class="No-Break"><code class="literal">trading-service</code></span><span class="No-Break">:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_7.jpg" alt="Figure 3.7: Custom spans in Zipkin">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7: Custom spans in Zipkin</p>
                    </div>
                  </div>
                  <p>The <code class="literal">trading-service</code> span contains two nested spans, and both have a custom tag that specifies the <span class="No-Break">player's name.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec26">
              <div class="epub-source">
                <h1>Accessing standard metrics</h1>
                <div>
                  <p>Your Football Trading service continues to grow by being adopted by football fans. You need to understand how it performs better so that you can adapt to demand while optimizing the resources that are used to provide <span class="No-Break">the service.</span></p>
                  <p>You can use the standard metrics provided by Spring Boot Actuator and its related components for real-time insights into your application's behavior. For instance, you can find out how much CPU and memory has been used by your application or the time spent in <strong class="bold">garbage collection</strong> (<strong class="bold">GC</strong>). These are the basic metrics that give you a general understanding of the performance of <span class="No-Break">the application.</span></p>
                  <p>Other metrics are more subtle, such as the metrics provided by the web container, Tomcat ‚Äì for instance, the number of active sessions, the number of sessions rejected, and the number of sessions that have expired. Similarly, the database connection pool, which is <code class="literal">hikaricp</code> by default, also exposes some metrics. For instance, you can view the number of active sessions, the number of waiting sessions, or the number of sessions that have been rejected. These types of metrics can be an indicator of problems in your application that aren't easy to detect just by using classic metrics such as CPU and <span class="No-Break">memory utilization.</span></p>
                  <p>In this recipe, you will learn how to access standard metrics and how to detect some common application issues. You will also learn how to perform a load test using JMeter, but it's not the main purpose of <span class="No-Break">this recipe.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the applications you created in the <em class="italic">Implementing distributed tracing</em> recipe. If you haven't completed that recipe yet, I've prepared a working version that you can find in this book's GitHub repository at https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/, in the <code class="literal">chapter3/recipe3-5/start</code> folder. These applications depend on PostgreSQL and also export activities to Zipkin, as explained in the previous recipe. Both PostgreSQL and Zipkin can be run locally <span class="No-Break">using Docker.</span></p>
                  <p>In this recipe, we'll perform some load tests using JMeter, a popular load-testing tool. You can download JMeter from the project website at <a href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank">https://jmeter.apache.org/download_jmeter.cgi</a>. Here, you can download a ZIP file containing JMeter binaries and unzip it; no further installation is required. To run JMeter, go to the folder where you unzipped the binaries and open the <code class="literal">bin</code> folder. Here, you will find different scripts to launch JMeter, depending on your operating system. For Unix-based operating systems, you can run the <code class="literal">jmeter.sh</code> script, while for Windows, you can run the <span class="No-Break"><code class="literal">jmeter.bat</code></span><span class="No-Break"> script.</span></p>
                  <p>I've created two JMeter scripts to create some load against the application. You can find them in this book's GitHub repository, in the <span class="No-Break"><code class="literal">chapter3/recipe3-5/jmeter</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, we'll use the JMeter scripts mentioned in the <em class="italic">Getting ready</em> section to generate a workload for the football application. Then, we'll observe the metrics provided by Spring Boot and its related components. Follow <span class="No-Break">these steps:</span></p>
                  <ol>
                    <li>Before running the first load test, ensure that the trading application is running and the <code class="literal">metrics</code> endpoint is exposed. As explained in the <em class="italic">Adding Actuator to your application</em> recipe, this can be done by adding the <code class="literal">metrics</code> value to the <code class="literal">management.endpoints.web.exposure.include</code> parameter. If you followed the previous recipes or used the working version I've prepared, as explained in the <em class="italic">Getting ready</em> section, the <code class="literal">application.yml</code> file should look <span class="No-Break">like this:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    endpoints:
        web:
            exposure:
                include: health,env,<strong class="bold">metrics</strong>,beans,loggers,football</code> </pre>
                      </div></li>
                    <li>Once the application is running, open JMeter and load the <code class="literal">loadTeams.jmx</code> script. You can find it in the <code class="literal">chapter3/recipe3-5/jmeter</code> folder, as explained in the <em class="italic">Getting ready</em> section. This script makes a request to the application's <code class="literal">/football</code> path and returns a list of teams. This process is executed by 30 <span class="No-Break">threads infinitely.</span>
                      <p class="list-inset">You can adjust some parameters of the load tests depending on the resources of your development computer. For instance, I used 30 threads to overload my computer, but maybe you need more or even fewer threads <span class="No-Break">than that:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_8.jpg" alt="Figure 3.8: The number of threads in JMeter">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8: The number of threads in JMeter</p>
                    </div>
                  </div>
                  <p class="list-inset">If you want to adjust the number of threads, click <strong class="bold">Main Thread Group</strong> and adjust <strong class="bold">Number of </strong><span class="No-Break"><strong class="bold">Threads (users)</strong></span><span class="No-Break">.</span></p>
                  <p class="list-inset">Once the application is ready, you can run the <span class="No-Break">JMeter script.</span></p>
                  <ol>
                    <li value="3">Let's observe the metrics of the application. Go to <code class="literal">http://localhost:8080/actuator/metrics</code> to see the full list of exposed metrics. You can get any of these metrics by appending the metric's name to the <code class="literal">/actuator/metrics</code> path. Typically, you will get the CPU and <span class="No-Break">memory-related counters:</span>
                      <ul>
                        <li>With <code class="literal">http://localhost:8080/actuator/metrics/process.cpu.usage</code>, you will get the percentage of CPU being used by the <span class="No-Break">application process</span></li>
                        <li>With http://localhost:8080/actuator/metrics/system.cpu.usage, you will get the percentage of CPU being used by <span class="No-Break">the system</span></li>
                        <li>With <code class="literal">http://localhost:8080/actuator/metrics/jvm.memory.used</code> you will get the amount of memory being used by <span class="No-Break">your application</span></li>
                      </ul>
                      <p class="list-inset">As an example, the result of the <code class="literal">process.cpu.usage</code> metric looks <span class="No-Break">like this:</span></p>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">{
    "name": "system.cpu.usage",
    "description": "The \"recent cpu usage\" of the system the application is running in",
    "measurements": [
        {
            "statistic": "VALUE",
            <strong class="bold">"value": 0.48494983277591974</strong>
        }
    ],
    "availableTags": []
}</code> </pre>
                      </div></li>
                    <li>Stop the test ‚Äì you need to create a new endpoint to access the database. For that, follow <span class="No-Break">these steps:</span>
                      <ol>
                        <li class="upper-roman">Create a new <code class="literal">DataService</code> class and inject <code class="literal">JdbcTemplate</code> into <span class="No-Break">the constructor:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Service
public class DataService {
    private JdbcTemplate jdbcTemplate;
    public DataService(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Now, create a method that makes a call to the database. To simulate a slow database query, you can use the <code class="literal">pg_sleep</code> PostgreSQL command. This command waits for a given number of seconds or fraction <span class="No-Break">of seconds:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public String getPlayerStats(String player) {
    Random random = new Random();
    jdbcTemplate.execute("SELECT pg_sleep(" + random.nextDouble(1.0) + ")");
    return "some complex stats for player " + player;
}</code> </pre>
                      </div>
                      <p class="list-inset">Since we passed a random number between <code class="literal">0</code> and <code class="literal">1.0</code>, it will wait a fraction of a second in <span class="No-Break">the database.</span></p>
                      <ol>
                        <li class="upper-roman" value="3">You can inject the new <code class="literal">DataService</code> into the <code class="literal">FootballController</code> class and create a method that will use the <span class="No-Break">new service:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@GetMapping("/stats/{player}")
public String getPlayerStats(@PathVariable String player){
    return dataService.getPlayerStats(player);
}</code> </pre>
                      </div>
                      <p class="list-inset">Now, you can run <span class="No-Break">the application.</span></p></li>
                    <li>Finally, run another JMeter script that makes a request to the same <code class="literal">/football</code> path and returns a list of teams, as well as the new path, <code class="literal">/stats/{player}</code>, which performs a long request to the database. Again, 30 threads are running these <span class="No-Break">requests infinitely.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>In the first load test, we can see that there is a bottleneck in the application's CPU. In a real-world scenario, the CPU metric can be used to scale the application automatically, such as by adding new instances of the application. That's the kind of bottleneck that we could expect under <span class="No-Break">heavy loads.</span></p>
                  <p>In the second load test, there is no physical resource bottleneck, but there's a query that takes a long time and blocks a connection that cannot be reused for other requests. In a real-world scenario, you could increase the number of available connections in the connection pool, but only up to a certain limit, since this is a very expensive and <span class="No-Break">finite resource.</span></p>
                  <p>If you look at <code class="literal">system.cpu.usage</code> and <code class="literal">process.cpu.usage</code>, you will see that the values are much lower than <code class="literal">1.0</code>, which we observed in the previous <span class="No-Break">load test.</span></p>
                  <p>You can also look at the metrics related to the database connection pool. The default database connection pool in Spring Data is HikariCP, and all the metrics related to this component are <code class="literal">hikaricp.*</code>. Let's consider the <span class="No-Break">following metrics:</span></p>
                  <ul>
                    <li><code class="literal">hikaricp.connections.max</code>: This value specifies the maximum number of real database connections that <code class="literal">hikaricp</code> will open in the PostgreSQL server. This number won't change during the execution of the test as the value is static during the application life cycle. By default, it's set <span class="No-Break">to </span><span class="No-Break"><code class="literal">10</code></span><span class="No-Break">.</span></li>
                    <li><code class="literal">hikaricp.connections.active</code>: This is the number of active connections ‚Äì that is, the connections that are executing something in the database server. Under light loads, the number will be less than the maximum. Since the database operation is long (up to 1 second), and there are 30 concurrent threads for only 10 maximum connections, this number will be 10 or near 10 during the execution of the <span class="No-Break">JMeter script.</span></li>
                    <li><code class="literal">hikaricp.connections.pending</code>: When there are no available connections in the connection pool, this metric queues the requests. This metric specifies the number of connections waiting for an available connection. This number will be greater than 1 during the JMeter <span class="No-Break">script's execution.</span></li>
                    <li><code class="literal">hikaricp.connections.timeout</code>: If a request is waiting for more than a given amount of time ‚Äì30 seconds by default ‚Äì it will time out. After executing the JMeter script, you will see that this metric will be more <span class="No-Break">than 1.</span></li>
                  </ul>
                  <p>Opening a physical database connection is an expensive operation. To avoid the overhead of creating a connection, there is a mechanism known as a database connection pool that keeps some already created connections ready to be used. When a process needs to connect to the database, it gets the connection from the pool and returns it to the pool once the operation is finished. In the second stress test, there were no connections as they took a long time to complete, so they took a long time to return to the pool. When there are no available connections, the connection pool enqueues the connection until one is released. That's why you saw <code class="literal">pending</code> connections. After some time, you will see timeout connections. Those are the connections that were enqueued for more than <span class="No-Break">30 seconds.</span></p>
                  <p>This situation also impacts the web container. By default, the number of threads to serve HTTP requests is finite and there is also a pool. When there are no more available threads, the web container ‚Äì in this case, Tomcat ‚Äì will enqueue the requests. In this kind of situation, when an HTTP request is mostly waiting for a dependency to complete, it appears the Reactive framework. In this case, the application uses special kinds of threads ‚Äì non-blocking threads ‚Äì that are intended for I/O operations. These types of threads allow the application to continue processing other tasks while waiting for responses from <span class="No-Break">external services.</span></p>
                  <h2>See also</h2>
                  <p>You can visualize your metrics with standard monitoring tools. In the <em class="italic">Integrating your application with Prometheus and Grafana</em> recipe, you will learn how to integrate application metrics with Prometheus and visualize them with Grafana. These are two popular open source tools that are part of the <strong class="bold">Cloud Native Computing </strong><span class="No-Break"><strong class="bold">Foundation</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">CNCF</strong></span><span class="No-Break">).</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec27">
              <div class="epub-source">
                <h1>Creating your own metrics</h1>
                <div>
                  <p>So far, you've created a new feature in your Football Trading service where users can list a card for exchange and another user can bid for the traded card. When a new bid is received, it is queued in memory until it is committed as it requires a bunch of complex validations. There are a lot of expectations for this new feature, and you want to be sure it works well. For that reason, you want to monitor the bids that are received, how many bids are pending to be committed, and the duration of <span class="No-Break">this process.</span></p>
                  <p>In this recipe, you will learn how to create custom metrics using <strong class="bold">Micrometer</strong>. Micrometer is an open source metrics collection library for Java applications that is very well integrated with Spring Boot Actuator. Other libraries can use the telemetry data generated by Micrometer to export to different <span class="No-Break">monitoring systems.</span></p>
                  <p>There are different types <span class="No-Break">of metrics:</span></p>
                  <ul>
                    <li><strong class="bold">Counter</strong>: As the name suggests, it counts how many times something happened. We can use this type of metric to find out how many bids <span class="No-Break">were received.</span></li>
                    <li><strong class="bold">Gauge</strong>: This metric provides a value in a given moment. We can use it to find out how many bids are waiting to <span class="No-Break">be processed.</span></li>
                    <li><strong class="bold">Timer</strong>: This metric measures the duration of a given operation. We can use it to find out the time spent <span class="No-Break">per bid.</span></li>
                  </ul>
                  <h2>Getting ready</h2>
                  <p>In this recipe, we'll reuse the projects from the <em class="italic">Accessing standard metrics</em> recipe. I've prepared a working version if you haven't completed that recipe yet. You can find it in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</a>, in the <span class="No-Break"><code class="literal">chapter3/recipe3-6/start</code></span><span class="No-Break"> folder.</span></p>
                  <p>To simulate a workload for the new feature, I've created a JMeter script. You can find it in this book's GitHub repository, in the <code class="literal">chapter3/recipe3-6/jmeter</code> folder. You can download JMeter from the project website at <a href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank">https://jmeter.apache.org/download_jmeter.cgi</a>. Here, you can download a ZIP file that contains JMeter binaries and unzip it ‚Äì no further installation is required. To run JMeter, go to the folder where you unzipped the binaries, then open the <code class="literal">bin</code> folder. Here, you can find different scripts to launch JMeter, depending on your operating system. For Unix, you can run the <code class="literal">jmeter.sh</code> script, while for Windows, you can run the <span class="No-Break"><code class="literal">jmeter.bat</code></span><span class="No-Break"> script.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, you'll incorporate your custom metrics into the football trading application. This enhancement will offer improved insights into your application's performance <span class="No-Break">during runtime:</span></p>
                  <ol>
                    <li>Go to your trading application and create a new service class <span class="No-Break">named </span><span class="No-Break"><code class="literal">AuctionService</code></span><span class="No-Break">:</span>
                      <ol>
                        <li class="upper-roman">Inject <code class="literal">MeterRegistry</code> into the constructor. In the same constructor, create a counter for the bids received, a timer for the duration of the bid to be processed, and a gauge for the bids waiting to be confirmed. The class should look <span class="No-Break">like this:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@Service
public class AuctionService {
    private Map&lt;String, String&gt; bids = new ConcurrentHashMap&lt;&gt;();
    private Counter bidReceivedCounter;
    private Timer bidDuration;
    Random random = new Random();
    public AuctionService(<strong class="bold">MeterRegistry meterRegistry</strong>) {
        <strong class="bold">meterRegistry.gauge("football.bids.pending", bids, Map::size);</strong>
<strong class="bold">        this.bidReceivedCounter = meterRegistry.counter("football.bids.receieved");</strong>
<strong class="bold">        this.bidDuration = meterRegistry.timer("football.bids.duration");</strong>
    }
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Note that <code class="literal">gauge</code> returns the size of the map that's used to keep the bids that have been received <span class="No-Break">in memory.</span></li>
                        <li class="upper-roman">Now, create a method to process the bids. In this method, you will use the <code class="literal">bidDuration</code> timer to measure the duration of the operation and increase the number of bids received <span class="No-Break">using </span><span class="No-Break"><code class="literal">bidReceivedCounter</code></span><span class="No-Break">.</span></li>
                        <li class="upper-roman">Use the <code class="literal">ordersTradedCounter</code> and <code class="literal">tradedDuration</code> metrics in a new method named <code class="literal">tradeCards</code>. The method should look <span class="No-Break">like this:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public void addBid(String player, String bid) {
    <strong class="bold">bidDuration.record</strong>(() -&gt; {
        bids.put(player, bid);
        <strong class="bold">bidReceivedCounter.increment();</strong>
        try {
            Thread.sleep(random.nextInt(20));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        bids.remove(player);
    });
}</code> </pre>
                      </div></li>
                    <li>Next, expose this feature in the <span class="No-Break"><code class="literal">FootballController</code></span><span class="No-Break"> class:</span>
                      <ol>
                        <li class="upper-roman">Inject your new <code class="literal">AuctionService</code> into <span class="No-Break">the constructor:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private AuctionService auctionService;
public FootballController(AuctionService auctionService) {
   this.auctionService = auctionService;
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Note that all the other parameters and fields have been omitted for simplicity. Since we are reusing the same project from previous recipes, you should have more parameters in the constructor, and you should have other fields <span class="No-Break">as well.</span></li>
                        <li class="upper-roman">Create a new method that will present bids for players using the <span class="No-Break">new service:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">@PostMapping("/bid/{player}")
public void addBid(@PathVariable String player,
                             @RequestBody String bid) {
      auctionService.addBidAOP(player, bid);
}</code> </pre>
                      </div></li>
                    <li>Now, you can run the application and start generating some load. To do this, open the <code class="literal">loadBids.jmx</code> file in JMeter. You can find this file in this book's GitHub repository at https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/, in the <code class="literal">chapter3/recipe3-6/jmeter</code> folder. Then, run the script in JMeter and keep it running while you observe <span class="No-Break">the metrics.</span></li>
                    <li>Observe the counters <span class="No-Break">you created:</span>
                      <ul>
                        <li>If you open the Actuator metrics endpoint at <code class="literal">http://localhost:8080/actuator/metrics</code>, you will see the new metrics that have been created: <code class="literal">football.bids.duration</code>, <code class="literal">football.bids.pending</code>, and <code class="literal">football.bids.receieved</code>. If you append the names of these metrics to the Actuator metrics endpoint, you will get the values of <span class="No-Break">each metric.</span></li>
                        <li>Open <code class="literal">http://localhost:8080/actuator/metrics/football.bids.received</code> to get the number of bids that have been received. You will see the total number <span class="No-Break">of bids.</span></li>
                        <li>Open <code class="literal">http://localhost:8080/actuator/metrics/football.bids.duration</code> to get the bids <span class="No-Break">processing duration.</span></li>
                        <li>Open <code class="literal">http://localhost:8080/actuator/metrics/football.bids.pending</code> to get the number of bids that <span class="No-Break">are pending.</span></li>
                      </ul>
                      <p class="list-inset">For counters and duration, normally, the monitoring tools also provide a rate that's calculated from the total values and based on the frequency of observation. It's more interesting in terms of performance analysis to know the bid processing rate than the total number. The same goes for <span class="No-Break">the duration.</span></p></li>
                    <li>Stop the <span class="No-Break">JMeter script.</span></li>
                  </ol>
                  <h2>How it works‚Ä¶</h2>
                  <p>The <code class="literal">MeterRegistry</code> class registers the metrics, after which they are automatically exposed in the Actuator <span class="No-Break">metrics endpoint.</span></p>
                  <p><code class="literal">gauge</code> calls the delegate that's been assigned to the metric. This delegate will be executed according to the observation frequency. In this recipe, we call the endpoint explicitly. If you use a monitoring tool, it will be observed periodically. Keep in mind that this operation should be as lightweight as possible because it will be <span class="No-Break">called frequently.</span></p>
                  <p>Timer metrics measure the time spent on the execution of the <span class="No-Break">delegate provided.</span></p>
                  <p>A counter metric increments the value of the counter. If you don't provide a value when calling the <code class="literal">increment</code> method, as we did in this recipe, it just increments by 1. You can provide a number as a parameter of method increment, at which point it will increment the counter value by the number provided. This number should always <span class="No-Break">be positive.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>You can create metrics by using a more declarative approach with <strong class="bold">Aspect Oriented Programming</strong> (<strong class="bold">AOP</strong>) libraries. For this, you should add a dependency to the <em class="italic">AOP starter</em> and configure the <span class="No-Break"><code class="literal">ObservedAspect</code></span><span class="No-Break"> bean.</span></p>
                  <p>To add the dependency to the <em class="italic">AOP starter</em>, include the following in your <span class="No-Break"><code class="literal">pom.xml</code></span><span class="No-Break"> file:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                  </div>
                  <p>To configure the <code class="literal">ObserverAspect</code> bean, add the following method to <span class="No-Break">the </span><span class="No-Break"><code class="literal">Football</code></span><code class="literal"> </code><span class="No-Break"><code class="literal">Configuration</code></span><span class="No-Break"> class:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">@Bean
ObservedAspect observedAspect(ObservationRegistry observationRegistry) {
    return new ObservedAspect(observationRegistry);
}</code> </pre>
                  </div>
                  <p>At this point, you can use the <code class="literal">@Observed</code> annotation in your code to generate metrics automatically. For instance, in this recipe, we could annotate the <code class="literal">AuctionService</code> class <span class="No-Break">with </span><span class="No-Break"><code class="literal">@Observed</code></span><span class="No-Break">:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup"><strong class="bold">@Observed(name = "football.auction")</strong>
@Service
public class AuctionService {
}</code> </pre>
                  </div>
                  <p>Then, you can simplify the class as you don't need to explicitly create the counters in the constructor. In the <code class="literal">addBidAOP</code> method, you only need to focus on the <span class="No-Break">application logic:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">public void addBidAOP(String player, String bid) {
    bids.put(bid, player);
    try {
        Thread.sleep(random.nextInt(20));
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    bids.remove(bid);
}</code> </pre>
                  </div>
                  <p>When you run the application and <code class="literal">AuctionService</code> is used (the metrics are created lazily the first time the methods are used), you will see that there are two new metrics in the Actuator <span class="No-Break">metrics endpoint:</span></p>
                  <ul>
                    <li><code class="literal">football.auction</code>: Provides general counters for the methods defined in your <span class="No-Break">annotated class</span></li>
                    <li><code class="literal">football.auction.active</code>: Provides counters for active executions for the methods defined in your <span class="No-Break">annotated class</span></li>
                  </ul>
                  <p>The following is a sample of the <code class="literal">football.auction</code> metric that was obtained <span class="No-Break">from </span><span class="No-Break"><code class="literal">http://localhost:8080/actuator/endpoint/football.auction</code></span><span class="No-Break">:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">{
    "name": "football.auction",
    "baseUnit": "seconds",
    "measurements": [
        {
            "statistic": "COUNT",
            "value": 1648870
        },
        {
            "statistic": "TOTAL_TIME",
            "value": 15809.168264051
        },
        {
            "statistic": "MAX",
            "value": 0.02272261
        }
    ],
    "availableTags": [
        {
            <strong class="bold">"tag": "method",</strong>
            "values": [
                "<strong class="bold">addBidAOP</strong>"
            ]
        },
        {
            "tag": "error",
            "values": [
                "none"
            ]
        },
        {
            "tag": "class",
            "values": [
                "com.packt.footballobs.service.AuctionService"
            ]
        }
    ]
}</code> </pre>
                  </div>
                  <p>You can get metrics for a specific method using tags. For instance, to get the metrics of the <code class="literal">addBidAOP</code> method, you can perform the following <span class="No-Break">request: </span><span class="No-Break"><code class="literal">http://localhost:8080/actuator/metrics/football.auction?tag=method:addBidAOP</code></span><span class="No-Break">.</span></p>
                  <p>This service is implemented in this book's GitHub repository at <code class="literal">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook</code>, in the <code class="literal">chapter3/recipe3-8/end</code> folder. As mentioned previously, the metric is created lazily, so you should invoke this service to make it available. You can do this by executing the following <code class="literal">curl</code> request in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">curl http://localhost:8080/football/bid/357669 \
--request POST \
--data "200"</code> </pre>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec28">
              <div class="epub-source">
                <h1>Integrating your application with Prometheus and Grafana</h1>
                <div>
                  <p>You have a successful Football Trading application, and you can observe it by calling the various Actuator endpoints. However, this way of observing the application is too manual. So, you want a system that allows you to automate how your application <span class="No-Break">is monitored.</span></p>
                  <p>In this recipe, you will learn how to expose the metrics of your application using a format that can be used by <strong class="bold">Prometheus</strong>, after which you will use the Prometheus data as a source for <strong class="bold">Grafana</strong>. Prometheus is an open source monitoring solution that collects and aggregates metrics as time series data, then stores the events in real time so that the events can be used to monitor your application. Grafana is an open source tool for visualization that allows you to create custom dashboards, graphs, and even alerts. One of the sources Grafana can use is the data collected by Prometheus. The combination of both tools is a very popular choice due to its ease of use, flexibility, <span class="No-Break">and scalability.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the outcome of the <em class="italic">Creating your own metrics</em> recipe. I've prepared a working version of this in case you haven't completed it yet. You can find it in this book's GitHub repository at https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/, in the <span class="No-Break"><code class="literal">chapter3/recipe3-7/start</code></span><span class="No-Break"> folder.</span></p>
                  <p>You will use Prometheus and Grafana servers. As usual, the easiest way to run Prometheus and Grafana on your local computer is by <span class="No-Break">using Docker.</span></p>
                  <p>To download and start Prometheus, run the following command in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">docker run -d --name prometheus -p 9090:9090 \
-v prometheus.yml:/etc/prometheus/prometheus.yml \
prom/prometheus</code> </pre>
                  </div>
                  <p>This command uses the <code class="literal">-v</code> parameter to mount a volume to a file named <code class="literal">prometheus.yml</code>. This file contains the configuration for Prometheus. The configuration will be described and created as part of this recipe in the <em class="italic">How to do </em><span class="No-Break"><em class="italic">it‚Ä¶</em></span><span class="No-Break"> section.</span></p>
                  <p>To download and start Grafana, run the following command in <span class="No-Break">your terminal:</span></p>
                  <div class="code-toolbar">
                    <pre class="language-markup"><code class="language-markup">docker run -d --name grafana -p 3000:3000 grafana/grafana</code> </pre>
                  </div>
                  <p>To simulate a workload for the new feature, I've created a JMeter script. You can find it in this book's GitHub repository, in the <code class="literal">chapter3/recipe3-7/jmeter</code> folder. You can download JMeter from the project's website at <a href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank">https://jmeter.apache.org/download_jmeter.cgi</a>. From here, download a ZIP file containing JMeter binaries and unzip it; no further installation is required. To run JMeter, go to the folder where you unzipped the binaries, then open the <code class="literal">bin</code> folder. Here, you will find different scripts to launch JMeter, depending on your operating system. For Unix, you can run the <code class="literal">jmeter</code> script, while for Windows, you can run the <span class="No-Break"><code class="literal">jmeter.bat</code></span><span class="No-Break"> script.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>First, we'll configure our application so that it exposes a Prometheus endpoint. Afterward, we'll set up Prometheus and Grafana so that we can ingest the data provided by <span class="No-Break">our application:</span></p>
                  <ol>
                    <li>Let's start by exposing a Prometheus endpoint to the trading application. For that, two steps <span class="No-Break">are necessary:</span>
                      <ol>
                        <li class="upper-roman">Add the following dependency to the <span class="No-Break"><code class="literal">pom.xml</code></span><span class="No-Break"> file:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Expose the Prometheus endpoint. To do so, open the <code class="literal">application.yml</code> file in the <code class="literal">resources</code> folder and add the following <span class="No-Break">highlighted properties:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">management:
    endpoint:
        health:
            probes:
                enabled: true
        <strong class="bold">prometheus:</strong>
<strong class="bold">            enabled: true</strong>
    endpoints:
        web:
            exposure:
                include: health,env,metrics,beans,loggers,football,<strong class="bold">prometheus</strong></code> </pre>
                      </div></li>
                    <li>You can run the application and open the Prometheus endpoint <span class="No-Break">at </span><span class="No-Break">http://localhost:8080/actuator/prometheus</span><span class="No-Break">.</span></li>
                    <li>The next step is running Prometheus and configuring it to consume the newly exposed endpoint. You can configure Prometheus by creating a <code class="literal">.yaml</code> configuration file and mounting it on the Prometheus <span class="No-Break">Docker image:</span>
                      <ol>
                        <li class="upper-roman">Prometheus will be hosted on Docker, while the application will be hosted on your computer, the Docker host. The first task is obtaining the IP address of your computer. On Linux, you can run the following command in <span class="No-Break">your Terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">ip addr show</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">On Windows, you can run the following command in <span class="No-Break">your terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">ipconfig</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">If you run your application in <strong class="bold">Windows Subsystem for Linux</strong> (<strong class="bold">WSL</strong>), you should run <code class="literal">ip addr show</code> in a <span class="No-Break">WSL</span><span class="No-Break"></span><span class="No-Break"> terminal.</span></li>
                        <li class="upper-roman">For instance, the IP of my interface is <code class="literal">172.26.109.186</code> when I run <code class="literal">ip addr show</code>. I will use this value to configure the Prometheus <span class="No-Break">YAML file.</span></li>
                        <li class="upper-roman">Let's continue by creating the configuration file using the IP address we obtained in the previous step. In the project's root directory, create an application named <code class="literal">prometheus.yml</code> with the <span class="No-Break">following content:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">global:
  scrape_interval: 3s
scrape_configs:
  - job_name: 'football_trading_app'
    metrics_path: '<strong class="bold">/actuator/prometheus</strong>'
    static_configs:
      - targets: [<strong class="bold">'172.26.109.186:8080'</strong>]</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="6">Note that we configured the metrics path exposed by our application, and the target is the IP address and port of <span class="No-Break">our application.</span></li>
                        <li class="upper-roman">Now, run the Prometheus container using the configuration file. For that, in the same directory you created the configuration file, execute the following command in <span class="No-Break">your terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">docker run -d --name prometheus -p 9090:9090 \
<strong class="bold"> -v $(pwd)/prometheus.yml</strong>:/etc/prometheus/prometheus.yml prom/prometheus</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="8">This command runs the <code class="literal">prom/prometheus</code> image, exposing port <code class="literal">9090</code> and mounting the <code class="literal">prometheus.yml</code> file in the container filesystem at <code class="literal">/etc/prometheus/prometheus.yml</code>. <code class="literal">$(pwd)</code> is a command substitution in Linux that is used to insert the <span class="No-Break">current directory.</span></li>
                      </ol></li>
                    <li>Now, Prometheus should be working and <em class="italic">scrapping</em> your application to get observability data. To verify it's working, you can open Prometheus at http://localhost:9090, then open the <strong class="bold">Status</strong> menu and <span class="No-Break">select </span><span class="No-Break"><strong class="bold">Targets</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_9.jpg" alt="Figure 3.9: Prometheus targets">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9: Prometheus targets</p>
                    </div>
                  </div>
                  <p class="list-inset">Verify that the status of your target is working. It should <span class="No-Break">be </span><span class="No-Break"><strong class="bold">UP</strong></span><span class="No-Break">.</span></p>
                  <ol>
                    <li value="5">You can use Prometheus to visualize the data from your application. Go to the Prometheus home page, search for any metric, and click on <strong class="bold">Execute</strong> to see the data. If you select the <strong class="bold">Graph</strong> tab, you will see the data in <span class="No-Break">graphical form:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_10.jpg" alt="Figure 3.10: Visualizing data in Prometheus">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10: Visualizing data in Prometheus</p>
                    </div>
                  </div>
                  <ol>
                    <li value="6">The visualization capabilities that are available in Prometheus are a bit limited, but we can use Grafana and connect it to Prometheus to achieve <span class="No-Break">better visualization:</span>
                      <ol>
                        <li class="upper-roman">Ensure that Grafana is running. As explained in the <em class="italic">Getting ready</em> section, you can run Grafana using Docker by executing the following command in <span class="No-Break">your terminal:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">docker run -d --name grafana -p 3000:3000 grafana/grafana</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Now, you can open Grafana by opening the following address in your browser: <code class="literal">http://localhost:3000</code>. You will be asked for your credentials. You can use the default credentials ‚Äì that is, user set to <code class="literal">admin</code> and password set <span class="No-Break">to </span><span class="No-Break"><code class="literal">admin</code></span><span class="No-Break">.</span></li>
                      </ol></li>
                    <li>Next, you will need to connect Prometheus as a Grafana data source. At this point, both containers are running <span class="No-Break">in Docker:</span>
                      <ol>
                        <li class="upper-roman">First, you will need to obtain the Prometheus IP address in Docker. You can get this information by inspecting the container. Execute the following commands to get the IP address of <span class="No-Break">the container:</span>
                          <ul>
                            <li>To retrieve the container ID, run the <span class="No-Break">following command:</span></li>
                          </ul></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">docker ps</code> </pre>
                      </div>
                      <ul>
                        <li>My container ID was <code class="literal">5affa2883c43</code>. Replace this with your container ID when running the <span class="No-Break">following command:</span></li>
                      </ul>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">docker inspect 5affa2883c43 | grep IPAddress</code> </pre>
                      </div>
                      <p class="list-inset">My terminal looks <span class="No-Break">like this:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_11.jpg" alt="Figure 3.11: Using docker inspect to get the container's IP address">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11: Using docker inspect to get the container's IP address</p>
                    </div>
                  </div>
                  <ol>
                    <li class="upper-roman" value="2">Now, open the menu on the left and select <strong class="bold">Connections</strong> | <span class="No-Break"><strong class="bold">Data sources</strong></span><span class="No-Break">:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_12.jpg" alt="Figure 3.12: Opening Data sources">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12: Opening Data sources</p>
                    </div>
                  </div>
                  <p class="list-inset">Click <strong class="bold">Add data source</strong> and select <strong class="bold">Prometheus</strong> as a data source type. If it doesn't appear on the first page, search for <code class="literal">Prometheus</code> in the <span class="No-Break">search bar:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_13.jpg" alt="Figure 3.13: Selecting Prometheus as a data source">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13: Selecting Prometheus as a data source</p>
                    </div>
                  </div>
                  <p class="list-inset">Then, configure the <strong class="bold">Prometheus server URL</strong> property. You will need to use the IP you obtained previously. In my case, this is <code class="literal">172.17.0.3</code>, but you likely have another value. The port <span class="No-Break">is </span><span class="No-Break"><code class="literal">9090</code></span><span class="No-Break">:</span></p>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_14.jpg" alt="Figure 3.14: Configuring the Prometheus server URL property">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14: Configuring the Prometheus server URL property</p>
                    </div>
                  </div>
                  <p class="list-inset">You can keep the default value for the rest of the parameters. At the bottom of the page, you'll find the <strong class="bold">Save &amp; Test</strong> button. Click on it. At this point, you can start visualizing data by building <span class="No-Break">a dashboard.</span></p>
                  <ol>
                    <li value="8">Finally, create a dashboard to visualize the number of pending bids. Go to <strong class="bold">Dashboards</strong>, click <strong class="bold">Create Dasboard</strong>, and then click <span class="No-Break"><strong class="bold">Add visualization</strong></span><span class="No-Break">.</span>
                      <p class="list-inset">For <strong class="bold">Metric</strong>, select <code class="literal">football_bids_pending</code>, and then click <strong class="bold">Run queries</strong>. Change the time range to the last 30 minutes. Finally, <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Save</strong></span><span class="No-Break">:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_15.jpg" alt="Figure 3.15: Configuring a panel">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15: Configuring a panel</p>
                    </div>
                  </div>
                  <p class="list-inset">Now, save your dashboard. Name it <span class="No-Break"><code class="literal">Pending Bids</code></span><span class="No-Break">.</span></p>
                  <ol>
                    <li value="9">Run a load test to see how metrics are visualized in the panel. You can use the JMeter script I created to generate some traffic. You can find it in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/" target="_blank">https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/</a>, in the <code class="literal">chapter3/recipe3-7/jmeter</code> folder. The Grafana panel should look <span class="No-Break">like this:</span></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_16.jpg" alt="Figure 3.16: Pending bids visualized in Grafana">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16: Pending bids visualized in Grafana</p>
                    </div>
                  </div>
                  <p class="list-inset">With that, you've learned how to visualize your metrics in powerful tools such <span class="No-Break">as Grafana.</span></p>
                  <h2>How it works‚Ä¶</h2>
                  <p>Prometheus is an extensible tool that can use exporters. These exporters are jobs that run in Prometheus and can get data from external sources if they're exposed using the appropriate format. This recipe's job scrapes the data, meaning that it gets the data from the external source periodically. In this recipe, we configured our application to export the data in a format that Prometheus can understand, after which we configured a target to retrieve <span class="No-Break">that data.</span></p>
                  <p>Some of the benefits of using Prometheus are <span class="No-Break">as follows:</span></p>
                  <ul>
                    <li>It can take metrics from multiple sources ‚Äì not only applications but also <span class="No-Break">infrastructure components.</span></li>
                    <li>It allows PromQL to be used, a language for querying and aggregating data. You can combine this data from multiple sources to extract relevant information <span class="No-Break">for monitoring.</span></li>
                    <li>You can create alerts based on queries and the thresholds you define. For instance, we could use CPU usage thresholds or our pending bids to send <span class="No-Break">an alert.</span></li>
                  </ul>
                  <p>Grafana can take data from different sources; one of them is Prometheus. This combination is very popular for monitoring solutions. Grafana can be used for advanced visualizations, and it also allows you to create alerts and send notifications. This is very important as it improves the monitoring <span class="No-Break">automation process.</span></p>
                  <p>In this recipe, we used these popular open source tools, but the same approach can be used with other commercial tools. Usually, monitoring tools manage tracing, logging, and metrics, adding capabilities for visualization, such as dashboards and alerting by <span class="No-Break">different channels.</span></p>
                  <p>An important thing to think about is when you should use traces or metrics for monitoring. Traces are very useful in showing the relationship between services and finding the specific operations using data from the transaction itself. This is very helpful in finding the root cause of an issue. The main issue with traces is that in scenarios with a high volume of operations, the amount of data that's generated can be huge, and usually, the traces are sampled so that all the data that's been generated can be processed and the cost can <span class="No-Break">be controlled.</span></p>
                  <p>On the other hand, the metrics aggregate the measurements, and they just export those aggregated measurements periodically to create the time series data. Then, the data that's generated is constant, regardless of the traffic managed by the target system. The main advantage of metrics is that they don't require sampling and the data that's generated is quite precise. For that reason, the metrics are more appropriate for certain types of alerts. However, when you need to find the root cause of an issue, traces are <span class="No-Break">more appropriate.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="row">
          <div class="col-lg-11 col-md-11 col-sm-10 col-10 reset-position">
            <div class="book-sections" id="book-section-ch04lvl1sec29">
              <div class="epub-source">
                <h1>Changing the settings of a running application</h1>
                <div>
                  <p>So far, you've added logging to your successful football trading application, and it receives quite a lot of traffic. The program creates logs in different places. These logs can help you figure out what the program did while it was running. Not every log is equally important. So, the program uses various log levels, ranging from debugging to error logs. Sorting logs by their level prevents an excessive number of logs from being created. However, you want to ensure you can change the minimum level of logs to be processed without restarting or redeploying <span class="No-Break">your application.</span></p>
                  <p>Some Spring Boot Actuator endpoints allow you to make changes in runtime, with no need to restart the application. The logging endpoint is one of those endpoints as it allows you to change the minimum level <span class="No-Break">of logging.</span></p>
                  <p>In this recipe, you will learn how to change the logging level of a <span class="No-Break">running application.</span></p>
                  <h2>Getting ready</h2>
                  <p>In this recipe, you will reuse the outcome of the <em class="italic">Integrating your application with Prometheus and Grafana</em> recipe. I've prepared a working version in case you haven't completed it yet. You can find it in this book's GitHub repository at https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/, in the <span class="No-Break"><code class="literal">chapter3/recipe3-8/start</code></span><span class="No-Break"> folder.</span></p>
                  <h2>How to do it‚Ä¶</h2>
                  <p>In this recipe, you'll adapt the football trading application so that it generates logs with different levels of importance. Once you've done this you'll learn how to change the level <span class="No-Break">at runtime:</span></p>
                  <ol>
                    <li>First, let's add some logs to the <span class="No-Break"><code class="literal">TradingService</code></span><span class="No-Break"> class:</span>
                      <ol>
                        <li class="upper-roman">Create a logger for the class. You can define a static member for <span class="No-Break">this purpose:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">private static final Logger logger = LoggerFactory.getLogger(TradingService.class);</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="2">Then, add debug and information logging to the <span class="No-Break"><code class="literal">getPendingOrders</code></span><span class="No-Break"> method:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public int getPendingOrders() {
    <strong class="bold">logger.debug("Ensuring that pending orders can be calculated");</strong>
    Random random = new Random();
    int pendingOrders = random.nextInt(100);
    <strong class="bold">logger.info(pendingOrders + " pending orders found");</strong>
    return pendingOrders;
}</code> </pre>
                      </div>
                      <ol>
                        <li class="upper-roman" value="3">You can also add some logging for the <span class="No-Break"><code class="literal">tradeCards</code></span><span class="No-Break"> method:</span></li>
                      </ol>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">public int tradeCards(int orders) {
    if (getPendingOrders() &gt; 90) {
        <strong class="bold">logger.warn</strong>("There are more than 90 orders, this can cause the system to crash");
        AvailabilityChangeEvent.publish(applicationEventPublisher, new Exception("There are more than 90 pending orders"), LivenessState.BROKEN);
    } else {
        <strong class="bold">logger.debug</strong>("There are more less than 90 orders, can manage it");
        AvailabilityChangeEvent.publish(applicationEventPublisher, new Exception("working fine"), LivenessState.CORRECT);
        }
    return orders;
}</code> </pre>
                      </div></li>
                    <li>Now, you can perform some requests and validate that the information is being logged. You can execute the following command in your terminal to execute a request <span class="No-Break">every second:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">watch -n 1 -x curl --request POST -H "Content-Type: application/json" --data "1" http://localhost:8080/football</code> </pre>
                      </div>
                      <p class="list-inset">You will see that only <code class="literal">INFO</code> and <code class="literal">WARN</code> logs <span class="No-Break">are processed:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_17.jpg" alt="Figure 3.17: Only INFO and WARN logs are processed">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.17: Only INFO and WARN logs are processed</p>
                    </div>
                  </div>
                  <p class="list-inset">This is because the default level is <code class="literal">INFO</code>. This means that only <code class="literal">INFO</code> or higher priority levels <span class="No-Break">are logged.</span></p>
                  <ol>
                    <li value="3">You can verify the log level by calling the Actuator <code class="literal">loggers</code> endpoint. Go to http://localhost:8080/actuator/loggers. You will see the available log levels, as well as the loggers that are defined in your application. You will see that there is a logger for your service class, <code class="literal">com.packt.footballobs.service.TradingService</code>, and that the effective level <span class="No-Break">is </span><span class="No-Break"><code class="literal">INFO</code></span><span class="No-Break">.</span></li>
                    <li>Let's say you've detected an issue in the application, and you want to activate the <code class="literal">DEBUG</code> level. Let's change it by using the Actuator <code class="literal">loggers</code> endpoint. For that, you just need to perform the <span class="No-Break">following request:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --request POST \
-H 'Content-Type: application/json' \
-d '{"configuredLevel": "DEBUG"}' \
http://localhost:8080/actuator/loggers/com.packt.footballobs.service.TradingService</code> </pre>
                      </div>
                      <p class="list-inset">You will see that it now generates logs for <code class="literal">DEBUG</code> <span class="No-Break">as well:</span></p></li>
                  </ol>
                  <div class="flex">
                    <div class="IMG---Figure">
                      <img src="https://static.packt-cdn.com/products/9781835089491/graphics/image/B21646_03_18.jpg" alt="Figure 3.18: DEBUG and higher critical logs are generated">
                      <p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.18: DEBUG and higher critical logs are generated</p>
                    </div>
                  </div>
                  <p class="list-inset">If you verify the <code class="literal">loggers</code> endpoint, as explained in <em class="italic">Step 3</em>, you will see that the <code class="literal">TradingService</code> class now has <span class="No-Break">two attributes:</span></p>
                  <ul>
                    <li><span class="No-Break"><code class="literal">configuredLevel</code></span><span class="No-Break">: </span><span class="No-Break"><code class="literal">DEBUG</code></span></li>
                    <li><span class="No-Break"><code class="literal">effectiveLevel</code></span><span class="No-Break">: </span><span class="No-Break"><code class="literal">DEBUG</code></span></li>
                  </ul>
                  <ol>
                    <li value="5">Now that you've verified the logs, you decide to change the log level to <code class="literal">WARN</code> by running the following command since too much noise is generated by <code class="literal">DEBUG</code> and <span class="No-Break"><code class="literal">INFO</code></span><span class="No-Break"> logs:</span>
                      <div class="code-toolbar">
                        <pre class="language-markup"><code class="language-markup">curl --request POST \
-H 'Content-Type: application/json' \
-d '{"configuredLevel": "WARN"}' \
http://localhost:8080/actuator/loggers/com.packt.footballobs.service.TradingService</code> </pre>
                      </div></li>
                  </ol>
                  <p>If you verify the <code class="literal">loggers</code> endpoint, as explained in <em class="italic">Step 3</em>, you will see that the <code class="literal">TradingService</code> level is <code class="literal">WARN</code>. If you continue making requests, you will see that only <code class="literal">WARN</code> logs <span class="No-Break">are emitted.</span></p>
                  <h2>How it works‚Ä¶</h2>
                  <p>As we saw in the <em class="italic">Creating a custom Actuator endpoint</em> recipe, some endpoints implement update and delete operations. The <code class="literal">loggers</code> endpoint allows you to change the log level. This is a very helpful feature when you need to find issues in production as you no longer need to restart <span class="No-Break">your application.</span></p>
                  <p>In an application with high traffic, you will usually want to have a high log level, such as <code class="literal">WARN</code>. This is the warning level and is typically used to indicate that there is a potential issue or anomaly that should be noted. It signifies a situation that may not necessarily be an error, but it could lead to problems if it's not addressed. The reason for using higher log levels, such as <code class="literal">WARN</code>, is that the logs are usually saved by the monitoring system. If the application generates too many logs, it requires more resources to process and retain them, and that can be costly. At the same time, <code class="literal">DEBUG</code> and <code class="literal">INFO</code> logs are not critical and they can generate too much information, making it more difficult to find the root cause of <span class="No-Break">the problems.</span></p>
                  <h2>There's more‚Ä¶</h2>
                  <p>Other standard endpoints are part of Spring Boot that allow you to make changes at runtime. For instance, the <code class="literal">sessions</code> endpoint allows you to retrieve and delete <span class="No-Break">user sessions.</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
