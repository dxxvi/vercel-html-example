<!DOCTYPE html>
<html lang="en" style="font-size: 16px">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Noto+Serif:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
  <style>
    :root {
      --bs-code-color: #0a6e77;
      --bs-font-monospace: "Fira Code", monospace;
      --code-color-comment: #a1b1b6;
      --code-color-italic: #36939b;
      --bs-font-sans-serif: "Noto Sans", sans-serif;
      --bs-body-color: #333;
    }
    .accordion {
      --bs-accordion-active-bg: #2c4d6b;
      --bs-accordion-active-color: #fff;
      --bs-accordion-btn-bg: #233342;
      --bs-accordion-btn-color: var(--bs-accordion-active-color);
      --bs-accordion-btn-icon-transform: rotate(90deg);
      --bs-accordion-btn-padding-y: .5rem;
      --bs-accordion-transition: color .82s ease-in-out, background-color .82s ease-in-out, border-color .82s ease-in-out, box-shadow .82s ease-in-out, border-radius .82s ease;
    }
    a { text-decoration: none }
    code, pre { font-size: 1em }
    code > i { color: var(--code-color-italic) }
    code > i.comment { color: var(--code-color-comment) }
    pre code { color: var(--bs-code-color) }
    button.accordion-button {  padding-left: calc(var(--bs-accordion-btn-padding-x) / 2) }
    button.accordion-button > i:first-child { display: inline-block; width: 1.94em }
    button.accordion-button > code { color: var(--bs-accordion-btn-color); padding-left: .25rem; padding-right: .25rem }
    h2.accordion-header + div.accordion-collapse { margin-left: 1rem }
    .accordion-button::after { background-image: none; content: '\276F'; color: #fff; transform: none }
    .accordion-button:not(.collapsed)::after { background-image: none }
    .accordion-item { border: 0 }
    .accordion-button { box-shadow: none !important }
    pre { background: linear-gradient(90deg, #f3f3f3, #fff, #f5f5f5); padding: .5rem .5rem .5rem 1rem; margin-left: 1rem }
    li > pre { margin-left: unset }
    kbd { 
      display: inline-block; margin: 0 2px; text-shadow: 0 1px 0 #fff; color: #242729; font: .875em "Noto Serif"; text-align: center;
      line-height: 1.1; background-color: #e4e6e8; border: 1px solid #9fa6ad; border-radius: 3px; min-width: 2.7em;
      box-shadow: 0 1px 1px rgba(12,13,14,0.15),inset 0 1px 0 0 #fff
    }
    body table.table { width: unset }
    body .table > :not(caption) > * > * { padding-top: .25rem; padding-bottom: .25rem; padding-left: 1.4rem }
    th { font-family: "Noto Serif" }
    
    table.vim-motions kbd { font-size: 1.2rem; padding-left: .3rem; padding-right: .3rem; min-width: 2rem }
  </style>
</head>
<body style="font: 1rem/1.43 'Noto Serif'">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
<div class="tab" title="Configurations - Contacts - Credentials" fontawesome="fa-solid fa-gear">
Nothing in here
</div>
<div class="tab" title="Linux (including AWS and Vim)" fontawesome="fa-brands fa-linux">
[Install Arch Linux](https://www.youtube.com/watch?v=4dKzYmhcGEU) 17:27 shows how to remove Arch.

`find . -type f -exec ls "{}" \;` or `find . -type f -exec ls "{}" +`: in the 1st command, `;` needs to be escaped, that's why we need `\`. `\;` is like `ls file1; ls file2` and `+` is like `ls file1 file2`

Print the difference between 2 files: `diff --side-by-side --suppress-common-lines --width=210 *file1.java* *file2.java* | cat -n | grep -v -e '&#40;$'`

mount: `sshfs *remote_machine*:/*remote-folder* ~/*local-folder* -C` - unmount: `fusermount3 -u *mountpoint*`

Save SSL certificates in files: `openssl s_client [-proxy 10.51.40.129:3128] -connect *HOSTNAME*:*PORT* -showcerts`, save all `-----BEGIN CERTIFICATE----- ... -----END CERTIFICATE-----` in `.pem` files then convert .pem to .crt: `openssl x509 -inform PEM &lt; file.pem > file.crt`

Generate public key from AWS pem file: `ssh-keygen -y -f aws-generated.pem > aws-generated.pub`

substring: `echo "my string" | cut -c2-5 // returns a string from the position 2 to 5`

Regex: replace `([A-Z])\.([A-Z])` with `$1_$2`, look for strings not contain substring `^((?!sub string).)*$`

Keep environment variables in `sudo`: `sudo -E *command*`

To create RSA public, private keys in PEM format (`ssh-keygen` generates keys in a different format): `openssl genrsa -out private-key.pem 2048` then `openssl rsa -in private-key.pem -pubout -outform PEM -out public-key.pem`

Cut by multiple spaces: `*some command* | tr -s ' ' | cut -f...`

Read each line from a command output or from a file:
```
while read -r line; do                              while read -r line; do
  *do something with the variable $line*                *do something with the variable $line*
done &lt; &lt;(*command*)                                   done &lt; *some-file*
```

Display UTF-16 in Bash and Zsh: `snowflake=$(s='\u2744' && printf "$s") && echo $snowflake`

| Bash                                           | Zsh                          | Zsh in <i class="fa-brands fa-apple"></i> | Comment
|------------------------------------------------|------------------------------|-------------------------------------------|-------------
|<kbd>Alt</kbd>+<kbd>D</kbd>                     |                              |                                           |delete to the end of the word
|<kbd>Ctrl</kbd>+<kbd>W</kbd>                    | <kbd>Ctrl</kbd>+<kbd>W</kbd> |<kbd>&#8963;</kbd>+<kbd>W</kbd>            |delete to the beginning of the word
|<kbd>Alt</kbd>+<kbd>F</kbd>                     | <kbd>Alt</kbd>+<kbd>‚ûú</kbd>  |                                           |go to the end of the current/next word
|<kbd>Alt</kbd>+<kbd>B</kbd>                     | <kbd>Alt</kbd>+<kbd>‚Üê</kbd>  |                                           |go to the beginning of the current/prev word
|<kbd>Ctrl</kbd>+<kbd>A</kbd>                    | <kbd>Ctrl</kbd>+<kbd>A</kbd> |<kbd>&#8963;</kbd>+<kbd>A</kbd>            |to the beginning of the line
|<kbd>Ctrl</kbd>+<kbd>E</kbd>                    | <kbd>Ctrl</kbd>+<kbd>E</kbd> |<kbd>&#8963;</kbd>+<kbd>E</kbd>            |to the end of the line
|<kbd>Ctrl</kbd>+<kbd>K</kbd>                    | <kbd>Ctrl</kbd>+<kbd>K</kbd> |<kbd>&#8963;</kbd>+<kbd>K</kbd>            |kill to the end of the line
|<kbd>Ctrl</kbd>+<kbd>U</kbd>                    |                              |                                           |kill to the beginning of the line
|<kbd>Ctrl</kbd>+<kbd>Y</kbd>                    | <kbd>Ctrl</kbd>+<kbd>Y</kbd> |                                           |paste text from the kill buffer
|<kbd>Ctrl</kbd>+<kbd>L</kbd>                    | <kbd>Ctrl</kbd>+<kbd>L</kbd> |<kbd>&#8963;</kbd>+<kbd>L</kbd>            |clear screen
|                                                |<kbd>Ctrl</kbd>+<kbd>U</kbd>  |<kbd>&#8963;</kbd>+<kbd>U</kbd>            |kill the whole line
|<kbd>Ctrl</kbd>+<kbd>&#x21e7;</kbd>+<kbd>-</kbd>|<kbd>Ctrl</kbd>+<kbd>-</kbd>  |<kbd>&#8963;</kbd>+<kbd>-</kbd>            |undo the last change

| vim motions                                                              | `:set [no]number [no]relativenumber`                                         | `Ctrl-o` in insert mode                                    | c
|--------------------------------------------------------------------------|------------------------------------------------------------------------------|------------------------------------------------------------|---------------------------------------------------------------
| <kbd>h</kbd> ü†à                                                           | <kbd>j</kbd> ü†ã                                                              | <kbd>k</kbd> ü†â                                             | <kbd>l</kbd> ü†ä
| <kbd>e</kbd> to end of current word                                      | <kbd>w</kbd> to beginning of next word                                       | <kbd>b</kbd> to beginning of previous word                 | <kbd>g</kbd><kbd>e</kbd> end of previous word
| <kbd>0</kbd> to 1st character of line                                    | <kbd>^</kbd> to 1st non-blank character of line                              | <kbd>$</kbd> to end of line                                | <kbd>g</kbd><kbd>_</kbd> last non-blank character of line
| <kbd>E</kbd> to end of current WORD                                      | <kbd>W</kbd> to beginning of next WORD                                       | <kbd>B</kbd> to beginning of previous WORD                 | <kbd>g</kbd><kbd>E</kbd> end of previous WORD
| <kbd>f</kbd><kbd>{character}</kbd> to next {character}                   | <kbd>F</kbd><kbd>{character}</kbd> to previous {character}                   | <kbd>t</kbd><kbd>{character}</kbd> before next {character} | <kbd>T</kbd><kbd>{character}</kbd> before previous {character}
| <kbd>f</kbd><kbd>{character}</kbd> then <kbd>;</kbd> to next {character} | <kbd>f</kbd><kbd>{character}</kbd> then <kbd>,</kbd> to previous {character} | | 
| <kbd>&#125;</kbd> next paragraph                                         | <kbd>&#123;</kbd> previous paragraph                                         | |
| <kbd>/</kbd>{pattern} search forward, then <kbd>‚Üµ</kbd>                  | <kbd>?</kbd>{pattern} search backward , then <kbd>‚Üµ</kbd>                    | <kbd>n</kbd> next match                                    | <kbd>N</kbd> previous match
| <kbd>g</kbd><kbd>g</kbd> to top of the file                              | <kbd>G</kbd> to end of file                                                  | {line number}<kbd>g</kbd><kbd>g</kbd> to a specific line   | <kbd>%</kbd> to matching bracket `&#40;&#91;&#123;&#125;&#93;&#41;`
| <kbd>v</kbd> visual mode                                                 | <kbd>V</kbd> visual line mode (text is selected by line)                     | <kbd>Ctrl</kbd>+<kbd>v</kbd> visual block mode
| <kbd>y</kbd> yank                                                        | <kbd>d</kbd> cut                                                             | <kbd>p</kbd> paste

[waybar](https://github.com/Alexays/Waybar) is said to be better than polybar and tint2. [Linux Desktop](https://www.youtube.com/watch?v=kHG5czrQ7WA)

sed: substitute, add and delete lines‚à®
  - of course, the one I already knew: substitue: `sed -i 's/*a*/*b*/g' *file.txt*`; multiple substitutions `sed -i -e 's/*a*/*b*/g' -e 's/*c*/*d*/' *file.txt*`
  - print the Nth line in the file: `sed -n '*N*p' *file.txt*`
  - delete the first N + 1 lines in the file: `sed -i -e '1,*N*d' *file.txt*`
  - delete lines containing something in the file: `sed -i -e '/*something*/d' file`
  - add a line after the Nth line in the file: `sed '*N* a *line to be added*' *file.txt*` (don't forget to add `-i` to edit the file)
  - add a line before the Nth line in the file: `sed '*N* i *line to be added*' *file.txt*`, `$` means the last line
  - add a line after the lines containing a pattern match: `sed '/*PATTERN*/a *line to be added*' *file.txt*`, use `-E` for regex
  - add a line before the lines containing a pattern match: `sed '/*PATTERN*/i *line to be added*' *file.txt*`

grep: filter‚à®
  - get lines longer than 82 characters: `grep '.\{82\}'`
  - count number of lines longer than 82 characters: `grep -c '.\{82\}'` instead of `grep '.\{82\}' | wc -l`

[jq](https://www.youtube.com/watch?v=j7xZ2VkLYIY)‚à®
  - `jq '.' file.json` or `cat file.json | jq '.'`. `.` is like the root, so we can add fields after it.

Use our private key on a remote machine without copying it there‚à®
  - Lists fingerprints of all identities currently represented by the agent: `ssh-add -l` which might return an error if the ssh-agent is not started.
  - In [PowerShell](https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_keymanagement), check the status of ssh-agent with `Get-Service ssh-agent`, start it `Start-Service ssh-agent`: hm ... doesn't work for me
  - Load our keys into the ssh-agent `ssh-add $env:USERPROFILE\.ssh\id_ed25519`
  - `ssh -A user@remote-machine`

AWS EC2‚à®
  - To generate the `accessKeyId` and `secretAccessKey` for the IAM in an ec2 instance:
```
export TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/iam/security-credentials/*our-iam-role-name*"
```
  - `X11Forwarding` in EC2 instances is not enough, we need `AllowTcpForwarding` too. Install vcxsrv, run `xlaunch`, in PowerShell `$env:DISPLAY="localhost:0"`, then `ssh -Y remote-machine`. In the remote machine `export LIBGL_ALWAYS_INDIRECT=1`
  - Attach an EBS volume to an EC2 instance: `ec2Client.attacheVolume(AttacheVolumeRequest.volumeId("...").instanceId("i-xxx").device("/dev/sdb"))` then `lsblk` to check the real device as it might not be `/dev/sdb` but `/dev/nvme1n1`. Check if the volume has any file system `file -s /dev/nvme1n1`. Format it `mkfs -t ext4 /dev/nvme1n1`. Mount it `mount /dev/nvme1n1 /mnt/something`.
  - Unmount then detach an EBS volume from an EC2 instance before terminating it (`aws ec2 detach-volume` or `ec2Client.detachVolume(detachVolumeRequest)`).
  - Java example to create an EC2 spot instance that can hibernate:
```
IamInstanceProfileSpecification.builder().name("...").build()
SpotMarketOptions.builder().spotInstanceType(PERSISTENT).instanceInterruptionBehavior(HIBERNATE).maxPrice("2").build()
InstanceMarketOptionsRequest.builder().marketType(SPOT).spotOptions(spotMarketOptions).build()
TagSpecification.builder().resourceType(INSTANCE).tags(Tag.builder().key("...").value("...").build(), ...).build()
EbsBlockDevice.builder().deleteOnTermination(true).volumeSize(...).volumeType(GP3).build()
BlockDeviceMapping.builder().ebs(ebsBlockDevice, ...).deviceName("/dev/sdh").build()
RunInstancesRequest.builder().blockDeviceMappings(...).iamInstanceProfile(...).imageId(...).instanceType(T3_LARGE).instanceMarketOptions(...).keyName(...).maxCount(1).minCount(1).securityGroupIds(...).subnetId(...).tagSpecifications(...).userData(Base64.getEncoder().encodeToString(...)).build()
```

AWS ECS‚à®
  - Create a private repository (contains tags of only 1 docker image). AWS console will show us the exact commands to login, push a docker image to ECR.
  - Create a cluster (can run on Fargate (serverless) or EC2 instances)
  - Create a task definition: a task definition does the job of docker-compose.yml
  - Create a load balancer (under EC2):
      - target group: for ECS the target type is IP address but we don't need to specify any IP address here (that makes sense as the IP addresses are not fixed)
      - choose Application Load Balancer
  - Create a service:
      - a service ensures that a certain number of tasks run at all times
      - task: a running container with settings defined in the Task Definition
      - VPC, subnets: ec2 instances will be created in these subnets to run our tasks
      - security groups: applied for the ec2 instances that run our tasks
      - there's a section to specify the load balancer. At this moment, we know that load balancer will route traffics to where.
      - when done, there's a link in the service for the load balancer where there's a DNS name for this load balancer

AWS Lambda‚à®
  - All acceptable events are in `com.amazonaws:aws-lambda-java-events`.
  - Every lambda has an execution role which can upload logs to CloudWatch.
  - With API Gateway as a trigger:
      - Create a lambda but don't <kbd>+ Add Trigger</kbd> yet
      - Create an API Gateway (REST API type)
      - Add resource (e.g. `countries`, `{countryId}`, `states`, `{stateId}`)
      - <kbd>Create method</kbd> for the above resource: in this step we need the lambda arn (that's why we need a lambda first)
      - <kbd>Deploy API</kbd> so that we can specify a stage name.
      - Refresh the lambda console, we'll see that the API Gateway is added as a trigger. In the Configuration tab, the API Gateway trigger gives use an API endpoint
      - Code source: to set the jar in s3; Runtime settings: to set the runtime (e.g. Java 21) and the handler method
      - Logging messages are in CloudWatch
      - After putting the new jar in s3, we need to go to the lambda console and <kbd>Upload from ‚ñº</kbd> again.
  - With S3 event as a trigger:
      - Use `com.amazonaws.services.lambda.runtime.events.S3Event` as the input, the output can be anything.
      - `S3Event` has a `List&lt;S3EventNotificationRecord&gt;`. Each record has information about the S3 object (bucket, key, size, owner, arn ...)

AWS EventBridge‚à®
  - We can schedule an event based on cron. It can trigger a lambda.

AWS SQS (simple queue service)‚à®

| 2 types of queues | throughput           | delivery type           | ordering
|-------------------|----------------------|-------------------------|----------------------
| Standard queues   | unlimited throughput | At-Least-Once delivery  | Best effort ordering
| FIFO queues       | high throughput      | Exactly-Once processing | FIFO delivery

  - When a message is received, the visibility timeout starts. Nobody can receive the message before the visibility timeout ends. The person who receives the message has to explicitly delete it otherwise he will receive that message again.
  - Message payload max size is 256KB. Each 64KB is billed as 1 request. If we use the SQS Extended Client library for Java, we can send messages of up to 2GB (message payload will be stored in S3).
  - Messages are retained in queues for 14 days
  - We can do a long polling (wait 20s for messages) to reduce the number of requests
  - [Message group id](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagegroupid-property.html): not very sure about its purpose. It's advised to have unique message group id if we want to avoid processing duplicates in a multi-producer/consumer system.
  - SNS is a publish-subscribe service. AWS allows some types of subscribers only like SQS, Lambda, HTTP, email, mobile push notification and SMS.
  - Amazon MQ is for applications that are using JMS, Active/Rabbit MQ ... to migrate to AWS.

</div>
<div class="tab" title="Docker" fontawesome="fa-brands fa-docker">
[Docker Compose UI](https://github.com/louislam/dockge)

A place [to store a docker image](http://ttl.sh/) for 24 hrs

To run docker in a docker container: run the docker container with `-v /var/run/docker.sock:/var/run/docker.sock`

To use the exact network as host (e.g. a docker container in an ec2 instance wants to use the IAM on that instance): run the docker container with `--network host` and that means `-p host-port:container-port` is ignored (the container and the host will use the same ports).

Expose docker daemon on tcp port and access it from Powershell‚à®
  - Running `systemctl start docker` shows something like `/usr/lib/systemd/system/docker.service`. Edit the line `ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 ...`
  - Powershell: install chocolatey and `choco install docker-cli` with admin right. Then `$env:DOCKER_HOST="tcp://x.x.x.x:2375"`, `docker image ls` will work.
</div>
<div class="tab" title="Kubernetes">
This is Kubernetes
</div>
<div class="tab" title="Mac" fontawesome="fa-brands fa-apple">
Cannot be opened because the developer cannot be verified:
  - locate the app in Finder | &#8963;+click | select Open | click Open: the app will be saved as an exception
  - or <i class="fa-brands fa-apple"></i> menu | System Settings | Privacy & Security | there's a Open Anyway button for the app we've just failed to open
  - in case of graalvm, run `find ~/graalvm/Contents/Home/ -name "*.dylib" -exec xattr -d com.apple.quarantine "{}" \;`

Add spaces to MacOS dock: `defaults write com.apple.dock persistent-apps -array-add '{"tile-type"="spacer-tile";}'; killall Dock`
</div>
<div class="tab" title="NodeJS - HTML - CSS" fontawesome="fa-brands fa-node-js">
[HTML codes](https://www.rapidtables.com/web/html/html-codes.html) for example `&#123;` is `&#38;#123;`

[paged.js](https://pagedjs.org/) paginates any HTML content to produce beautiful print-ready PDF

css property: `-moz-osx-font-smoothing`, Roboto Flex font (Google Fonts [filtered for variable only](https://fonts.google.com/?vfonly=true)): adjustable width

Align `dt` and `dd` in `dl`:
```
dl { display: grid; grid-template-columns: max-content auto }
dt { display: grid; align-content: center; grid-column-start: 1 }
dd { margin-left: 0; grid-column-start: 2 }
```

`getComputedStyle(*element*).getPropertyValue('*property*')`: [for example](https://developer.mozilla.org/en-US/docs/Web/API/Window/getComputedStyle) `getComputedStyle(p).getPropertyValue('font-size')`

[Insert html code to an element](https://developer.mozilla.org/en-US/docs/Web/API/Element/insertAdjacentHTML): `*element*.insertAdjacentHTML(*position*, *text*)` where `*position*` can be `beforebegin`, `afterbegin`, `beforeend` or `afterend` and `*text*` is the string to be parsed as HTML and inserted into the tree.

[Get all attributes](https://developer.mozilla.org/en-US/docs/Web/API/Element/attributes) of a html element

Convert image data to base64:
```
function convertImageToBase64(imgUrl, callback) {
  const image = new Image();
  image.crossOrigin = 'anonymous';
  image.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = image.naturalHeight;
    canvas.width = image.naturalWidth;
    ctx.drawImage(image, 0, 0);
    callback && callback(canvas.toDataURL()) // canvas.toDataURL() is what we want
  };
  image.src = imgUrl;
}
```

Angular‚à®
  - A component is annotated with `@Component` which takes a css `selector`, a `templateUrl`, 0 or many `styleUrls` and other non-popular properties like `encapsulation: ViewEncapsulation.Emulated | ShadowDom` (so that the css styles of the page don't affect this component and vice versa), ...
  - Component lifecycle: the Typescript class for the component can implement some interfaces like
      - `OnChanges`: called before `ngOnInit()` if the component has bound inputs and when the data-bound input properties change
      - `OnInit`, `DoCheck`, `AfterContentInit`, `AfterContentChecked`, `AfterViewInit`, `AfterViewChecked`, 'OnDestroy'
  - Component interaction:
      - Pass data from a parent to its child with `@Input`. We can intercept input property changes with a setter or `ngOnChanges()`
      - Parent listens for child event with `@Output() *someVar* = new EventEmitter&lt;*SomeType*&gt;(); *someVar*.emit(*someTypeInstance*);`
      - Parent can declare a local variable which is of child component type `&lt;child-component #myChildComponent&gt;&lt;/child-component&gt;`. Then __in parent component template__ (not parent component class, if we want to access the child component in the parent component class, use `@ViewChild()`), we can access properties, methods of child component using `myChildComponent.property` or `myChildComponent.method()`.
      - Parent can declare a local variable in the typescript class `@ViewChild(ChildComponent) private childComponent: ChildComponent;`
      - Use `RxJs`: [2 components share a service](https://angular.io/guide/component-interaction#parent-and-children-communicate-using-a-service) which has a `Subject` instance (from `rxjs`) and an observable of that subject. This service must be annotated with `@Injectable()` so that it can be injected to constructors of other services/components. In those other services/components, we need to subscribe to that observable.
  - Content projection: [when](https://angular.io/guide/content-projection) _I have time, I'll write about this_
  - Dynamic components: [also](https://angular.io/guide/dynamic-component-loader) very interesting
  - Directives: are classes that add additional behavior to elements. 3 directive types: component, attribute directive (`ngClass`, `ngStyle`, `ngModel` to display and update properties) and structural directive (`ngIf`, `ngFor`, `ngSwitch`)
  - Forms: [a big subject](https://angular.io/guide/forms-overview) with reactive and template-driven forms.
  - HTTP client: I think nobody will ask about [this](https://angular.io/guide/understanding-communicating-with-http) in interviews
  - What is multicasting? Error handing in observable?

</div>
<div class="tab" title="Java" fontawesome="fa-brands fa-java">
[Slim docker images for Java apps](https://piotrminkowski.com/2023/11/07/slim-docker-images-for-java/)

[Disable SSL](https://stackoverflow.com/questions/52988677/allow-insecure-https-connection-for-java-jdk-11-httpclient) in Java 11 HttpClient

[Java 21 language update](https://docs.oracle.com/en/java/javase/21/language/pattern-matching-switch-expressions-and-statements.html): a very good to see all the changes in 1 place

Jdk 22 - [Stream Gatherer](https://blog.soebes.io/posts/2024/01/2024-01-07-jdk-gatherer/) (preview) Viktor Klang

Using Datadog + profilers [to understand request latency](https://richardstartin.github.io/posts/wallclock-profiler)

New Language [Features](https://jenkov.com/tutorials/java/index.html) from Java 7 - 21 ~ [Compare](https://javaalmanac.io/) Java API of different JDK versions

[JFR events](https://sap.github.io/SapMachine/jfrevents/21.html): when can I have time to play with JFR? 

[Manifold](http://manifold.systems/) is a Java _compiler plugin_ for method extension ~ [BoofCV](http://boofcv.org) computer vision Java library - [Benchmark JDBC connectors and virtual threads](https://mariadb.com/resources/blog/benchmark-jdbc-connectors-and-java-21-virtual-threads/)

Elasticsearch in Action 2nd Edition Dec 2023 - Getting Started with Elastic Stack 8.0 Mar 2022 - Kibana 7 Quick Start Guid Jan 2019

Install certificates:
  - Java 11+: `keytool -importcert -trustcacerts -storepass changeit -cacerts -noprompt -file */Downloads/certificates/prag.pem* -alias *prag*`
  - Java 8: `keytool -importcert -trustcacerts -storepass changeit -keystore $JAVA_HOME/jre/lib/security/cacerts -noprompt -file */Downloads/certificates/prag.pem* -alias *prag*`

Tell the jvm to use proxy: `-Dhttp.proxyHost=... -Dhttp.proxyPort=... -Dhttp.nonProxyHosts="10.*|*.nbc.net" -Dhttp.proxyUser=... -Dhttp.proxyPassword=...`

To programmatically set log level (check [this](https://prefab.cloud/blog/dynamically-changing-java-log-level/) for ways to do this for all instances of a service. IMO Redis pub/sub is the best. If the service discovery can tell us all the instances, then we can use that):
```
var loggerContext = (ch.qos.logback.classic.LoggerContext) org.slf4j.LoggerFactory.getILoggerFactory()
List&lt;ch.qos.logback.classic.Logger> loggers = loggerContext.getLoggerList() // need to define a logger for a specific package/class in logback.xml
logger.setLevel(ch.qos.logback.classic.Level.DEBUG)
```

To test if there's a particular log message at a particular log level (for logback only):
  - Create `var listAppender = new ListAppender&lt;ILoggingEvent>()`
  - Get the logger that prints out the particular log message: `var logger = (ch.qos.logback.classic.Logger) org.slf4j.LoggerFactory.getLogger("*logger.name*")`
  - Then `logger.addAppender(listAppender); listAppender.start()`. The `listAppender.list` has all the logging events.

Download an artifact with maven: `mvn org.apache.maven.plugins:maven-dependency-plugin:3.3.0:get -Dartifact=org.jetbrains.kotlin:kotlin-stdlib:1.7.21:jar:sources`

git-commit-id maven/gradle plugin generates a `git.properties` file that we can expose via an endpoint.

Kafka‚à®
  - [Confluent Kafka](https://docs.confluent.io/platform/current/installation/installing_cp/zip-tar.html) download and installation or [previous version](https://www.confluent.io/previous-versions/)
  - To make `KafkaConsumer` return `SpecificRecord`:
```
props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, KafkaAvroDeserializer.class); 
props.put(KafkaAvroDeserializerConfig.SPECIFIC_AVRO_READER_CONFIG, "true"); 
props.put(AbstractKafkaSchemaSerDeConfig.SCHEMA_REGISTRY_URL_CONFIG, ...);
```
  - Kafka Stream: runs in our applications - Apache Flink (more powerful): runs in Flink servers (how to unit test a Flink-based app?)
  - Kafka Stream task: is the code that does the joining/mapping/filtering ...The max number of tasks is the max number of partitions of all the topics used in that task.
      - `KStream`: a partitioned record stream
      - `KTable`: a partitioned table (changelog stream)
      - `GlobalKTable`: similar to KTable but unpartitioned
      - Handling deserialization errors: use the config `DEFAULT_DESERIALIZATION_EXCEPTION_HANDLER_CLASS_CONFIG`
      - Stateless processing: filter, adding &amp; removing fields (what's this?), rekeying records, branching &amp; merging streams, enriching records, flatMapping
      - Stateful processing:
          - Joining data: enrich an event with info captured in a separate stream/table (`join`, `leftJoin`, `outerJoin`)
          - Aggregating data: maybe in one partition only (`aggregate`, `count`, `reduce`)
          - Windowing data: group events that are close to each other in time (`windowedBy`)
          - States are stored in RocksDB which flushes data to files in `StreamsConfig.STATE_DIR_CONFIG`.

Concurrency‚à®
  - interface `Executor.execute(Runnable): void`
  - interface `ExecutorService extends Executor`:
      - `ExecutorService.submit(Runnable): Future&lt;?>`
      - `ExecutorService.submit(Runnable, T result): Future&lt;T>`
      - `ExecutorService.submit(Callable&lt;T>): Future&lt;T>`
      - `ExecutorService.invokeAny(Collection&lt;Callable&lt;T>>, optional timeout): T`
      - `ExecutorService.invokeAll(Collection&lt;Callable&lt;T>>, optional timeout): List&lt;Future&lt;T>>`
  - interface `ScheduledExecutorService extends ExecutorService` has `schedule(Runnable | Callable, delay): ScheduledFuture`, `scheduleAtFixedRate(Runnable, initialDelay, period): ScheduledFuture&lt;?>` and `scheduleAtFixedDelay(Runnable, initialDelay, delay): ScheduledFuture&lt;?>`. 
  - To get the task results in order of completion, use `var completionService = new ExecutorCompletionService&lt;R>(executorService)` then submit a job `completionService.submit(runnable/callable): Future&lt;R>` then get the next completed task result `completionService.poll/take: Future&lt;R>`
  - `ConcurrentHashMap`: `compute/computeIfAbsent/computeIfPresent` are atomic, to create a *ConcurrentHashSet*: `.newKeySet`, reduce: `reduce/reduceEntries[ToInt/Long/Double]/reduceKeys[ToInt/Long/Double]/reduceValues[ToInt/Long/Double](parallelThreshold, (k, v) -> r, (r, r) -> r): R`, parallel search: `search[Entries/Keys/Values](parallelThreshold, (k, v) -> r)`
  - Lock:
      - Issues with `synchronized`: locks must be released in the reverse order of lock acquisitions `synchronized (a) { synchronized (b) { ... } }`
      - `interface Lock`: wait forever to get the lock: `.lock()` - try to get the lock: `.tryLock(timeout): boolean` - finally must `.unlock()`. Implementation is `ReentrantLock`.
      - `interface ReadWriteLock`: still can't find an example of why a read lock is needed. `.writeLock(): Lock` returns the lock for writing - `.readLock(): Lock`: that means only 1 thread can read at a time? Implementation is `ReentrantReadWriteLock`.

Spring Data Redis‚à®
  - If we have `spring.data.redis.host/port/password/database` then a `redisConnectionFactory` bean is created for us. Otherwise, create that bean like this:
```
var redisStandaloneConfiguration = new RedisStandaloneConfiguration(host, port);
redisStandaloneConfiguration.setPassword(redisPassword);
var redisConnectionFactory = new LettuceConnectionFactory(redisStandaloneConfiguration);
redisConnectionFactory.afterPropertiesSet(); // this is very important
```
  - Then, create a `RedisTemplate&lt;..., ...>` like:
```
var redisTemplate = new RedisTemplate&lt;String, Object>();
redisTemplate.setConnectionFactory(redisConnectionFactory);
redisTemplate.setKeySerializer(new GenericJackson2JsonRedisSerializer()); // Jackson is faster than the Java serialization
redisTemplate.setHashKeySerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
redisTemplate.afterPropertiesSet(); // this is very important
```
  - Need to test: for every type `T`, we need a Spring bean of type `RedisTemplate&lt;String, T>` otherwise, how do we read an object of type `T` from redis?

JPA‚à®
  - Collection mapping (this is [what the DB tables look like](https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-01.jpg)):
```
public &#64;Embeddable class VacationEntry &#123;                          public &#64;Entity class Employee {
  private &#64;Temporal(TemporalType.DATE) Calendar startDate;          private &#64;Id int id;
  private &#64;Column(name = "DAYS") int daysTaken;                     private long salary;
}                                                                   private &#64;ElementCollection(targetClass = VacationEntry.class) Collection vacations;
                                                                    private &#64;ElementCollection Set&lt;String> nickNames;
```
  - Transaction:
      - Propagation
          - in Spring, the default is `&#64;Transactional(propagation = Propagation.REQUIRED)` which means that a current transaction is supported and a new one is created if none exists
          - `SUPPORTS` means the current transaction is supported but will execute non-transactionally if none exists
          - `MANDATORY` supports a current transaction, throws an exception if none exists
          - `REQUIRES_NEW` creates a new transaction and suspends the current transaction
          - `NOT_SUPPORTED` executes non-transactionally, suspends the current transaction
          - `NEVER` executes non-transactionally, throws an exception if a transaction exists
          - `NESTED` executes within a nested transaction if a transaction exists
      - Isolation: describes how changes in concurrent transactions are visible to each other
          - `&#64;Transactional(isolation = Isolation.DEFAULT)`: use the default isolation level of the DB, e.g. Postgres has Read Committed as default
          - `READ_UNCOMMITTED`: dirty reads *(a transaction reads data written by a concurrent uncommitted transaction)*, non-repeatable reads *(a transaction re-reads data it has previously read and finds that data has been modified by another transaction, i.e. commited after the 1st read)* and phantom reads *(a transaction re-executes a query returning a set of rows that satisfy a search condition and finds that the set of rows has changed due to another recently-committed transaction)* can occur
          - `READ_COMMITTED`: dirty reads are prevented but non-repeatable and phantom reads can occur
          - `REPEATABLE_READ`: dirty and non-repeatable reads are prevented but phantom reads can occur
          - `SERIALIZABLE`: dirty, non-repeatable and phantom reads are prevented
  - Inheritance:
      - Class hierarchies:
          - `&#64;Entity abstract class Employee(id: int, name: String, startDate: Date)`
          - `&#64;Entity class ContractEmployee(dailyRate: int) extends Employee(id, name, startDate)`
          - `&#64;Entity abstract class CompanyEmployee(vacation: int) extends Employee(id, name, startDate) // &#64;Entity can be used with abstract class too`
          - `&#64;Entity class PartTimeEmployee(hourlyRate: int) extends CompanyEmployee(vacation)`
          - `&#64;Entity class FullTimeEmployee(salary: int) extends CompanyEmployee(vacation)`
      - `&#64;MappedSuperclass`: denotes a class that stores shared state but is not a persistent class (i.e. no `&#64;Table` on it, no query over it). In the above example, we can put `&#64;MappedSuperclass` on `CompanyEmployee` but then we won't be able to find all company employees in 1 shot.
      - Single-table strategy: the most common and performant way. Then we need a discriminator column and discriminator values.
          - `&#64;Entity &#64;Table &#64;DiscriminatorColumn(name = "...") abstract class Employee`
          - `&#64;Entity &#64;DiscriminatorValue("...") class FullTimeEmployee`
      - Joined strategy:
      - Table-per-concrete-class strategy:

Composition vs Inheritance‚à®
  - class inheritance issue:
```
class Animal { void walk() { ... } }
class FlyingAnimal extends Animal { void fly() { ... } }
class SwimmingAnimal extends Animal { void swim() { ... } } // now, how to define an animal that can fly and swim?
```
  - ~~object composition~~: this is not object composition:
```
interface Animal { default void walk() { ... } }
interface FlyingAnimal extends Animal { default void fly() { ... } }
interface SwimmingAnimal extends Animal { default void swim() { ... } }
class Duck implements FlyingAnimal, SwimmingAnimal { } // we can do this because we can implement multiple interfaces
```
  - object composition:
```
class WalkingAbility { ... }
class FlyingAbility { ... }
class SwimmingAbility { ... }
class Animal {
  private WalkingAbility wa;
  private FlyingAbility fa;
  private SwimmingAbility sa;
  public static Animal createDog(WalkingAbility _wa, SwimmingAbility _sa) { ... }
  public static Animal createDuck(WalkingAbility _wa, SwimmingAbility _sa, FlyingAbility _fa) { ... }
}
```

Spring Boot 3 and OpenAPI; Always use `wiremock-standalone` to avoid jetty version conflict‚à®
  - `org.springdoc:springdoc-openapi-starter-webmvc-ui` then on a Controller method for an endpoint, we can have `@Operation`, `@ApiResponse`. On an input/output class, we can have `@Schema`. We can create a bean of type `OpenAPI` to security schemes to endpoints (e.g. `authorization: bearer ...`), a bean of type `OpenApiCustomizer` to add some examples that can be seen in `/swagger-ui/index.html`.

Testcontainers‚à®
  - [No need to start and stop the container](https://java.testcontainers.org/test_framework_integration/manual_lifecycle_control/) in every test: test classes need to `extends` an abstract class with a static variable for the container and a static block to start that container. No need to stop the container as Ryuk will do it.
  - If a specific container doesn't work, a generic container is good enough:
```
genericContainer = new GenericContainer<>(DockerImageName.parse("docker.elastic.co/elasticsearch/elasticsearch:7.10.2"))
    .withExposedPort(9200, 9300) // look for these info in docker-compose.yml
    .withEnv("...", "...")
    .waitingFor(
        new LogMessageWaitStrategy() // we can get the LogMessageWaitStrategy source code and modify it to print the logging messages
            .withRegEx("...")
            .withTimes(1)        // the docker container is said to start completely when we see a logging message matching the above regex this many times
            .withStartupTimeout(Duration.ofMinutes(2)));
```
</div>
<div class="tab" title="Scala">
This is Scala
</div>
<div class="tab" title="Kotlin">
This is Kotlin
</div>
<div class="tab" title="Rust" fontawesome="fa-brands fa-rust">
[Good blogs](https://www.shuttle.rs/blog/tags/all) - [Free public APIs for testing](https://apipheny.io/free-api/) - `rustup doc` - [Practical Rust 1.x Cookbook](https://www.amazon.com/Practical-Rust-1-x-Cookbook-Microservices-ebook/dp/B0BW47FLQ9/) Feb 2023 - [Rust Standard Library Cookbook](https://www.amazon.com/Rust-Standard-Library-Cookbook-leverage-ebook/dp/B07B8RJ8VJ/) Mar 2018 - [All the books](https://1337x.to/torrent/5828661/Rust-Programming-Language-Book-Pack-3-46-titles/)

A [sample](https://github.com/rust-lang/rustlings) project structure. Or [setup Rust for AoC](https://www.youtube.com/watch?v=fEQv-cqzbPg)

[Iggy](https://blog.iggy.rs/posts/building-message-streaming-in-rust/): Kafka-like in Rust (single node for now) - [Fluvio](https://fluvio.io/): also in Rust, production-ready, said to be like Kafka + Flink

[This person](https://medium.com/@omprakashsridharan) wrote blogs about server-side Rust in 2022 - 2023.

Functions `Fn`, `FnMut` and `FnOnce`:
```
let square = |x: i32, y: i32| -> i32 {                // the number of arguments can be 0,
  println!("Calculating square of {x} then add {y}"); //   then the function body can access variables in the scope that has this function (closure)
  x * x + y
}
```

The `collect&lt;B>() -> B` method of the `Iterator` trait to transform an iterator into a collection
  - the most basic pattern: take a collection, call `iter` on it, do a bunch of transformations and then `collect()` at the end:
```
let a = [3, 2, 1];
// no need to specify the type of the vector elements          // or use the turbofish
let double: Vec&lt;_> =                                           let trippled =
    a.iter().map(|&x| x * 2).collect();                            a.iter().map(|&x| x * 3).collect::&lt;Vec&lt;_>>();
```
  - make a string:
```
let chars = ['g', 'd', 'k', 'k', 'n'];
let hello: String = chars.iter().map(|&x| x as u8).map(|x| (x + 1) as char).collect();
```
  - given a list of `Result&lt;T, E>`, check if any of them failed:
```
let results = [Ok(2), Err("a"), Ok(1), Err("b")];              let other_results = [Ok(2), Ok(1)];
// this returns Err("a")                                       // this returns Ok(vec![2, 1])
let result: Result&lt;Vec&lt;_>, &str> =                             let another_result: Result&lt;Vec&lt;_>, &str> =
    results.iter().cloned().collect();                             results.iter().cloned().collect();
```

The `.chain(self, other: U)` method of `Iterator` concatenate 2 iterators. As iterators are lazy, the 2nd iterator can be infinite like `std::iter::repeat(...)` and we'll use the method `std::iter::Iterator::take(self, n: usize)` to limit the number of elements we'll process.

If a function is given the ownership of its arguments and the arguments are immutable, then we can do this to make the argument values mutable like this `fn function(a: *SomeType*) { let mut b = a }`

To modify the value inside a `Box`: `let mut x = Box::new(4); *x = 19`

To sleep: `std::thread::sleep(std::time::Duration::from_secs(1))`

`.iter()`                                                       | `.into_iter()`
----------------------------------------------------------------|-----------------------------------------------------------------------
borrows elements from the collection, create references to them | takes ownership of the collection and moves elements into the iterator
can still use the collection after iterating                    | cannot
read but not modify the elements directly                       | have full ownership of the elements, so can move or modify them
                                                                | used by the `for` loop 

Moving data around in the memory with `std::mem::` (only when the data types don't implement the `Copy` trait)‚à®
  - maybe this is useful for `Box` or our custom `struct`
  - `std::mem::replace&lt;T>(dest: &mut T, src: T) -> T`: move `src` into the referenced `dest`, returns the previous `dest` value. Neither value is dropped.
  - `std::mem::swap&lt;T>(x: &mut T, y: &mut T)`: swap the values at 2 mutable locations (if we want to swap with a default value, use `take`; if we want to swap with a passed value, use `replace`).

String‚à®
  - to split to lines: `std::str::lines() -> Lines&lt;'_>'`
  - `.into_bytes() -> Vec&lt;u8>` takes ownership of the receiver `self` while `.as_bytes() -> &[u8]`
  - To iterate a string:
```
for (i, &item) in String::from("Hello World").as_bytes().iter().enumerate() { // if we need the index of each byte
  if (item == b' ') {
    println!("Found a space");
  } else {
    println!("{}: {}", i, item);
  }
}
for c in "hello world".chars() {                                              // if we only need each character
  println!("{c}");
}
```

Vector‚à®
  - access, push (to the end) and pop (from the end), insert, remove:
```
let mut v: Vec<i32> = vec![1, 5, 2, 4];    // no need of mut if there's no push nor pop
v.push(3);                                 // we need mut even when we modify an element in a vector (e.g. a vector of struct)
let third: &i32 = &v[2];                   // & is used so that we access a reference, not the real one
let third_option: Option&lt;&i32> = v.get(2);
```
  - iterate:
```
for item in v {                             // if there's any issue, consider using &v
  println!("item: {}", item);
}
for (index, item) in v.iter().enumerate() { // iterate and the item index is needed
  println!("index: {}, item: {:?}", index, item);
}
```
  - `.retain(&mut self, f: FnMut(&T) -> bool)`: [retains](https://doc.rust-lang.org/std/vec/struct.Vec.html#method.retain) only the elements specified by the predicate

Struct‚à®
  - define and use:
```
#[derive(Debug)] // so that the struct content can be printed with {:?} in println!
struct User {                      let user = User {
  active: bool,                      active: true,
  username: String,                  username: String::from("user1"),
  sign_in_count: u64,                sign_in_count: 5,
}                                  }
```
  - methods:
```
#[derive(Debug)]
struct Rectangle {                impl Rectangle {
  width: u32,                       fn area(&self, message: &str) -> u32 {
  height: u32,                        println!("Message {} for this rectangle {:?}", str, self);
}                                     self.width * self.height
                                    }

                                    fn square(size: u32) -> Self { // methods without &self become "static" methods
                                      Self {                       // let square = Rectangle::square(4)
                                        width: size,
                                        height: size,
                                      }
                                    }
                                  }
```
  - implement the `Display` trait so that a `struct` can be printed out with `{}`:
```
use std::fmt;                                     impl fmt::Display for Person {
struct Person { name: String, age: u8 }             fn fmt(&self, f: &mut fmt::Formatter&lt;'_>) -> fmt::Result {
                                                      write!(f, "used as with println!")
                                                    }
                                                  }
```

Enum‚à®
  - define and use:
```
  enum IpAddrKind {               let four = IpAddrKind::V4;
    V4,                           let six  = IpAddrKind::V6;
    V6,
  }
```
  - think twice before putting `enum` in a `struct` as we can do this:
```
  enum IpAddr {                                                   enum Color {                enum Message {
    V4(u8, u8, u8, u8),                                             Rgb(i32, i32, i32),         Quit,
    V6(String),                                                     Hsv(i32, i32, i32),         Stop,
  }                                                               }                             Move { x: i8, y: i8 },
  let home     = IpAddr::V4(127, 0, 0, 1);                                                      ChangeColor(Color),
  let loopback = IpAddr::V6(String::from("::1"));                                             }
```
  - using `match` with `enum`:
```
let message1 = Message::Move { x: 3, y: 4 };
let message2 = Message::ChangeColor(Color::Rgb(5, 6, 7));

match message {
  Message::Quit | Message::Stop              => println!("Quitting"), // match one or several values
  Message::Move { x, y } if x > 99 && y > 99 => println!("Moving to far"),
  Message::Move { x, y }                     => {
    println!("Moving to ({}, {})", x, y)                              // if a block { } is used, no need of a comma after that block
  }
  Message::ChangeColor(Color::Rgb(r, g, b))  => println!("Changing color to RGB: ({}, {}, {})", r, g, b),
  Message::ChangeColor(Color::Hsv(h, s, v))  => println!("Changing color to HSV: ({}, {}, {})", h, s, v),
}
```
  - using `if let` if we want to do something with only 1 enum value and optionally do something else with all other enum values:
```
let my_message = Message::Move { x = 4, y = 19 };
match message {                                                                       if let Message::Move { x, y } = my_message {
  my_message => println!("Moving to ({my_message.x}, {my_message.y})"),                 println!("Moving to ({x}, {y})");
  _          => println!("Not moving")                                                } else {
}                                                                                       println!("Not moving");
                                                                                      }
```
  - using `while let`:
```
while let *some_enum_variable* = *an_enum_value* {               while let Some(...) = *an_enum_value* {
  // need to change the an_enum_value here                     // access the ... and modify the an_enum_value
}                                                            }
``` 
  - `enum std::result::Result&lt;T, E&gt; { Ok(T), Err(E) }`
    - `.unwrap()` or `.expect(&str)`: panic with the error E message or our custom message
    - `.unwrap_or(default: T) -> T` `.unwrap_or_else&lt;F>(op: FnOnce(E) -> T) -> T`: if error, return a default value
    - propagating errors: inside our function which returns `Result&lt;T, E>`, whenever we have a `Result&lt;U, E>` we can put `?` after it to get `U`
  - `enum std::option::Option&lt;T> { None, Some(T) }`
    - `*my_option*.unwrap(self) -> T` means that `*my_option*` is moved and cannot be used after this command. To use `*my_option*` again, we need `*my_option*.as_ref().unwrap()` or `*my_option*.as_mut().unwrap()`
    - `.as_mut(&mut self) -> Option&lt;&mut T>` is used when we want to modify the value inside the `Option` or `.as_ref()` to access the option content. Otherwise, the `option` cannot be used after that.
    - [This](https://leetcode.com/problems/remove-duplicates-from-sorted-list/solutions/344741/my-idiomatic-solution-rust/) is a very good example of manipulating options.
    - `Option&lt;i8 | u8 | i16 |...&gt;` can be compared to each others

Trait‚à®
  - define and implement:
```
trait Summary {                                                        impl Summary for NewsArticle {
  // we can have default implementations for methods in trait
  fn summarize(&self) -> String;                                         fn summarize(&self) -> String {
}                                                                          // format! is a way to concatenate strings
struct NewsArticle {                                                       format!("{} then {}", self.author, self.content)
  author: String,                                                        }
  content: String,                                                     }
}
```
  - extends: `trait MyTrait: YourTrait { ... }`
  - passing traits as paramaters:
```
fn notify(item: &(impl Summary + Display)) { ... }                     fn notify&lt;T: Summary + Display>(item: &T) { ... }
```
  - returning types that implement traits: `fn return_summarizable() -> impl Summary { ... }`
</div>
<div class="tab" title="Python" fontawesome="fa-brands fa-python">
Start an http server in the current directory at a specific port: `python -m http.server 8000`
</div>
<div class="tab" title="Gradle">
[Using maven BOM](https://docs.gradle.org/current/userguide/platforms.html#sub:bom_import) in `gradle.build`

All the versions (including release candidates) are [here](https://services.gradle.org/distributions/); system properties in [gradle.properties](https://docs.gradle.org/current/userguide/build_environment.html) e.g. to run gradle and compile the app with different jdks

To exclude a library globally:

```
configurations {
  all*.exclude group: 'ch.qos.reload4j', module: 'reload4j'
  all*.exclude group: 'org.slf4j', module: 'slf4j-reload4j'
}
```
</div>
<div class="tab" title="Git" fontawesome="fa-brands fa-git">
Delete local branch: `git branch -d *local_branch_name*`

Delete remote branch: `git push origin --delete *remote_branch_name*`

Update the local list of remote branches: `git remote update origin --prune`

Merge from another branch: `git pull && git merge --squash origin/master`     If conflict: `git merge --abort`

Make git ignore SSL verification: `export GIT_SSL_NO_VERIFY=true`

Overwrite the current local branch with the remote master: `git fetch --all && git reset --hard origin/master`

Make a file executable (so that when it is checked out, it's executable):
```
git add file.sh && git ls-files --stage // that file will have 100644
git update-index --chmod=+x file.sh && git ls-files --stage // that file will have 100755
git commit -m "..." && git push
```

Show info about a commit id (e.g. date, ...): `git show *commit-id*`

Automatically create a remote branch for the current local branch: `git config --global push.autoSetupRemote true`

Use proxy: `git config --global http.proxy http://1.2.3.4:8080` (this works for both http and https repositories). To not use proxy: `git config --global --unset http.proxy`

Use a non-default private key with git (recent versions only): `$env:GIT_SSH_COMMAND='ssh -i non-default-private-key -o IdentitiesOnly=yes'`
</div>
<div class="tab" title="VS Code">
| Windows                                               |                           | Mac                                                     |
|------------------------------------------------------:|:-------------------------:|:--------------------------------------------------------|
|<kbd>Alt</kbd>+ click                                  | multiple cursor           |<kbd>option</kbd>+ click                                 |
|<kbd>‚áß</kbd>+<kbd>Alt</kbd>+<kbd>&#8593;/&#8595;</kbd> | copy line up/down         |<kbd>‚áß</kbd>+<kbd>option</kbd>+<kbd>&#8593;/&#8595;</kbd>|
|<kbd>Alt</kbd>+<kbd>&#8593;/&#8595;</kbd>              | move line up/down         |<kbd>option</kbd>+<kbd>&#8593;/&#8595;</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>K</kbd>              | delete line               |<kbd>‚áß</kbd>+<kbd>command</kbd>+<kbd>K</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>\</kbd>              | jump to mactching bracket |<kbd>‚áß</kbd>+<kbd>command</kbd>+<kbd>\</kbd>             |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>[</kbd>              | fold region               |<kbd>option</kbd>+<kbd>command</kbd>+<kbd>[</kbd>        |
|<kbd>‚áß</kbd>+<kbd>Ctrl</kbd>+<kbd>]</kbd>              | unfold region             |<kbd>option</kbd>+<kbd>command</kbd>+<kbd>]</kbd>        |
</div>
<div class="tab" title="PowerShell - Windows" fontawesome="fa-brands fa-windows">
[Upgrade Windows 11 Home to Pro](https://www.youtube.com/watch?v=2FHn2GzIZrc): disconnect Internet, `Settings` | `System` | `Activation` | `Change Product Key`, use this generic key `VK7JG-NPHTM-C97JM-9MPGT-3V66T`. Finally run [this](https://github.com/massgravel/Microsoft-Activation-Scripts) in powershell `irm https://massgrave.dev/get | iex`

Install a `.msi` file: in cmd `msiexec.exe /i *file.msi* INSTALLDIR=%USERPROFILE%\*some-directory* MSIINSTALLPERUSER=1`

Install python, pip in Windows: unzip the python, install pip with `python get-pip.py` here is [get-pip.py](https://bootstrap.pypa.io/get-pip.py), then modify the file `python312._pth` like this:
```
python312.zip
.
Lib\site-packages
```

| Windows Terminal | ...                                                                        | ...
|------------------|----------------------------------------------------------------------------|------------------------------------------
|                  | <kbd>Alt</kbd>+<kbd>Shft</kbd>+<kbd>-/+</kbd>                              | create a new pane vertically/horizontally
|                  | <kbd>Ctrl</kbd>+<kbd>Shft</kbd>+<kbd>W</kbd>                               | close
|                  | <kbd>Alt</kbd>+<kbd>&#x2190;&#x2191;&#x2193;&#x2192;</kbd>                 | move around
|                  | <kbd>Alt</kbd>+<kbd>Shft</kbd>+<kbd>&#x2190;&#x2191;&#x2193;&#x2192;</kbd> | resize
|                  | The cursor doesn't blink                                                   | try this `printf "\e[?12h"`

PowerShell‚à®
  - Allow scripts to run in PowerShell: `Set-ExecutionPolicy Bypass -Scope Process`
  - Change window title: `$host.ui.RawUI.WindowTitle="*New Title*"`
  - Set an environment variable: `$env:PATH += "..."` or `$env:PATH = "...;$env:PATH"` for example `$env:HTTPS_PROXY=$env:HTTP_PROXY='http://1.2.3.4:8080'`. To show all env vars: `dir env:`
  - Run a PowerShell script in background: `start-job -filepath *path\to\file.ps1*`
  - Download with wget: `Invoke-WebRequest -Uri $*uri* -OutFile $*dest*`
  - To run an app with Avecto: `PowerShell Start 'D:\Users\DangTh\PowerShell\pwsh.exe' -Verb Runas`
  - Add something to MS Defender exclusion list: `Add-MpPreference -ExclusionPath 'C:\temp'`, `Add-MpPreference -ExclusionExtension '.java'`. To see those exclusions: Settings | Virus & thread protection (Manage settings) | Exclusions (Add or remove exclusions)

Uninstall some apps from cmd (run cmd as Admin) or PowerShell‚à®
  - `wmic // the prompt turns into wmic:root\cli>`
  - `product get name // get all un-installable program names`
  - `product where name="*program name*" call uninstall`
  - `Get-ProvisionedAppxPackage -Online | Where-Object { $_.PackageName -match "xbox" } | ForEach-Object { Remove-ProvisionedAppxPackage -Online -AllUsers -PackageName $_.PackageName }`

Firefox‚à®
  - [Firefox zip format](https://ftp.mozilla.org/pub/firefox/candidates/)
  - Delete the Firefox under Mozilla in registry (this has corporate-set keys to forbid Firefox extension installation): `reg delete HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Mozilla\Firefox /f`
  - [Delete 1 property](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/remove-itemproperty) in the registry: `Remove-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Mozilla\Firefox" -Name "ExtensionSettings" -Force`
  - Clean up Firefox: `rm -rf AppData/Local/Mozilla AppData/Roaming/Mozilla`
</div>
<div class="tab" title="Jenkins">
To list files: `http https://artifacts.devops.bfsaws.net/artifactory/GPTM-TEST-DEV/DF-Query/ X-JFrog-Art-Api:xxx | grep -e "-2022 " -e "-Jan-2023 " | sed 's/^.*DFQueryService/abc DFQueryService/g' | sed 's/^.*//g'`

To delete: `http DELETE https://artifacts.devops.bfsaws.net/artifactory/GPTM-TEST-DEV/DF-Query/*file.ext* X-JFrog-Art-Api:xxx` __Note__: this can be done with a folder too

Search in Jira: `project = gptmcr and assignee in (..., ...) order by key desc, assignee asc`

Declarative pipeline:
```
pipeline {
  agent { label 'aws_set2_node1 || aws_set1_node1 || aws_set1_node2' }
  options {
    timeout(time: 100, unit: 'SECONDS')
  }
  environment {
    SA_GPTM_CI = credentials('sa-gptm-ci')
  }
  stages {
    stage('...') {
      steps {
        sh '''
          echo "" >> ~/.ssh/authorized_keys.jenkins
          echo "ssh-ed25519 ..." >> ~/.ssh/authorized_keys.jenkins
        '''
      }
    }
  }
  post {
    always{
      cleanWs()
    }
  }
}
```
</div>
<div class="tab" title="Terraform">
DevOps: to make software delivery better - Terraform: Infrastructure as Code to define, deploy, update and destroy the infrastructure

Versions: 1.1.* (Dec 21 - Apr 22). Now 1.6.*

`terraform apply`
</div>
<div class="tab" title="B√°nh Flan Caramel" fontawesome="fa-solid fa-cake-candles">
[9 eggs, 1 cup of sugar, 320 ml of milk (not non-fat), vanilla powder](https://www.youtube.com/watch?v=F4WSf2YCstA) 1 cup = 125ml

In a non-stick pan: .5 cup of sugar, 1 spoon of water (just enough to make the sugar wet), cook medium heat until the sugar turns into caramel, quickly remove it.

.5 cup of sugar + 2.5 cups of milk, cook until it's hot but not boiling.

Whisk 9 eggs in a bowl. Pour the hot/warm milk into it while whisking. Put a bit vanilla there. Pour it out through a strainer. Remove all the bubbles. Cool it down for 10 mins.

Preheat the oven to 350oF, pour the boiling water in a large pan, bake for 45 mins.
</div>
<div class="tab" title="Finance Knowledge" fontawesome="fa-solid fa-piggy-bank">
[Underlying asset](https://www.investopedia.com/terms/u/underlying-asset.asp) are the financial assets upon which a derivative's price is based.

[Derivative](https://www.investopedia.com/terms/d/derivative.asp): a financial contract with a price that depends on underlying asset or group of assets. A derivative is set between 2 or more parties that can trade on an exchange. For example: options

[Option](https://www.investopedia.com/terms/o/option.asp): a financial instrument that is based on the value of underlying securities such as stocks, indexes and ETFs (exchange traded funds)

[Investment securities](https://www.investopedia.com/terms/i/investment-securities.asp): a category of securities. They are tradable assets such as equities or fixed income instruments. They are purchased with the intention of holding them for investment.

[Equity](https://www.investopedia.com/terms/e/equity.asp): the amount of money that would be returned to a shareholder if all the assets are liquidated and all the debts are paid off.

[Fixed income](https://www.investopedia.com/terms/f/fixedincome.asp): a type of assets and securities that pay investors a fixed interest or dividends. For example: government and corporate bonds.

[Capital Markets](https://www.investopedia.com/terms/c/capitalmarkets.asp): where savings and investments are channeled between suppliers (e.g. banks, investors) and those in need (e.g. businesses, governments). The most common capital markets are the stock market and the bond market.
</div>
<script>
  /*
   * s is a line in <code>...</code>
   * `&amp;amp;` will be replaced with `&amp;`
   * the `// till the end of the line` will be put in a <i class="comment">// till the end of the line</i>
   * the `*something here*` will be put in `<i>something here</i>`
   * Return the new line.
   */
  function fixAmpersandAndMakeComment(s) {
    let startPosition = 0;
    while (true) { // TODO needs unit tests
      s = s.replaceAll('&amp;amp;', '&amp;');
      let i = s.indexOf('*', startPosition);
      if (i < 0) break;

      if (s.substring(i + 1, i + 2) !== ' ' && s.substring(i + 1, i + 2) != '.' && s.substring(i - 1, i) != '.') {
        let j = s.indexOf('*', i + 1);
        if (j > i && s.substring(j - 1, j) !== ' ') {
          s = s.substring(0, i) + `<i>${s.substring(i + 1, j)}</i>` + s.substring(j + 1);
          startPosition = j + 1;
        } else {
          startPosition = i + 1;
        }
      } else  {
        startPosition = i + 1;
      }
    }

    let i = s.indexOf('// ');
    if (i >= 0) {
      return s.substring(0, i) + `<i class="comment">${s.substring(i)}</i>`;
    }

    return s;
  }

  /*
   * If `<...>` is used in <code>, the browser thinks that it's a tag. So we have to write `&lt;...>`.
   * But then, showdown converts them to `&amp;lt;` and `&amp;gt;`.
   * This method replaces `&amp;lt;` with `&lt;` and `&amp;gt;` with `&gt;`.
   */
  function fixLessGreaterThan(s) {
    return s.replaceAll('&amp;lt;', '&lt;').replaceAll('&amp;gt;', '&gt;');
  }

  const converter = new showdown.Converter({tables: true, literalMidWordUnderscores: true, strikethrough: true});
  let i = 1; // used to create the id for each accordion item

  const allAccordionItemHtmls = Array.from(document.querySelectorAll('div.tab'))
    .map(div => {
      const accordionItem = `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
            <i class="${div.getAttribute('fontawesome')}"></i>${div.getAttribute('title')}
          </button>
        </h2>
        <div id="collapse${i}" class="accordion-collapse collapse">
          <div class="accordion-body">${converter.makeHtml(div.innerHTML)}</div>
        </div>
      </div>
      `;
      div.parentElement.removeChild(div);
      i += 1;
      return accordionItem;
    })
    .join('\n');
  document.body.insertAdjacentHTML('afterbegin', `<div class="accordion accordion-flush" id="myAccordionNotes">${allAccordionItemHtmls}</div>`);

  // add <i> inside <code></code>
  document.querySelectorAll('code').forEach(code => {
    const newInnerHtml = code.innerHTML.split('\n')
      .map(line => fixAmpersandAndMakeComment(line))
      .map(line => fixLessGreaterThan(line))
      .join('\n');
    code.innerHTML = newInnerHtml;
  });

  // move <pre> inside the above <li> if <li> ends with `:`
  Array.from(document.querySelectorAll('li:last-child'))
    .filter(li => li.innerText.endsWith(':'))
    .forEach(li => {
      const ul = li.parentElement;
      const pre = ul.nextElementSibling;
      if (pre != null && pre.nodeName == 'PRE') {
        pre.style.marginTop = '.2em';
        li.innerHTML += pre.outerHTML;
        pre.parentElement.removeChild(pre);
      }
    });

  // if <p> is followed by an <ul> which is followed by another <ul>, merge these <ul> together
  document.querySelectorAll('p + ul + ul')
    .forEach(ul => {
      const firstUl = ul.previousElementSibling;
      while (ul) {
        let nextUl = ul.nextElementSibling;
        firstUl.insertAdjacentHTML('beforeend', ul.innerHTML);
        ul.parentElement.removeChild(ul);
        if (nextUl && nextUl.localName != 'ul') nextUl = null;
        ul = nextUl;
      }
    });

  // make <p> ending with a `‚à®` and followed by <ul> an accordion
/* TODO this function is not used?
  function removePTag(markdown) { // calls converter.makeHtml which returns <p>...</p> then removes <p> and fixes the < or >
    console.log('markdown', markdown);
    return converter.makeHtml(markdown).replace('<p>', '').replace('</p>', '').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
  }
*/
  Array.from(document.querySelectorAll('p + ul'))
    .filter(ul => ul.previousElementSibling.innerText.endsWith('‚à®'))
    .forEach(ul => {
      const p = ul.previousElementSibling;
      p.insertAdjacentHTML('beforebegin', `
        <div class="accordion accordion-flush">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
                ${p.innerHTML.substring(0, p.innerHTML.length - 1)}
              </button>
            </h2>
            <div id="collapse${i}" class="accordion-collapse collapse">${ul.outerHTML}</div>
          </div>
        </div>
      `);
      p.parentElement.removeChild(p);
      ul.parentElement.removeChild(ul);
      i += 1;
    });

  // make <p> ending with a `‚à®` and followed by a <table> which is followed by an <ul> an accordion
    Array.from(document.querySelectorAll('p + table + ul'))
      .filter(ul => ul.previousElementSibling.previousElementSibling.innerText.endsWith('‚à®'))
      .forEach(ul => {
        const table = ul.previousElementSibling;
        const p = table.previousElementSibling;
        p.insertAdjacentHTML('beforebegin', `
          <div class="accordion accordion-flush">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}" aria-expanded="false" aria-controls="collapse${i}">
                  ${p.innerHTML.substring(0, p.innerHTML.length - 1)}
                </button>
              </h2>
              <div id="collapse${i}" class="accordion-collapse collapse">
                ${table.outerHTML}
                ${ul.outerHTML}
              </div>
            </div>
          </div>
        `);
        p.parentElement.removeChild(p);
        table.parentElement.removeChild(table);
        ul.parentElement.removeChild(ul);
        i += 1;
      });

  // if <p> endings with `:` and followed by <ul> or <pre>, make them close to each other
  Array.from(document.querySelectorAll('p + ul, p + pre'))
    .filter(ulORpre => ulORpre.previousElementSibling.innerText.endsWith(':'))
    .forEach(ulORpre => ulORpre.previousElementSibling.style.marginBottom = '.2rem');

  // add bootstrap `table` class to all <table>
  document.querySelectorAll('table').forEach(table => table.classList.add('table'));

  // this is used to increase the font size of kbd in vim motions
  document.querySelectorAll('th').forEach(th => {
    if (th.innerText === 'vim motions') {
      th.parentElement.parentElement.parentElement.classList.add('vim-motions');
    }
  });
</script>
<div class="accordion accordion-flush">
  <style>
    .pro-jpa-2 { margin: .5rem }
    .pro-jpa-2 a { text-decoration: none }
    .pro-jpa-2 p.ChapterNumber, .pro-jpa-2 p.ChapterTitle { font: 1.6rem "Noto Sans", sans-serif }
    .pro-jpa-2 span.FontName2 { font-family: "Fira Code", monospace }
    .pro-jpa-2 p.Heading1 { font: 1.4rem sans-serif; color: #13c69d }
    .pro-jpa-2 pre { background: linear-gradient(90deg, #eef2f6, #fff, #eef2f6); padding: .5rem 1rem }
    .pro-jpa-2 p.Heading2 { font: 1.2rem sans-serif; color: #9f1ad8 }
    .pro-jpa-2 p.Heading3 { font: 1rem sans-serif; color: #f62 }
    .pro-jpa-2 div.notepara { margin-left: 4rem; border-left: .3rem solid #5cd81a; padding-left: 1rem }
    .pro-jpa-2 td { vertical-align: top; padding-left: 1rem }
  </style>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#jpa-collection-mapping" aria-expanded="false" aria-controls="jpa-collection-mapping">
        JPA - Collection Mapping (from the book Pro JPA 2, 2nd Edition)
      </button>
    </h2>
    <div id="jpa-collection-mapping" class="accordion-collapse collapse pro-jpa-2">
      <p class="ChapterNumber"><a id="Chap_5" target="_blank" rel="noopener noreferrer"></a>CHAPTER 5</p>
      <p class="chapimage"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/frontdot.jpg" alt="image" width="82" height="25"></p>
      <p class="ChapterTitle">Collection Mapping</p>
      <div>
        <p class="noindent">Sometimes a <span class="FontName2">Collection</span> is used like a milk crate: it‚Äôs just a simple container with no apparent order or intended organization. Other cases demand some kind of system of order and arranging so the way objects are retrieved from the collection has meaning. Whether the collection is of the first type or the second, collections of objects require more effort to map than single objects, although in compensation they offer greater flexibility.</p>
        <p class="indent">In the last chapter, we began the journey of mapping collection-valued relationships, spooning out only the basics of mapping collections of entities to the database. This chapter goes into more detail about how we can map more sophisticated collection types, such as persistently ordered <span class="FontName2">Lists</span><a id="cXXX.231a" target="_blank" rel="noopener noreferrer"></a>, and <span class="FontName2">Maps</span> with keys and values that are of various object types. We will even explore how to map collections of objects that are not entities.</p>
        <p id="Sec1" class="Heading1">Relationships and Element Collections<a id="cXXX.227a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">When we speak of mapping collections, there are actually three kinds of objects that we can store in mapped collections. We can map collections of entities, embeddables, or basic types, and each one requires a certain level of understanding to be correctly mapped and efficiently used.</p>
        <p class="indent">We should clarify one potential point of confusion about these types of objects when they are stored in collections. In the previous chapter, we introduced the concept of relationships from one entity type to another, and you learned that when the source entity has a collection containing instances of the target entity type it is called a multivalued relationship. However, collections of embeddable and basic types are not relationships; they are simply collections of elements that are thus called element collections. Relationships define associations between independent entities, whereas element collections contain objects that are dependent upon the referencing entity, and can be retrieved only through the entity that contains them.</p>
        <p class="indent">A practical difference between relationships and element collections is the annotation that is used to denote them. A relationship minimally requires the relationship annotation, either <span class="FontName2">&#64;OneToMany</span> or <span class="FontName2">&#64;ManyToMany</span>, whereas an element collection is indicated by the <span class="FontName2">&#64;ElementCollection</span> annotation. Assuming the <span class="FontName2">VacationEntry</span> embeddable class in <a href="#list1" id="_list1" target="_blank" rel="noopener noreferrer">Listing 5-1</a>, <a href="#list2" id="_list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> shows an example of an element collection of embeddables in the <span class="FontName2">vacationBookings</span> attribute, as well as an element collection of basic types (<span class="FontName2">String</span>) in the <span class="FontName2">nickNames</span> attribute.</p>
        <table>
          <tr>
            <td>
              <p class="noindent2"><a href="#_list1" id="list1" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-1</i></b></a>.&nbsp;&nbsp;VacationEntry Embeddable<a id="cXXX.226" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class VacationEntry {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Calendar startDate;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DAYS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int daysTaken;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <p class="noindent2"><a href="#_list2" id="list2" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-2</i></b></a>.&nbsp;&nbsp;Element Collections of Embeddables and Basic Types<a id="cXXX.227" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=VacationEntry.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection vacationBookings;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Set&lt;String&gt; nickNames;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <div class="Figure" id="Fig1">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-01.jpg" alt="9781430249269_Fig05-01.jpg" width="502" height="285"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig1" target="_blank" rel="noopener noreferrer">Figure 5-1</a>. </span>EMPLOYEE entity table<a id="cXXX.238" target="_blank" rel="noopener noreferrer"></a> and mapped collection tables</p>
              </div>
            </td>
          </tr>
        </table>
        <p class="indent">You can see from <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> that, like the relationship annotations, the <span class="FontName2">&#64;ElementCollection</span> annotation includes a <span class="FontName2">targetClass</span> element that is used to specify the class if the <span class="FontName2">Collection</span> does not define the type of element contained in it. It also includes a <span class="FontName2">fetch</span> element to indicate whether the collection should be lazily loaded.</p>
        <p class="indent">A more interesting aspect of the mappings in <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a> is the absence of any additional metadata. Recall that the elements that are being stored in the collections are not entities, so they do not have any mapped table. Embeddables are supposed to be stored in the same table as the entity that refers to them, but if there is a collection of embeddables, how would it be possible to store a multiplicity of like-mapped objects in a single row? Similarly for basic types, we could not map each nickname <span class="FontName2">String</span> to a column in the <span class="FontName2">EMPLOYEE</span> table and expect to store multiple strings in a single row. For this reason, element collections require a separate table called a collection table. Every collection table must have a join column that refers to the containing entity table. Additional columns in the collection table are used to map the attributes of the embeddable element, or the basic element state if the element is of a basic type.</p>
        <p class="indent">We can specify a collection table using a <span class="FontName2">&#64;CollectionTable</span> annotation, which allows us to designate the name of the table, as well as the join column. Default values will apply if the annotation or specific elements within that annotation are not specified. The table name will default to the name of the referencing entity, appended with an underscore and the name of the entity attribute that contains the element collection. The join column default is similarly the name of the referencing entity, appended with an underscore and the name of the primary key column of the entity table. Because no collection tables were specified in either of the element collections in the <span class="FontName2">vacationBookings</span> and <span class="FontName2">nickNames</span> attributes of the <span class="FontName2">Employee</span> entity defined in <a href="#list2" target="_blank" rel="noopener noreferrer">Listing 5-2</a>, they are defaulted to use collection tables named <span class="FontName2">EMPLOYEE_VACATIONBOOKINGS</span> and <span class="FontName2">EMPLOYEE_NICKNAMES</span>, respectively. The join column in each of the collection tables will be <span class="FontName2">EMPLOYEE_ID</span>, which is just the name of the entity combined with the mapped <span class="FontName2">Employee</span> primary key column.</p>
        <p class="indent">We map the fields or properties of the embeddable type to the columns in the collection table instead of to the primary table of the entity, with the usual column name defaulting rules applying. When the element collection contains basic types, the values are also stored in a column in the collection table, with the default column name being the name of the entity attribute. Applying this rule, the nicknames would be stored in the <span class="FontName2">NICKNAMES</span> column. After all the defaults are applied, the mapped tables would look like those in <a href="#Fig1" id="_Fig1" target="_blank" rel="noopener noreferrer">Figure 5-1</a> above.</p>
        <p class="indent">When we first discussed embeddables, you saw how the attributes were mapped within the embeddable object but could be overridden when embedded inside other entities or embeddables. We used the <span class="FontName2">&#64;AttributeOverride</span> annotation to override the column names. The same annotation can also be used to override the embedded attributes in the elements of an element collection. In <a href="#list3" id="_list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a>, the <span class="FontName2">daysTaken</span> attribute is being remapped, using <span class="FontName2">&#64;AttributeOverride</span>, from being stored in the <span class="FontName2">DAYS</span> column to being stored in the <span class="FontName2">DAYS_ABS</span> column. One important difference between using <span class="FontName2">&#64;AttributeOverride</span> on simple embedded mappings and using it to override the columns of embeddables in an element collection is that in the latter case the column specified by <span class="FontName2">&#64;AttributeOverride</span> actually applies to the collection table, not to the entity table.</p>
        <table>
          <tr>
            <td>
              <p class="noindent2"><a href="#_list3" id="list3" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-3</i></b></a>.&nbsp;&nbsp;Overriding Collection Table Columns<a id="cXXX.229" target="_blank" rel="noopener noreferrer"></a></p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=VacationEntry.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="VACATION",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="daysTaken",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="DAYS_ABS"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection vacationBookings;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="NICKNAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Set&lt;String&gt; nickNames;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </td>
            <td>
              <p class="indent">In order to override the name of the column in which the nicknames are stored, we can use the <span class="FontName2">&#64;Column</span> annotation, remembering again that the name specifies a column in the collection table, not the entity table. <a href="#Fig2" id="_Fig2" target="_blank" rel="noopener noreferrer">Figure 5-2</a> shows the mapped tables, including the overridden <span class="FontName2">VACATION</span> collection table mapped by the <span class="FontName2">vacationBookings</span> collection.</p>
              <div class="Figure" id="Fig2">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-02.jpg" alt="9781430249269_Fig05-02.jpg" width="452" height="310"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig2" target="_blank" rel="noopener noreferrer">Figure 5-2</a>. </span>EMPLOYEE entity table and mapped collection tables with overrides</p>
              </div>
            </td>
          </tr>
        </table>
        <p id="Sec2" class="Heading1">Using Different Collection Types</p>
        <p class="noindent">We can use different types of collections to store multivalued entity associations and collections of objects. Depending upon the needs of the application, any of <span class="FontName2">Collection</span>, <span class="FontName2">Set</span>, <span class="FontName2">List</span>, and <span class="FontName2">Map</span> might be appropriate. There are rules corresponding to the type of collection, however, that guide its usage, so before using a given collection type, you should be familiar with the rules that govern how that type can be mapped and manipulated.</p>
        <p class="indent">The first step is to define the collection to be any one of the interface types mentioned previously. You then initialize the attribute with a concrete implementation class. This can be done in a constructor or initialization method of the entity class and allows you to put objects in the implementation collection of a new or unpersisted entity. Once the entity becomes managed or has been persisted by means of an <span class="FontName2">EntityManager.persist()</span> call, the interface must always be used when operating on the collection, whether it has been read in from the database or has been detached from the entity manager. This is because the moment the entity becomes managed, the persistence provider can replace the initial concrete instance with an alternate instance of a <span class="FontName2">Collection</span> implementation class of its own.</p>
        <div>
          <p id="Sec3" class="Heading2">Sets or Collections<a id="cXXX.230" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The most common collection type used in associations is the standard <span class="FontName2">Collection</span> superinterface. This is used when it doesn‚Äôt matter which implementation is underneath and when the common <span class="FontName2">Collection</span> methods are all that is required to access the entities stored in it.</p>
          <p class="indent">A <span class="FontName2">Set</span> will prevent duplicate elements from being inserted and might be a simpler and more concise collection model, while a vanilla <span class="FontName2">Collection</span> interface is the most generic. Neither of these interfaces requires additional annotations beyond the original mapping annotation to further specify them. They are used the same way as if they held non-persistent objects. An example of using a <span class="FontName2">Set</span> interface for an element collection and a <span class="FontName2">Collection</span> for another is in <a href="#list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a>.</p>
        </div>
        <div>
          <p id="Sec4" class="Heading2">Lists</p>
          <p class="noindent">Another common collection type is the <span class="FontName2">List</span>. A <span class="FontName2">List</span> is typically used when the entities or elements are to be retrieved in some user-defined order. Because the notion of row order in the database is not commonly defined, the task of determining the ordering must lie with the application.</p>
          <p class="indent">There are two ways to determine the order of the <span class="FontName2">List</span>. The first is to map it so that it is ordered according to state that exists in each entity or element in the List. This is the easiest method and is less intrusive on the data model. The second involves maintaining the order of the <span class="FontName2">List</span> in an additional database column. It is more Java-friendly in that it supports the traditional ordering semantics of a Java <span class="FontName2">List</span>, but can be far less performant, as you will see in the following sections.</p>
          <div>
            <p id="Sec5" class="Heading3">Ordering By Entity or Element Attribute</p>
            <p class="noindent"><a id="cXXX.231" target="_blank" rel="noopener noreferrer"></a>The most prevalent approach to ordering entities or elements in a <span class="FontName2">List</span> is to specify an ordering rule based on the comparison of a particular attribute of the entity or element. If the <span class="FontName2">List</span> is a relationship, the attribute is most often the primary key of the target entity.</p>
            <p class="indent">We indicate the attribute to order by in the <span class="FontName2">&#64;OrderBy</span> annotation. The value of the annotation is a string that contains one or more comma-separated fields or properties of the object being ordered. Each of the attributes can be optionally followed by an <span class="FontName2">ASC</span> or <span class="FontName2">DESC</span> keyword to define whether the attribute should be ordered in ascending or descending order. If the direction is not specified, the property will be ordered in ascending order.</p>
            <p class="indent">If the <span class="FontName2">List</span> is a relationship and references entities, specifying <span class="FontName2">&#64;OrderBy</span> with no fields or properties, or not specifying it at all, will cause the <span class="FontName2">List</span> to be ordered by the primary keys of the entities in the <span class="FontName2">List</span>. In the case of an element collection of basic types, then the <span class="FontName2">List</span> will be ordered by the values of the elements. Element collections of embeddable types will result in the <span class="FontName2">List</span> being defaulted to be in some undefined order, typically in the order returned by the database in the absence of any <span class="FontName2">ORDER BY</span> clause.</p>
            <p class="indent">The example back in <a href="#list20" target="_blank" rel="noopener noreferrer">Listing 4-20</a> of the previous chapter had a one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span>. If we want the employees to be in a particular order, we can use a <span class="FontName2">List</span> instead of a <span class="FontName2">Collection</span>. By adding an <span class="FontName2">&#64;OrderBy</span> annotation on the mapping, we can indicate that we want the employees to be ordered in ascending alphabetical order by name. <a href="#list4" id="_list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a> shows the updated example.</p>
            <p class="noindent2"><a href="#_list4" id="list4" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-4</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a List</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OrderBy("name ASC")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">We needn‚Äôt have included the <span class="FontName2">ASC</span> in the <span class="FontName2">&#64;OrderBy</span> annotations because it would be ascending by default, but it is good style to include it.</p>
            <p class="indent">We could have just as easily ordered the employee <span class="FontName2">List</span> by an embedded field of <span class="FontName2">Employee</span>. For example, if <span class="FontName2">name</span> had been embedded in an embedded <span class="FontName2">Employee</span> field called <span class="FontName2">info</span> that was of embeddable type <span class="FontName2">EmployeeInfo</span>, we would write the annotation as <span class="FontName2">&#64;OrderBy("info.name ASC")</span>.</p>
            <p class="indent">We might also want to have suborderings using multiple attributes. We can do that by specifying comma-separated &lt;attribute name <span class="FontName2">ASC</span>/<span class="FontName2">DESC</span>&gt; pairs in the annotation. For example, if <span class="FontName2">Employee</span> had a <span class="FontName2">status</span>, we might have ordered by status and then by name by using an <span class="FontName2">&#64;OrderBy</span> annotation of <span class="FontName2">&#64;OrderBy("status DESC, name ASC")</span>. Of course, the prerequisite for using an attribute in an <span class="FontName2">&#64;OrderBy</span> annotation is that the attribute type should be comparable, meaning that it supports comparison operators.</p>
            <p class="indent">If you were to simply switch the order of two employees in the <span class="FontName2">List</span>, it might appear that they were assuming new positions in the <span class="FontName2">List</span>. However, if in a new persistence context you read the department back in again and accessed its employees the <span class="FontName2">List</span> would come back in the order that it was in before you manipulated it<a id="_Fn1" href="#Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a>. This is because the <span class="FontName2">List</span> order is based upon the collation order asserted by the <span class="FontName2">&#64;OrderBy</span> annotation. Simply changing the order of the items in a <span class="FontName2">List</span> in memory will not cause that order to be stored in the database at commit time. In fact, the order specified in <span class="FontName2">&#64;OrderBy</span> will be used only when reading the <span class="FontName2">List</span> back into memory. As a rule of thumb, the <span class="FontName2">List</span> order should always be maintained in memory to be consistent with the <span class="FontName2">&#64;OrderBy</span> ordering rules.</p>
          </div>
          <div>
            <p id="Sec6" class="Heading3">Persistently Ordered Lists<a id="cXXX.232" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Another example that calls for the order provided by <span class="FontName2">List</span> is a print queue that keeps a list of the print jobs that are queued up at any given time. The <span class="FontName2">PrintQueue</span> is essentially a First In First Out (FIFO)<a id="cXXX.233" target="_blank" rel="noopener noreferrer"></a> queue that, when the printer is available, takes the next <span class="FontName2">PrintJob</span> from the front of the queue and sends it to the printer for printing. Assuming that <span class="FontName2">PrintQueue</span> and <span class="FontName2">PrintJob</span> are entities, we would have a one-to-many relationship from <span class="FontName2">PrintQueue</span> to <span class="FontName2">PrintJob</span> and a many-to-one relationship back.</p>
            <p class="indent">Given that you know how to map the relationships, and you just learned above how to map ordered lists using <span class="FontName2">&#64;OrderBy</span>, it would seem pretty straightforward to map this relationship using a <span class="FontName2">List</span>. The <span class="FontName2">PrintJob</span> entity, in <a href="#list5" id="_list5" target="_blank" rel="noopener noreferrer">Listing 5-5</a>, illustrates its many-to-one side of the bidirectional mapping.</p>
            <table>
              <tr>
                <td>
                  <p class="noindent2"><a href="#_list5" id="list5" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-5</i></b></a>.&nbsp;&nbsp;PrintJob Entity<a id="cXXX.234" target="_blank" rel="noopener noreferrer"></a></p>
                  <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                    <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PrintJob {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private PrintQueue queue;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                    <div class="orm-ChapterReader-snippetButtonContainer"></div>
                  </div>
                </td>
                <td>
                  <div class="Figure" id="Fig3">
                    <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-03.jpg" alt="9781430249269_Fig05-03.jpg" width="423" height="133"></p>
                    <p class="FigCapt"><span class="CaptNr"><a href="#_Fig3" target="_blank" rel="noopener noreferrer">Figure 5-3</a>. </span>PRINTQUEUE table and target PRINTJOB table with order column</p>
                  </div>
                </td>
              </tr>
            </table>
            <p class="indent">The problem arises when we discover that the <span class="FontName2">PrintJob</span> entity does not have an attribute that can be used in <span class="FontName2">&#64;OrderBy</span>. Because the order of the job does not really affect the actual <span class="FontName2">PrintJob</span> that gets serviced, the decision was made to not store the order of a given job within the <span class="FontName2">PrintJob</span> entity. The position of a particular <span class="FontName2">PrintJob</span> in the queue is determined simply by its position in the job <span class="FontName2">List</span>.</p>
            <p class="indent">The <span class="FontName2">PrintJob</span> entities in the Java <span class="FontName2">List</span> cannot retain their order unless a designated database column has been created to store it. We call this column the order column, and it provides a stronger persistent ordering than <span class="FontName2">&#64;OrderBy</span>. It is in the order column that the object‚Äôs order is stored and updated when it is moved from one position to another within the same <span class="FontName2">List</span>. It is transparent to the user in that the user does not need to manipulate it, or even necessarily be aware of it, in order to use the <span class="FontName2">List</span>. It does need to be known and considered as part of the mapping process, though, and is declared by means of an <span class="FontName2">&#64;OrderColumn</span> annotation.</p>
            <p class="indent">Using an <span class="FontName2">&#64;OrderColumn</span> annotation precludes the use of <span class="FontName2">&#64;OrderBy</span>, and vice versa. <a href="#list6" id="_list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a> shows how <span class="FontName2">&#64;OrderColumn</span> can be used with our one-to-many relationship mapping in <span class="FontName2">PrintQueue</span>. The table mappings are shown in <a href="#Fig3" id="_Fig3" target="_blank" rel="noopener noreferrer">Figure 5-3</a> above.</p>
            <p class="noindent2"><a href="#_list6" id="list6" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-6</i></b></a>.&nbsp;&nbsp;One-To-Many List from PrintQueue to PrintJob<a id="cXXX.235" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PrintQueue {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="queue")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OrderColumn(name="PRINT_ORDER")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;PrintJob&gt; jobs;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">You probably noticed something different about the declaration of the order column on the one-to-many side of the relationship. In the last chapter, we explained the practice of mapping the physical columns on the owning side because that is the side that owns the table in which they apply. The order column is an exception to this rule when the relationship is bidirectional because the column is always defined beside the <span class="FontName2">List</span> that it is ordering, even though it is in the table mapped by the owning many-to-one entity side. So in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a>, the <span class="FontName2">&#64;OrderColumn</span> annotation is on the <span class="FontName2">PrintQueue</span> side of the relationship, but the column named <span class="FontName2">PRINT_ORDER</span> is referring to whatever table the <span class="FontName2">PrintJob</span> entity is mapped to.</p>
            <p class="indent">Although the <span class="FontName2">&#64;OrderColumn</span> annotation must be present to enable the ordered position of the entity to be stored in a database column, the elements of the annotation are optional. The <span class="FontName2">name</span> just defaults to the name of the entity attribute, appended by the ‚Äú_ORDER‚Äù string. So, if the name had not been overridden in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a> to be <span class="FontName2">PRINT_ORDER</span>, it would have defaulted to be <span class="FontName2">JOBS_ORDER</span>.</p>
            <p class="indent">The table that the order column is stored in depends on the mapping that <span class="FontName2">&#64;OrderColumn</span> is being applied to. It is usually in the table that stores the entity or element being stored. As mentioned, in our bidirectional one-to-many relationship in <a href="#list6" target="_blank" rel="noopener noreferrer">Listing 5-6</a>, the entity being stored is <span class="FontName2">PrintJob</span>, and the order column would be stored in the <span class="FontName2">PRINTJOB</span> table. If the mapping were an element collection, the order column would be stored in the collection table. In many-to-many relationships, the order column is in the join table.</p>
            <p class="indent">Some additional comments about using <span class="FontName2">&#64;OrderColumn</span> are necessary because it is a feature that could easily be misused. We said that the order column is transparent to the user of the list, but it turns out that this transparency can have unexpected repercussions for a na√Øve user.</p>
            <p class="indent">Consider a busy company with many people and many print jobs being submitted and printed. When a job makes it to the first position, it gets removed from the queue and sent to the printer. Meanwhile, another job inherits the ‚Äúon deck‚Äù position. Every time a job gets serviced, every other <span class="FontName2">PrintJob</span> remaining on the queue moves up by one position and is one step closer to being printed. In other words, with each printed job, the order of each and every other <span class="FontName2">PrintJob</span> changes and must be resaved to the database. In our case, the order column is being stored in the table in which <span class="FontName2">PrintJob</span> entities are stored: the <span class="FontName2">PRINTJOB</span> table.</p>
            <p class="indent">Needless to say, we are looking at a potentially large cost, further compounded as the queue gets longer. For every job added to a queue of size n, there will be n additional SQL updates sent to the database to change the order of that job before it even makes it to the printer. That could ring alarm bells for a database administrator, especially a vigilant one with a penchant for perusing the SQL audits.</p>
            <p class="indent">As a final comment on <span class="FontName2">List</span> usage, there is special support in JPA queries that allows ordered subsets or individual items of a <span class="FontName2">List</span> to be accessed and returned. You will see how this can be achieved in <a href="9781430249269_Ch08.xhtml" target="_blank" rel="noopener noreferrer">Chapter 8</a>.</p>
          </div>
        </div>
        <div>
          <p id="Sec7" class="Heading2">Maps</p>
          <p class="noindent">The <span class="FontName2">Map</span> is a very common collection that is used in virtually every application and offers the ability to associate a key object with an arbitrary value object. The various underlying implementations are expected to use fast hashing techniques to optimize direct access to the keys.</p>
          <p class="indent">There is a great deal of flexibility with <span class="FontName2">Map</span> types in JPA, given that the keys and values can be any combination of entities, basic types, and embeddables. Permuting the three types in the two key and value positions renders nine distinct <span class="FontName2">Map</span> types. We will give detailed explanations of the most common combinations in the following sections.</p>
          <div>
            <p id="Sec8" class="Heading3">Keys and Values<a id="cXXX.236" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Although basic types, embeddable types, or entity types can be <span class="FontName2">Map</span> keys, remember that if they are playing the role of key, they must follow the basic rules for keys. They must be comparable and respond appropriately to the <span class="FontName2">hashCode()</span> method, and <span class="FontName2">equals()</span> method when necessary<a id="_Fn2" href="#Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a>. They should also be unique, at least within the domain of a particular collection instance, so that values are not lost or overwritten in memory. Keys should not be changed, or more specifically, the parts of the key object that are used in the <span class="FontName2">hashCode()</span> and <span class="FontName2">equals()</span> methods must not be changed while the object is acting as a key in a <span class="FontName2">Map</span>.</p>
            <p class="indent">When keys are basic or embeddable types, they are stored directly in the table being referred to. Depending upon the type of mapping, it can be either the target entity table, join table, or collection table. However, when keys are entities, only the foreign key is stored in the table because entities are stored in their own table, and their identity in the database must be preserved.</p>
            <p class="indent">It is always the type of the value object in the <span class="FontName2">Map</span> that determines what kind of mapping must be used. If the values are entities, the <span class="FontName2">Map</span> must be mapped as a one-to-many or many-to-many relationship, whereas if the values of the <span class="FontName2">Map</span> are either embeddable or basic types, the <span class="FontName2">Map</span> is mapped as an element collection.</p>
            <p class="indent">Even though the <span class="FontName2">Map</span> keys do not affect the type of mapping, they still require annotations, in addition to the relationship or element collection annotations, to indicate the column(s) in which they are stored. These annotations will be covered in the different use cases in the following sections.</p>
          </div>
          <div>
            <p id="Sec9" class="Heading3">Keying By Basic Type</p>
            <p class="noindent">We mentioned in the previous sections that element collections of basic types are stored in collection tables, and basic keys are stored in the tables referred to by the mapping. If the mapping is an element collection keyed by a basic type, the keys will be stored in the same collection table in which the <span class="FontName2">Map</span> values are stored. Likewise, if it is a one-to-many relationship, and the foreign key is in the target entity table, the keys will be in the target entity table. If the relationship mapping uses a join table, the keys will be in the join table.</p>
            <p class="indent">To show the collection table case, let‚Äôs look at an element collection example that maps the phone numbers of an <span class="FontName2">Employee</span>. If we use a <span class="FontName2">Map</span>, we can key on the phone number type and store the phone number as the value. So the key of each <span class="FontName2">Map</span> entry will be any of ‚ÄúHome‚Äù, ‚ÄúWork‚Äù or ‚ÄúMobile‚Äù, as a <span class="FontName2">String</span>, and the value will be the associated phone number <span class="FontName2">String</span>. <a href="#list7" id="_list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a> shows the element collection mapping<a id="cXXX.245a" target="_blank" rel="noopener noreferrer"></a> code.</p>
            <p class="noindent2"><a href="#_list7" id="list7" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-7</i></b></a>.&nbsp;&nbsp;Element Collection of Strings with String Keys<a id="cXXX.237" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, String&gt; phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">&#64;ElementCollection</span> and <span class="FontName2">&#64;CollectionTable</span> annotations are nothing new, and <a href="#list3" target="_blank" rel="noopener noreferrer">Listing 5-3</a> showed that we can use the <span class="FontName2">&#64;Column</span> annotation to override the name of the column that stores the values in the <span class="FontName2">Collection</span>. Here we are doing the same thing, except that we are overriding the column in which the <span class="FontName2">Map</span> values would be stored instead of the items in a generic <span class="FontName2">Collection</span>.</p>
            <p class="indent">The only new annotation is <span class="FontName2">&#64;MapKeyColumn</span>, which is used to indicate the column in the collection table that stores the basic key. When the annotation is not specified, the key is stored in a column named after the mapped collection attribute, appended with the ‚Äú_KEY‚Äù suffix. In <a href="#list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a>, if we had not specified <span class="FontName2">&#64;MapKeyColumn</span>, the defaulting rule would have caused the key to be mapped to the <span class="FontName2">PHONENUMBERS_KEY</span> column in the <span class="FontName2">EMP_PHONE</span> collection table.</p>
            <p class="indent">Phone number values can be duplicated in the collection table (for example, multiple employees living at the same home and having the same phone number), so the <span class="FontName2">PHONE_NUM</span> column obviously won‚Äôt be unique in the table. The types of phone numbers have to be unique only within a given <span class="FontName2">Map</span> or <span class="FontName2">Employee</span> instance, so the <span class="FontName2">PHONE_TYPE</span> column won‚Äôt be the primary key, either. In fact, because basic types do not have identity, and in some cases the same key-value entries can be duplicated in multiple source entities, the key-value columns can‚Äôt be the primary key columns on their own. Unique tuples in the collection table must be the combination of the key column and the foreign key column that references the source entity instance. <a href="#Fig4" id="_Fig4" target="_blank" rel="noopener noreferrer">Figure 5-4</a> shows the resulting collection table, along with the source <span class="FontName2">EMPLOYEE</span> entity table that it references. You can see the primary key constraint on the <span class="FontName2">EMPLOYEE_ID</span> and <span class="FontName2">PHONE_TYPE</span> columns.</p>
            <div class="Figure" id="Fig4">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-04.jpg" alt="9781430249269_Fig05-04.jpg" width="452" height="131"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig4" target="_blank" rel="noopener noreferrer">Figure 5-4</a>. </span>EMPLOYEE entity table<a id="cXXX.228" target="_blank" rel="noopener noreferrer"></a> and EMP_PHONE collection table<a id="cXXX.240" target="_blank" rel="noopener noreferrer"></a></p>
            </div>
            <p class="indent">We should really improve our model, though, because using a <span class="FontName2">String</span> key to store something that is constrained to be one of only three values (‚ÄúHome‚Äù, ‚ÄúMobile‚Äù, or ‚ÄúWork‚Äù), is not great style. An appropriate improvement would be to use an enumerated type instead of <span class="FontName2">String</span>. We can define our enumerated type as follows:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">public enum PhoneType { Home, Mobile, Work }</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">Now we have the valid options as enumerated constants, and there is no chance of mistyping or having invalid phone types. However, there is one further enhancement to consider. If we want to protect ourselves from future changes to the enumerated type values, either by reordering existing values or inserting additional ones, we should override the way the value is stored in the database. Instead of relying on the default approach of storing the ordinal value of the enumerated element, we want to store the <span class="FontName2">String</span> value, so we get the best of both worlds. The column will contain values that correspond to phone type settings in a human readable way, and the Java Map will have a strongly typed key.</p>
            <p class="indent">The usual way of overriding the storage strategy for an enumerated type is to use the <span class="FontName2">&#64;Enumerated</span> annotation. However, if we were to put <span class="FontName2">&#64;Enumerated</span> on our <span class="FontName2">Map</span> attribute, it would apply to the values of the element collection, not the keys. That is why there is a special <span class="FontName2">&#64;MapKeyEnumerated</span> annotation (see <a href="#list8" id="_list8" target="_blank" rel="noopener noreferrer">Listing 5-8</a>). There is also an equivalent <span class="FontName2">&#64;MapKeyTemporal</span> to specify the temporal type when the key is of type <span class="FontName2">java.util.Date</span>. Both <span class="FontName2">&#64;MapKeyEnumerated</span> and <span class="FontName2">&#64;MapKeyTemporal</span> are applicable to keys that are of a basic type, regardless of whether it is an element collection or a relationship.</p>
            <p class="noindent2"><a href="#_list8" id="list8" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-8</i></b></a>.&nbsp;&nbsp;Element Collection of Strings with Enumerated Type Keys<a id="cXXX.241" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyEnumerated(EnumType.STRING)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;PhoneType, String&gt; phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent"><a href="#list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a> had a one-to-many relationship that used a <span class="FontName2">List</span> to hold all the employees in a given department. Suppose that we change it to use a <span class="FontName2">Map</span> and keep track of which employee is working in any given office or cubicle. By keying on the cubicle number (which can contain letters as well, so we will represent them as a <span class="FontName2">String</span>), we can easily find which <span class="FontName2">Employee</span> works in that cubicle. Because this is a bidirectional one-to-many relationship, it will be mapped as a foreign key to <span class="FontName2">DEPARTMENT</span> in the <span class="FontName2">EMPLOYEE</span> table. The cubicle number keys will be stored in an additional column in the <span class="FontName2">EMPLOYEE</span> table, each one stored in the row corresponding to the <span class="FontName2">Employee</span> associated with that cubicle. <a href="#list9" id="_list9" target="_blank" rel="noopener noreferrer">Listing 5-9</a> shows the one-to-many mapping.</p>
            <p class="noindent2"><a href="#_list9" id="list9" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-9</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a Map <a id="cXXX.242" target="_blank" rel="noopener noreferrer"></a>with String Key</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="CUB_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Employee&gt; employeesByCubicle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">What if an employee could split his time between multiple departments? We would have to change our model to a many-to-many relationship and use a join table. The <span class="FontName2">&#64;MapKeyColumn</span> will be stored in the join table that references the two entities. The relationship is mapped in <a href="#list10" id="_list10" target="_blank" rel="noopener noreferrer">Listing 5-10</a>.</p>
            <p class="noindent2"><a href="#_list10" id="list10" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-10</i></b></a>.&nbsp;&nbsp;Many-to-Many Relationship Using a Map with String Keys<a id="cXXX.243" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="DEPT_EMP",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns=&#64;JoinColumn(name="DEPT_ID"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="CUB_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Employee&gt; employeesByCubicle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">If we did not override the key column with <span class="FontName2">&#64;MapKeyColumn</span>, it would have been defaulted as the name of the collection attribute suffixed by ‚Äú_KEY‚Äù. This would have produced a dreadful-looking <span class="FontName2">EMPLOYEESBYCUBICLE_KEY</span> column in the join table, which is not only ugly to read, but does not actually indicate what the key really is. <a href="#Fig5" id="_Fig5" target="_blank" rel="noopener noreferrer">Figure 5-5</a> shows the resulting tables.</p>
            <div class="Figure" id="Fig5">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-05.jpg" alt="9781430249269_Fig05-05.jpg" width="652" height="133"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig5" target="_blank" rel="noopener noreferrer">Figure 5-5</a>. </span>EMPLOYEE and DEPARTMENT entity tables<a id="cXXX.244" target="_blank" rel="noopener noreferrer"></a> and DEPT_EMP join table<a id="cXXX.245" target="_blank" rel="noopener noreferrer"></a></p>
            </div>
            <div class="notepara">
              <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;You can use a Map on only one side of a many-to-many relationship; it makes no difference which side.</p>
            </div>
          </div>
          <div>
            <p id="Sec10" class="Heading3">Keying by Entity Attribute<a id="cXXX.246" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">When a one-to-many or many-to-many relationship collection of entities is represented as a <span class="FontName2">Map</span>, it is most often keyed by some attribute of the target entity type. Keying by entity attribute is actually a special case of keying by basic type where the mapping is a relationship, and the basic type of the key is the type of the attribute (that we are keying on) in the target entity. When this common case occurs, the <span class="FontName2">&#64;MapKey</span> annotation can be used to designate the attribute of the target entity that is being keyed on.</p>
            <p class="indent">If each department keeps track of the employees in it, as in our previous example in <a href="#list4" target="_blank" rel="noopener noreferrer">Listing 5-4</a>, we could use a <span class="FontName2">Map</span> and key on the Employee id for quick <span class="FontName2">Employee</span> lookup. The updated <span class="FontName2">Department</span> mapping is shown in <a href="#list11" id="_list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a>.</p>
            <p class="noindent2"><a href="#_list11" id="list11" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-11</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Keyed by Entity Attribute</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKey(name="id")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;Integer, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">id</span> attribute of <span class="FontName2">Employee</span> is also the identifier or primary key attribute, and it turns out that keying on the identifier is the most common case of all. It is so common that when no name is specified the entities will by default be keyed by their identifier attribute<a id="_Fn3" href="#Fn3" target="_blank" rel="noopener noreferrer"><sup>3</sup></a>. When the identifier attribute is defaulted and not explicitly listed, we do need to know the identifier type so we can correctly specify the first type parameter of the <span class="FontName2">Map</span> when using a parameterized <span class="FontName2">Map</span>.</p>
            <p class="indent">One of the reasons why the identifier attribute is used for the key is because it fits the key criteria nicely. It responds to the necessary comparison methods, <span class="FontName2">hashCode()</span> and <span class="FontName2">equals()</span>, and it is guaranteed to be unique.</p>
            <p class="indent">If another attribute is used as the key, it should also be unique, although it is not absolutely required that it be unique across the entire domain of that entity type. It really needs to be unique only within the scope of the relationship. For example, we could key on the employee name as long as we made sure that the name would be unique within any department.</p>
            <p class="indent">In the previous section, we stated that a basic key is stored in the table referred to by the mapping. The special case of keying by entity attribute is an exception to that rule in that no additional column is needed to store the key. It is already stored as part of the entity. That is why the <span class="FontName2">&#64;MapKeyColumn</span> annotation is never used when keying on an entity attribute. A provider can easily build the contents of a one-to-many relationship <span class="FontName2">Map</span> by loading the entities that are associated with the source entity and extracting the attribute being keyed on from each of the loaded entities. No additional columns need to be read or extra joins performed.</p>
          </div>
          <div>
            <p id="Sec11" class="Heading3">Keying by Embeddable Type<a id="cXXX.247" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Using embeddables as keys is not something that you should encounter very often. In fact, if you are considering doing it at all, you should probably think twice before proceeding. Just because it‚Äôs possible does not mean that it is a good idea.</p>
            <p class="indent">The problem with embeddables is that they are not full-fledged entities. They are not queryable in the sense that they can‚Äôt be discovered or returned except as an aggregate part of their enclosing entities. Although this might not seem like a very severe limitation at the outset, it often becomes a problem later on in the development cycle.</p>
            <p class="indent">Identity of embeddables is not defined in general, but when they are used as keys in a <span class="FontName2">Map</span> there must be some notion of uniqueness defined, applicable at least within the given <span class="FontName2">Map</span>. This means that the uniqueness constraint, at least logically, is on the combination of the embedded attributes and the foreign key column to the source entity.</p>
            <p class="indent">Embeddable key types are similar to basic key types in that they are also stored in the table referred to by the mapping, but with embeddable types there are multiple attributes to store, not just one value. This results in multiple columns contributing to the primary key.</p>
            <div>
              <p id="Sec12" class="Heading4">Sharing Embeddable Key Mappings with Values</p>
              <p class="noindent">The code example in <a href="#list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a> showed a bidirectional one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span> that was keyed by the <span class="FontName2">id</span> attribute of <span class="FontName2">Employee</span>. What if we had wanted to key on multiple attributes of <span class="FontName2">Employee</span>? For example, it might be desirable to look up employees by name in the <span class="FontName2">Map</span>, assuming that the name is unique within a given department. If the name were split into two attributes, one for the first name and one for the last name, as shown in <a href="#list12" id="_list12" target="_blank" rel="noopener noreferrer">Listing 5-12</a>, then we would need a separate object to combine them and act as the key object in the <span class="FontName2">Map</span>. An embeddable type, such as <span class="FontName2">EmployeeName</span> in <a href="#list13" id="_list13" target="_blank" rel="noopener noreferrer">Listing 5-13</a>, can be used for this purpose. Having an <span class="FontName2">EmployeeName</span> embeddable type also provides a useful class for passing the encapsulated full name around the system.</p>
              <p class="noindent2"><a href="#_list12" id="list12" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-12</i></b></a>.&nbsp;&nbsp;Employee Entity</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String firstName;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String lastName;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="noindent2"><a href="#_list13" id="list13" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-13</i></b></a>.&nbsp;&nbsp;EmployeeName Embeddable with Read-Only Mappings</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeName {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String first_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String last_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">Because the bidirectional one-to-many relationship from <span class="FontName2">Department</span> to <span class="FontName2">Employee</span> is stored in the target entity table, the embeddable object key must also be stored there. However, it would be redundant for the two name components to be stored twice in each row, once for the <span class="FontName2">firstName</span> and <span class="FontName2">lastName</span> attributes of <span class="FontName2">Employee</span> and once for the <span class="FontName2">first_Name</span> and <span class="FontName2">last_Name</span> attributes of the <span class="FontName2">EmployeeName</span> key object. With a bit of clever mapping we can just reuse the two columns mapped to the <span class="FontName2">Employee</span> attributes and map them as read-only in the key (setting insertable and updatable to <span class="FontName2">false</span>). That is why in <a href="#list13" target="_blank" rel="noopener noreferrer">Listing 5-13</a> we map the <span class="FontName2">first_Name</span> and <span class="FontName2">last_Name</span> attributes to the same columns as the <span class="FontName2">firstName</span> and <span class="FontName2">lastName</span> attributes of <span class="FontName2">Employee</span>. From the <span class="FontName2">Department</span> perspective, the relationship in <a href="#list14" id="_list14" target="_blank" rel="noopener noreferrer">Listing 5-14</a> does not change much from <a href="#list11" target="_blank" rel="noopener noreferrer">Listing 5-11</a>, except that the <span class="FontName2">Map</span> is keyed by <span class="FontName2">EmployeeName</span> instead of by <span class="FontName2">Integer</span>, and <span class="FontName2">&#64;MapKey</span> is not used because the key is an embeddable and not an attribute of <span class="FontName2">Employee</span>.</p>
              <p class="noindent2"><a href="#_list14" id="list14" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-14</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Keyed by Embeddable</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </div>
            <div>
              <p id="Sec13" class="Heading4">Overriding Embeddable Attributes</p>
              <p class="noindent">Another modeling option is to combine the two name columns within the <span class="FontName2">Employee</span> entity and define an embedded attribute of type <span class="FontName2">EmployeeName</span>, as shown in <a href="#list15" id="_list15" target="_blank" rel="noopener noreferrer">Listing 5-15</a>.</p>
              <p class="noindent2"><a href="#_list15" id="list15" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-15</i></b></a>.&nbsp;&nbsp;Employee Entity with Embedded Attribute</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private EmployeeName name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">This time we are not sharing columns, so we must ensure that the mappings in <span class="FontName2">EmployeeName</span> are no longer read-only, or else the name will never get written to the database. The updated <span class="FontName2">EmployeeName</span> embeddable is in <a href="#list16" id="_list16" target="_blank" rel="noopener noreferrer">Listing 5-16</a>.</p>
              <p class="noindent2"><a href="#_list16" id="list16" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-16</i></b></a>.&nbsp;&nbsp;EmployeeName Embeddable</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeName {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="F_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String first_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="L_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String last_Name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">For the purpose of illustration, let's go back to the many-to-many model described in <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 5-10</a>, except that we will key on the <span class="FontName2">EmployeeName</span> embeddable instead of the cubicle <span class="FontName2">id</span>. Even though the <span class="FontName2">EmployeeName</span> attributes are stored in the <span class="FontName2">EMPLOYEE</span> table for every <span class="FontName2">Employee</span>, the keys of the <span class="FontName2">Map</span> must still be stored in the <span class="FontName2">DEPT_EMP</span> join table. This is a result of the key being an embeddable type. Keying by either a single attribute of the entity or by a basic type would alleviate this denormalized data scenario.</p>
              <p class="indent">By default, the key attributes would be mapped to the column names from the mappings defined within <span class="FontName2">EmployeeName</span>, but if the join table already exists and the columns in the join table do not have those names, the names must be overridden. <a href="#list17" id="_list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a> shows how the embeddable attribute mappings of the <span class="FontName2">Map</span> key can be overridden from what they are defined to be in the embeddable class.</p>
              <p class="noindent2"><a href="#_list17" id="list17" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-17</i></b></a>.&nbsp;&nbsp;Many-to-Many Map Keyed by Embeddable Type with Overriding</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="DEPT_EMP",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="DEPT_ID"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="EMP_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;AttributeOverride(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="first_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">column=&#64;Column(name="EMP_FNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;AttributeOverride(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="last_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">column=&#64;Column(name="EMP_LNAME"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">The tables for the mapping are shown in <a href="#Fig6" id="_Fig6" target="_blank" rel="noopener noreferrer">Figure 5-6</a>, with the embeddable attributes mapped to the join table for the key state and in the <span class="FontName2">EMPLOYEE</span> table for the <span class="FontName2">Employee</span> state. If the mapping had been an element collection, the embeddable attributes would be stored in a collection table instead of a join table.</p>
              <div class="Figure" id="Fig6">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-06.jpg" alt="9781430249269_Fig05-06.jpg" width="652" height="148"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig6" target="_blank" rel="noopener noreferrer">Figure 5-6</a>. </span>DEPARTMENT and EMPLOYEE entity table<a id="cXXX.239" target="_blank" rel="noopener noreferrer"></a>s and DEPT_EMP join table</p>
              </div>
              <p class="indent">As you can see from <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, the mapping defaults for the key are being overridden through the use of <span class="FontName2">&#64;AttributeOverride</span>. If instead of a many-to-many relationship we had an <span class="FontName2">&#64;ElementCollection</span> of some embeddable type in a <span class="FontName2">Map</span>, we would have to differentiate between the key and the value. We would do this by prefixing the attribute name with ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù, depending upon which of the embeddable types we were overriding. An element collection of embedded <span class="FontName2">EmployeeInfo</span> types, with the same key overrides as those in the relationship in <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, would use the following key prefixes:</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;ElementCollection</span><br><span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="key.first_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="EMP_FNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="key.last_Name",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="EMP_LNAME"))</span><br><span class="FontName2">})</span><br><span class="FontName2">private Map&lt;EmployeeName, EmployeeInfo&gt; empInfos;</span></pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
            </div>
          </div>
          <div>
            <p id="Sec14" class="Heading3">Keying by Entity<a id="cXXX.248" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">You might be reluctant to use entities as keys because intuition might lead you to think of this as a more resource-intensive option, with higher load and management costs. While that might be true in some cases, it is not necessarily always so. Quite often the entity you are considering keying on will already be in memory, or needed anyway, and keying on it either just accesses a cached instance or causes the instance to be loaded for later use.</p>
            <p class="indent">One advantage of keying by entity type is that entity instances are globally unique (within the persistence unit) so there will not be any identity problems to deal with across different relationships or collections. A corollary of the basic identity property of entities is that only a foreign key needs to be stored in the mapped table, leading to a more normalized design and data storage schema.</p>
            <p class="indent">As with the other types of <span class="FontName2">Map</span> keys, the key (in this case, a foreign key to the entity being keyed on) will be stored in the table referred to by the mapping.</p>
            <p class="indent">Recall that the term used by JPA to represent a foreign key column is join column, and we use join columns in many-to-one and one-to-one relationships, as well as in join tables of collection-valued relationships. We now have a similar situation, except that instead of referring to the target of a relationship, our join column is referring to the entity key in a <span class="FontName2">Map</span> entry. To differentiate join columns that point to map keys from the ones used in relationships, a separate <span class="FontName2">&#64;MapKeyJoinColumn</span> annotation was created. This annotation is used to override the join column defaults for an entity key. When it is not specified, the join column will have the same default column name as basic keys (the name of the relationship or element collection attribute, appended with the string ‚Äú_KEY‚Äù).</p>
            <p class="indent">To illustrate the case of an entity being used as a key, we can add the notion of the seniority an <span class="FontName2">Employee</span> has within a given <span class="FontName2">Department</span>. We want to have a loose association between an <span class="FontName2">Employee</span> and his seniority, and the seniority has to be local to a <span class="FontName2">Department</span>. By defining an element collection <span class="FontName2">Map</span> in <span class="FontName2">Department</span>, with the seniority as the values and <span class="FontName2">Employee</span> entities as the keys, the seniority any <span class="FontName2">Employee</span> has in a given <span class="FontName2">Department</span> can be looked up by using the <span class="FontName2">Employee</span> instance as a key. The seniority is stored in a collection table, and if an <span class="FontName2">Employee</span> changes departments none of the other <span class="FontName2">Employee</span> objects needs to change. The indirection of the collection table, and the fact that the connections between the <span class="FontName2">Department</span>, the <span class="FontName2">Employee</span>, and the seniority value are all maintained by virtue of the <span class="FontName2">Map</span>, provide just the right level of coupling. Only the entries in the collection table would need to be updated.</p>
            <p class="indent"><a href="#list18" id="_list18" target="_blank" rel="noopener noreferrer">Listing 5-18</a> shows the element collection mapping, with the join column being overridden using the <span class="FontName2">&#64;MapKeyJoinColumn</span> annotation and the <span class="FontName2">Map</span> value column being overridden using the standard <span class="FontName2">&#64;Column</span> annotation.</p>
            <p class="noindent2"><a href="#_list18" id="list18" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-18</i></b></a>.&nbsp;&nbsp;Element Collection Map Keyed by EntityType</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_SENIORITY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyJoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="SENIORITY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;Employee, Integer&gt; seniorities;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent"><a href="#Fig7" id="_Fig7" target="_blank" rel="noopener noreferrer">Figure 5-7</a> shows that the collection table is nothing more than the values of the <span class="FontName2">Map</span> (the seniority) with a foreign key to the <span class="FontName2">Department</span> source entity table and another foreign key to the <span class="FontName2">Employee</span> entity key table.</p>
            <div class="Figure" id="Fig7">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig05-07.jpg" alt="9781430249269_Fig05-07.jpg" width="671" height="125"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig7" target="_blank" rel="noopener noreferrer">Figure 5-7</a>. </span>DEPARTMENT and EMPLOYEE entity tables with EMP_SENIORITY collection table</p>
            </div>
          </div>
          <div>
            <p id="Sec15" class="Heading3">Untyped Maps<a id="cXXX.249" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">If we did not want to (or were not able to) use the typed parameter version of <span class="FontName2">Map&lt;KeyType, ValueType&gt;</span>, we would define it using the non-parameterized style of <span class="FontName2">Map</span> shown in <a href="#list19" id="_list19" target="_blank" rel="noopener noreferrer">Listing 5-19</a>.</p>
            <p class="noindent2"><a href="#_list19" id="list19" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-19</i></b></a>.&nbsp;&nbsp;One-to-Many Relationship Using a Non-parameterized Map</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(targetEntity=Employee.class, mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKey</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">targetEntity</span> element only ever indicates the type of the <span class="FontName2">Map</span> value. Of course, if the <span class="FontName2">Map</span> holds an element collection and not a relationship, the <span class="FontName2">targetClass</span> element of <span class="FontName2">&#64;ElementCollection</span> is used to indicate the value type of the <span class="FontName2">Map</span>.</p>
            <p class="indent">In <a href="#list19" target="_blank" rel="noopener noreferrer">Listing 5-19</a>, the type of the <span class="FontName2">Map</span> key can be easily deduced because the mapping is an entity relationship. The <span class="FontName2">&#64;MapKey</span> default is to use the identifier attribute, <span class="FontName2">id</span>, of type <span class="FontName2">int</span> or <span class="FontName2">Integer</span>. If <span class="FontName2">&#64;MapKey</span> had been specified and dictated that the key be an attribute that was not an identifier attribute, the type would still have been deducible because the entity attributes are all mapped with known types. However, if the key isn‚Äôt an attribute of the target entity, <span class="FontName2">&#64;MapKeyClass</span> might be used instead of <span class="FontName2">&#64;MapKey</span>. It indicates the type of the key class when the <span class="FontName2">Map</span> is not defined in a typed way using generics. It is also used when the <span class="FontName2">Map</span> references an element collection instead of a relationship because basic or embeddable types do not have identifier attributes, and basic types do not even have attributes.</p>
            <p class="indent">To illustrate how <span class="FontName2">&#64;MapKeyClass</span> is used, let‚Äôs take the element collection in <a href="#list7" target="_blank" rel="noopener noreferrer">Listing 5-7</a> and assume that it does not define the type parameters on the <span class="FontName2">Map</span>. The typing is filled in through the use of the <span class="FontName2">&#64;MapKeyClass</span> annotation and the <span class="FontName2">targetClass</span> element in <span class="FontName2">&#64;ElementCollection</span>, as shown in <a href="#list20" id="_list20" target="_blank" rel="noopener noreferrer">Listing 5-20</a>.</p>
            <p class="noindent2"><a href="#_list20" id="list20" target="_blank" rel="noopener noreferrer"><b><i>Listing 5-20</i></b></a>.&nbsp;&nbsp;Untyped Element Collection of Strings with String Keys</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ElementCollection(targetClass=String.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;CollectionTable(name="EMP_PHONE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyColumn(name="PHONE_TYPE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapKeyClass(String.class)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PHONE_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map phoneNumbers;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The <span class="FontName2">&#64;MapKeyClass</span> annotation should be used whenever the key class cannot be deduced from the attribute definition or the other mapping metadata.</p>
          </div>
          <div>
            <p id="Sec16" class="Heading3">Rules for Maps<a id="cXXX.250" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">Learning about the various <span class="FontName2">Map</span> variants can get kind of confusing given that you can choose any one of three different kinds of key types and three different kinds of value types. Below are some of the basic rules of using a <span class="FontName2">Map</span>.</p>
            <ul class="bulleted">
              <li>Use the <span class="FontName2">&#64;MapKeyClass</span> and <span class="FontName2">targetEntity</span>/<span class="FontName2">targetClass</span> elements of the relationship and element collection mappings to specify the classes when an untyped <span class="FontName2">Map</span> is used.</li>
              <li>Use <span class="FontName2">&#64;MapKey</span> with one-to-many or many-to-many relationship <span class="FontName2">Map</span> that is keyed on an attribute of the target entity.</li>
              <li>Use <span class="FontName2">&#64;MapKeyJoinColumn</span> to override the join column of the entity key.</li>
              <li>Use <span class="FontName2">&#64;Column</span> to override the column storing the values of an element collection of basic types.</li>
              <li>Use <span class="FontName2">&#64;MapKeyColumn</span> to override the column storing the keys when keyed by a basic type.</li>
              <li>Use <span class="FontName2">&#64;MapKeyTemporal</span> and <span class="FontName2">&#64;MapKeyEnumerated</span> if you need to further qualify a basic key that is a temporal or enumerated type.</li>
              <li>Use <span class="FontName2">&#64;AttributeOverride</span> with a ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù prefix to override the column of an embeddable attribute type that is a <span class="FontName2">Map</span> key or a value, respectively.</li>
            </ul>
            <p class="indent"><a href="#Tab1" id="_Tab1" target="_blank" rel="noopener noreferrer">Table 5-1</a> summarizes some of the different aspects of using a <span class="FontName2">Map</span>.</p>
            <div class="Table" id="Tab1">
              <p class="TabCapt"><span class="CaptNr"><a href="#_Tab1" target="_blank" rel="noopener noreferrer">Table 5-1</a>. </span>Summary of Mapping a Map</p>
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/Table5-1.jpg" alt="image" width="900" height="762"></p>
            </div>
          </div>
        </div>
        <div>
          <p id="Sec17" class="Heading2">Duplicates<a id="cXXX.251" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">When we were discussing the <span class="FontName2">Set</span> interface we mentioned that it was ideal for preventing duplicates. What we meant was that the <span class="FontName2">Set</span> datatype in Java does not allow them. We didn‚Äôt really say anything about duplicates in the database. In fact, the JPA specification does not say anything about whether duplicates are allowed in collections, either in the database or in memory, and in most cases they will not be supported. To get a feeling for why supporting duplicates is difficult, let's go to the data model and uncover some of the gory details. You might prefer to skip this section if duplicates are not interesting to you. Read on, however, if you are in a situation where an external application can come in behind your back and insert a duplicate record, for example.</p>
          <p class="indent">The <span class="FontName2">Collection</span> interface is very general and allows for a multitude of <span class="FontName2">Collection</span> subinterfaces and implementation classes. So it is very soft in its specification of whether duplicates are allowed, instead allowing the subinterface or implementation class to decide what behavior best fits that <span class="FontName2">Collection</span> type.</p>
          <p class="indent">For a <span class="FontName2">Collection</span> that does happen to allow duplicates, collection-valued relationship mappings use either a foreign key in the target entity table or a join table. The first case will always be a one-to-many mapping, and in that case there will be only one row for the target entity, and only one column in that row to contain the foreign key to the source entity. That leaves no way to capture the fact that the target entity is in the collection more than once.</p>
          <p class="indent">In the join table case, each row stores a join column to the source entity and a join column to the target entity, and the primary key of the join table is composed of the combination of the two. Only duplicate rows in that model could link multiple instances of the target to the same source, and duplicate rows in a relational database are highly frowned upon.</p>
          <p class="indent">An element collection is in a similar situation, except that instead of a foreign key to the target entity there are one or more columns in the collection table storing the basic or embeddable values. These columns just combine with the foreign key to the source entity to make up the primary key, and once again duplicate rows would be required to have duplicate values in a collection.</p>
          <p class="indent">The persistently ordered <span class="FontName2">List</span> is a little different, however, because it adds an order column to the mix. If the order column were to be included as part of the primary key, multiple relationship entries could exist in the <span class="FontName2">List</span>‚Äîeach of their respective rows potentially having the same element value data and foreign key reference, but differing only by the value of the order column. Thus, the uniqueness of a row is identified not only by the source and target objects but also by its position in the <span class="FontName2">List</span>.</p>
          <p class="indent">In the case of the foreign key in the target table, it would be bad practice indeed to include the order column in the primary key of an entity table, so we won‚Äôt even explore that as an option. However, when a join table or collection table is used, it is a perfectly reasonable thing to do, allowing duplicate values to be inserted in a persistently ordered <span class="FontName2">List</span>. This is possible, though, only if the provider includes the order column in the primary key of the table or gives you the option of configuring it in that way.</p>
          <p class="indent">Before you rejoice that your provider might allow you to store duplicates, be aware that there is a price to pay. This can be seen in the example of exchanging the order of two elements in the <span class="FontName2">List</span>. If the order column were just a regular column, it wouldn‚Äôt be too much of a stretch for the provider to optimize the database operations by simply updating the order columns of the two records with the correct values. However, if the order column is part of the primary key, what you are really saying is that the ordering of the contained object in the <span class="FontName2">List</span> is an integral part of the relationship between the containing and contained objects. Assigning a new order to the contained object is not modifying an aspect of the relationship, but effectively destroying the relationship and creating a new one with a different ordering. That means deleting the two old rows and creating two new ones.</p>
          <p class="indent">A <span class="FontName2">Map</span> has keys that must be unique, so duplicate keys clearly don‚Äôt make sense. It is similar to a <span class="FontName2">List</span> when it comes to its values, however, because it has a key column that can be part of the primary key. Once again, the case of the foreign key in the target table does not allow for multiple keys to point to the same entity, so one-to-many relationships that are mapped that way simply do not permit the same entity to be mapped to multiple keys in the same <span class="FontName2">Map</span>.</p>
          <p class="indent">For join tables and collection tables, duplicates will be possible in the <span class="FontName2">Map</span> only if it is keyed by something other than an attribute of the entity, or embeddable, and the key column is included in the primary key. The trade-off in the case of the <span class="FontName2">Map</span> is similar to the one that we discussed with <span class="FontName2">List</span>, except that the price of allowing duplicates in a <span class="FontName2">Map</span> is paid when you want to reassign an existing key to a different value.</p>
        </div>
        <div>
          <p id="Sec18" class="Heading2">Null Values<a id="cXXX.252" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">It is probably even less common to insert null values in a collection than it is to have duplicates. This is one reason why the JPA specification is not particularly clear on what happens when you insert null into a collection. As with duplicates, the cases are a little complex and require individual consideration.</p>
          <p class="indent">The <span class="FontName2">Set</span>, <span class="FontName2">List</span>, and <span class="FontName2">Map</span> interfaces join the <span class="FontName2">Collection</span> interface in being general enough to be wishy-washy when it comes to specifying what happens when null is inserted. They simply delegate the decision to the implementation, so an implementation class might choose to support inserting null values or throw an exception. JPA does no better; it ends up falling to the particular vendor‚Äôs proxy implementation to allow null or throw a <span class="FontName2">NullPointerException</span> when null is added. Note that you cannot make your collection interface allow null simply by initializing it with an implementation instance, such as <span class="FontName2">HashSet</span>, that allows null. The provider will replace the instance with one of its own implementation classes the next time the object becomes managed, and the new implementation class might or might not allow null values.</p>
          <p class="indent">In order for a null value to exist in the database the value column or columns must be nullable. This is the obvious part, but the corollary might be less evident, if a little repetitive. It claims once again that only relationships and element collections that use a join table or collection table can have null values in the collection. The proof is left for you to figure out, but (as a hint) try creating an entity that has all null values, including the identifier, with no identifier generation.</p>
          <p class="indent">There is a further limitation on null values when it comes to element collections of embeddable objects. Entity references in a join table or element collections of basic types in a collection table are single-column values or references. The problem in the embeddable case is that if a combination of columns mapped to an embeddable are all null, there is no way for the provider to know whether it signifies a null value or an empty embeddable object full of null values. Providers might assume that it is an empty embedded object or they might have a controllable option to dictate whether the nulls get treated one way or the other.</p>
          <p class="indent">Maps are equally non-committal about allowing null keys, but it really doesn‚Äôt fit very well with the model of key columns being primary key fields. Most databases do not allow one of the primary key fields to be nullable, and we would not recommend it even for the odd one that does.</p>
        </div>
        <p id="Sec19" class="Heading1">Best Practices</p>
        <p class="noindent">With all the options and possibilities that have emerged, we would be cruel indeed if we did not offer at least some measure of guidance to the lonely collections traveler. Of course, the reason why there are so many options is because there are so many different cases to solve, so it is not really appropriate to come up with hard and fast rules. However, some general guidelines will hopefully assist you in picking the right mapping strategy for your specific application use case.</p>
        <ul class="bulleted">
          <li>When using a <span class="FontName2">List</span>, do not assume that it is ordered automatically if you have not actually specified any ordering. The <span class="FontName2">List</span> order might be affected by the database results, which are only partially deterministic with respect to how they are ordered. There are no guarantees that such an ordering will be the same across multiple executions.</li>
          <li>It will generally be possible to order the objects by one of their own attributes. Using the <span class="FontName2">&#64;OrderBy</span> annotation will always be the best approach when compared to a persistent <span class="FontName2">List</span> that must maintain the order of the items within it by updating a specific order column. Use the order column only when it is impossible to do otherwise.</li>
          <li><span class="FontName2">Map</span> types are very helpful, but they can be relatively complicated to properly configure. Once you reach that stage, however, the modeling capabilities that they offer and the loose association support that can be leveraged makes them ideal candidates for various kinds of relationships and element collections.</li>
          <li>As with the <span class="FontName2">List</span>, the preferred and most efficient use of a <span class="FontName2">Map</span> is to use an attribute of the target object as a key, making a <span class="FontName2">Map</span> of entities keyed by a basic attribute type the most common and useful. It will often solve most of the problems you encounter. A <span class="FontName2">Map</span> of basic keys and values can be a useful configuration for associating one basic object with another.</li>
          <li>Avoid using embedded objects in a <span class="FontName2">Map</span>, particularly as keys, because their identity is typically not defined. Embeddables in general should be treated with care and used only when absolutely necessary.</li>
          <li>Support for duplicate or null values in collections is not guaranteed, and is not recommended even when possible. They will cause certain types of operations on the collection type to be slower and more database-intensive, sometimes amounting to a combination of record deletion and insertion instead of simple updates.</li>
        </ul>
        <p id="Sec20" class="Heading1">Summary</p>
        <p class="noindent">In this chapter, we took a more in-depth look at various ways of mapping collections to the database. We looked at how the contents of the collection determine how it is mapped, and noted that there are many flexible options for storing different kinds of objects in various types of collections.</p>
        <p class="indent">We showed that the difference between relationships and element collections was whether entities or basic/embeddable types were being stored in them. We went on to examine the different types of collections, and how <span class="FontName2">Collection</span> and <span class="FontName2">Set</span> can be used for simple container purposes, while <span class="FontName2">List</span> can be used to maintain ordered collections. We showed that there are two different approaches to using a <span class="FontName2">List</span> and that maintaining a persistent <span class="FontName2">List</span> is possible, but not usually the best strategy.</p>
        <p class="indent">We then elaborated on all the <span class="FontName2">Map</span> types, explaining how combinations of basic, embeddable, and entity types can be used as keys and values. We experimented with and showed examples of using many of the different combinations of key and value types, illustrating how each changed the way the collection was mapped. We then outlined, in list form, the basic rules of using a <span class="FontName2">Map</span> type.</p>
        <p class="indent">We finished off collections by looking at the corner cases of adding duplicates and null values to collections and outlined the cases when support might be reasonable. Some best practices and practical guidance to using collections followed.</p>
        <p class="indent">The next chapter will discuss using entity managers and persistence contexts in more advanced ways than we did previously, delving into the practices and nuances of injecting and using them in Java EE and Java SE environments.</p>
        <p class="FootNote"><a id="Fn1" href="#_Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a> Assuming that the collection was not returned from a second level shared cache.</p>
        <p class="FootNote"><a id="Fn2" href="#_Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> See the javadoc for java.util.Map for more details.</p>
        <p class="FootNote"><a id="Fn3" href="#_Fn3" target="_blank" rel="noopener noreferrer"><sup>3</sup></a> The <span class="FontName2">&#64;MapKey</span> annotation is still required, however; otherwise, the <span class="FontName2">&#64;MapKeyColumn</span> defaults would apply.</p>
      </div>    
    </div>
  </div>
</div>
<div class="accordion accordion-flush">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#jpa-advanced-object-relational-mapping" aria-expanded="false" aria-controls="jpa-advanced-object-relational-mapping">
        JPA - Advanced Object-Relational Mapping (from the book Pro JPA 2, 2nd Edition)
      </button>
    </h2>
    <div id="jpa-advanced-object-relational-mapping" class="accordion-collapse collapse pro-jpa-2">
      <p class="ChapterNumber"><a id="Chap_10" target="_blank" rel="noopener noreferrer"></a>CHAPTER 10</p>
      <p class="chapimage"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/frontdot.jpg" alt="image" width="82" height="25"></p>
      <p class="ChapterTitle">Advanced Object-Relational Mapping<a id="cXXX.634" target="_blank" rel="noopener noreferrer"></a></p>
      <div>
        <p class="noindent">Every application is different, and, while most have some elements of complexity in them, the difficult parts in one application will tend to be different than those in other types of applications. Chances are that whichever application you are working on at any given time will need to make use of at least one advanced feature of the API. This chapter will introduce and explain some of these more advanced ORM<a id="cXXX.684a" target="_blank" rel="noopener noreferrer"></a> features.</p>
        <p class="indent">Many of the features in this chapter are targeted at applications that need to reconcile the differences between an existing data model and an object model. For example, when the data in an entity table would be better decomposed in the object model as an entity and a dependent object that is referenced by the entity, then the mapping infrastructure should be able to support that. Likewise, when the entity data is spread across multiple tables, the mapping layer should allow for this kind of configuration to be specified.</p>
        <p class="indent">There has been no shortage of discussion in this book about how entities in JPA are just regular Java classes and not special objects that are required to extend a specific subclass or implement special methods. One of the benefits of entities being regular Java classes is that they can adhere to already established concepts and practices that exist in object-oriented systems. One of the traditional object-oriented innovations is the use of inheritance and creating objects in a hierarchy in order to inherit state and behavior.</p>
        <p class="indent">This chapter will discuss some of the more advanced mapping features and delve into the diverse possibilities offered by the API and the mapping layer. We will also see how inheritance works within the framework of the Java Persistence API and how it affects the model.</p>
        <p class="Heading1" id="Sec1">Table and Column Names<a id="cXXX.635" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In previous sections, we have shown the names of tables and columns as uppercase identifiers. We did this, first, because it helps differentiate them from Java identifiers and, second, because the SQL standard defines that undelimited database identifiers do not respect case, and most tend to display them in uppercase.</p>
        <p class="indent">Anywhere a table or column name is specified, or is defaulted, the identifier string is passed through to the JDBC driver exactly as it is specified, or defaulted. For example, when no table name is specified for the <span class="FontName2">Employee</span> entity, then the name of the table assumed and used by the provider will be <span class="FontName2">Employee</span>, which by SQL definition is no different from <span class="FontName2">EMPLOYEE</span>. The provider is neither required nor expected to do anything to try to adjust the identifiers before passing them to the database driver.</p>
        <p class="indent">The following annotations should, therefore, be equivalent in that they refer to the same table in a SQL standard compliant database:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Table(name="employee")</span><br><span class="FontName2">&#64;Table(name="Employee")</span><br><span class="FontName2">&#64;Table(name="EMPLOYEE")</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Some database names are intended to be case-specific and must be explicitly delimited. For example, a table might be called <span class="FontName2">EmployeeSales</span>, but without case distinction would become <span class="FontName2">EMPLOYEESALES</span>, clearly less readable and harder to ascertain its meaning. While it is by no means common, or good practice, a database in theory could have an <span class="FontName2">EMPLOYEE</span> table as well as an <span class="FontName2">Employee</span> table. These would need to be delimited in order to distinguish between the two. The method of delimiting is the use of a second set of double quotes, which must be escaped, around the identifier. The escaping mechanism is the backslash (the \ character), which would cause the following annotations to refer to different tables:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Table(name="\"Employee\"")</span><br><span class="FontName2">&#64;Table(name="\"EMPLOYEE\"")</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Notice that the outer set of double quotes is just the usual delimiter of strings in annotation elements, but the inner double quotes are preceded by the backslash to cause them to be escaped, indicating that they are part of the string, not string terminators.</p>
        <p class="indent">When using an XML mapping file, the identifier is also delimited by including quotes in the identifier name. For example, the following two elements represent different columns:</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&lt;column name="&amp;quot;ID&amp;quot;"/&gt;</span><br><span class="FontName2">&lt;column name="&amp;quot;Id&amp;quot;"/&gt;</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">The method of XML escaping is different than the one used in Java. Instead of using the backslash, XML escapes with an ampersand (&amp;) character followed by a word describing the specific thing being escaped (in this case, ‚Äúquot‚Äù) and finally a trailing semicolon (;) character.</p>
        <div class="notepara">
          <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Some vendors support features to normalize the case of the identifiers that are stored and passed back and forth between the provider and the JDBC driver. This works around certain JDBC drivers that, for example, accept uppercase identifiers in the native SQL query select statement, but pass them back mapped to lowercase identifiers.</p>
        </div>
        <p class="indent">Sometimes the database is set to use case-specific identifiers, and it would become rather tedious (and look exceedingly ugly) to have to put the extra quotes on every single table and column name. If you find yourself in that situation, there is a convenience setting in the XML mapping file that will be of value to you.</p>
        <p class="indent">By including the empty <span class="FontName2">delimited-identifiers</span> element in the XML mapping file, all identifiers in the persistence unit will be treated as delimited, and quotes will be added to them when they are passed to the driver. The only catch is that there is no way to override this setting. Once the <span class="FontName2">delimited-identifiers</span> flag is turned on, all identifiers must be specified exactly as they exist in the database. Furthermore, if you decide to turn on the <span class="FontName2">delimited-identifiers</span> option, make sure you remove any escaped quotes in your identifier names or you will find that they will be included in the name. Using escaping in addition to the delimited identifiers option will take the escaped quotes and wrap them with further quotes, making the escaped ones become part of the identifier.</p>
        <p class="Heading1" id="Sec2">Converting Entity State<a id="cXXX.636" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.636a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">Back in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> we showed some of the ways that specific kinds of data, such as enumerated types, temporal types, and large objects, can be stored in the database. However, it would be impractical to define targeted support for each and every kind of data that is not a primitive, particularly because there will always be some application that wants to store the data in a new and different way, or is forced to do so because of a legacy database. Furthermore, an application might define its own set of types that the specification could clearly never predict. A more flexible and scalable solution, therefore, is to devise a way that enables the application to define its own conversion strategy for whatever type it deems necessary to convert. This is made possible through the use of converters.</p>
        <div class="notepara">
          <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Converters were added to the JPA 2.1 specification.</p>
        </div>
        <div>
          <p id="Sec3" class="Heading2">Creating a Converter<a id="cXXX.637" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">A converter is a application-specified class that implements the <span class="FontName2">AttributeConverter&lt;X,Y&gt;</span> interface. It can be declaratively applied to persistent attributes in any entity, mapped superclass, or embeddable class to control how the state of the attribute is stored in the database. It similarly defines how the state is converted from the database back into the object. These two conversion operations comprise the two methods of the <span class="FontName2">AttributeConverter&lt;X,Y&gt;</span> interface, shown in <a href="#list1" id="_list1" target="_blank" rel="noopener noreferrer">Listing 10-1</a>.</p>
          <p class="noindent2"><a href="#_list1" id="list1" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-1.</i></b></a>&nbsp;&nbsp;AttributeConverter Interface<a id="cXXX.638" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public interface AttributeConverter&lt;X,Y&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Y convertToDatabaseColumn (X attribute);</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public X convertToEntityAttribute (Y dbData);</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that the interface should be defined with two type parameters. The first type parameter represents the type of the entity attribute while the second represents the JDBC type to be used when storing the data in the database column. A sample converter implementation class is shown in <a href="#list2" id="_list2" target="_blank" rel="noopener noreferrer">Listing 10-2</a>. It illustrates a simple converter needed to store a boolean entity attribute as an integer in the database.</p>
          <p class="noindent2"><a href="#_list2" id="list2" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-2.</i></b></a>&nbsp;&nbsp;Boolean-to-Integer Converter<a id="cXXX.639" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Converter</span><br><span class="FontName2">public class BooleanToIntegerConverter&nbsp;&nbsp;implements AttributeConverter&lt;Boolean,Integer&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Integer convertToDatabaseColumn (Boolean attrib) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (attrib ? 1 : 0);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Boolean convertToEntityAttribute (Integer dbData) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (dbData &gt; 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;There is currently only support to convert an entity attribute to a single column in the database. The ability to store it across multiple columns may be standardized in a future release.</p>
          </div>
          <p class="indent">The converter class is annotated so that the container can detect and validate it. The conversion methods are trivial in this case because the conversion process is such a simple one, but the conversion logic could be more extensive if more was needed.</p>
          <p class="indent">Converters can be used for explicit or automatic conversion of basic state, as the following sections describe.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Converters are <i>managed classes</i>, hence when running in Java SE each converter class should be included in a <span class="FontName2">class</span> element in the <span class="FontName2">persistence.xml</span> descriptor.</p>
          </div>
        </div>
        <div>
          <p id="Sec4" class="Heading2">Declarative Attribute Conversion<a id="cXXX.642a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">A converter can be used explicitly to convert an entity attribute by annotating the attribute with <span class="FontName2">&#64;Convert</span> and setting the <span class="FontName2">converter</span> element to the converter class. For example, if we had a <span class="FontName2">Boolean</span> attribute named ‚Äúbonded‚Äù in our <span class="FontName2">Employee</span> entity, it could be converted to an <span class="FontName2">Integer</span> in the mapped database column if we annotated the attribute with <span class="FontName2">&#64;Convert</span> and specified the converter class declared in the previous section:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class)</span><br><span class="FontName2">private Boolean bonded;</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The attribute being converted should be of the correct type. Since the first parameterized type of the converter is <span class="FontName2">Boolean</span>, the attribute we are converting should be of type <span class="FontName2">Boolean</span>. However, wrapper and primitive types are autoboxed during conversion, so the attribute could also have been of type <span class="FontName2">boolean</span>.</p>
          <div>
            <p id="Sec5" class="Heading3">Converting Embedded Attributes<a id="cXXX.640" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">If the attribute to be converted is part of an embeddable type and we are converting it from within a referencing entity, then we use the <span class="FontName2">attributeName</span> element to specify the attribute to convert. For example, if the <span class="FontName2">bonded</span> attribute from above was contained within a <span class="FontName2">SecurityInfo</span> embeddable object and the <span class="FontName2">Employee</span> entity had a <span class="FontName2">securityInfo</span> attribute, then we could convert it as in <a href="#list3" id="_list3" target="_blank" rel="noopener noreferrer">Listing 10-3</a>:</p>
            <p class="noindent2"><a href="#_list3" id="list3" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-3.</i></b></a>&nbsp;&nbsp;Converting an Embedded Attribute</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class, attributeName="bonded")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private SecurityInfo securityInfo;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class SecurityInfo {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Boolean bonded;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">In the ‚ÄúComplex Embedded Objects‚Äù section later in this chapter we will describe more advanced usages of embeddables; in particular, the dot notation will be shown as a means to override nested embeddables. This same notation may also be used in the <span class="FontName2">attributeName</span> of the <span class="FontName2">&#64;Convert</span> annotation<a id="cXXX.641" target="_blank" rel="noopener noreferrer"></a> to reference a nested embedded attribute.</p>
          </div>
          <div>
            <p id="Sec6" class="Heading3">Converting Collections<a id="cXXX.642" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">In <a href="9781430249269_Ch05.xhtml" target="_blank" rel="noopener noreferrer">Chapter 5</a> we showed that collections may be mapped as element collections if the values are a basic or embeddable type, or mapped as one-to-many or many-to-many relationships if the values are an entity type. Converters may be applied to element collections but since converters do not convert entity instances they may not, in general, be applied to relationship mappings.<a id="_Fn1" href="#Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a></p>
            <p class="indent">Element collections of basic types are simple to convert. They are annotated the same way as basic attributes that are not collections. Thus, if we had an attribute that was of type <span class="FontName2">List&lt;Boolean&gt;</span>, we would annotate it just as we did our <span class="FontName2">bonded</span> attribute above, and all of the boolean values in the collection would be converted:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;ElementCollection</span><br><span class="FontName2">&#64;Convert(converter=BooleanToIntegerConverter.class)</span><br><span class="FontName2">private List&lt;Boolean&gt; securityClearances;</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">If an element collection is a <span class="FontName2">Map</span> with values that are of a basic type, then the values of the <span class="FontName2">Map</span> will be converted. To perform conversion on the keys, the <span class="FontName2">attributeName</span> element should be used with a special value of ‚Äúkey‚Äù to indicate that the keys of the <span class="FontName2">Map</span> are to be converted instead of the values.</p>
            <p class="indent">Recall from the ‚ÄúOverriding Embeddable Attributes‚Äù section in <a href="9781430249269_Ch05.xhtml" target="_blank" rel="noopener noreferrer">Chapter 5</a> that if we had an element collection that was a <span class="FontName2">Map</span>, and it contained embeddables, then we prefixed the <span class="FontName2">name</span> element of <span class="FontName2">&#64;AttributeOverride</span> with ‚Äúkey.‚Äù or ‚Äúvalue‚Äù. This was to distinguish whether we were overriding the column for an embeddable key or value of the <span class="FontName2">Map</span>. Similarly, if we want to convert an embeddable attribute in a <span class="FontName2">Map</span>, then we would prefix the <span class="FontName2">attributeName</span> element with ‚Äúkey.‚Äù or ‚Äúvalue.‚Äù followed by the name of the embeddable attribute to be converted. As a special case, we can use the ‚Äúkey‚Äù or ‚Äúkey.‚Äù prefix on either of the one-to-many or many-to-many collection relationships to map the keys if they are basic or embeddable types, respectively. Using the domain model in <a href="9781430249269_Ch05.xhtml#list17" target="_blank" rel="noopener noreferrer">Listing 5-17</a>, if we wanted to convert the employee last name to be stored as uppercase characters (assuming we have defined the corresponding converter class), we would annotate the attribute as shown in <a href="#list4" id="_list4" target="_blank" rel="noopener noreferrer">Listing 10-4</a>:</p>
            <p class="noindent2"><a href="#_list4" id="list4" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-4.</i></b></a>&nbsp;&nbsp;Converting an Embeddable Attribute Key in a Relationship Map</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Convert(converter=UpperCaseConverter.class, attributeName="key.lastName")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;EmployeeName, Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec7" class="Heading3">Limitations<a id="cXXX.643" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">There are a few restrictions placed on converters, mostly to prevent users from doing things that would get them into trouble. For instance, converters cannot be used on identifier attributes, version attributes, or relationship attributes (unless you are converting the key part of a relationship <span class="FontName2">Map</span>, as in <a href="#list4" target="_blank" rel="noopener noreferrer">Listing 10-4</a>). Hopefully this will not come as a surprise to you, since in most cases converting these types of attributes would arguably be a pretty bad idea. These attributes are heavily used by the provider as it manages the entities; changing their shape or even their value could cause inconsistencies or incorrect results.</p>
            <p class="indent">Converters also cannot be used on attributes annotated with <span class="FontName2">&#64;Enumerated</span> or <span class="FontName2">&#64;Temporal</span>, but that doesn‚Äôt mean you can‚Äôt convert enumerated types or temporal types. It just means that if you use the standard <span class="FontName2">&#64;Enumerated</span> or <span class="FontName2">&#64;Temporal</span> annotations to map those types, then you also cannot use custom converters. If you are using a custom converter class, then you are taking over control of the value that gets stored and there is no need for you to use any of those annotations to get the JPA provider to do the conversion for you. Put simply, if you are doing custom conversion using converters on enumerated or temporal types, just leave the <span class="FontName2">&#64;Enumerated</span><a id="cXXX.644" target="_blank" rel="noopener noreferrer"></a> or <span class="FontName2">&#64;Temporal</span> annotations<a id="cXXX.645" target="_blank" rel="noopener noreferrer"></a> off.</p>
          </div>
        </div>
        <div>
          <p id="Sec8" class="Heading2">Automatic Conversion<a id="cXXX.646" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">When we defined a converter to convert a boolean to an integer, we likely had in mind that it would be used in very specific places, on one or possibly a few attributes. You generally don‚Äôt want to convert every boolean attribute in your domain to an integer. However, if you frequently use a more semantically rich data type, such as the <span class="FontName2">URL</span> class, then you might want every attribute of that type to be converted. You can do this by setting the <span class="FontName2">autoApply</span> option on the <span class="FontName2">&#64;Converter</span> annotation<a id="cXXX.647" target="_blank" rel="noopener noreferrer"></a>. In <a href="#list5" id="_list5" target="_blank" rel="noopener noreferrer">Listing 10-5</a>, a <span class="FontName2">URL</span> converter is declared with the <span class="FontName2">autoApply</span> option enabled. This will cause every persistent attribute of type <span class="FontName2">URL</span> in the persistence unit to be converted to a string when the entity that contains it is written to the database.</p>
          <p class="noindent2"><a href="#_list5" id="list5" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-5.</i></b></a>&nbsp;&nbsp;URL-to-String Converter<a id="cXXX.648" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Converter(autoApply=true)</span><br><span class="FontName2">public class URLConverter implements AttributeConverter&lt;URL,String&gt; {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String convertToDatabaseColumn (URL attrib) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return attrib.toString();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public URL convertToEntityAttribute (String dbData) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return new URL(dbData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;It is undefined if two converters are declared to be auto-applied to the same attribute type.</p>
          </div>
          <p class="indent">We can override the conversion on a per-attribute basis. If, instead of the auto-applied converter, we want to use a different converter for a given attribute, then we can annotate the attribute with the <span class="FontName2">&#64;Convert</span> annotation and specify the converter class we want to use. Alternatively, if we want to disable the conversion altogether and let the provider revert to serialization of the URL, then we can use the <span class="FontName2">disableConversion</span> attribute:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Convert(disableConversion=true)</span><br><span class="FontName2">URL homePage;</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec9" class="Heading2">Converters and Queries<a id="cXXX.649" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Defining the converters and configuring which attributes to convert is pretty much all you need to do to get conversion to work. But there are a couple of additional points related to conversion that you should be aware of when querying.</p>
          <p class="indent">The first is that the query processor will apply the converter to both the attributes targeted for conversion as well as the literals they are being compared against in a query. However, the operators are not modified. This means that only certain comparison operators will work once the query is converted. To illustrate this point, consider the following query:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">SELECT e FROM Employee e WHERE e.bonded = true</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">This query will work fine if <span class="FontName2">bonded</span> is set to be converted from boolean to integer. The generated SQL will have converted both the <span class="FontName2">bonded</span> attribute and the literal ‚Äútrue‚Äù to the corresponding integer by invoking the <span class="FontName2">convertToDatabaseColumn()</span> method on it and the equals operator will work just as well on integers as it does on booleans.</p>
          <p class="indent">However, we may want to query for all of the employees who are not bonded:</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">SELECT e FROM Employee e WHERE NOT e.bonded</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">If we try to execute this query the parser will have no problem with it, but when it comes time to execute it the resulting SQL will contain a <span class="FontName2">NOT</span> and the value of <span class="FontName2">e.bonded</span> will have been converted to be an integer. This will generally cause a database exception since the <span class="FontName2">NOT</span> operation cannot be applied to an integer.</p>
          <p class="indent">It is possible that you will bump into an issue or two if you do any significant querying across converted attributes. While you can usually rely on conversion of literals and input parameters used in comparison, if they are contained within a function, such as <span class="FontName2">UPPER()</span> or <span class="FontName2">MOD()</span>, they probably will not be converted. Even some of the more advanced comparison operations, such as <span class="FontName2">LIKE</span>, may not apply conversion to the literal operand. The moral is to try not to use converted attributes in queries, and if you do, play around and do some experimenting to make sure your queries work as expected.</p>
        </div>
        <p id="Sec10" class="Heading1">Complex Embedded Objects<a id="cXXX.650a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we looked at embedding objects within entities, and how an embedded object becomes part of, and dependent upon, the entity that embeds it. We will now explain how more can be done with embedded objects, and how they can contain more than just basic mappings.</p>
        <div>
          <p id="Sec11" class="Heading2">Advanced Embedded Mappings</p>
          <p class="noindent">Embedded objects can embed other objects, have element collections of basic or embeddable types, and have relationships to entities. This is all possible under the assumption that objects embedded within other embedded objects are still dependent upon the embedding entity. Similarly, when bidirectional relationships<a id="cXXX.650" target="_blank" rel="noopener noreferrer"></a> exist within an embedded object, they are treated as though they exist in the owning entity, and the target entity points back to the owning entity, not to the embedded object.</p>
          <p class="indent">As an example, let‚Äôs bring back our <span class="FontName2">Employee</span> and embedded <span class="FontName2">Address</span> objects from <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> and update the model just a little bit. Insert a <span class="FontName2">ContactInfo</span> object<a id="cXXX.651" target="_blank" rel="noopener noreferrer"></a>, containing the address plus the phone information, into each employee. Instead of having an <span class="FontName2">address</span> attribute, our <span class="FontName2">Employee</span> entity would now have an attribute named <span class="FontName2">contactInfo</span>, of type <span class="FontName2">ContactInfo</span>, annotated with <span class="FontName2">&#64;Embedded</span>. The model is shown in <a href="#Fig1" id="_Fig1" target="_blank" rel="noopener noreferrer">Figure 10-1</a>.</p>
          <div class="Figure" id="Fig1">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-01.jpg" alt="9781430249269_Fig10-01.jpg" width="673" height="306"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig1" target="_blank" rel="noopener noreferrer">Figure 10-1</a>. </span>Nested embeddables with relationships</p>
          </div>
          <p class="indent">The <span class="FontName2">ContactInfo</span> clas<a id="cXXX.652" target="_blank" rel="noopener noreferrer"></a>s contains an embedded object, as well as some relationships, and would be annotated as shown in <a href="#list6" id="_list6" target="_blank" rel="noopener noreferrer">Listing 10-6</a>.</p>
          <p class="noindent2"><a href="#_list6" id="list6" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-6.</i></b></a>&nbsp;&nbsp;Embeddable ContactInfo Class<a id="cXXX.653" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Embeddable &#64;Access(AccessType.FIELD)</span><br><span class="FontName2">public class ContactInfo {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Address residence;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="PRI_NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Phone primaryPhone;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany &#64;MapKey(name="type")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="EMP_PHONES")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Map&lt;String, Phone&gt; phones;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The <span class="FontName2">Address</span> class remains the same as in <a href="9781430249269_Ch04.xhtml#list26" target="_blank" rel="noopener noreferrer">Listing 4-26</a>, but we have added more depth to our contact information. Within the <span class="FontName2">ContactInfo</span> embeddable, we have the address as a nested embedded object, but we also have an additional unidirectional relationship to the phone number serving as the primary contact number. A bidirectional many-to-many relationship to the employee‚Äôs phone numbers would have a default join table named <span class="FontName2">EMPLOYEE_PHONE</span>, and on the <span class="FontName2">Phone</span> side the relationship attribute would refer to a list of <span class="FontName2">Employee</span> instances, with the <span class="FontName2">mappedBy</span> element being the qualified name of the embedded relationship attribute. By qualified, we mean that it must first contain the attribute within <span class="FontName2">Employee</span> that contains the embeddable, as well as a dot separator character (.) and the relationship attribute within the embeddable. <a href="#list7" id="_list7" target="_blank" rel="noopener noreferrer">Listing 10-7</a> shows the <span class="FontName2">Phone</span> class and its mapping back to the <span class="FontName2">Employee</span> entity.</p>
          <p class="noindent2"><a href="#_list7" id="list7" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-7.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Phone</span> Class<a id="cXXX.654" target="_blank" rel="noopener noreferrer"></a> Referring To Embedded Attribute</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Phone {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String num;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany(mappedBy="contactInfo.phones")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Employee&gt; employees;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String type;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">A proviso about embeddable types is that if an embedded object is a part of an element collection, then the embedded object in the collection can only include mappings where the foreign key is stored in the source table. It can contain owned relationships, such as one-to-one and many-to-one, but it cannot contain one-to-many or many-to-many relationships where the foreign key is in either the target table or a join table<a id="cXXX.695" target="_blank" rel="noopener noreferrer"></a>. Similarly, it can‚Äôt contain other collection table-based mappings like element collections.</p>
        </div>
        <div>
          <p id="Sec12" class="Heading2">Overriding Embedded Relationships</p>
          <p class="noindent">When we first introduced embeddables back in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we showed how embeddable types could be reused by being embedded within multiple entity classes. Even though the state is mapped within the embeddable, the embedding entity can override those mappings by using <span class="FontName2">&#64;AttributeOverride</span> to redefine how the embedded state is mapped within that particular entity table. Now that we are using relationships within embeddables, <span class="FontName2">&#64;AttributeOverride</span> does not suffice. To override how a relationship is mapped, we need to use <span class="FontName2">&#64;AssociationOverride</span>, which provides us with the ability to override relationship<a id="cXXX.655" target="_blank" rel="noopener noreferrer"></a> join columns and join tables.</p>
          <p class="indent">Before we look at an example of overriding an embeddable with a relationship in it, let‚Äôs first think about the reusability of such an object. If a relationship from entity A to entity B is defined within the embeddable of type E, then either the relationship is owned by A and the foreign key is in the table corresponding to A (or in a join table owned by A), or it is owned by B and the foreign key is going to be in B‚Äôs table (or a join table owned by B). If it is owned by B, then the foreign key will be to A‚Äôs table, and there would be no way to use E in any other entity because the foreign key would be to the wrong table. Similarly, if the relationship was bidirectional, then the attribute in B would be of type A (or a collection of A) and could not refer to an object of some other type. It can be understood, therefore, that only embeddables with relationships that are owned by the source entity, A, and that are unidirectional, can be reused in other entities.</p>
          <p class="indent">Suppose the many-to-many relationship in <span class="FontName2">ContactInfo</span> was unidirectional and <span class="FontName2">Phone</span> didn‚Äôt have a reference back to the <span class="FontName2">Employee</span> that embedded the <span class="FontName2">ContactInfo</span>. We might want to embed instances of <span class="FontName2">ContactInfo</span> within a <span class="FontName2">Customer</span> entity as well. The <span class="FontName2">CUSTOMER</span> table, however, might have a <span class="FontName2">PRI_CONTACT</span> foreign key column instead of <span class="FontName2">PRI_NUM</span>, and of course we would not be able to share the same join table for both <span class="FontName2">Employee</span> and <span class="FontName2">Customer</span> relationships to the <span class="FontName2">Phone</span>. The resulting <span class="FontName2">Customer</span> class is shown in <a href="#list8" id="_list8" target="_blank" rel="noopener noreferrer">Listing 10-8</a>.</p>
          <p class="noindent2"><a href="#_list8" id="list8" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-8.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Customer</span> Class Embedding <span class="FontName2">ContactInfo</span></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Customer {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="address.zip", column=&#64;Column(name="ZIP"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverride(name="primaryPhone",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="EMERG_PHONE")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AssociationOverride(name="phones",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinTable=&#64;JoinTable(name="CUST_PHONE"))})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private ContactInfo contactInfo;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We can override the <span class="FontName2">zip</span> attribute in the address that is embedded within <span class="FontName2">contactInfo</span> by using <span class="FontName2">&#64;AttributeOverride</span> and navigating to the attribute in the nested embedded <span class="FontName2">Address</span> object.</p>
          <p class="indent">Because we are overriding two associations we need to use the plural variant of <span class="FontName2">&#64;AssociationOverrides</span>. Note that if there had not been a join table explicitly specified for the <span class="FontName2">phones</span> attribute, then the default join table name would have been different depending upon which entity was embedding the <span class="FontName2">ContactInfo</span>. Since the default name is composed partly of the name of the owning entity, the table joining the <span class="FontName2">Employee</span> entity to the <span class="FontName2">Phone</span> entity would have defaulted to <span class="FontName2">EMPLOYEE_PHONE</span>, whereas in <span class="FontName2">Customer</span> the join table would have defaulted to <span class="FontName2">CUSTOMER_PHONE</span>.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;There is currently no way to override the collection table for an element collection in an embeddable.</p>
          </div>
        </div>
        <p class="Heading1" id="Sec13">Compound Primary Keys<a id="cXXX.656a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.656" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">In some cases, an entity needs to have a primary key or identifier that is composed of multiple fields, or from the database perspective the primary key in its table is made up of multiple columns. This is more common for legacy databases and also occurs when a primary key is composed of a relationship, a topic that we will discuss later in this chapter.</p>
        <p class="indent">There are two options available for having compound primary keys in an entity, depending on how the entity class is structured. Both of them require the use of a separate class containing the primary key fields called a primary key class; the difference between the two options is determined by what the entity class contains.</p>
        <p class="indent">Primary key classes must include method definitions for <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> in order to be able to be stored and keyed on by the persistence provider, and their fields or properties must be in the set of valid identifier types listed in the previous chapter. They must also be public, implement <span class="FontName2">Serializable</span>, and have a no-arg constructor.</p>
        <p class="indent">As an example of a compound primary key, we will look at the <span class="FontName2">Employee</span> entity<a id="cXXX.657" target="_blank" rel="noopener noreferrer"></a> again, only this time the employee number is specific to the country where he works. Two employees in different countries can have the same employee number, but only one can be used within any given country. <a href="#Fig2" id="_Fig2" target="_blank" rel="noopener noreferrer">Figure 10-2</a> shows the <span class="FontName2">EMPLOYEE</span> table structured with a compound primary key to capture this requirement. Given this table definition, we will now look at how to map the <span class="FontName2">Employee</span> entity using the two different styles of primary key class.</p>
        <div class="Figure" id="Fig2">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-02.jpg" alt="9781430249269_Fig10-02.jpg" width="196" height="206"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig2" target="_blank" rel="noopener noreferrer">Figure 10-2</a>. </span>EMPLOYEE table with a compound primary key</p>
        </div>
        <div>
          <p id="Sec14" class="Heading2">Id Class<a id="cXXX.658" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The first and most basic type of primary key class is an id class. Each field of the entity that makes up the primary key is marked with the <span class="FontName2">&#64;Id</span> annotation. The primary key class is defined separately and associated with the entity by using the <span class="FontName2">&#64;IdClass</span> annotation on the entity class definition. <a href="#list9" id="_list9" target="_blank" rel="noopener noreferrer">Listing 10-9</a> demonstrates an entity with a compound primary key that uses an id class. The accompanying id class is shown in <a href="#list10" id="_list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a>.</p>
          <p class="noindent2"><a href="#_list9" id="list9" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-9.</i></b></a>&nbsp;&nbsp;Using an Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The primary key class must contain fields or properties that match the primary key attributes in the entity in both name and type. <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a> shows the <span class="FontName2">EmployeeId</span> primary key class. It has two fields, one to represent the country and one to represent the employee number. We have also supplied <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> methods to allow the class to be used in sorting and hashing operations.</p>
          <p class="noindent2"><a href="#_list10" id="list10" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-10.</i></b></a>&nbsp;&nbsp;The <span class="FontName2">EmployeeId</span> Id Class<a id="cXXX.659" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public class EmployeeId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String getCountry() { return country; }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int getId() { return id; }</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public boolean equals(Object o) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return ((o instanceof EmployeeId) &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">country.equals(((EmployeeId)o).getCountry()) &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">id == ((EmployeeId)o).getId());</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int hashCode() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return country.hashCode() + id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that there are no setter methods on the <span class="FontName2">EmployeeId</span> class. Once it has been constructed using the primary key values, it can‚Äôt be changed. We do this to enforce the notion that a primary key value cannot be changed, even when it is made up of multiple fields. Because the <span class="FontName2">&#64;Id</span> annotation was placed on the fields of the entity, the provider will also use field access when it needs to work with the primary key class.</p>
          <p class="indent">The id class is useful as a structured object that encapsulates all of the primary key information. For example, when doing a query based upon the primary key, such as the <span class="FontName2">find()</span> method of the <span class="FontName2">EntityManager</span> interface, an instance of the id class can be used as an argument instead of some unstructured and unordered collection of primary key data. <a href="#list11" id="_list11" target="_blank" rel="noopener noreferrer">Listing 10-11</a> shows a code snippet that searches for an <span class="FontName2">Employee</span> with a given country name and employee number. A new instance of the <span class="FontName2">EmployeeId</span> class is constructed using the method arguments and then used as the argument to the <span class="FontName2">find()</span> method.</p>
          <p class="noindent2"><a href="#_list11" id="list11" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-11.</i></b></a>&nbsp;&nbsp;Invoking a Primary Key Query on an Entity with an Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">EmployeeId id = new EmployeeId(country, id);</span><br><span class="FontName2">Employee emp = em.find(Employee.class, id);</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Because the argument to <span class="FontName2">find()</span> is of type <span class="FontName2">Object</span>, vendors can support passing in simple arrays or collections of primary key information. Passing arguments that are not primary key classes is not portable.</p>
          </div>
        </div>
        <div>
          <p id="Sec15" class="Heading2">Embedded Id Class<a id="cXXX.660" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">An entity that contains a single field of the same type as the primary key class is said to use an embedded id class. The embedded id class is just an embedded object that happens to be composed of the primary key components. We use an <span class="FontName2">&#64;EmbeddedId</span> annotation to indicate that it is not just a regular embedded object but also a primary key class. When we use this approach, there are no <span class="FontName2">&#64;Id</span> annotations on the class, nor is the <span class="FontName2">&#64;IdClass</span> annotation used. You can think of <span class="FontName2">&#64;EmbeddedId</span> as the logical equivalent to putting both <span class="FontName2">&#64;Id</span> and <span class="FontName2">&#64;Embedded</span> on the field.</p>
          <p class="indent">Like other embedded objects, the embedded id class must be annotated with <span class="FontName2">&#64;Embeddable</span>, but the access type might differ from that of the entity that uses it. <a href="#list12" id="_list12" target="_blank" rel="noopener noreferrer">Listing 10-12</a> shows the <span class="FontName2">EmployeeId</span> class again, this time as an embeddable primary key class. The getter methods, <span class="FontName2">equals()</span> and <span class="FontName2">hashCode()</span> implementations are the same as the previous version from <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a>.</p>
          <p class="noindent2"><a href="#_list12" id="list12" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-12.</i></b></a>&nbsp;&nbsp;Embeddable Primary Key Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class EmployeeId {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public EmployeeId(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Using the embedded primary key class is no different than using a regular embedded type, except that the annotation used on the attribute is <span class="FontName2">&#64;EmbeddedId</span> instead of <span class="FontName2">&#64;Embedded</span>. <a href="#list13" id="_list13" target="_blank" rel="noopener noreferrer">Listing 10-13</a> shows the <span class="FontName2">Employee</span> entity adjusted to use the embedded version of the <span class="FontName2">EmployeeId</span> class. Note that since the column mappings are present on the embedded type, we do not specify the mapping for <span class="FontName2">EMP_ID</span> as was done in the case of the id class. If the embedded primary key class is used by more than one entity, then the <span class="FontName2">&#64;AttributeOverride</span> annotation can be used to customize mappings just as you would for a regular embedded type. To return the <span class="FontName2">country</span> and <span class="FontName2">id</span> attributes of the primary key from getter methods, we must delegate to the embedded id object to obtain the values.</p>
          <p class="noindent2"><a href="#_list13" id="list13" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-13.</i></b></a>&nbsp;&nbsp;Using an Embedded Id Class</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private EmployeeId id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.id = new EmployeeId(country, id);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public String getCountry() { return id.getCountry(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public int getId() { return id.getId(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We can create an instance of <span class="FontName2">EmployeeId</span> and pass it to the <span class="FontName2">find()</span> method just as we did for the id class example, but, if we want to create the same query using JP QL and reference the primary key, we have to traverse the embedded id class explicitly. <a href="#list14" id="_list14" target="_blank" rel="noopener noreferrer">Listing 10-14</a> shows this technique. Even though <span class="FontName2">id</span> is not a relationship, we still traverse it using the dot notation in order to access the members of the embedded class.</p>
          <p class="noindent2"><a href="#_list14" id="list14" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-14.</i></b></a>&nbsp;&nbsp;Referencing an Embedded Id Class in a Query</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public Employee findEmployee(String country, int id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">return (Employee)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">em.createQuery("SELECT e " +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">"FROM Employee e " +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">"WHERE e.id.country = ?1 AND e.id.id = ?2")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.setParameter(1, country)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.setParameter(2, id)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">.getSingleResult();</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The decision to use a single embedded identifier attribute or a group of identifier attributes, each mapped separately in the entity class, mostly comes down to personal preference. Some people like to encapsulate the identifier components into a single entity attribute of the embedded identifier class type. The trade-off is that it makes dereferencing a part of the identifier a little bit longer in code or in JP QL, although having helper methods, like those in <a href="#list13" target="_blank" rel="noopener noreferrer">Listing 10-13</a>, can help.</p>
          <p class="indent">If you access or set parts of the identifier individually, then it might make more sense to create a separate entity attribute for each of the constituent identifier parts. This presents a more representative model and interface for the separate identifier components. However, if most of the time you reference and pass around the entire identifier as an object, then you might be better off with an embedded identifier that creates and stores a single instance of the composite identifier.</p>
        </div>
        <p class="Heading1" id="Sec16">Derived Identifiers<a id="cXXX.661" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">When an identifier in one entity includes a foreign key to another entity, it‚Äôs called a derived identifier. Because the entity containing the derived identifier depends upon another entity for its identity, the first is called the dependent entity<a id="cXXX.662" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.663" target="_blank" rel="noopener noreferrer"></a>. The entity that it depends upon is the target of a many-to-one or one-to-one relationship from the dependent entity, and is called the parent entity<a id="cXXX.664" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.665" target="_blank" rel="noopener noreferrer"></a>. <a href="#Fig3" id="_Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a> shows an example of a data model for the two kinds of entities, with <span class="FontName2">DEPARTMENT</span> table representing the parent entity and <span class="FontName2">PROJECT</span> table representing the dependent entity. Note that in this example there is an additional <span class="FontName2">name</span> primary key column in <span class="FontName2">PROJECT</span>, meaning that the corresponding <span class="FontName2">Project</span> entity has an identifier attribute that is not part of its relationship to <span class="FontName2">Department</span>.</p>
        <div class="Figure" id="Fig3">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-03.jpg" alt="9781430249269_Fig10-03.jpg" width="540" height="192"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>. </span>Dependent and parent entity tables</p>
        </div>
        <p class="indent">The dependent object cannot exist without a primary key, and since that primary key consists of the foreign key to the parent entity it should be clear that a new dependent entity cannot be persisted without the relationship to the parent entity being established. It is undefined to modify the primary key of an existing entity, thus the one-to-one or many-to-one relationship that is part of a derived identifier is likewise immutable and must not be reassigned to a new entity once the dependent entity has been persisted or already exists.</p>
        <p class="indent">We spent the last few sections discussing different kinds of identifiers, and you might think back to what you learned and realize that there are a number of different parameters that might affect how a derived identifier can be configured. For example, the identifier in either of the entities might be composed of one or a plurality of attributes. The relationship from the dependent entity to the parent entity might make up the entire derived identifier, or, as in <a href="#Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>, there might be additional state in the dependent entity that contributes to it. One of the entities might have a simple or compound primary key, and in the compound case might have an id class or an embedded id class. All of these factors combine to produce a multitude of scenarios, each of which requires slightly different configurations. The basic rules for derived identifiers are outlined first, with some more detailed descriptions in the following sections.</p>
        <div>
          <p id="Sec17" class="Heading2">Basic Rules<a id="cXXX.666" target="_blank" rel="noopener noreferrer"></a> for Derived Identifiers<a id="cXXX.679a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Most of the rules for derived identifiers can be summarized in a few general statements, although applying the rules together might not be quite as easy. We will go through some of the cases later to explain them, and even show an exception case or two to keep it interesting, but to lay the groundwork for those use cases the rules can be laid out as follows:</p>
          <ul class="bulleted">
            <li>A dependent entity might have multiple parent entities (i.e., a derived identifier might include multiple foreign keys).</li>
            <li>A dependent entity must have all its relationships to parent entities set before it can be persisted.</li>
            <li>If an entity class has multiple id attributes, then not only must it use an id class, but there must also be a corresponding attribute of the same name in the id class as each of the id attributes in the entity.</li>
            <li>Id attributes in an entity might be of a simple type, or of an entity type that is the target of a many-to-one or one-to-one relationship.</li>
            <li>If an id attribute in an entity is of a simple type, then the type of the matching attribute in the id class must be of the same simple type.</li>
            <li>If an id attribute in an entity is a relationship, then the type of the matching attribute in the id class is of the same type as the primary key type of the target entity in the relationship (whether the primary key type is a simple type, an id class, or an embedded id class).</li>
            <li>If the derived identifier of a dependent entity is in the form of an embedded id class, then each attribute of that id class that represents a relationship should be referred to by a <span class="FontName2">&#64;MapsId</span> annotation on the corresponding relationship attribute.</li>
          </ul>
          <p class="indent">The following sections describe how these rules may be applied.</p>
        </div>
        <div>
          <p id="Sec18" class="Heading2">Shared Primary Key</p>
          <p class="noindent">A simple, if somewhat less common case, is when the derived identifier is composed of a single attribute<a id="cXXX.667" target="_blank" rel="noopener noreferrer"></a> that is the relationship foreign key. As an example, suppose there was a bidirectional one-to-one relationship between <span class="FontName2">Employee</span> and <span class="FontName2">EmployeeHistory</span> entities. Because there is only ever one <span class="FontName2">EmployeeHistory</span> per <span class="FontName2">Employee</span>, we might decide to share the primary key. In <a href="#list15" id="_list15" target="_blank" rel="noopener noreferrer">Listing 10-15</a>, if the <span class="FontName2">EmployeeHistory</span> is the dependent entity, then we indicate that the relationship foreign key is the identifier by annotating the relationship with <span class="FontName2">&#64;Id</span>.</p>
          <p class="noindent2"><a href="#_list15" id="list15" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-15.</i></b></a>&nbsp;&nbsp;Derived Identifier with Single Attribute</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class EmployeeHistory {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The primary key type of <span class="FontName2">EmployeeHistory</span> is going to be of the same type as <span class="FontName2">Employee</span>, so if <span class="FontName2">Employee</span> has a simple integer identifier<a id="cXXX.668" target="_blank" rel="noopener noreferrer"></a> then the identifier of <span class="FontName2">EmployeeHistory</span> is also going to be an integer. If <span class="FontName2">Employee</span> has a compound primary key, either with an id class or an embedded id class, then <span class="FontName2">EmployeeHistory</span> is going to share the same id class (and should also be annotated with the <span class="FontName2">&#64;IdClass</span> annotation). The problem is that this trips over the id class rule that there should be a matching attribute in the entity for each attribute in its id class. This is the exception to the rule, because of the very fact that the id class is shared between both parent and dependent entities.</p>
          <p class="indent">Occasionally, somebody might want the entity to contain a primary key attribute as well as the relationship attribute, with both attributes mapped to the same foreign key column in the table. Even though the primary key attribute is unnecessary in the entity, some people might want to define it separately for easier access. Despite the fact that the two attributes map to the same foreign key column (which is also the primary key column), the mapping does not have to be duplicated in both places. The <span class="FontName2">&#64;Id</span> annotation is placed on the identifier attribute and <span class="FontName2">&#64;MapsId</span> annotates the relationship attribute to indicate that it is mapping the id attribute as well. This is shown in <a href="#list16" id="_list16" target="_blank" rel="noopener noreferrer">Listing 10-16</a>. Note that physical mapping annotations (e.g. <span class="FontName2">&#64;Column</span>) should not be specified on the <span class="FontName2">empId</span> attribute since <span class="FontName2">&#64;MapsId</span> is indicating that the relationship attribute is where the mapping occurs.</p>
          <p class="noindent2"><a href="#_list16" id="list16" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-16.</i></b></a>&nbsp;&nbsp;Derived Identifier with Shared Mappings<a id="cXXX.669" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class EmployeeHistory {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">int empId;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapsId</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">There are a couple of additional points worth mentioning about <span class="FontName2">&#64;MapsId</span>, before we move on to derived identifiers with multiple mapped attributes.</p>
          <p class="indent">The first point is really a logical follow-on to the fact that the relationship annotated with <span class="FontName2">&#64;MapsId</span> defines the mapping for the identifier attribute as well. If there is no overriding <span class="FontName2">&#64;JoinColumn</span> annotation<a id="cXXX.670" target="_blank" rel="noopener noreferrer"></a> on the relationship attribute, then the join column will be defaulted according to the usual defaulting rules. If this is the case, then the identifier attribute will also be mapped to that same default. For example, if the <span class="FontName2">&#64;JoinColumn</span> annotation was removed from <a href="#list16" target="_blank" rel="noopener noreferrer">Listing 10-16</a> then both the <span class="FontName2">employee</span> and the <span class="FontName2">empId</span> attributes would be mapped to the default <span class="FontName2">EMPLOYEE_ID</span> foreign key column (assuming the primary key column in the <span class="FontName2">EMPLOYEE</span> table was <span class="FontName2">ID</span>).</p>
          <p class="indent">Secondly, even though the identifier attribute shares the database mapping defined on the relationship attribute, from the perspective of the identifier attribute it is really a read-only mapping. Updates or inserts to the database foreign key column will only ever occur through the relationship attribute<a id="cXXX.671" target="_blank" rel="noopener noreferrer"></a>. This is one of the reasons why you must always remember to set the parent relationships before trying to persist a dependent entity.</p>
          <div class="notepara">
            <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Note</b>&nbsp;&nbsp;Do not attempt to set only the identifier attribute (and not the relationship attribute) as a means to shortcut persisting a dependent entity. Some providers may have special support for doing this, but it will not portably cause the foreign key to be written to the database.</p>
          </div>
          <p class="indent">The identifier attribute will get filled in automatically by the provider when an entity instance is read from the database, or flushed/committed. However, it cannot be assumed to be there when first calling <span class="FontName2">persist()</span> on an instance unless the user sets it explicitly.</p>
        </div>
        <div>
          <p id="Sec19" class="Heading2">Multiple Mapped Attributes</p>
          <p class="noindent">A more common case is probably the one in which the dependent entity has an identifier that includes not only a relationship, but also some state of its own. We will use the example shown in <a href="#Fig3" target="_blank" rel="noopener noreferrer">Figure 10-3</a>, where a <span class="FontName2">Project</span> has a compound identifier composed of a name and a foreign key to the department that manages it. With the unique identifier being the combination of its name and department, no department would be permitted to create more than one project with the same name. However, two different departments may choose the same name for their own projects. <a href="#list17" id="_list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> illustrates the trivial mapping<a id="cXXX.672" target="_blank" rel="noopener noreferrer"></a> of the <span class="FontName2">Project</span> identifier using <span class="FontName2">&#64;Id</span> on both the <span class="FontName2">name</span> and <span class="FontName2">dept</span> attributes.</p>
          <p class="noindent2"><a href="#_list17" id="list17" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-17.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Project</span> with Dependent Identifier</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(ProjectId.class)</span><br><span class="FontName2">public class Project {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_NUM",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_CTY",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">referencedColumnName="COUNTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department dept;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">The compound identifier<a id="cXXX.673" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.674" target="_blank" rel="noopener noreferrer"></a> means that we must also specify the primary key class using the <span class="FontName2">&#64;IdClass</span> annotation. Recall our rule that primary key classes must have a matching named attribute for each of the id attributes on the entity, and usually the attributes must also be of the same type. However, this rule only applies when the attributes are of simple types, not entity types. If <span class="FontName2">&#64;Id</span> is annotating a relationship, then that relationship attribute is going to be of some target entity type, and the rule extension is that the primary key class attribute must be of the same type as the primary key of the target entity. This means that the <span class="FontName2">ProjectId</span> class specified as the id class for <span class="FontName2">Project</span> in <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> must have an attribute named <span class="FontName2">name</span>, of type <span class="FontName2">String</span>, and another named <span class="FontName2">dept</span> that will be the same type as the primary key of <span class="FontName2">Department</span>. If <span class="FontName2">Department</span> has a simple integer primary key, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> will be of type <span class="FontName2">int</span>, but if <span class="FontName2">Department</span> has a compound primary key, with its own primary key class, say <span class="FontName2">DeptId</span>, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> would be of type <span class="FontName2">DeptId</span>, as shown in <a href="#list18" id="_list18" target="_blank" rel="noopener noreferrer">Listing 10-18</a>.</p>
          <p class="noindent2"><a href="#_list18" id="list18" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-18.</i></b></a>&nbsp;&nbsp;<span class="FontName2">ProjectId and DeptId</span> Id Classes<a id="cXXX.675" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">public class ProjectId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private DeptId dept;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public ProjectId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public ProjectId(DeptId deptId, String name) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.dept = deptId;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.name = name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br>&nbsp;&nbsp; <span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">public class DeptId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public DeptId() {}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public DeptId (int number, String country) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.number = number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">this.country = country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec20" class="Heading2">Using EmbeddedId</p>
          <p class="noindent">It is also possible to have a derived identifier when one or the other (or both) of the entities uses <span class="FontName2">&#64;EmbeddedId</span>. When the id class is embedded, the non-relationship identifier attributes are mapped within the embeddable id class<a id="cXXX.678a" target="_blank" rel="noopener noreferrer"></a>, as usual, but the attributes in the embedded id class that correspond to relationships are mapped by the relationship attributes in the entity. <a href="#list19" id="_list19" target="_blank" rel="noopener noreferrer">Listing 10-19</a> shows how the derived identifier is mapped in the <span class="FontName2">Project</span> class when an embedded id class is used. We annotate the relationship attribute with <span class="FontName2">&#64;MapsId(‚Äúdept‚Äù)</span>, indicating that it is also specifying the mapping for the <span class="FontName2">dept</span> attribute of the embedded id class. The <span class="FontName2">dept</span> attribute<a id="cXXX.676" target="_blank" rel="noopener noreferrer"></a> of <span class="FontName2">ProjectId</span> is of the same primary key type as <span class="FontName2">Department</span> in <a href="#list20" id="_list20" target="_blank" rel="noopener noreferrer">Listing 10-20</a>.</p>
          <p class="noindent2"><a href="#_list19" id="list19" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-19.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Project</span> and Embedded <span class="FontName2">ProjectId</span> Class<a id="cXXX.677" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Project {</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private ProjectId id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;MapsId("dept")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;JoinColumn(name="DEPT_NUM", referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">&#64;JoinColumn(name="DEPT_CTRY", referencedColumnName="CTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class ProjectId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="P_NAME")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private DeptId dept;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="noindent2"><a href="#_list20" id="list20" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-20.</i></b></a>&nbsp;&nbsp;<span class="FontName2">Department</span> and Embedded <span class="FontName2">DeptId</span> Class<a id="cXXX.678" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;EmbeddedId private DeptId id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="department")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Project&gt; projects;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Embeddable</span><br><span class="FontName2">public class DeptId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="NUM")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int number;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="CTRY")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Note that we have used multiple join columns on the <span class="FontName2">department</span> relationship because <span class="FontName2">Department</span> has a compound primary key. Mapping multipart identifiers is explained in more detail in the ‚ÄúCompound Join Columns‚Äù section later in the chapter.</p>
          <p class="indent">The <span class="FontName2">Department</span> entity has an embedded identifier, but it is not a derived identifier because the <span class="FontName2">DeptId</span> id class does not have any attributes that correspond to relationship attributes in <span class="FontName2">Department</span>. The <span class="FontName2">&#64;Column</span> annotations in the <span class="FontName2">DeptId</span> class map the identifier fields in the <span class="FontName2">Department</span> entity, but when <span class="FontName2">DeptId</span> is embedded in <span class="FontName2">ProjectId</span>, those column mappings do not apply. Once the <span class="FontName2">dept</span> attribute is mapped by the <span class="FontName2">department</span> relationship in <span class="FontName2">Project</span>, the <span class="FontName2">&#64;JoinColumn</span> annotations on that relationship are used as the column mappings for the <span class="FontName2">PROJECT</span> table.</p>
          <p class="indent">If the <span class="FontName2">Department</span> class had a simple primary key, for example a long instead of an id class, then the <span class="FontName2">dept</span> attribute in <span class="FontName2">ProjectId</span> would just be the simple primary key type of <span class="FontName2">Department</span> (the <span class="FontName2">long</span> type), and there would only be one join column on the many-to-one <span class="FontName2">department</span> attribute in <span class="FontName2">Project</span>.</p>
          <div class="singlethin">
            <p class="Heading4a">ALTERNATIVE TO DERIVED IDENTIFIERS<a id="cXXX.679" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The <span class="FontName2">&#64;MapsId</span> annotation and the ability to apply <span class="FontName2">&#64;Id</span> to relationship attributes was introduced in JPA 2.0 to improve the situation that existed in JPA 1.0. At that time, only the one-to-one shared primary key scenario was specified using the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation (using the <span class="FontName2">&#64;Id</span> annotation is the preferred and recommended method going forward).</p>
            <p class="noindent">Although there was no specified way to solve the general case of including a foreign key in an identifier, it was generally supported through the practice of adding one or more additional (redundant) fields to the dependent entity. Each added field would hold a foreign key to the related entity, and, because both the added field and the relationship would be mapped to the same join column(s), one or the other of the two would need to be marked as read-only (see ‚ÄúRead-Only Mappings‚Äù section), or not updatable or insertable. The following example shows how <a href="#list17" target="_blank" rel="noopener noreferrer">Listing 10-17</a> would be done using JPA 1.0. The id class would be the same. Since the <span class="FontName2">deptNumber</span> and <span class="FontName2">deptCountry</span> attributes are identifier attributes, and can‚Äôt be changed in the database, there is no need to set their updatability to false.</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(ProjectId.class)</span><br><span class="FontName2">public class Project {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DEPT_NUM", insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int deptNumber;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="DEPT_CTRY", insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String deptCountry;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_NUM", referencedColumnName="NUM"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_CTRY", referencedColumnName="CTRY")})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br><br><span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
        </div>
        <p id="Sec21" class="Heading1">Advanced Mapping Elements</p>
        <p class="noindent">Additional elements<a id="cXXX.684b" target="_blank" rel="noopener noreferrer"></a> may be specified on the <span class="FontName2">&#64;Column</span> and <span class="FontName2">&#64;JoinColumn</span> annotations (and their <span class="FontName2">&#64;MapKeyColumn</span>, <span class="FontName2">&#64;MapKeyJoinColumn</span>, and <span class="FontName2">&#64;OrderColumn</span> relatives), some of which apply to schema generation that will be discussed in <a href="9781430249269_Ch14.xhtml" target="_blank" rel="noopener noreferrer">Chapter 14</a>. Other parts we can describe separately as applying to columns and join columns in the following sections.</p>
        <div>
          <p id="Sec22" class="Heading2">Read-Only Mappings<a id="cXXX.680" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.681" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">JPA does not really define any kind of read-only entity, although it will likely show up in a future release. The API does, however, define options to set individual mappings to be read-only using the <span class="FontName2">insertable</span> and <span class="FontName2">updatable</span> elements of the <span class="FontName2">&#64;Column</span> and <span class="FontName2">&#64;JoinColumn</span> annotations<a id="cXXX.682" target="_blank" rel="noopener noreferrer"></a>. These two settings default to true but can be set to false if we want to ensure that the provider will not insert or update information in the table in response to changes in the entity instance. If the data in the mapped table already exists and we want to ensure that it will not be modified at runtime, then the <span class="FontName2">insertable</span> and <span class="FontName2">updatable</span> elements can be set to false, effectively preventing the provider from doing anything other than reading the entity from the database. <a href="#list21" id="_list21" target="_blank" rel="noopener noreferrer">Listing 10-21</a> demonstrates the <span class="FontName2">Employee</span> entity with read-only mappings.</p>
          <p class="noindent2"><a href="#_list21" id="list21" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-21.</i></b></a>&nbsp;&nbsp;Making An Entity Read-only<a id="cXXX.683" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">We don‚Äôt need to worry about the identifier mapping being modified, because it is illegal to modify identifiers. The other mappings, though, are marked as not being able to be inserted or updated, so we are assuming that there are already entities in the database to be read in and used. No new entities will be persisted, and existing entities will never be updated.</p>
          <p class="indent">Note that this does not guarantee that the entity state will not change in memory. <span class="FontName2">Employee</span> instances could still get changed either inside or outside a transaction, but at transaction commit time or whenever the entities get flushed to the database, this state will not be saved and the provider will likely not throw an exception to indicate it. Be careful modifying read-only mappings in memory, however, as changing the entities can cause them to become inconsistent with the state in the database and could wreak havoc on a vendor-specific cache.</p>
          <p class="indent">Even though all of these mappings are not updatable, the entity as a whole could still be deleted. A proper read-only feature will solve this problem once and for all in a future release, but in the meantime some vendors support the notion of read-only entities, and can optimize the treatment of them in their caches and persistence context implementations.</p>
        </div>
        <div>
          <p id="Sec23" class="Heading2">Optionality<a id="cXXX.684" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">As we will see in <a href="9781430249269_Ch14.xhtml" target="_blank" rel="noopener noreferrer">Chapter 14</a>, when we talk about schema generation, there exists metadata that either permits the database columns to be null or requires them to have values. While this setting will affect the physical database schema, there are also settings on some of the logical mappings that allow a basic mapping or a single-valued association mapping to be left empty or required to be specified in the object model. The element that requires or permits such behavior is the <span class="FontName2">optional</span> element in the <span class="FontName2">&#64;Basic</span>, <span class="FontName2">&#64;ManyToOne</span>, and <span class="FontName2">&#64;OneToOne</span> annotations.</p>
          <p class="indent">When the <span class="FontName2">optional</span> element is specified as false, it indicates to the provider that the field or property mapping may not be null. The API does not actually define what the behavior is in the case when the value is null, but the provider may choose to throw an exception or simply do something else. For basic mappings, it is only a hint and can be completely ignored. The <span class="FontName2">optional</span> element may also be used by the provider when doing schema generation, because, if <span class="FontName2">optional</span> is set to true, then the column in the database must also be nullable.</p>
          <p class="indent">Because the API does not go into any detail about ordinality of the object model, there is a certain amount of non-portability associated with using it. An example of setting the manager to be a required attribute is shown in <a href="#list22" id="_list22" target="_blank" rel="noopener noreferrer">Listing 10-22</a>. The default value for <span class="FontName2">optional</span> is true, making it necessary to be specified only if a false value is needed.</p>
          <p class="noindent2"><a href="#_list22" id="list22" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-22.</i></b></a>&nbsp;&nbsp;Using Optional Mappings<a id="cXXX.685" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne(optional=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID", insertable=false, updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <p id="Sec24" class="Heading1">Advanced Relationships<a id="cXXX.686a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.686" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">If you are in the opportune position of starting from a Java application and creating a database schema, then you have complete control over what the schema looks like and how you map the classes to the database. In this case, it is likely that you will not need to use very many of the advanced relationship features that are offered by the API. The flexibility of being able to define a data model usually makes for a less demanding mapping configuration. However, if you are in the unfortunate situation of mapping a Java model to an existing database, then in order to work around the data schema you might need access to more mappings than those we have discussed so far. The mappings described in the following sections are primarily for mapping to legacy databases, and will most often be used because they are the only option. A notable exception is the orphan removal feature, used to model a parent‚Äìchild relationship.</p>
        <div>
          <p id="Sec25" class="Heading2">Using Join Tables<a id="cXXX.688a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">We have already seen mappings such as the many-to-many and unidirectional one-to-many mappings that use join tables. Sometimes a database schema uses a join table to relate two entity types, even though the cardinality of the target entity in the relationship is one. A one-to-one or many-to-one relationship does not normally need a join table because the target will only ever be a single entity and the foreign key can be stored in the source entity table. But if the join table already exists for a many-to-one relationship, then of course we must map the relationship using that join table. To do so, we need only add the <span class="FontName2">&#64;JoinTable</span> annotation to the relationship mapping.</p>
          <p class="indent">Whether the relationship is unidirectional or bidirectional<a id="cXXX.687" target="_blank" rel="noopener noreferrer"></a>, the <span class="FontName2">&#64;JoinTable</span> annotation is a physical annotation and must be defined on the owning side of the relationship, just as with all other mappings. However, because a join table is not the default configuration for mappings that are not many-to-many or unidirectional one-to-many, we do need to specify the annotation when we want a join table to be used. The elements of the <span class="FontName2">&#64;JoinTable</span> annotation can still be used to override the various schema names.</p>
          <p class="indent">In <a href="#list23" id="_list23" target="_blank" rel="noopener noreferrer">Listing 10-23</a>, we see a join table being used for a many-to-one relationship from <span class="FontName2">Employee</span> to <span class="FontName2">Department</span>. The relationship may be unidirectional or it may be bidirectional, with a one-to-many relationship from <span class="FontName2">Department</span> back to <span class="FontName2">Employee</span>, but in either case the ‚Äúmany‚Äù side must always be the owner. The reason is because even if it were bidirectional, the <span class="FontName2">&#64;ManyToOne</span> side could not be the owner because there would be no way for the <span class="FontName2">&#64;ManyToOne</span> attribute to refer to the owning <span class="FontName2">&#64;OneToMany</span> attribute side. There is no <span class="FontName2">mappedBy</span> element in the <span class="FontName2">&#64;ManyToOne</span> annotation definition.</p>
          <p class="noindent2"><a href="#_list23" id="list23" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-23.</i></b></a>&nbsp;&nbsp;Many-to-One Mapping<a id="cXXX.688" target="_blank" rel="noopener noreferrer"></a> Using a Join Table</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(name="EMP_DEPT")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Department department;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">As with most other mappings, the non-owning side of a bidirectional relationship does not change based upon whether the relationship is mapped using a join table or not. It simply refers to the owning relationship and lets it map to the physical tables/columns accordingly.</p>
        </div>
        <div>
          <p id="Sec26" class="Heading2">Avoiding Join Tables</p>
          <p class="noindent">Up to this point, we have discussed a unidirectional one-to-many mapping in the context of using a join table, but it is also possible to map a unidirectional mapping without using a join table. It requires the foreign key to be in the target table, or ‚Äúmany‚Äù side of the relationship, even though the target object does not have any reference to the ‚Äúone‚Äù side. This is called a unidirectional one-to-many target foreign key mapping, because the foreign key is in the target table instead of a join table.</p>
          <p class="indent">To use this mapping, we first indicate that the one-to-many relationship<a id="cXXX.689" target="_blank" rel="noopener noreferrer"></a> is unidirectional by not specifying any <span class="FontName2">mappedBy</span> element in the annotation. Then we specify a <span class="FontName2">&#64;JoinColumn</span> annotation on the one-to-many attribute to indicate the foreign key column. The catch is that the join column that we are specifying applies to the table of the target object, not the source object in which the annotation appears.</p>
          <p class="indent">The example in <a href="#list24" id="_list24" target="_blank" rel="noopener noreferrer">Listing 10-24</a> shows how simple it is to map a unidirectional one-to-many mapping using a target foreign key. The <span class="FontName2">DEPT_ID</span> column refers to the table mapped by <span class="FontName2">Employee</span>, and is a foreign key to the <span class="FontName2">DEPARTMENT</span> table, even though the <span class="FontName2">Employee</span> entity does not have any relationship attribute back to <span class="FontName2">Department</span>.</p>
          <p class="noindent2"><a href="#_list24" id="list24" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-24.</i></b></a>&nbsp;&nbsp;Unidirectional One-to-Many Mapping Using a Target Foreign Key<a id="cXXX.690" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Department {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="DEPT_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Employee&gt; employees;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Before you use this mapping, you should understand the implications of doing so, as they can be quite negative, both from a modeling perspective and a performance perspective. Each row in the <span class="FontName2">EMPLOYEE</span> table corresponds to an <span class="FontName2">Employee</span> instance, with each column corresponding to some state or relationship in the instance. When there is a change in the row, there is the assumption that some kind of change occurred to the corresponding <span class="FontName2">Employee</span>, but in this case that does not necessarily follow. The <span class="FontName2">Employee</span> might have just been changed to a different <span class="FontName2">Department</span>, and because there was no reference to the <span class="FontName2">Department</span> from the <span class="FontName2">Employee</span> there was no change to the <span class="FontName2">Employee</span>.</p>
          <p class="indent">From a performance standpoint, think of the case when both the state of an <span class="FontName2">Employee</span> is changed and the <span class="FontName2">Department</span> that it belongs to is changed. When writing out the <span class="FontName2">Employee</span> state, the foreign key to the <span class="FontName2">Department</span> is not known because the <span class="FontName2">Employee</span> entity does not have any reference to it. In this case, the <span class="FontName2">Employee</span> might have to be written out twice, once for the changed state of the <span class="FontName2">Employee</span>, and a second time when the <span class="FontName2">Department</span> entity changes are written out, and the foreign key from <span class="FontName2">Employee</span> to <span class="FontName2">Department</span> must be updated to point to the <span class="FontName2">Department</span> that is referring to it.</p>
        </div>
        <div>
          <p id="Sec27" class="Heading2">Compound Join Columns<a id="cXXX.693a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Now that we have discussed how to create entities with compound primary keys, it is not a far stretch to figure out that, as soon as we have a relationship to an entity with a compound identifier, we will need some way to extend the way we currently reference it.</p>
          <p class="indent">Up to this point, we have dealt with the physical relationship mapping only as a join column, but, if the primary key that we are referencing is composed of multiple fields, then we will need multiple join columns. This is why we have the plural <span class="FontName2">&#64;JoinColumns</span> annotation<a id="cXXX.691" target="_blank" rel="noopener noreferrer"></a> that can hold as many join columns as we need to put into it.</p>
          <p class="indent">There are no default values for join column names when we have multiple join columns. The simplest answer is to require the user to assign them, so, when multiple join columns are used, both the <span class="FontName2">name</span> element and the <span class="FontName2">referencedColumnName</span> element, which indicates the name of the primary key column in the target table, must be specified.</p>
          <p class="indent">Now that we are getting into more complex scenarios, let‚Äôs add a more interesting relationship to the mix. Let‚Äôs say that employees have managers and that each manager has a number of employees that work for him. You may not find that very interesting until you realize that managers are themselves employees, so the join columns are actually self-referential<a id="cXXX.692" target="_blank" rel="noopener noreferrer"></a>, that is, referring to the same table they are stored in. <a href="#Fig4" id="_Fig4" target="_blank" rel="noopener noreferrer">Figure 10-4</a> shows the <span class="FontName2">EMPLOYEE</span> table<a id="cXXX.693" target="_blank" rel="noopener noreferrer"></a> with this relationship.</p>
          <div class="Figure" id="Fig4">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-04.jpg" alt="9781430249269_Fig10-04.jpg" width="269" height="265"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig4" target="_blank" rel="noopener noreferrer">Figure 10-4</a>. </span>EMPLOYEE table with self-referencing compound foreign key</p>
          </div>
          <p class="indent"><a href="#list25" id="_list25" target="_blank" rel="noopener noreferrer">Listing 10-25</a> shows a version of the <span class="FontName2">Employee</span> entity that has a <span class="FontName2">manager</span> relationship, which is many-to-one from each of the managed employees to the manager, and a one-to-many <span class="FontName2">directs</span> relationship from the manager to its managed employees.</p>
          <p class="noindent2"><a href="#_list25" id="list25" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-25.</i></b></a>&nbsp;&nbsp;Self-referencing Compound Relationships</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_ID", referencedColumnName="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="manager")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Employee&gt; directs;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Any number of join columns can be specified, although in practice very seldom are there more than two. The plural form of <span class="FontName2">&#64;JoinColumns</span> may be used on many-to-one or one-to-one relationships<a id="cXXX.694" target="_blank" rel="noopener noreferrer"></a> or more generally whenever the single <span class="FontName2">&#64;JoinColumn</span> annotation is valid.</p>
          <p class="indent">Another example to consider is in the join table of a many-to-many relationship. We can revisit the <span class="FontName2">Employee</span> and <span class="FontName2">Project</span> relationship described in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> to take into account our compound primary key in <span class="FontName2">Employee</span>. The new table structure for this relationship is shown in <a href="#Fig5" id="_Fig5" target="_blank" rel="noopener noreferrer">Figure 10-5</a>.</p>
          <div class="Figure" id="Fig5">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-05.jpg" alt="9781430249269_Fig10-05.jpg" width="708" height="163"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig5" target="_blank" rel="noopener noreferrer">Figure 10-5</a>. </span>Join table with a compound primary key</p>
          </div>
          <p class="indent">If we keep the <span class="FontName2">Employee</span> entity as the owner, where the join table is defined, then the mapping for this relationship will be as shown in <a href="#list26" id="_list26" target="_blank" rel="noopener noreferrer">Listing 10-26</a>.</p>
          <p class="noindent2"><a href="#_list26" id="list26" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-26.</i></b></a>&nbsp;&nbsp;Join Table with Compound Join Columns</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToMany</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinTable(</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">name="EMP_PROJECT",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">joinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID", referencedColumnName="EMP_ID")},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">inverseJoinColumns=&#64;JoinColumn(name="PROJECT_ID"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;Project&gt; projects;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <div>
          <p id="Sec28" class="Heading2">Orphan Removal<a id="cXXX.696" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">The <span class="FontName2">orphanRemoval</span> element<a id="cXXX.697" target="_blank" rel="noopener noreferrer"></a> provides a convenient way of modeling parent-child relationships, or more specifically privately owned relationships. We differentiate these two because privately owned is a particular variety of parent-child in which the child entity may only be a child of one parent entity, and may not ever belong to a different parent. While some parent-child relationships allow the child to migrate from one parent to another, in a privately owned mapping the owned entity was created to belong to the parent and cannot ever be migrated. Once it is removed from the parent, it is considered orphaned and is deleted by the provider.</p>
          <p class="indent">Only relationships with single cardinality on the source side can enable orphan removal, which is why the <span class="FontName2">orphanRemoval</span> option is defined on the <span class="FontName2">&#64;OneToOne</span> and <span class="FontName2">&#64;OneToMany</span> relationship annotations, but on neither of the <span class="FontName2">&#64;ManyToOne</span> or <span class="FontName2">&#64;ManyToMany</span> annotations.</p>
          <p class="indent">When specified, the <span class="FontName2">orphanRemoval</span> element causes the child entity to be removed when the relationship between the parent and the child is broken. This can be done either by setting to null the attribute that holds the related entity, or additionally in the one-to-many case by removing the child entity from the collection. The provider is then responsible, at flush or commit time (whichever comes first), for removing the orphaned child entity.</p>
          <p class="indent">In a parent-child relationship, the child is dependent upon the existence of the parent. If the parent is removed, then by definition the child becomes an orphan and must also be removed. This second feature of orphan removal behavior is exactly equivalent to a feature that we covered in <a href="9781430249269_Ch06.xhtml" target="_blank" rel="noopener noreferrer">Chapter 6</a> called cascading, in which it is possible to cascade any subset of a defined set of operations across a relationship. Setting orphan removal on a relationship automatically causes the relationship to have the <span class="FontName2">REMOVE</span> operation option added to its cascade list, so it is not necessary to explicitly add it. Doing so is simply redundant. It is impossible to turn off cascading <span class="FontName2">REMOVE</span> from a relationship marked for orphan removal since its very definition requires such behavior to be present.</p>
          <p class="indent">In <a href="#list27" id="_list27" target="_blank" rel="noopener noreferrer">Listing 10-27</a>, the <span class="FontName2">Employee</span> class defines a one-to-many relationship to its list of annual evaluations. It doesn‚Äôt matter whether the relationship is unidirectional or bidirectional, the configuration and semantics are the same, so we need not show the other side of the relationship.</p>
          <p class="noindent2"><a href="#_list27" id="list27" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-27.</i></b></a>&nbsp;&nbsp;Employee Class with Orphan Removal<a id="cXXX.698" target="_blank" rel="noopener noreferrer"></a> of Evaluation Entities</p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(orphanRemoval=true)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private List&lt;Evaluation&gt; evals;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Suppose an employee receives an unfair evaluation from a manager. The employee might go to the manager to correct the information and the evaluation might be modified, or the employee might have to appeal the evaluation, and if successful the evaluation might simply be removed from the employee record. This would cause it to be deleted from the database as well. If the employee decided to leave the company, then when the employee is removed from the system his evaluations will be automatically removed along with him.</p>
          <p class="indent">If the collection in the relationship was a <span class="FontName2">Map</span>, keyed by a different entity type, then orphan removal would only apply to the entity values in the <span class="FontName2">Map</span>, not to the keys. This means that entity keys are never privately owned.</p>
          <p class="indent">Finally, if the orphaned object is not currently managed in the persistence context, either because it has been created in memory and not yet persisted or because it is simply detached from the persistence context, orphan removal will not be applied. Similarly, if it has already been removed in the current persistence context orphan removal will not be applied.</p>
        </div>
        <div>
          <p id="Sec29" class="Heading2">Mapping Relationship State<a id="cXXX.687a" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">There are times when a relationship actually has state associated with it. For example, let‚Äôs say that we want to maintain the date an employee was assigned to work on a project. Storing the state on the employee is possible but less helpful, since the date is really coupled to the employee‚Äôs relationship to a particular project (a single entry in the many-to-many association). Taking an employee off a project should really just cause the assignment date to go away, so storing it as part of the employee means that we have to ensure that the two are consistent with each other, which can be bothersome. In UML, we would show this kind of relationship using an association class. <a href="#Fig6" id="_Fig6" target="_blank" rel="noopener noreferrer">Figure 10-6</a> shows an example of this technique.</p>
          <div class="Figure" id="Fig6">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-06.jpg" alt="9781430249269_Fig10-06.jpg" width="675" height="329"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig6" target="_blank" rel="noopener noreferrer">Figure 10-6</a>. </span>Modeling state on a relationship using an association class<a id="cXXX.699" target="_blank" rel="noopener noreferrer"></a></p>
          </div>
          <p class="indent">In the database, everything is rosy because we can simply add a column to the join table. The data model provides natural support for relationship state. <a href="#Fig7" id="_Fig7" target="_blank" rel="noopener noreferrer">Figure 10-7</a> shows the many-to-many relationship between <span class="FontName2">EMPLOYEE</span> and <span class="FontName2">PROJECT</span> with an expanded join table.</p>
          <div class="Figure" id="Fig7">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-07.jpg" alt="9781430249269_Fig10-07.jpg" width="708" height="142"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig7" target="_blank" rel="noopener noreferrer">Figure 10-7</a>. </span>Join table<a id="cXXX.700" target="_blank" rel="noopener noreferrer"></a> with additional state</p>
          </div>
          <p class="indent">When we get to the object model, however, it becomes much more problematic. The issue is that Java has no inherent support for relationship state. Relationships are just object references or pointers, hence no state can ever exist on them. State exists on objects only, and relationships are not first-class objects.</p>
          <p class="indent">The Java solution is to turn the relationship into an entity that contains the desired state and map the new entity to what was previously the join table. The new entity will have a many-to-one relationship to each of the existing entity types, and each of the entity types will have a one-to-many relationship back to the new entity representing the relationship. The primary key of the new entity will be the combination of the two relationships to the two entity types. <a href="#list28" id="_list28" target="_blank" rel="noopener noreferrer">Listing 10-28</a> shows all of the participants in the <span class="FontName2">Employee</span> and <span class="FontName2">Project</span> relationship.</p>
          <p class="noindent2"><a href="#_list28" id="list28" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-28.</i></b></a>&nbsp;&nbsp;Mapping Relationship State with an Intermediate Entity<a id="cXXX.701" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="employee")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;ProjectAssignment&gt; assignments;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Project {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;OneToMany(mappedBy="project")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Collection&lt;ProjectAssignment&gt; assignments;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP_PROJECT")</span><br><span class="FontName2">&#64;IdClass(ProjectAssignmentId.class)</span><br><span class="FontName2">public class ProjectAssignment {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee employee;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="PROJECT_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Project project;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="START_DATE", updatable=false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">public class ProjectAssignmentId implements Serializable {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int employee;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int project;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
          <p class="indent">Here we have the primary key entirely composed of relationships, with the two foreign key columns making up the primary key in the <span class="FontName2">EMP_PROJECT</span> join table. The date at which the assignment was made could be manually set when the assignment is created, or it could be associated with a trigger that causes it to be set when the assignment is created in the database. Note that, if a trigger were used, then the entity would need to be refreshed from the database in order to populate the assignment date field in the Java object.</p>
        </div>
        <p id="Sec30" class="Heading1">Multiple Tables<a id="cXXX.709a" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">The most common mapping scenarios are of the so-called meet-in-the-middle variety<a id="cXXX.702" target="_blank" rel="noopener noreferrer"></a>. This means that the data model and the object model already exist, or, if one does not exist, then it is created independently of the other model. This is relevant because there are a number of features in the Java Persistence API that attempt to address concerns that arise in this case.</p>
        <p class="indent">Up to this point, we have assumed that an entity gets mapped to a single table and that a single row in that table represents an entity. In an existing or legacy data model, it was actually quite common to spread data, even data that was tightly coupled, across multiple tables. This was done for different administrative as well as performance reasons, one of which was to decrease table contention when specific subsets of the data were accessed or modified.</p>
        <p class="indent">To account for this, entities may be mapped across multiple tables by making use of the <span class="FontName2">&#64;SecondaryTable</span> annotation<a id="cXXX.703" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.704" target="_blank" rel="noopener noreferrer"></a> and its plural <span class="FontName2">&#64;SecondaryTables</span> form. The default table or the table defined by the <span class="FontName2">&#64;Table</span> annotation<a id="cXXX.705" target="_blank" rel="noopener noreferrer"></a> is called the primary table, and any additional ones are called secondary tables. We can then distribute the data in an entity across rows in both the primary table and the secondary tables simply by defining the secondary tables as annotations on the entity and then specifying when we map each field or property which table the column is in. We do this by specifying the name of the table in the <span class="FontName2">table</span> element in <span class="FontName2">&#64;Column</span> or <span class="FontName2">&#64;JoinColumn</span>. We did not need to use this element earlier, because the default value of <span class="FontName2">table</span> is the name of the primary table.</p>
        <p class="indent">The only bit that is left is to specify how to join the secondary table or tables to the primary table. We saw in <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a> how the primary key join column is a special case of a join column where the join column is just the primary key column (or columns in the case of composite primary keys). Support for joining secondary tables to the primary table is limited to primary key join columns and is specified as a <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation<a id="cXXX.706" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.707" target="_blank" rel="noopener noreferrer"></a> as part of the <span class="FontName2">&#64;SecondaryTable</span> annotation.</p>
        <p class="indent">To demonstrate the use of a secondary table, consider the data model shown in <a href="#Fig8" id="_Fig8" target="_blank" rel="noopener noreferrer">Figure 10-8</a>. There is a primary key relationship between the <span class="FontName2">EMP</span> and <span class="FontName2">EMP_ADDRESS</span> tables. The <span class="FontName2">EMP</span> table stores the primary employee information, while the address information has been moved to the <span class="FontName2">EMP_ADDRESS</span> table.</p>
        <div class="Figure" id="Fig8">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-08.jpg" alt="9781430249269_Fig10-08.jpg" width="579" height="233"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig8" target="_blank" rel="noopener noreferrer">Figure 10-8</a>. </span>EMP and EMP_ADDRESS tables</p>
        </div>
        <p class="indent">To map this table structure to the <span class="FontName2">Employee</span> entity, we must declare <span class="FontName2">EMP_ADDRESS</span> as a secondary table and use the table element of the <span class="FontName2">&#64;Column</span> annotation for every attribute stored in that table. <a href="#list29" id="_list29" target="_blank" rel="noopener noreferrer">Listing 10-29</a> shows the mapped entity. The primary key of the <span class="FontName2">EMP_ADDRESS</span> table is in the <span class="FontName2">EMP_ID</span> column. If it had been named <span class="FontName2">ID</span>, then we would not have needed to use the name element in the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation. It defaults to the name of the primary key column in the primary table.</p>
        <p class="noindent2"><a href="#_list29" id="list29" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-29.</i></b></a>&nbsp;&nbsp;Mapping an Entity Across Two Tables<a id="cXXX.708" target="_blank" rel="noopener noreferrer"></a></p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;SecondaryTable(name="EMP_ADDRESS",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">pkJoinColumns=&#64;PrimaryKeyJoinColumn(name="EMP_ID"))</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String street;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String city;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String state;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="ZIP_CODE", table="EMP_ADDRESS")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String zip;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">In <a href="9781430249269_Ch04.xhtml" target="_blank" rel="noopener noreferrer">Chapter 4</a>, we learned how to use the <span class="FontName2">schema</span> or <span class="FontName2">catalog</span> elements in <span class="FontName2">&#64;Table</span> to qualify the primary table to be in a particular database schema or catalog. This is also valid in the <span class="FontName2">&#64;SecondaryTable</span> annotation.</p>
        <p class="indent">Previously, when discussing embedded objects, we mapped the address fields of the <span class="FontName2">Employee</span> entity into an <span class="FontName2">Address</span> embedded type. With the address data in a secondary table, it is still possible to do this by specifying the mapped table name as part of the column information in the <span class="FontName2">&#64;AttributeOverride</span> annotation. <a href="#list30" id="_list30" target="_blank" rel="noopener noreferrer">Listing 10-30</a> demonstrates this approach. Note that we have to enumerate all of the fields in the embedded type even though the column names may match the correct default values.</p>
        <p class="noindent2"><a href="#_list30" id="list30" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-30.</i></b></a>&nbsp;&nbsp;Mapping an Embedded Type<a id="cXXX.709" target="_blank" rel="noopener noreferrer"></a> to a Secondary Table</p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;SecondaryTable(name="EMP_ADDRESS",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">pkJoinColumns=&#64;PrimaryKeyJoinColumn(name="EMP_ID"))</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Embedded</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="street", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="city", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="state", column=&#64;Column(table="EMP_ADDRESS")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="zip",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">column=&#64;Column(name="ZIP_CODE", table="EMP_ADDRESS"))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Address address;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">Let‚Äôs consider a more complex example involving multiple tables and compound primary keys. <a href="#Fig9" id="_Fig9" target="_blank" rel="noopener noreferrer">Figure 10-9</a> shows the table structure<a id="cXXX.710" target="_blank" rel="noopener noreferrer"></a> we wish to map. In addition to the <span class="FontName2">EMPLOYEE</span> table, there are two secondary tables, <span class="FontName2">ORG_STRUCTURE</span> and <span class="FontName2">EMP_LOB</span>. The <span class="FontName2">ORG_STRUCTURE</span> table stores employee and manager reporting information. The <span class="FontName2">EMP_LOB</span> table stores large objects that are infrequently fetched during normal query options. Moving large objects to a secondary table is a common design technique in many database schemas.</p>
        <div class="Figure" id="Fig9">
          <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-09.jpg" alt="9781430249269_Fig10-09.jpg" width="742" height="160"></p>
          <p class="FigCapt"><span class="CaptNr"><a href="#_Fig9" target="_blank" rel="noopener noreferrer">Figure 10-9</a>. </span>Secondary tables with compound primary key relationships</p>
        </div>
        <p class="indent"><a href="#list31" id="_list31" target="_blank" rel="noopener noreferrer">Listing 10-31</a> shows the <span class="FontName2">Employee</span> entity mapped to this table structure. The <span class="FontName2">EmployeeId</span> id class from <a href="#list10" target="_blank" rel="noopener noreferrer">Listing 10-10</a> has been reused in this example.</p>
        <p class="noindent2"><a href="#_list31" id="list31" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-31.</i></b></a>&nbsp;&nbsp;Mapping an Entity with Multiple Secondary Tables<a id="cXXX.711" target="_blank" rel="noopener noreferrer"></a></p>
        <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
          <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;IdClass(EmployeeId.class)</span><br><span class="FontName2">&#64;SecondaryTables({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;SecondaryTable(name="ORG_STRUCTURE", pkJoinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="EMP_ID", referencedColumnName="EMP_ID")}),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;SecondaryTable(name="EMP_LOB", pkJoinColumns={</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="COUNTRY", referencedColumnName="COUNTRY"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;PrimaryKeyJoinColumn(name="ID", referencedColumnName="EMP_ID")})</span><br><span class="FontName2">})</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private String country;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="EMP_ID")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int id;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Basic(fetch=FetchType.LAZY)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Lob</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_LOB")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private byte[] photo;</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Basic(fetch=FetchType.LAZY)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Lob</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(table="EMP_LOB")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private char[] comments;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumns({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_COUNTRY", referencedColumnName="COUNTRY",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">table="ORG_STRUCTURE"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;JoinColumn(name="MGR_ID", referencedColumnName="EMP_ID",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">table="ORG_STRUCTURE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">})</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
          <div class="orm-ChapterReader-snippetButtonContainer"></div>
        </div>
        <p class="indent">We have thrown a few curves into this example to make it more interesting. The first is that we have defined <span class="FontName2">Employee</span> to have a composite primary key. This requires additional information to be provided for the <span class="FontName2">EMP_LOB</span> table, because its primary key is not named the same as the primary table. The next difference is that we are storing a relationship in the <span class="FontName2">ORG_STRUCTURE</span> secondary table. The <span class="FontName2">MGR_COUNTRY</span> and <span class="FontName2">MGR_ID</span> columns combine to reference the id of the manager for this employee. Since the employee has a composite primary key, the <span class="FontName2">manager</span> relationship must also specify a set of join columns instead of only one, and the <span class="FontName2">referencedColumnName</span> elements in those join columns refer to the primary key columns <span class="FontName2">COUNTRY</span> and <span class="FontName2">EMP_ID</span> in the entity‚Äôs own primary table <span class="FontName2">EMPLOYEE</span>.</p>
        <p id="Sec31" class="Heading1">Inheritance<a id="cXXX.712a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.712" target="_blank" rel="noopener noreferrer"></a></p>
        <p class="noindent">One of the common mistakes made by novice object-oriented developers is that they get converted to the principle of reuse, but carry it too far. It is too easy to get caught up in the quest for reuse and create complex inheritance hierarchies all for the sake of sharing a few methods. These kinds of multi-level hierarchies will often lead to pain and hardship down the road as the application becomes difficult to debug and a challenge to maintain.</p>
        <p class="indent">Most applications do enjoy the benefits of at least some inheritance in the object model. As with most things, though, moderation should be applied, especially when it comes to mapping the classes to relational databases. Large hierarchies can often lead to significant performance reduction, and it may be that the cost of code reuse is higher than you might want to pay.</p>
        <p class="indent">In the following sections, we will explain the support that exists in the API to map inheritance hierarchies and outline some of the repercussions.</p>
        <div>
          <p id="Sec32" class="Heading2">Class Hierarchies<a id="cXXX.719b" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">Because this is a book about the Java Persistence API, the first and most obvious place to start talking about inheritance is in the Java object model<a id="cXXX.713" target="_blank" rel="noopener noreferrer"></a>. Entities are objects, after all, and should be able to inherit state and behavior from other entities. This is not only expected but also essential for the development of object-oriented applications.</p>
          <p class="indent">What does it mean when one entity inherits state from its entity superclass? It can imply different things in the data model, but in the Java model it simply means that when a subclass entity is instantiated, it has its own version or copy of both its locally defined state and its inherited state, all of which is persistent. While this basic premise is not at all surprising, it opens up the less obvious question of what happens when an entity inherits from something other than another entity. Which classes is an entity allowed to extend, and what happens when it does?</p>
          <p class="indent">Consider the class hierarchy shown in <a href="#Fig10" id="_Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. As we saw in <a href="9781430249269_Ch01.xhtml" target="_blank" rel="noopener noreferrer">Chapter 1</a>, there are a number of ways that class inheritance can be represented in the database. In the object model, there may even be a number of different ways to implement a hierarchy, some of which may include non-entity classes<a id="cXXX.714" target="_blank" rel="noopener noreferrer"></a>. We will use this example as we explore ways to persist inheritance hierarchies in the following sections.</p>
          <div class="Figure" id="Fig10">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-10.jpg" alt="9781430249269_Fig10-10.jpg" width="629" height="483"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. </span>Inheritance class hierarchy</p>
          </div>
          <p class="indent">We differentiate between a general class hierarchy, which is a set of various types of Java classes that extend each other in a tree, and an entity hierarchy, which is a tree consisting of persistent entity classes interspersed with non-entity classes. An entity hierarchy is rooted at the first entity class in the hierarchy.</p>
          <div>
            <p id="Sec33" class="Heading3">Mapped Superclasses<a id="cXXX.715" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The Java Persistence API defines a special kind of class called a mapped superclass that is quite useful as a superclass for entities. A mapped superclass provides a convenient class in which to store shared state and behavior that entities can inherit from, but it is itself not a persistent class and cannot act in the capacity of an entity. It cannot be queried over and cannot be the target of a relationship. Annotations such as <span class="FontName2">&#64;Table</span> are not permitted on mapped superclasses because the state defined in them applies only to its entity subclasses.</p>
            <p class="indent">Mapped superclasses can be compared to entities in somewhat the same way that an abstract class is compared to a concrete class; they can contain state and behavior but just can‚Äôt be instantiated as persistent entities. An abstract class is of use only in relation to its concrete subclasses, and a mapped superclass is useful only as state and behavior that is inherited by the entity subclasses that extend it. They do not play a role in an entity inheritance hierarchy other than contributing that state and behavior to the entities that inherit from them.</p>
            <p class="indent">Mapped superclasses may or may not be defined as abstract in their class definitions, but it is good practice to make them actual abstract Java classes. We don‚Äôt know of any good use cases for creating concrete Java instances of them without ever being able to persist them, and chances are that, if you happen to find one, you probably want the mapped superclass to be an entity.</p>
            <p class="indent">All of the default mapping rules that apply to entities also apply to the basic and relationship state in mapped superclasses. The biggest advantage of using mapped superclasses is being able to define partial shared state that should not be accessed on its own without the additional state that its entity subclasses add to it. If you are not sure whether to make a class an entity or a mapped superclass, then you need only ask yourself if you will ever need to query across or access an instance that is only exposed as an instance of that mapped class. This also includes relationships, since a mapped superclass can‚Äôt be used as the target of a relationship. If you answer yes to any variant of that question, then you should probably make it a first-class entity.</p>
            <p class="indent">Looking back at <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>, we could conceivably treat the <span class="FontName2">CompanyEmployee</span> class as a mapped superclass instead of an entity. It defines shared state, but perhaps we have no reason to query over it.</p>
            <p class="indent">A class is indicated as being a mapped superclass by annotating it with the <span class="FontName2">&#64;MappedSuperclass</span> annotation. The class fragments from <a href="#list32" id="_list32" target="_blank" rel="noopener noreferrer">Listing 10-32</a> show how the hierarchy would be mapped with <span class="FontName2">CompanyEmployee</span> as a mapped superclass.</p>
            <p class="noindent2"><a href="#_list32" id="list32" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-32.</i></b></a>&nbsp;&nbsp;Entities Inheriting from a Mapped Superclass<a id="cXXX.716" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pension;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec34" class="Heading3">Transient Classes<a id="cXXX.717" target="_blank" rel="noopener noreferrer"></a> in the Hierarchy</p>
            <p class="noindent">Classes in an entity hierarchy, that are not entities or mapped superclasses, are called transient classes. Entities may extend transient classes either directly or indirectly through a mapped superclass. When an entity inherits from a transient class, the state defined in the transient class is still inherited in the entity, but it is not persistent. In other words, the entity will have space allocated for the inherited state, according to the usual Java rules, but that state will not be managed by the persistence provider. It will be effectively ignored during the lifecycle of the entity. The entity might manage that state manually through the use of lifecycle callback methods that we describe in <a href="9781430249269_Ch12.xhtml" target="_blank" rel="noopener noreferrer">Chapter 12</a>, or other approaches, but the state will not be persisted as part of the provider-managed entity lifecycle.</p>
            <p class="indent">One could conceive of having a hierarchy that is composed of an entity that has a transient subclass, which in turn has one or more entity subclasses. While this case is not really a common one, it is nonetheless possible and can be achieved in the rare circumstances when having shared transient state or common behavior is desired. It would normally be more convenient, though, to declare the transient state or behavior in the entity superclass than to create an intermediate transient class. <a href="#list33" id="_list33" target="_blank" rel="noopener noreferrer">Listing 10-33</a> shows an entity that inherits from a superclass that defines transient state that is the time an entity was created in memory.</p>
            <p class="noindent2"><a href="#_list33" id="list33" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-33.</i></b></a>&nbsp;&nbsp;Entity Inheriting from a Transient Superclass<a id="cXXX.718" target="_blank" rel="noopener noreferrer"></a></p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">public abstract class CachedEntity {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long createTime;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public CachedEntity() { createTime = System.currentTimeMillis(); }</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public long getCacheAge() { return System.currentTimeMillis() - createTime; }</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class Employee extends CachedEntity {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">public Employee() { super(); }</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">In this example, we moved the transient state from the entity class into a transient superclass, but the end result is really quite the same. The previous example might have been a little neater without the extra class, but this example allows us to share the transient state and behavior across any number of entities that need only extend <span class="FontName2">CachedEntity</span>.</p>
          </div>
          <div>
            <p id="Sec35" class="Heading3">Abstract and Concrete Classes<a id="cXXX.719" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">We have mentioned the notion of abstract versus concrete classes in the context of mapped superclasses, but we didn‚Äôt go into any more detail about entity and transient classes. Most people, depending upon their philosophy, might expect that all non-leaf classes in an object hierarchy should be abstract, or at the very least that some of them would be. A restriction that entities must always be concrete classes would mess this up quite handily, and fortunately this is not the case. It is perfectly acceptable for entities, mapped superclasses, or transient classes to be either abstract or concrete at any level of the inheritance tree. As with mapped superclasses, making transient classes concrete in the hierarchy doesn‚Äôt really serve any purpose, and as a general rule should be avoided to prevent accidental development errors and misuse.</p>
            <p class="indent">The case that we have not talked about is the one where an entity is an abstract class. The only difference between an entity that is an abstract class and one that is a concrete class is the Java rule that prohibits abstract classes from being instantiated. They can still define persistent state and behavior that will be inherited by the concrete entity subclasses below them. They can be queried, the result of which will be composed of concrete entity subclass instances. They can also bear the inheritance mapping metadata for the hierarchy.</p>
            <p class="indent">Our hierarchy in <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a> had an <span class="FontName2">Employee</span> class that was a concrete class. We would not want users to accidentally instantiate this class and then try to persist a partially defined employee. We could protect against this by defining it to be abstract. We would then end up with all of our non-leaf classes being abstract and the leaf classes being persistent.</p>
          </div>
        </div>
        <div>
          <p id="Sec36" class="Heading2">Inheritance Models<a id="cXXX.720" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">JPA provides support for three different data representations. The use of two of them is fairly widespread, while the third is less common and not required to be supported, though it is still fully defined with the intention that providers might be required to support it in the future.</p>
          <p class="indent">When an entity hierarchy exists, it is always rooted at an entity class. Recall that mapped superclasses do not count as levels in the hierarchy because they contribute only to the entities beneath them. The root entity class must signify the inheritance hierarchy by being annotated with the <span class="FontName2">&#64;Inheritance</span> annotation. This annotation indicates the strategy that should be used for mapping and must be one of the three strategies described in the following sections.</p>
          <p class="indent">Every entity in the hierarchy must either define or inherit its identifier, which means that the identifier must be defined either in the root entity or in a mapped superclass above it. A mapped superclass may be higher up in the class hierarchy than where the identifier is defined.</p>
          <div>
            <p id="Sec37" class="Heading3">Single-Table Strategy<a id="cXXX.721a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.721" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">The most common and performant way of storing the state of multiple classes is to define a single table to contain a superset of all the possible state in any of the entity classes. This approach is called, not surprisingly, a single-table strategy. It has the consequence that, for any given table row representing an instance of a concrete class, there may be columns that do not have values because they apply only to a sibling class in the hierarchy.</p>
            <p class="indent">From <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a> we see that the <span class="FontName2">id</span> is located in the root <span class="FontName2">Employee</span> entity class<a id="cXXX.297a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.722" target="_blank" rel="noopener noreferrer"></a> and is shared by the rest of the persistence classes<a id="cXXX.297s" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.723" target="_blank" rel="noopener noreferrer"></a>. All the persistent entities in an inheritance tree must use the same type of identifier. We don‚Äôt need to think about it very long before we see why this makes sense at both levels. In the object layer, it wouldn‚Äôt be possible to issue a polymorphic <span class="FontName2">find()</span> operation on a superclass if there were not a common identifier type that we could pass in. Similarly, at the table level, we would need multiple primary key columns but without being able to fill them all in on any given insertion of an instance that only made use of one of them.</p>
            <p class="indent">The table must contain enough columns to store all the state in all the classes. An individual row stores the state of an entity instance of a concrete entity type, which would normally imply that there would be some columns left unfilled in every row. Of course, this leads to the conclusion that the columns mapped to concrete subclass state should be nullable, which is normally not a big issue but could be a problem for some database administrators.</p>
            <p class="indent">In general, the single-table approach tends to be more wasteful of database tablespace, but it does offer peak performance for both polymorphic queries<a id="cXXX.298p" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.724" target="_blank" rel="noopener noreferrer"></a> and write operations. The SQL that is needed to issue these operations is simple, optimized, and does not require joining.</p>
            <p class="indent">To specify the single-table strategy for the inheritance hierarchy, the root entity class is annotated with the <span class="FontName2">&#64;Inheritance</span> annotation with its strategy set to <span class="FontName2">SINGLE_TABLE</span>. In our previous model, this would mean annotating the <span class="FontName2">Employee</span> class as follows:</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.SINGLE_TABLE)</span><br><span class="FontName2">public abstract class Employee { ... }</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">As it turns out, though, the single-table strategy is the default one, so we wouldn‚Äôt strictly even need to include the <span class="FontName2">strategy</span> element at all. An empty <span class="FontName2">&#64;Inheritance</span> annotation would do the trick just as well.</p>
            <p class="indent">In <a href="#Fig11" id="_Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a>, we see the single-table representation of our <span class="FontName2">Employee</span> hierarchy model. In terms of the table structure and schema architecture for the single-table strategy, it makes no difference whether <span class="FontName2">CompanyEmployee</span> is a mapped superclass or an entity.</p>
            <div class="Figure" id="Fig11">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-11.jpg" alt="9781430249269_Fig10-11.jpg" width="196" height="377"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a>. </span>A single-table inheritance data model</p>
            </div>
            <div>
              <p id="Sec38" class="Heading4">Discriminator Column<a id="cXXX.298a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.725" target="_blank" rel="noopener noreferrer"></a></p>
              <p class="noindent">You may have noticed an extra column named <span class="FontName2">EMP_TYPE</span> in <a href="#Fig11" target="_blank" rel="noopener noreferrer">Figure 10-11</a> that was not mapped to any field in any of the classes in <a href="#Fig10" target="_blank" rel="noopener noreferrer">Figure 10-10</a>. This field has a special purpose and is required when using a single table to model inheritance. It is called a discriminator column and is mapped using the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation in conjunction with the <span class="FontName2">&#64;Inheritance</span> annotation we have already learned about. The <span class="FontName2">name</span> element of this annotation specifies the name of the column that should be used as the discriminator column, and if not specified will be defaulted to a column named ‚ÄúDTYPE‚Äù.</p>
              <p class="indent">A <span class="FontName2">discriminatorType</span> element dictates the type of the discriminator column. Some applications prefer to use strings to discriminate between the entity types, while others like using integer values to indicate the class. The type of the discriminator column may be one of three predefined discriminator column types: <span class="FontName2">INTEGER</span>, <span class="FontName2">STRING</span>, or <span class="FontName2">CHAR</span>. If the <span class="FontName2">discriminatorType</span> element is not specified, then the default type of <span class="FontName2">STRING</span> will be assumed.</p>
            </div>
            <div>
              <p id="Sec39" class="Heading4">Discriminator Value<a id="cXXX.298v" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.726" target="_blank" rel="noopener noreferrer"></a></p>
              <p class="noindent">Every row in the table will have a value in the discriminator column called a discriminator value, or a class indicator, to indicate the type of entity that is stored in that row. Every concrete entity in the inheritance hierarchy, therefore, needs a discriminator value specific to that entity type so that the provider can process or assign the correct entity type when it loads and stores the row. The way this is done is to use a <span class="FontName2">&#64;DiscriminatorValue</span> annotation on each concrete entity class. The string value in the annotation specifies the discriminator value that instances of the class will get assigned when they are inserted into the database. This will allow the provider to recognize instances of the class when it issues queries. This value should be of the same type as was specified or defaulted as the <span class="FontName2">discriminatorType</span> element in the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation.</p>
              <p class="indent">If no <span class="FontName2">&#64;DiscriminatorValue</span> annotation is specified, then the provider will use a provider-specific way of obtaining the value. If the <span class="FontName2">discriminatorType</span> is <span class="FontName2">STRING</span>, then the provider will just use the entity name as the class indicator string. If the <span class="FontName2">discriminatorType</span> is <span class="FontName2">INTEGER</span>, then we would either have to specify the discriminator values for every entity class or none of them. If we were to specify some but not others, then we could not guarantee that a provider-generated value would not overlap with one that we specified.</p>
              <p class="indent"><a href="#list34" id="_list34" target="_blank" rel="noopener noreferrer">Listing 10-34</a> shows how our <span class="FontName2">Employee</span> hierarchy is mapped to a single-table strategy.</p>
              <p class="noindent2"><a href="#_list34" id="list34" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-34.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Single-Table Strategy</p>
              <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
                <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE")</span><br><span class="FontName2">public abstract class Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class ContractEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;DiscriminatorValue("FTEmp")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee { ... }</span><br><br><span class="FontName2">&#64;Entity(name="PTEmp")</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee { ... }</span>
  </pre>
                <div class="orm-ChapterReader-snippetButtonContainer"></div>
              </div>
              <p class="indent">The <span class="FontName2">Employee</span> class is the root class, so it establishes the inheritance strategy and discriminator column. We have assumed the default strategy of <span class="FontName2">SINGLE_TABLE</span> and discriminator type of <span class="FontName2">STRING</span>.</p>
              <p class="indent">Neither the <span class="FontName2">Employee</span> nor the <span class="FontName2">CompanyEmployee</span> classes have discriminator values, because discriminator values should not be specified for abstract entity classes, mapped superclasses, transient classes, or any abstract classes for that matter. Only concrete entity classes use discriminator values since they are the only ones that actually get stored and retrieved from the database.</p>
              <p class="indent">The <span class="FontName2">ContractEmployee</span> entity<a id="cXXX.727" target="_blank" rel="noopener noreferrer"></a> does not use a <span class="FontName2">&#64;DiscriminatorValue</span> annotation, because the default string ‚ÄúContractEmployee‚Äù, which is the default entity name that is given to the class, is just what we want. The <span class="FontName2">FullTimeEmployee</span> class explicitly lists its discriminator value to be ‚ÄúFTEmp‚Äù, so that is what is stored in each row for instances of <span class="FontName2">FullTimeEmployee</span>. Meanwhile, the <span class="FontName2">PartTimeEmployee</span> class will get ‚ÄúPTEmp‚Äù as its discriminator value because it set its entity name to be ‚ÄúPTEmp‚Äù, and the entity name gets used as the discriminator value when none is specified.</p>
              <p class="indent">In <a href="#Fig12" id="_Fig12" target="_blank" rel="noopener noreferrer">Figure 10-12</a>, we can see a sample of some of the data<a id="cXXX.727a" target="_blank" rel="noopener noreferrer"></a> that we might find given the earlier model and settings. We can see from the <span class="FontName2">EMP_TYPE</span> discriminator column that there are three different types of concrete entities. We also see null values in the columns that do not apply to an entity instance.</p>
              <div class="Figure" id="Fig12">
                <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-12.jpg" alt="9781430249269_Fig10-12.jpg" width="727" height="269"></p>
                <p class="FigCapt"><span class="CaptNr"><a href="#_Fig12" target="_blank" rel="noopener noreferrer">Figure 10-12</a>. </span>Sample of single-table inheritance data</p>
              </div>
            </div>
          </div>
          <div>
            <p id="Sec40" class="Heading3">Joined Strategy<a id="cXXX.729" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.730" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">From the perspective of a Java developer, a data model that maps each entity to its own table makes a lot of sense. Every entity, whether it is abstract or concrete, will have its state mapped to a different table. Consistent with our earlier description, mapped superclasses do not get mapped to their own tables but are mapped as part of their entity subclasses.</p>
            <p class="indent">Mapping a table per entity provides the data reuse that a normalized<a id="_Fn2" href="#Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> data schema offers and is the most efficient way to store data that is shared by multiple subclasses in a hierarchy. The problem is that, when it comes time to reassemble an instance of any of the subclasses, the tables of the subclasses must be joined together with the superclass tables. It makes it fairly obvious why this strategy is called the joined strategy. It is also somewhat more expensive to insert an entity instance, because a row must be inserted in each of its superclass tables along the way.</p>
            <p class="indent">Recall from the single-table strategy that the identifier must be of the same type for every class in the hierarchy. In a joined approach, we will have the same type of primary key in each of the tables, and the primary key of a subclass table also acts as a foreign key that joins to its superclass table. This should ring a bell because of its similarity to the multiple-table case earlier in the chapter where we joined the tables together using the primary keys of the tables and used the <span class="FontName2">&#64;PrimaryKeyJoinColumn</span> annotation to indicate it. We use this same annotation in the joined inheritance case since we have multiple tables that each contain the same primary key type and each potentially has a row that contributes to the final combined entity state.</p>
            <p class="indent">While joined inheritance is both intuitive and efficient in terms of data storage, the joining that it requires makes it somewhat expensive to use when hierarchies are deep or wide. The deeper the hierarchy, the more joins it will take to assemble instances of the concrete entity at the bottom. The broader the hierarchy the more joins it will take to query across an entity superclass.</p>
            <p class="indent">In <a href="#Fig13" id="_Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a>, we see our <span class="FontName2">Employee</span> example mapped to a joined table architecture. The data for an entity subclass is spread across the tables in the same way that it is spread across the class hierarchy. When using a joined architecture, the decision as to whether <span class="FontName2">CompanyEmployee</span> is a mapped superclass or an entity makes a difference, since mapped superclasses do not get mapped to tables. An entity, even if it is an abstract class, always does. Figure 8-13 shows it as a mapped superclass, but if it were an entity, then an additional <span class="FontName2">COMPANY_EMP</span> table would exist with <span class="FontName2">ID</span> and <span class="FontName2">VACATION</span> columns in it, and the <span class="FontName2">VACATION</span> column in the <span class="FontName2">FT_EMP</span> and <span class="FontName2">PT_EMP</span> tables would not be present.</p>
            <div class="Figure" id="Fig13">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-13.jpg" alt="9781430249269_Fig10-13.jpg" width="752" height="427"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a>. </span>Joined inheritance data model</p>
            </div>
            <p class="indent">To map an entity hierarchy to a joined model, the <span class="FontName2">&#64;Inheritance</span> annotation need only specify <span class="FontName2">JOINED</span> as the strategy. Like the single-table example, the subclasses will adopt the same strategy that is specified in the root entity superclass.</p>
            <p class="indent">Even though there are multiple tables to model the hierarchy, the discriminator column is only defined on the root table, so the <span class="FontName2">&#64;DiscriminatorColumn</span> annotation is placed on the same class as the <span class="FontName2">&#64;Inheritance</span> annotation.</p>
            <div class="notepara">
              <p class="paraaftertitle1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/sq.jpg" alt="image" width="12" height="12">&nbsp;<b>Tip</b>&nbsp;&nbsp;Some vendors offer implementations of joined inheritance without the use of a discriminator column. Discriminator columns should be used if provider portability is required.</p>
            </div>
            <p class="indent">Our <span class="FontName2">Employee</span> hierarchy example can be mapped using the joined approach shown in <a href="#list35" id="_list35" target="_blank" rel="noopener noreferrer">Listing 10-35</a>. In this example, we have used integer discriminator columns instead of the default string type.</p>
            <p class="noindent2"><a href="#_list35" id="list35" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-35.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using the Joined Strategy</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.JOINED)</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE", discriminatorType=DiscriminatorType.INTEGER)</span><br><span class="FontName2">public abstract class Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("1")</span><br><span class="FontName2">public class ContractEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="FT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("2")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee { ... }</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="PT_EMP")</span><br><span class="FontName2">&#64;DiscriminatorValue("3")</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee { ... }</span>
  </pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
          </div>
          <div>
            <p id="Sec41" class="Heading3">Table-per-Concrete-Class Strategy<a id="cXXX.302a" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.731" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.732" target="_blank" rel="noopener noreferrer"></a></p>
            <p class="noindent">A third approach to mapping an entity hierarchy is to use a strategy where a table per concrete class is defined. This data architecture goes in the reverse direction of non-normalization of entity data and maps each concrete entity class and all its inherited state to a separate table. This has the effect of causing all shared state to be redefined in the tables of all the concrete entities that inherit it. This strategy is not required to be supported by providers but is included because it is anticipated that it will be required in a future release of the API. We will describe it briefly for completeness.</p>
            <p class="indent">The negative side of using this strategy is that it makes polymorphic querying across a class hierarchy more expensive than the other strategies. The problem is that it must either issue multiple separate queries across each of the subclass tables, or query across all of them using a UNION operation, which is generally regarded as being expensive when lots of data is involved. If there are non-leaf concrete classes, then each of them will have its own table. Subclasses of the concrete classes will have to store the inherited fields in their own tables, along with their own defined fields.</p>
            <p class="indent">The bright side of table-per-concrete-class hierarchies when compared to joined hierarchies is seen in cases of querying over instances of a single concrete entity. In the joined case, every query requires a join, even when querying across a single concrete entity class. In the table-per-concrete-class case, it is akin to the single-table hierarchy because the query is confined to a single table. Another advantage is that the discriminator column goes away. Every concrete entity has its own separate table, and there is no mixing or sharing of schema, so no class indicator is ever needed.</p>
            <p class="indent">Mapping our example to this type of hierarchy is a matter of specifying the strategy as <span class="FontName2">TABLE_PER_CLASS</span> and making sure there is a table for each of the concrete classes. If a legacy database is being used, then the inherited columns could be named differently in each of the concrete tables and the <span class="FontName2">&#64;AttributeOverride</span> annotation would come in handy. In this case, the <span class="FontName2">CONTRACT_EMP</span> table didn‚Äôt have the <span class="FontName2">NAME</span> and <span class="FontName2">S_DATE</span> columns but instead had <span class="FontName2">FULLNAME</span> and <span class="FontName2">SDATE</span> for the <span class="FontName2">name</span> and <span class="FontName2">startDate</span> fields defined in <span class="FontName2">Employee</span>.</p>
            <p class="indent">If the attribute that we wanted to override was an association instead of a simple state mapping, then we could still override the mapping, but we would need to use an <span class="FontName2">&#64;AssociationOverride</span> annotation instead of <span class="FontName2">&#64;AttributeOverride</span>. The <span class="FontName2">&#64;AssociationOverride</span> annotation allows us to override the join columns used to reference the target entity of a many-to-one or one-to-one association defined in a mapped superclass. To show this, we need to add a <span class="FontName2">manager</span> attribute to the <span class="FontName2">CompanyEmployee</span> mapped superclass. The join column is mapped by default in the <span class="FontName2">CompanyEmployee</span> class to the <span class="FontName2">MANAGER</span> column in the two <span class="FontName2">FT_EMP</span> and <span class="FontName2">PT_EMP</span> subclass tables, but in <span class="FontName2">PT_EMP</span> the name of the join column is actually <span class="FontName2">MGR</span>. We override the join column by adding the <span class="FontName2">&#64;AssociationOverride</span> annotation to the <span class="FontName2">PartTimeEmployee</span> entity class and specifying the name of the attribute we are overriding and the join column that we are overriding it to be. <a href="#list36" id="_list36" target="_blank" rel="noopener noreferrer">Listing 10-36</a> shows a complete example of the entity mappings, including the overrides.</p>
            <p class="noindent2"><a href="#_list36" id="list36" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-36.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Table-per-Concrete-Class Strategy</p>
            <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
              <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.TABLE_PER_CLASS)</span><br><span class="FontName2">public abstract class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">&#64;AttributeOverrides({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="name", column=&#64;Column(name="FULLNAME")),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;AttributeOverride(name="startDate", column=&#64;Column(name="SDATE"))</span><br><span class="FontName2">})</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;MappedSuperclass</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;ManyToOne</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Employee manager;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity &#64;Table(name="FT_EMP")</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PENSION")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pensionContribution;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="PT_EMP")</span><br><span class="FontName2">&#64;AssociationOverride(name="manager",</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName2">joinColumns=&#64;JoinColumn(name="MGR"))</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span></pre>
              <div class="orm-ChapterReader-snippetButtonContainer"></div>
            </div>
            <p class="indent">The table organization shows how these columns are mapped to the concrete tables. See <a href="#Fig14" id="_Fig14" target="_blank" rel="noopener noreferrer">Figure 10-14</a> for a clear picture of what the tables would look like and how the different types of employee instances would be stored.</p>
            <div class="Figure" id="Fig14">
              <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-14.jpg" alt="9781430249269_Fig10-14.jpg" width="644" height="225"></p>
              <p class="FigCapt"><span class="CaptNr"><a href="#_Fig14" target="_blank" rel="noopener noreferrer">Figure 10-14</a>. </span>Table-per-concrete-class data model</p>
            </div>
          </div>
        </div>
        <div>
          <p id="Sec42" class="Heading2">Mixed Inheritance<a id="cXXX.733" target="_blank" rel="noopener noreferrer"></a><a id="cXXX.734" target="_blank" rel="noopener noreferrer"></a></p>
          <p class="noindent">We should begin this section by saying that the practice of mixing inheritance types within a single inheritance hierarchy is currently outside the specification. We are including it because it is both useful and interesting, but we are offering a warning that it might not be portable to rely on such behavior, even if your vendor supports it.</p>
          <p class="indent">Furthermore, it really makes sense to mix only single-table and joined inheritance types. We will show an example of mixing these two, bearing in mind that support for them is vendor-specific. The intent is that, in future releases of the specification, the more useful cases will be standardized and required to be supported by compliant implementations.</p>
          <p class="indent">The premise for mixing inheritance types is that it is well within the realm of possibilities that a data model includes a combination of single-table and joined-table designs within a single entity hierarchy. This can be illustrated by taking our joined example in <a href="#Fig13" target="_blank" rel="noopener noreferrer">Figure 10-13</a> and storing the <span class="FontName2">FullTimeEmployee</span> and <span class="FontName2">PartTimeEmployee</span> instances in a single table. This would produce a model that looks like the one shown in <a href="#Fig15" id="_Fig15" target="_blank" rel="noopener noreferrer">Figure 10-15</a>.</p>
          <div class="Figure" id="Fig15">
            <p class="img"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781430249269/files/images/9781430249269_Fig10-15.jpg" alt="9781430249269_Fig10-15.jpg" width="654" height="171"></p>
            <p class="FigCapt"><span class="CaptNr"><a href="#_Fig15" target="_blank" rel="noopener noreferrer">Figure 10-15</a>. </span>Mixed inheritance data model</p>
          </div>
          <p class="indent">In this example, the joined strategy is used for the <span class="FontName2">Employee</span> and <span class="FontName2">ContractEmployee</span> classes, while the <span class="FontName2">CompanyEmployee</span>, <span class="FontName2">FullTimeEmployee</span>, and <span class="FontName2">PartTimeEmployee</span> classes revert to a single-table model. To make this inheritance strategy switch at the level of the <span class="FontName2">CompanyEmployee</span>, we need to make a simple change to the hierarchy. We need to turn <span class="FontName2">CompanyEmployee</span> into an abstract entity instead of a mapped superclass so that it can bear the new inheritance metadata. Note that this is simply an annotation change, not making any change to the domain model.</p>
          <p class="indent">The inheritance strategies can be mapped as shown in <a href="#list37" id="_list37" target="_blank" rel="noopener noreferrer">Listing 10-37</a>. Notice that we do not need to have a discriminator column for the single-table subhierarchy since we already have one in the superclass <span class="FontName2">EMP</span> table.</p>
          <p class="noindent2"><a href="#_list37" id="list37" target="_blank" rel="noopener noreferrer"><b><i>Listing 10-37.</i></b></a>&nbsp;&nbsp;Entity Hierarchy Mapped Using Mixed Strategies<a id="cXXX.735" target="_blank" rel="noopener noreferrer"></a></p>
          <div data-testid="custom pre block" class="orm-ChapterReader-codeSnippetContainer">
            <pre><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.JOINED)</span><br><span class="FontName2">&#64;DiscriminatorColumn(name="EMP_TYPE")</span><br><span class="FontName2">public abstract class Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Id private int id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private String name;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Temporal(TemporalType.DATE)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="S_DATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private Date startDate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="CONTRACT_EMP")</span><br><span class="FontName2">public class ContractEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="D_RATE") private int dailyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int term;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">&#64;Table(name="COMPANY_EMP")</span><br><span class="FontName2">&#64;Inheritance(strategy=InheritanceType.SINGLE_TABLE)</span><br><span class="FontName2">public abstract class CompanyEmployee extends Employee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private int vacation;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class FullTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long salary;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="PENSION")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private long pensionContribution;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span><br><br><span class="FontName2">&#64;Entity</span><br><span class="FontName2">public class PartTimeEmployee extends CompanyEmployee {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">&#64;Column(name="H_RATE")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">private float hourlyRate;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName2">// ...</span><br><span class="FontName2">}</span>
  </pre>
            <div class="orm-ChapterReader-snippetButtonContainer"></div>
          </div>
        </div>
        <p id="Sec43" class="Heading1">Summary</p>
        <p class="noindent">Entity mapping requirements often go well beyond the simplistic mappings that map a field or a relationship to a named column. In this chapter, we addressed some of the more varied and diverse mapping practices that are supported by the Java Persistence API.</p>
        <p class="indent">We discussed how to delimit database identifiers on a case-by-case basis, or for all the mappings in a persistence unit. We illustrated how delimiting identifiers allows the inclusion of special characters and provides case-sensitivity when the target database requires it.</p>
        <p class="indent">A method of doing fine-grained conversion of basic attribute state was shown to be a powerful technique to adapt data. By creating converters we were also able to persist existing and newly defined data types in highly customizable ways. Conversion can be declaratively controlled on a flexible per-attribute or across-the-board basis.</p>
        <p class="indent">We showed how embeddable objects can have state, element collections, further nested embeddables, and even relationships. We gave examples of reusing an embeddable object with relationships in it by overriding the relationship mappings within the embedding entity.</p>
        <p class="indent">Identifiers may be composed of multiple columns. We revealed the two approaches for defining and using compound primary keys, and demonstrated when they could be used. We established how other entities can have foreign key references to entities with compound identifiers and explained how multiple join columns can be used in any context when a single join column applies. We also showed some examples of mapping identifiers, called derived identifiers, which included a relationship as part of their identities.</p>
        <p class="indent">We explained some advanced relationship features, such as read-only mappings and optionality, and showed how they could be of benefit to some models. We then went on to describe some of the more advanced mapping scenarios that included using join tables or sometimes avoiding the use of join tables. The topic of orphan removal was also touched upon and clarified.</p>
        <p class="indent">We went on to show how to distribute entity state across multiple tables and how to use the secondary tables with relationships. We even saw how an embedded object can map to a secondary table of an entity.</p>
        <p class="indent">Finally, we went into detail about the three different inheritance strategies that can be used to map inheritance hierarchies to tables. We explained mapped superclasses and how they can be used to define shared state and behavior. We went over the data models that differentiate the various approaches and showed how to map an entity hierarchy to the tables in each case. We finished off by illustrating how to mix inheritance types within a single hierarchy.</p>
        <p class="indent">In the next chapter, we will continue our discussion of advanced topics but turn our attention to queries and the use of native SQL and stored procedures. We will also exlain how to create entity graphs and use them to create query fetch plans.</p>
        <p class="FootNote"><a id="Fn1" href="#_Fn1" target="_blank" rel="noopener noreferrer"><sup>1</sup></a> Except in the case described later in this section.</p>
        <p class="FootNote"><a id="Fn2" href="#_Fn2" target="_blank" rel="noopener noreferrer"><sup>2</sup></a> Normalization of data is a database practice that attempts to remove redundantly stored data. For the seminal paper on data normalization, see ‚ÄúA Relational Model of Data for Large Shared Databanks‚Äù by E. F. Codd (Communications of the ACM, 13(6) June 1970). Also, any database design book or paper should have an overview.</p>
      </div>    
    </div>
  </div>
</div>
</body>
</html>